<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>タコ民 住民票｜焼かれた伝説</title>
<meta name="description" content="たこ焼きトレカの街に住む『タコ民』の住民票（プロフィール）" />

<style>
:root{
  --bg:#07060b;

  /* 紙 */
  --paper:#f7f1dc;
  --paper2:#f2e7c6;
  --ink:#2b2416;
  --line:#b79b59;
  --accent:#8b6c2f;

  --shadow:0 12px 34px rgba(0,0,0,.55);
  --radius:14px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

  --safeT: env(safe-area-inset-top, 0px);
  --safeB: env(safe-area-inset-bottom, 0px);
  --safeL: env(safe-area-inset-left, 0px);
  --safeR: env(safe-area-inset-right, 0px);

  /* スクショに収まる幅（スマホ想定） */
  --shotW: 420px;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  background: radial-gradient(circle at 50% 20%, rgba(90,120,255,.12), transparent 55%),
              radial-gradient(circle at 70% 30%, rgba(255,210,120,.10), transparent 55%),
              linear-gradient(#05060b, #0a0a16);
  color:#fff;
  font-family: "Hiragino Mincho ProN","Yu Mincho","Noto Serif JP",serif;
  padding: calc(14px + var(--safeT)) calc(10px + var(--safeR)) calc(16px + var(--safeB)) calc(10px + var(--safeL));
  display:flex;
  justify-content:center;
  align-items:flex-start;
}

/* ===== ページ枠：スクショに収める ===== */
.page{
  width:100%;
  max-width: var(--shotW);
}

/* ===== ヘッダー（小さく） ===== */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:0 0 10px;
}
.back{
  display:inline-flex;
  align-items:center;
  gap:8px;
  text-decoration:none;
  color:rgba(255,255,255,.88);
  font-weight:900;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.18);
  border-radius:12px;
  background:rgba(255,255,255,.06);
  font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
.back:active{ transform: translateY(1px); }
.topmeta{
  text-align:right;
  font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
.topmeta .ttl{
  font-weight:1000;
  font-size:12px;
  letter-spacing:.08em;
  opacity:.95;
}
.topmeta .sub{
  font-size:11px;
  opacity:.70;
}

/* ===== 紙の住民票 ===== */
.paper{
  background:
    radial-gradient(circle at 30% 20%, rgba(0,0,0,.06), transparent 52%),
    radial-gradient(circle at 80% 10%, rgba(0,0,0,.04), transparent 50%),
    repeating-linear-gradient(
      0deg,
      rgba(0,0,0,.018),
      rgba(0,0,0,.018) 2px,
      transparent 2px,
      transparent 5px
    ),
    linear-gradient(180deg, var(--paper), var(--paper2));
  color: var(--ink);
  border:4px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px 14px 12px;
  position:relative;
  overflow:hidden;
}

/* 内枠 */
.paper::before{
  content:"";
  position:absolute;
  inset:8px;
  border:2px solid rgba(183,155,89,.55);
  border-radius: 12px;
  pointer-events:none;
}

/* 紙の角ダメージ風 */
.paper::after{
  content:"";
  position:absolute;
  right:-30px; top:-30px;
  width:90px; height:90px;
  background: radial-gradient(circle at 30% 30%, rgba(0,0,0,.12), transparent 62%);
  transform: rotate(20deg);
  opacity:.35;
  pointer-events:none;
}

.title{
  text-align:center;
  font-weight:1000;
  font-size:18px;
  letter-spacing:.16em;
  margin:4px 0 12px;
  text-shadow: 0 1px 0 rgba(255,255,255,.6);
}

/* ===== 上段 ===== */
.top{
  display:flex;
  gap:12px;
  align-items:center;
}

.avatar{
  width:74px;
  height:74px;
  border:3px solid var(--line);
  border-radius:12px;
  background: rgba(255,255,255,.35);
  overflow:hidden;
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:contain;
  image-rendering:pixelated;
}

.nameBlock{
  flex:1 1 auto;
  min-width:0;
}
.name{
  font-size:17px;
  font-weight:1000;
  letter-spacing:.02em;
  line-height:1.25;
}
.subline{
  margin-top:4px;
  font-size:11px;
  opacity:.78;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.subline .mono{
  font-family: var(--mono);
  letter-spacing:.06em;
  font-size:11px;
}

/* ===== 行テーブル ===== */
.table{
  margin-top:12px;
  border-top:2px solid rgba(183,155,89,.75);
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  border-bottom:1px dashed rgba(183,155,89,.85);
  padding:8px 2px;
  font-size:13px;
}
.label{
  opacity:.85;
  font-weight:900;
}
.value{
  font-weight:1000;
  text-align:right;
}
.value .big{
  font-size:16px;
}
.value .mini{
  font-size:11px;
  opacity:.72;
  margin-top:2px;
}

/* 2列ブロック（スクショ内に収める） */
.grid2{
  margin-top:8px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
}
.box{
  border:2px solid rgba(183,155,89,.75);
  border-radius:12px;
  padding:8px 10px;
  background: rgba(255,255,255,.28);
}
.box b{
  display:block;
  font-size:11px;
  opacity:.75;
  margin-bottom:3px;
  letter-spacing:.02em;
}
.box .n{
  font-weight:1000;
  font-size:16px;
}
.box .s{
  margin-top:2px;
  font-size:11px;
  opacity:.70;
  font-family: var(--mono);
}

/* ===== EXP ===== */
.expWrap{
  margin-top:10px;
}
.expLine{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  font-size:12px;
  font-weight:1000;
}
.expLine .mono{ font-family: var(--mono); letter-spacing:.06em; }
.expBar{
  margin-top:6px;
  height:12px;
  border:2px solid rgba(183,155,89,.85);
  border-radius:999px;
  background: rgba(255,255,255,.35);
  overflow:hidden;
}
.expFill{
  height:100%;
  width:0%;
  background: linear-gradient(180deg, #ffe7a0, #d6a642);
}

/* ===== セリフ ===== */
.say{
  margin-top:10px;
  border:3px double rgba(183,155,89,.9);
  border-radius:12px;
  padding:10px 10px;
  background: rgba(255,255,255,.40);
}
.say .who{
  font-size:11px;
  opacity:.72;
  font-weight:900;
}
.say .text{
  margin-top:4px;
  font-size:13px;
  line-height:1.65;
  font-weight:1000;
}

/* ===== ボタン ===== */
.actions{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
.btn{
  border:2px solid rgba(183,155,89,.90);
  background: rgba(255,255,255,.34);
  color: #2b2416;
  border-radius:12px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:1000;
  font-size:12px;
}
.btn.primary{
  background: linear-gradient(180deg, rgba(255,231,160,.75), rgba(214,166,66,.35));
}
.btn:active{ transform: translateY(1px); }

.note{
  margin-top:8px;
  font-size:10.5px;
  opacity:.70;
  text-align:center;
  font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
}

/* ===== モーダル（編集） ===== */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  background:rgba(0,0,0,.72);
  z-index:9999;
}
.modal.on{display:flex}
.modalCard{
  width:min(var(--shotW), 100%);
  border-radius:14px;
  border:2px solid rgba(255,255,255,.22);
  background:#0b0b14;
  box-shadow: 0 18px 60px rgba(0,0,0,.70);
  overflow:hidden;
  font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
  color:#fff;
}
.modalHead{
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
}
.modalHead .ttl{font-weight:1000;letter-spacing:.04em}
.modalClose{
  border:2px solid rgba(255,255,255,.28);
  background:rgba(255,255,255,.06);
  color:#fff;
  border-radius:10px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:1000;
}
.modalBody{ padding:12px 12px 14px; }

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin:0 0 12px;
}
.field label{
  font-size:12px;
  color:rgba(255,255,255,.78);
  font-weight:900;
}
.field input{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,.24);
  background:rgba(255,255,255,.06);
  color:#fff;
  outline:none;
  font-weight:900;
}

.avatarGrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
}
.avOpt{
  border:2px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  border-radius:12px;
  padding:8px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  cursor:pointer;
  user-select:none;
}
.avOpt.on{
  border-color: rgba(180,220,255,.60);
  background: rgba(140,200,255,.10);
}
.avOpt .img{
  width:52px;height:52px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.25);
  overflow:hidden;
  display:grid;place-items:center;
}
.avOpt img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
.avOpt .nm{font-size:11px;color:rgba(255,255,255,.9);text-align:center;line-height:1.2;font-weight:900}

.modalBtns{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<div class="page">
  <div class="topbar">
    <a class="back" href="./index.html">← 戻る</a>
    <div class="topmeta">
      <div class="ttl">TAKOMIN PROFILE</div>
      <div class="sub">retro paper</div>
    </div>
  </div>

  <section class="paper" aria-label="住民票">
    <div class="title">タコ民 住民票</div>

    <div class="top">
      <div class="avatar">
        <img id="uiAvatar" src="https://ul.h3z.jp/v0hjoXZ3.png" alt="アバター">
      </div>

      <div class="nameBlock">
        <div class="name" id="uiName">名無しのタコ民</div>
        <div class="subline">
          <span id="uiTitle">称号：はじまりの焼き手</span>
          <span class="mono" id="uiId">TKM------</span>
        </div>
      </div>
    </div>

    <div class="table">
      <div class="row">
        <div class="label">ログイン日数</div>
        <div class="value">
          <div class="big"><span id="uiDays">0</span> 日</div>
          <div class="mini">連続 <span id="uiStreak">0</span> / 最終 <span id="uiLast">—</span></div>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="box">
        <b>図鑑総数</b>
        <div class="n"><span id="uiZukan">0</span></div>
        <div class="s">tf_v1_book</div>
      </div>
      <div class="box">
        <b>オクト</b>
        <div class="n"><span id="uiOcto">0</span></div>
        <div class="s">roten_v1_octo</div>
      </div>

      <div class="box">
        <b>露店販売数</b>
        <div class="n"><span id="uiSold">0</span></div>
        <div class="s">roten_v1_sold</div>
      </div>
      <div class="box">
        <b>タワー最高</b>
        <div class="n"><span id="uiTower">0</span></div>
        <div class="s">tower_v1_state</div>
      </div>
    </div>

    <div class="expWrap">
      <div class="expLine">
        <span>経験値</span>
        <span class="mono" id="uiExpText">Lv1 0 / 100</span>
      </div>
      <div class="expBar"><div class="expFill" id="uiExpFill"></div></div>
    </div>

    <div class="say">
      <div class="who">門番</div>
      <div class="text" id="uiQuote">「この街にいるほど、経験が染み込む…」</div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnEdit" type="button">編集</button>
      <button class="btn" id="btnCopy" type="button">コピー</button>
      <button class="btn" id="btnReset" type="button">住民票リセット</button>
    </div>

    <div class="note">
      ※ 住民票は端末保存（localStorage）です（バックアップ対象）
    </div>
  </section>
</div>

<!-- ===== 編集モーダル ===== -->
<div class="modal" id="editModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="住民票編集">
    <div class="modalHead">
      <div class="ttl">住民票 編集</div>
      <button class="modalClose" id="btnClose" type="button">×</button>
    </div>
    <div class="modalBody">
      <div class="field">
        <label for="nameInput">ニックネーム（最大16文字）</label>
        <input id="nameInput" type="text" maxlength="16" placeholder="例：焼き師のmika / たこぴ太郎 など">
      </div>

      <div class="field">
        <label>アバター</label>
        <div class="avatarGrid" id="avatarGrid"></div>
      </div>

      <div class="modalBtns">
        <button class="btn primary" id="btnSave" type="button" style="flex:1">保存</button>
        <button class="btn" id="btnCancel" type="button" style="flex:1">キャンセル</button>
      </div>

      <div style="margin-top:10px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.6">
        ※ サーバ送信はありません（端末内保存のみ）<br>
        ※ 経験値は「滞在時間」で増えます（今回は“遅め”に調整済み）
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  /* =========================================================
     タコ民 住民票（紙プロフィール）
     ✅ バックアップ/復元コードが保存するキーから「必要情報」を拾って表示＆住民票データに反映
       - trc_v1_resident_paper（このページの本体）
       - trc_v1_resident（旧住民票があれば移植）
       - trc_v1_last_login（旧があれば補助）
       - tf_v1_book / roten_v1_octo / roten_v1_sold / tower_v1_state（表示）
     ✅ 経験値：増加が早すぎる問題を “かなり遅く” 調整
        - 10秒ごと加算
        - 1秒あたりEXPを下げる
        - 復帰で一気に増えない上限
     ========================================================= */

  // ===== 保存キー（バックアップ対象）=====
  const KEY_RESIDENT_PAPER = "trc_v1_resident_paper";

  // ===== 旧住民票（バックアップ対象）=====
  const KEY_RESIDENT_OLD   = "trc_v1_resident";
  const KEY_LASTLOGIN_OLD  = "trc_v1_last_login";

  // ===== 連携キー（読むだけ：バックアップ対象）=====
  const K_BOOK  = "tf_v1_book";
  const K_OCTO  = "roten_v1_octo";
  const K_SOLD  = "roten_v1_sold";    // 露店側で加算してね
  const K_TOWER = "tower_v1_state";

  // ===== EXP設定（✅遅くした）=====
  // 例：1分で約3EXP（見えてる間だけ）
  const EXP_PER_SEC = 0.05;   // ← 以前0.5だったので 10分の1に（さらに遅くしたいなら 0.03 など）
  const EXP_PER_LV  = 100;
  const TICK_MS     = 10000;  // ← 以前5000ms（5秒）→ 10秒に
  const DT_CAP_SEC  = 12;     // 復帰で一気に増えない（1回最大12秒分）

  // ===== 初期値 =====
  const DEFAULT_RES = {
    id: "",
    name: "名無しのタコ民",
    title: "はじまりの焼き手",
    avatarUrl: "https://ul.h3z.jp/v0hjoXZ3.png",
    days: 0,
    streak: 0,
    lastDate: "",
    exp: 0
  };

  // ===== アバター候補（増やしてOK）=====
  const AVATARS = [
    { id:"a1", name:"たこぴ", url:"https://ul.h3z.jp/v0hjoXZ3.png" },
    { id:"a2", name:"扉",     url:"https://ul.h3z.jp/X8jPVkhD.png" }
  ];

  const $ = (s, r=document) => r.querySelector(s);

  // ===== 日付 YYYY-MM-DD =====
  function todayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function safeParse(json, fallback){
    try{ return JSON.parse(json); }catch(_){ return fallback; }
  }

  function getIntLS(key, fallback=0){
    const v = localStorage.getItem(key);
    if(v == null) return fallback;
    const n = Number(v);
    return Number.isFinite(n) ? Math.floor(n) : fallback;
  }

  function makeResidentId(){
    const n = Math.floor(10000 + Math.random()*90000);
    return `TKM-${n}`;
  }

  // ===== 旧住民票 → 新住民票へ移植（あれば）=====
  function normalizeOldResident(obj){
    if(!obj || typeof obj !== "object") return null;

    // よくある候補名を吸い上げて整形
    const out = {};

    // id
    out.id = String(obj.id || obj.residentId || obj.uid || obj.code || "").trim();

    // name/title/avatar
    out.name = String(obj.name || obj.nickname || obj.playerName || obj.handle || "").trim();
    out.title = String(obj.title || obj.rank || obj.badge || obj.role || "").trim();
    out.avatarUrl = String(obj.avatarUrl || obj.avatar || obj.icon || obj.iconUrl || "").trim();

    // days/streak/lastDate/exp
    const days = Number(obj.days ?? obj.loginDays ?? obj.totalDays ?? obj.day ?? obj.countDays ?? NaN);
    const streak = Number(obj.streak ?? obj.loginStreak ?? obj.continuous ?? obj.combo ?? NaN);
    const exp = Number(obj.exp ?? obj.xp ?? obj.experience ?? obj.point ?? NaN);

    out.days = Number.isFinite(days) ? Math.max(0, Math.floor(days)) : undefined;
    out.streak = Number.isFinite(streak) ? Math.max(0, Math.floor(streak)) : undefined;
    out.exp = Number.isFinite(exp) ? Math.max(0, exp) : undefined;

    // lastDate: "YYYY-MM-DD" を期待
    const last = String(obj.lastDate || obj.lastLogin || obj.last || obj.last_day || obj.lastDay || "").trim();
    out.lastDate = last;

    // 空は消す
    for(const k of Object.keys(out)){
      if(out[k] === "" || out[k] === undefined) delete out[k];
    }
    return out;
  }

  function tryMigrateFromOldIfNeeded(){
    // すでに新住民票があれば何もしない
    const existing = localStorage.getItem(KEY_RESIDENT_PAPER);
    if(existing) return;

    const rawOld = localStorage.getItem(KEY_RESIDENT_OLD);
    const rawLast = localStorage.getItem(KEY_LASTLOGIN_OLD);

    const oldObj = rawOld ? safeParse(rawOld, null) : null;
    const lastObj = rawLast ? safeParse(rawLast, null) : null;

    let migrated = null;

    // oldObj がオブジェクトならまずそれを試す
    if(oldObj && typeof oldObj === "object"){
      migrated = normalizeOldResident(oldObj);

      // old が配列っぽい場合（住民一覧など）→先頭を採用
      if(!migrated && Array.isArray(oldObj) && oldObj[0] && typeof oldObj[0] === "object"){
        migrated = normalizeOldResident(oldObj[0]);
      }
    }

    // last_login がオブジェクトなら補助情報として取り込む（あれば）
    if(lastObj && typeof lastObj === "object"){
      // last_login 形式が {days, streak, lastDate} とかの場合がある
      const days = Number(lastObj.days ?? lastObj.loginDays ?? lastObj.totalDays ?? NaN);
      const streak = Number(lastObj.streak ?? lastObj.loginStreak ?? NaN);
      const lastDate = String(lastObj.lastDate || lastObj.lastLogin || lastObj.last || "").trim();

      migrated = migrated || {};
      if(Number.isFinite(days) && migrated.days == null) migrated.days = Math.max(0, Math.floor(days));
      if(Number.isFinite(streak) && migrated.streak == null) migrated.streak = Math.max(0, Math.floor(streak));
      if(lastDate && !migrated.lastDate) migrated.lastDate = lastDate;
    }

    // 何も取れなかったら終了
    if(!migrated) return;

    // DEFAULT と合成して保存
    const res = Object.assign({}, DEFAULT_RES, migrated);
    if(!res.id) res.id = makeResidentId();
    if(!res.name) res.name = DEFAULT_RES.name;
    if(!res.title) res.title = DEFAULT_RES.title;
    if(!res.avatarUrl) res.avatarUrl = DEFAULT_RES.avatarUrl;
    if(typeof res.exp !== "number" || !Number.isFinite(res.exp)) res.exp = 0;

    localStorage.setItem(KEY_RESIDENT_PAPER, JSON.stringify(res));
  }

  function loadResident(){
    // 起動時に旧→新の移植を一度だけ試す
    tryMigrateFromOldIfNeeded();

    const raw = localStorage.getItem(KEY_RESIDENT_PAPER);
    const obj = raw ? safeParse(raw, null) : null;
    const res = Object.assign({}, DEFAULT_RES, obj || {});
    if(!res.id) res.id = makeResidentId();
    if(typeof res.exp !== "number" || !Number.isFinite(res.exp)) res.exp = 0;
    return res;
  }

  function saveResident(res){
    localStorage.setItem(KEY_RESIDENT_PAPER, JSON.stringify(res));
  }

  function updateLogin(res){
    const today = todayStr();
    if(res.lastDate === today) return res;

    if(res.lastDate){
      const last = new Date(res.lastDate + "T00:00:00");
      const now  = new Date(today + "T00:00:00");
      const diffDays = Math.round((now - last) / 86400000);
      if(diffDays === 1){
        res.streak = (res.streak || 0) + 1;
      }else{
        res.streak = 1;
      }
    }else{
      res.streak = 1;
    }

    res.days = (res.days || 0) + 1;
    res.lastDate = today;
    return res;
  }

  // 図鑑総数（tf_v1_book の got[id].count 合計）
  function calcZukanTotal(){
    const raw = localStorage.getItem(K_BOOK);
    if(!raw) return 0;
    const book = safeParse(raw, null);
    if(!book) return 0;

    // book.got がある想定、なければ book 自体を “gotっぽい” として見る
    const got = (book.got && typeof book.got === "object") ? book.got : book;
    if(!got || typeof got !== "object") return 0;

    let sum = 0;
    for(const k of Object.keys(got)){
      const v = got[k];
      const c = (v && typeof v === "object") ? Number(v.count || 0) : 0;
      if(Number.isFinite(c)) sum += c;
    }
    return sum;
  }

  // タワー最高（best / bestScore / hiScore 等を探す）
  function readTowerBest(){
    const raw = localStorage.getItem(K_TOWER);
    if(!raw) return 0;
    const st = safeParse(raw, null);
    if(!st || typeof st !== "object") return 0;

    const cand = [
      st.best,
      st.bestScore,
      st.hiScore,
      st.highScore,
      st.max,
      st.top
    ].map(Number).filter(n => Number.isFinite(n));
    return cand.length ? Math.max(...cand) : 0;
  }

  // ===== UI =====
  const uiAvatar = $("#uiAvatar");
  const uiName   = $("#uiName");
  const uiTitle  = $("#uiTitle");
  const uiId     = $("#uiId");

  const uiDays   = $("#uiDays");
  const uiStreak = $("#uiStreak");
  const uiLast   = $("#uiLast");

  const uiZukan  = $("#uiZukan");
  const uiOcto   = $("#uiOcto");
  const uiSold   = $("#uiSold");
  const uiTower  = $("#uiTower");

  const uiExpText = $("#uiExpText");
  const uiExpFill = $("#uiExpFill");
  const uiQuote   = $("#uiQuote");

  const btnEdit  = $("#btnEdit");
  const btnCopy  = $("#btnCopy");
  const btnReset = $("#btnReset");

  const editModal = $("#editModal");
  const btnClose  = $("#btnClose");
  const btnCancel = $("#btnCancel");
  const btnSave   = $("#btnSave");
  const nameInput = $("#nameInput");
  const avatarGrid= $("#avatarGrid");

  let selectedAvatarUrl = null;

  function openModal(){
    editModal.classList.add("on");
    editModal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    editModal.classList.remove("on");
    editModal.setAttribute("aria-hidden","true");
  }

  function renderAvatarPicker(currentUrl){
    avatarGrid.innerHTML = "";
    selectedAvatarUrl = currentUrl;

    AVATARS.forEach(a => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "avOpt" + (a.url === currentUrl ? " on" : "");
      b.innerHTML = `
        <div class="img"><img src="${a.url}" alt="${a.name}"></div>
        <div class="nm">${a.name}</div>
      `;
      b.addEventListener("click", () => {
        selectedAvatarUrl = a.url;
        [...avatarGrid.children].forEach(el => el.classList.remove("on"));
        b.classList.add("on");
      });
      avatarGrid.appendChild(b);
    });
  }

  function levelFromExp(exp){
    const lv = Math.floor(exp / EXP_PER_LV) + 1;
    const cur = exp % EXP_PER_LV;
    return { lv, cur, next: EXP_PER_LV };
  }

  function render(res){
    uiAvatar.src = res.avatarUrl || DEFAULT_RES.avatarUrl;
    uiName.textContent  = res.name || "名無しのタコ民";
    uiTitle.textContent = `称号：${res.title || "はじまりの焼き手"}`;
    uiId.textContent    = res.id || "TKM------";

    uiDays.textContent   = String(res.days || 0);
    uiStreak.textContent = String(res.streak || 0);
    uiLast.textContent   = res.lastDate ? res.lastDate : "—";

    // 連携（バックアップのコードが保存してるキー群）
    uiOcto.textContent  = String(getIntLS(K_OCTO, 0));
    uiSold.textContent  = String(getIntLS(K_SOLD, 0));
    uiZukan.textContent = String(calcZukanTotal());
    uiTower.textContent = String(readTowerBest());

    // EXP
    const { lv, cur, next } = levelFromExp(Math.max(0, res.exp || 0));
    uiExpText.textContent = `Lv${lv} ${Math.floor(cur)} / ${next}`;
    uiExpFill.style.width = `${Math.min(100, (cur/next)*100)}%`;

    // セリフ（雰囲気）
    const d = res.days || 0;
    const s = res.streak || 0;
    if(lv >= 20){
      uiQuote.textContent = "「古い紙ほど…価値がある。お前は、もう“遺産”だ。」";
    }else if(lv >= 10){
      uiQuote.textContent = "「ここまで来たか…もう古参だな。」";
    }else if(s >= 7){
      uiQuote.textContent = "「連続7日…街の匂いが染みている。」";
    }else if(d <= 1){
      uiQuote.textContent = "「住民票の発行、完了だ。ここから焼かれろ。」";
    }else{
      uiQuote.textContent = "「この街にいるほど、経験が染み込む…（ゆっくりな）」";
    }
  }

  // ===== 起動 =====
  let resident = loadResident();
  resident = updateLogin(resident);
  saveResident(resident);
  render(resident);

  // ===== 滞在時間EXP（ページが見えてる間だけ）=====
  let lastTick = Date.now();

  function tick(){
    if(document.visibilityState !== "visible"){
      lastTick = Date.now();
      return;
    }

    const now = Date.now();
    const dt = Math.max(0, (now - lastTick) / 1000);
    lastTick = now;

    // 復帰・放置で一気に増えない
    const capped = Math.min(dt, DT_CAP_SEC);

    resident = loadResident(); // 最新を読む
    resident.exp = Number(resident.exp || 0) + capped * EXP_PER_SEC;
    saveResident(resident);
    render(resident);
  }

  // ✅ 10秒ごと（遅め）
  setInterval(tick, TICK_MS);

  // タブ復帰でズレないように
  document.addEventListener("visibilitychange", () => {
    lastTick = Date.now();
  });

  // ===== UIイベント =====
  btnEdit.addEventListener("click", () => {
    resident = loadResident();
    nameInput.value = resident.name || "";
    renderAvatarPicker(resident.avatarUrl || DEFAULT_RES.avatarUrl);
    openModal();
  });

  btnClose.addEventListener("click", closeModal);
  btnCancel.addEventListener("click", closeModal);
  editModal.addEventListener("click", (e) => { if(e.target === editModal) closeModal(); });

  btnSave.addEventListener("click", () => {
    resident = loadResident();
    const nm = String(nameInput.value || "").trim();
    if(nm) resident.name = nm;
    if(selectedAvatarUrl) resident.avatarUrl = selectedAvatarUrl;
    saveResident(resident);
    render(resident);
    closeModal();
  });

  btnCopy.addEventListener("click", async () => {
    resident = loadResident();
    const { lv } = levelFromExp(Math.max(0, resident.exp || 0));
    const text =
`【タコ民 住民票】
住民番号：${resident.id}
名前：${resident.name}
称号：${resident.title}
ログイン日数：${resident.days}日（連続${resident.streak}日）
Lv：${lv}
経験値：${Math.floor(resident.exp || 0)}
タワー最高：${readTowerBest()}
露店販売数：${getIntLS(K_SOLD,0)}
オクト：${getIntLS(K_OCTO,0)}
図鑑総数：${calcZukanTotal()}
最終ログイン：${resident.lastDate || "—"}`;
    try{
      await navigator.clipboard.writeText(text);
      const old = btnCopy.textContent;
      btnCopy.textContent = "コピーしました！";
      setTimeout(()=>btnCopy.textContent=old, 1200);
    }catch(_){
      alert("コピーに失敗しました（ブラウザの制限）");
    }
  });

  btnReset.addEventListener("click", () => {
    if(!confirm("住民票だけ初期化します（経験値/日数など）。よろしいですか？")) return;
    const keep = loadResident();
    const id = keep.id || makeResidentId();
    const fresh = Object.assign({}, DEFAULT_RES, { id });
    saveResident(fresh);
    resident = fresh;
    render(resident);
  });

})();
</script>

<!-- ✅ 共通バックアップUI（導入済みならこのまま） -->
<!-- <script src="assets/trc-backup-float.js"></script> -->

</body>
</html>
