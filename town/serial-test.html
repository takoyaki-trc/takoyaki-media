<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GAS redeem 診断テスト</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; background:#0b0d17; color:#fff; }
    .wrap{ max-width:860px; margin:0 auto; padding:18px 12px 40px; }
    .panel{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:14px; margin:12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{ flex:1; min-width:240px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.25); color:#fff; font-size:16px; }
    button{ padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.08); color:#fff; font-weight:900; cursor:pointer; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    pre{ white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,.35); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); }
    .muted{ color:rgba(255,255,255,.75); font-size:12px; line-height:1.6; }
    .ok{ color:#9fffa8; font-weight:900; }
    .ng{ color:#ff9aa5; font-weight:900; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 2px;">GAS redeem 診断テスト</h1>
    <div class="muted">
      1) <b>Alive(GET)</b> → GASが生きてるか<br>
      2) <b>redeem(POST)</b> → JSONで返ってくるか / ok:falseの理由は何か<br>
      <span class="muted">※CORS回避のため、POSTは <b>text/plain</b> でJSON文字列を送っています（GASは e.postData.contents を読むのでOK）。</span>
    </div>

    <div class="panel">
      <div class="row">
        <button id="aliveBtn">Alive（GET）</button>
        <input id="code" placeholder="例）TC-ANN-0002" />
        <button id="redeemBtn">redeem（POST）</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        API_URL はこのページに埋め込み済み。結果は下のログに全部出ます。
      </div>
    </div>

    <div class="panel">
      <div class="muted" style="margin-bottom:6px;">ログ（ここをコピペすれば原因確定できます）</div>
      <pre id="log">準備OK</pre>
    </div>
  </div>

<script>
  // ✅ あなたの /exec
  const API_URL = "https://script.google.com/macros/s/AKfycbw4vS58-uznOh0EkCNvTvU3KRQKZlaxSJlRdCwI02uMriNniJOSFWtN1szfQRFVTRviMw/exec";
  const API_KEY = "takopi-gratan-2026";

  const logEl = document.getElementById("log");
  const codeEl = document.getElementById("code");
  const aliveBtn = document.getElementById("aliveBtn");
  const redeemBtn = document.getElementById("redeemBtn");

  function log(x){
    logEl.textContent = (typeof x === "string") ? x : JSON.stringify(x, null, 2);
  }

  async function safeFetch(url, opt){
    try{
      const res = await fetch(url, opt);
      const text = await res.text();
      return { res, text };
    }catch(e){
      throw new Error("FETCH_FAILED: " + (e && e.message ? e.message : e));
    }
  }

  aliveBtn.onclick = async () => {
    aliveBtn.disabled = true;
    log("Alive(GET) 実行中…");
    try{
      const { res, text } = await safeFetch(API_URL, { method:"GET", redirect:"follow" });
      let parsed = null;
      try{ parsed = JSON.parse(text); }catch(_){}
      log({
        step: "alive",
        httpStatus: res.status,
        contentType: res.headers.get("content-type"),
        textHead: text.slice(0, 300),
        json: parsed
      });
    }catch(e){
      log("❌ " + e.message);
    }finally{
      aliveBtn.disabled = false;
    }
  };

  redeemBtn.onclick = async () => {
    const code = codeEl.value.trim();
    if(!code) return log("コードを入力してください（例：TC-ANN-0002）");

    redeemBtn.disabled = true;
    log("redeem(POST) 実行中…");

    try{
      const payload = { apiKey: API_KEY, action:"redeem", code };

      // ✅ CORS回避：application/json をやめる（preflightを出さない）
      const { res, text } = await safeFetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
        redirect:"follow"
      });

      let data = null;
      let jsonError = null;
      try{ data = JSON.parse(text); }catch(e){ jsonError = String(e); }

      log({
        step: "redeem",
        sent: payload,
        httpStatus: res.status,
        contentType: res.headers.get("content-type"),
        textHead: text.slice(0, 800),
        jsonParsed: data,
        jsonParseError: jsonError
      });

    }catch(e){
      log("❌ " + e.message);
    }finally{
      redeemBtn.disabled = false;
    }
  };
</script>
</body>
</html>
