<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>redeemテスト（保存まで）</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; background:#0b0d17; color:#fff; }
    .wrap{ max-width:860px; margin:0 auto; padding:18px 12px 40px; }
    .panel{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:14px; margin:12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{ flex:1; min-width:240px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.25); color:#fff; font-size:16px; }
    button{ padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.08); color:#fff; font-weight:900; cursor:pointer; }
    pre{ white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,.35); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); }
    .muted{ color:rgba(255,255,255,.75); font-size:12px; line-height:1.6; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 2px;">redeemテスト（保存まで）</h1>
    <div class="muted">成功したら <b>localStorage(tf_v1_seedtokens)</b> に seed_tokens を追加します。</div>

    <div class="panel">
      <div class="row">
        <input id="code" placeholder="シリアルコード" />
        <button id="btn">redeem</button>
        <button id="btnShow">保存を見る</button>
        <button id="btnReset">保存リセット</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        ※ reward はGASが返すキー（例：anniv）です。<br>
        ※ API_URL はあなたの /exec。
      </div>
    </div>

    <div class="panel">
      <div class="muted" style="margin-bottom:6px;">ログ</div>
      <pre id="log">準備OK</pre>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwXJXFLCgL7ZMgb7M1hHwfKI6vBPicWgf0yutF5qyo9fkLrGH393zSoA20sRqk7PO71/exec";
  const API_KEY = "takopi-gratan-2026";
  const LS_SEEDTOKENS = "tf_v1_seedtokens";

  const logEl = document.getElementById("log");
  const codeEl = document.getElementById("code");
  const btnEl  = document.getElementById("btn");

  function log(x){
    logEl.textContent = (typeof x === "string") ? x : JSON.stringify(x, null, 2);
  }

  function loadSeedTokens(){
    try{
      const raw = localStorage.getItem(LS_SEEDTOKENS);
      if(!raw) return { ver:1, tokens:{} };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return { ver:1, tokens:{} };
      obj.tokens = obj.tokens || {};
      return obj;
    }catch(e){
      return { ver:1, tokens:{} };
    }
  }

  function saveSeedTokens(obj){
    localStorage.setItem(LS_SEEDTOKENS, JSON.stringify(obj));
  }

  function addTokens(reward, tokens){
    const r = String(reward || "").trim();
    const add = Array.isArray(tokens) ? tokens.filter(Boolean).map(String) : [];
    if(!r) throw new Error("NO_REWARD");
    if(!add.length) throw new Error("NO_SEED_TOKENS");

    const st = loadSeedTokens();
    const cur = Array.isArray(st.tokens[r]) ? st.tokens[r] : [];
    st.tokens[r] = cur.concat(add);
    saveSeedTokens(st);
    return { reward:r, added:add.length, total: st.tokens[r].length };
  }

  async function apiPost(payload){
    const res = await fetch(API_URL, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ apiKey: API_KEY, ...payload })
    });
    const text = await res.text();
    try{ return JSON.parse(text); }
    catch(e){ throw new Error("NON_JSON_RESPONSE: " + text.slice(0, 250)); }
  }

  document.getElementById("btnShow").onclick = () => {
    log(loadSeedTokens());
  };

  document.getElementById("btnReset").onclick = () => {
    localStorage.removeItem(LS_SEEDTOKENS);
    log("保存をリセットしました");
  };

  btnEl.onclick = async () => {
    const code = codeEl.value.trim();
    if(!code) return log("コードを入力してください");

    btnEl.disabled = true;
    log("redeem中...");

    try{
      const data = await apiPost({ action:"redeem", code });

      if(!data || !data.ok){
        log("❌ redeem失敗: " + (data && data.error ? data.error : "UNKNOWN") + "\n\n" + JSON.stringify(data, null, 2));
        return;
      }

      const saved = addTokens(data.reward, data.seed_tokens);
      log("✅ 成功して保存しました\nreward=" + saved.reward + "\n追加=" + saved.added + "\n合計=" + saved.total + "\n\n" + JSON.stringify(data, null, 2));

    }catch(e){
      log("❌ エラー: " + (e && e.message ? e.message : e));
    }finally{
      btnEl.disabled = false;
    }
  };
</script>
</body>
</html>
