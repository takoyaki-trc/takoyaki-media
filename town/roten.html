/* =========================================================
   assets/roten.jsï¼ˆå®Œå…¨ç‰ˆï¼‰
   - éœ²åº—ï¼ˆãŸã“ã´ã®ãŠåº—ï¼‰ã§è³‡æã‚’è³¼å…¥ â†’ tf_v1_inv ã«åæ˜ 
   - å›³é‘‘(tf_v1_book)ã®æ‰€æŒæ•°ã‚’ãƒãƒƒãƒ—ã«åæ˜ 
   - æ‰€æŒè³‡æãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç¨®/æ°´/è‚¥æ–™ï¼‰æ“ä½œæ€§UP
   - ãŸã“ç„¼ãã¿ãã˜ï¼ˆ1æ—¥1å›ï¼‰: ç„¼ãå°ã‹ã‚‰1ã¤é¸ã‚“ã§å ±é…¬ç²å¾—
   - ãŸã“ã´ã‹ã‚‰ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼ˆå…¬é–‹è¨˜å¿µ 1å›ã ã‘ï¼‰
========================================================= */

(() => {
  // ========= localStorage keys =========
  const LS = {
    octo: "roten_v1_octo",
    inv:  "tf_v1_inv",
    book: "tf_v1_book",
    mikujiLast: "roten_v1_mikuji_last",
    giftClaimed: "roten_v1_takopi_gift_claimed",
  };

  // ========= Items master (IDã¯ãƒ•ã‚¡ãƒ¼ãƒ ã¨ä¸€è‡´ã•ã›ã‚‹) =========
  const SEEDS = [
    { id:"seed_random",  name:"ã€ãªã«å‡ºã‚‹ã‚¿ãƒã€‘",  img:"https://ul.h3z.jp/gnyvP580.png", price:0,  note:"ç„¡æ–™âˆï¼ˆè²·ã†æ„å‘³ãªã—ï¼‰" },
    { id:"seed_shop",    name:"ã€åº—é ­ã‚¿ãƒã€‘",      img:"https://ul.h3z.jp/IjvuhWoY.png", price:18, note:"åº—é ­ç”±æ¥ï¼ˆç‰©èªæ ï¼‰" },
    { id:"seed_line",    name:"ã€å›ç·šã‚¿ãƒã€‘",      img:"https://ul.h3z.jp/AonxB5x7.png", price:18, note:"å›ç·šç”±æ¥ï¼ˆãƒãƒƒãƒˆæ ï¼‰" },
    { id:"seed_special", name:"ã€ãŸã“ã´ã®ã‚¿ãƒã€‘",  img:"https://ul.h3z.jp/29OsEvjf.png", price:80, note:"ä»Šã¯ä½•ã‚‚èµ·ããªã„ï¼ˆå°†æ¥æ ï¼‰" },
    { id:"seed_colabo",  name:"ã€ã‚³ãƒ©ãƒœã®ã‚¿ãƒã€‘",  img:"https://ul.h3z.jp/AWBcxVls.png", price:120,note:"ã‚·ãƒªã‚¢ãƒ«ã§ã‚‚å¢—ãˆã‚‹ï¼ˆå°†æ¥æ ï¼‰" },
  ];

  const WATERS = [
    { id:"water_plain_free", name:"ã€ŠãŸã ã®æ°´ã€‹",         img:"https://ul.h3z.jp/13XdhuHi.png", price:0,  note:"ç„¡æ–™âˆï¼ˆUR/LRãªã—ï¼‰" },
    { id:"water_nice",       name:"ã€Šãªã‚“ã‹è‰¯ã•ãã†ãªæ°´ã€‹",img:"https://ul.h3z.jp/3z04ypEd.png", price:25, note:"ã¡ã‚‡ã„ä¸ŠæŒ¯ã‚Œ" },
    { id:"water_suspicious", name:"ã€Šæ€ªã—ã„æ°´ã€‹",         img:"https://ul.h3z.jp/wtCO9mec.png", price:30, note:"ç¾å®Ÿæº–æ‹ ï¼ˆæ¨™æº–ï¼‰" },
    { id:"water_overdo",     name:"ã€Šã‚„ã‚Šã™ããªæ°´ã€‹",     img:"https://ul.h3z.jp/vsL9ggf6.png", price:55, note:"å‹è² æ°´ï¼ˆä¸ŠæŒ¯ã‚Œï¼‰" },
    { id:"water_regret",     name:"ã€ŠæŠ¼ã•ãªãã‚ƒã‚ˆã‹ã£ãŸæ°´ã€‹",img:"https://ul.h3z.jp/L0nafMOp.png", price:99, note:"ç‹‚æ°—ï¼ˆæ¼”å‡ºæ ï¼‰" },
  ];

  const FERTS = [
    { id:"fert_agedama", name:"â‘ ãŸã ã®æšã’ç‰",     img:"https://ul.h3z.jp/9p5fx53n.png", price:0,  note:"ç„¡æ–™âˆï¼ˆæ™‚çŸ­0ï¼‰" },
    { id:"fert_feel",    name:"â‘¡ã€Šæ°—ã®ã›ã„è‚¥æ–™ã€‹", img:"https://ul.h3z.jp/XqFTb7sw.png", price:18, note:"æ™‚çŸ­5%ï¼ˆæ°—ã®ã›ã„ï¼‰" },
    { id:"fert_guts",    name:"â‘¢ã€Šæ ¹æ€§è«–ã¶ã¡è¾¼ã¿è‚¥æ–™ã€‹", img:"https://ul.h3z.jp/bT9ZcNnS.png", price:33, note:"æ™‚çŸ­20%ï¼ˆæ°—åˆï¼‰" },
    { id:"fert_skip",    name:"â‘£ã€Šå·¥ç¨‹ã™ã£é£›ã°ã—è‚¥æ–™ã€‹", img:"https://ul.h3z.jp/FqPzx12Q.png", price:58, note:"æ™‚çŸ­40%ï¼ˆç¦å¿Œï¼‰" },
    { id:"fert_timeno",  name:"â‘¤ã€Šæ™‚é–“ã‚’ä¿¡ã˜ãªã„è‚¥æ–™ã€‹", img:"https://ul.h3z.jp/l2njWY57.png", price:88, note:"æ™‚çŸ­90%ï¼ˆç¦å‘ªï¼‰" },
  ];

  const FREE = {
    seed:  new Set(["seed_random"]),
    water: new Set(["water_plain_free"]),
    fert:  new Set(["fert_agedama"]),
  };

  // ========= DOM =========
  const el = (id) => document.getElementById(id);

  const octoNow   = el("octoNow");
  const chipSeed  = el("chipSeed");
  const chipWater = el("chipWater");
  const chipFert  = el("chipFert");
  const chipDex   = el("chipDex");

  const btnOpenInv   = el("btnOpenInv");
  const btnTakopiInv = el("btnTakopiInv");
  const btnTakopiRates = el("btnTakopiRates");
  const btnTakopiTalk  = el("btnTakopiTalk");
  const takopiReveal   = el("takopiReveal");
  const takopiGoods    = el("takopiGoods");
  const takopiExplain  = el("takopiExplain");

  const btnGiveOcto  = el("btnGiveOcto");
  const btnMikuji    = el("btnMikuji");
  const btnOpenDex   = el("btnOpenDex");
  const btnGift      = el("btnTakopiGift");
  const giftHint     = el("giftHint");

  // modal
  const modal     = el("modal");
  const modalBg   = el("modalBg");
  const modalX    = el("modalX");
  const modalTitle= el("modalTitle");
  const modalBody = el("modalBody");

  function openModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.setAttribute("aria-hidden","true");
    modalBody.innerHTML = "";
  }
  modalBg.addEventListener("click", closeModal);
  modalX.addEventListener("click", closeModal);

  // ========= Helpers =========
  function safeJsonParse(raw, fallback){
    try{ return JSON.parse(raw); }catch(e){ return fallback; }
  }
  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  // ========= Octo =========
  function loadOcto(){
    const n = Number(localStorage.getItem(LS.octo) || 0);
    return Number.isFinite(n) ? n : 0;
  }
  function saveOcto(n){
    localStorage.setItem(LS.octo, String(Math.max(0, Math.floor(n))));
  }

  // ========= Inventory (tf_v1_inv) =========
  function defaultInv(){
    const inv = { ver:1, seed:{}, water:{}, fert:{} };
    SEEDS.forEach(x=> inv.seed[x.id]=0);
    WATERS.forEach(x=> inv.water[x.id]=0);
    FERTS.forEach(x=> inv.fert[x.id]=0);
    return inv;
  }
  function loadInv(){
    const raw = localStorage.getItem(LS.inv);
    if(!raw) return defaultInv();
    const inv = safeJsonParse(raw, null);
    if(!inv || typeof inv !== "object") return defaultInv();
    inv.seed  = inv.seed  || {};
    inv.water = inv.water || {};
    inv.fert  = inv.fert  || {};
    // è¶³ã‚Šãªã„ã‚­ãƒ¼è£œå®Œ
    SEEDS.forEach(x=> { if(typeof inv.seed[x.id] !== "number") inv.seed[x.id] = Number(inv.seed[x.id]||0); });
    WATERS.forEach(x=> { if(typeof inv.water[x.id] !== "number") inv.water[x.id] = Number(inv.water[x.id]||0); });
    FERTS.forEach(x=> { if(typeof inv.fert[x.id] !== "number") inv.fert[x.id] = Number(inv.fert[x.id]||0); });
    return inv;
  }
  function saveInv(inv){
    localStorage.setItem(LS.inv, JSON.stringify(inv));
  }

  function isFree(type, id){
    return !!FREE[type]?.has(id);
  }
  function invGet(inv, type, id){
    if(isFree(type, id)) return Infinity;
    const box = inv[type] || {};
    const n = Number(box[id] ?? 0);
    return Number.isFinite(n) ? n : 0;
  }
  function invAdd(inv, type, id, delta){
    if(isFree(type, id)) return;
    if(!inv[type]) inv[type] = {};
    const cur = Number(inv[type][id] ?? 0);
    const next = Math.max(0, cur + Number(delta||0));
    inv[type][id] = next;
  }

  function sumFiniteCounts(box){
    let t = 0;
    for(const k in box){
      const n = Number(box[k]);
      if(Number.isFinite(n)) t += n;
    }
    return t;
  }

  // ========= Book (tf_v1_book) =========
  function loadBook(){
    const raw = localStorage.getItem(LS.book);
    if(!raw) return { ver:1, got:{} };
    const b = safeJsonParse(raw, { ver:1, got:{} });
    b.got = b.got || {};
    return b;
  }
  function sumBookCount(book){
    const got = (book && book.got) ? book.got : {};
    let total = 0;
    for(const id in got){
      const c = got[id];
      const n = Number(c?.count ?? 1);
      total += Number.isFinite(n) ? n : 1;
    }
    return total;
  }

  // ========= UI refresh =========
  function refreshChips(){
    const octo = loadOcto();
    octoNow.textContent = String(octo);

    const inv = loadInv();
    const seedFinite  = sumFiniteCounts(inv.seed);
    const waterFinite = sumFiniteCounts(inv.water);
    const fertFinite  = sumFiniteCounts(inv.fert);

    chipSeed.textContent  = String(seedFinite);
    chipWater.textContent = String(waterFinite);
    chipFert.textContent  = String(fertFinite);

    const book = loadBook();
    chipDex.textContent = String(sumBookCount(book));

    // gift button state
    const claimed = localStorage.getItem(LS.giftClaimed) === "1";
    if(claimed){
      btnGift.style.display = "none";
      if(giftHint) giftHint.textContent = "â€»å—ã‘å–ã‚Šæ¸ˆã¿";
    }else{
      btnGift.style.display = "inline-flex";
      if(giftHint) giftHint.textContent = "â€»1å›ã ã‘ã€‚æŠ¼ã—ãŸã‚‰æˆ»ã‚Œãªã„ã€‚";
    }

    // mikuji button label
    const last = localStorage.getItem(LS.mikujiLast) || "";
    const ok = (last !== todayKey());
    btnMikuji.textContent = ok ? "ğŸ² ãŸã“ç„¼ãã¿ãã˜ï¼ˆ1æ—¥1å›ï¼‰" : "ğŸ² ãŸã“ç„¼ãã¿ãã˜ï¼ˆæœ¬æ—¥æ¸ˆï¼‰";
    btnMikuji.disabled = !ok;
  }

  // ========= Takopi shop goods =========
  let activeTab = "seed"; // seed | water | fert

  function itemsByTab(tab){
    if(tab==="seed") return { type:"seed", items: SEEDS };
    if(tab==="water") return { type:"water", items: WATERS };
    return { type:"fert", items: FERTS };
  }

  function renderGoods(){
    const { type, items } = itemsByTab(activeTab);
    const inv = loadInv();
    const octo = loadOcto();

    takopiGoods.innerHTML = items.map(it => {
      const cnt = invGet(inv, type, it.id);
      const cntLabel = (cnt === Infinity) ? "âˆ" : String(cnt);
      const canBuy = (it.price > 0) && (octo >= it.price);
      const isFreeItem = (it.price === 0);

      const buyLabel = isFreeItem ? "ç„¡æ–™âˆ" : `è²·ã†ï¼ˆ${it.price}ã‚ªã‚¯ãƒˆï¼‰`;

      return `
        <div class="goodCard">
          <img class="img" src="${it.img}" alt="${it.name}">
          <div class="body">
            <div class="name">${it.name}</div>
            <div class="meta"><span>æ‰€æŒ</span><b>Ã—${cntLabel}</b></div>
            <div class="meta"><span>ãƒ¡ãƒ¢</span><span class="muted">${it.note||""}</span></div>
            <button class="buy ${canBuy ? "primary":""}" data-buy="1"
              data-type="${type}" data-id="${it.id}"
              ${isFreeItem ? "disabled" : (canBuy ? "" : "disabled")}
              >
              ${isFreeItem ? "ç„¡æ–™âˆï¼ˆè³¼å…¥ä¸å¯ï¼‰" : (canBuy ? buyLabel : `ä¸è¶³ï¼ˆ${it.price}ã‚ªã‚¯ãƒˆï¼‰`)}
            </button>
          </div>
        </div>
      `;
    }).join("");

    takopiGoods.querySelectorAll("button[data-buy]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const type = btn.getAttribute("data-type");
        const id = btn.getAttribute("data-id");
        const item = (type==="seed"?SEEDS:(type==="water"?WATERS:FERTS)).find(x=>x.id===id);
        if(!item) return;

        const octoNow = loadOcto();
        if(octoNow < item.price){
          alert("ã‚ªã‚¯ãƒˆãŒè¶³ã‚Šãªã„â€¦ãŸã“ã€‚");
          return;
        }

        // æ”¯æ‰•ã„
        saveOcto(octoNow - item.price);

        // ä»˜ä¸
        const inv2 = loadInv();
        invAdd(inv2, type, id, 1);
        saveInv(inv2);

        refreshChips();
        renderGoods();
      });
    });

    // explain text
    if(activeTab === "seed"){
      takopiExplain.textContent = "ã€Œç¨®ã¯â€œç‰©èªâ€ã€‚å¢—ã‚„ã™ã»ã©ã€æœªæ¥ãŒå¢—ãˆã‚‹â€¦ãŸã“ã€‚ã€";
    }else if(activeTab === "water"){
      takopiExplain.textContent = "ã€Œæ°´ã¯â€œé‹â€ã€‚å¼·ã„æ°´ã»ã©ã€å¿ƒè‡“ã«æ‚ªã„â€¦ãŸã“ã€‚ã€";
    }else{
      takopiExplain.textContent = "ã€Œè‚¥æ–™ã¯â€œä»£å„Ÿâ€ã€‚æ™‚çŸ­ã¯ã€ã ã„ãŸã„å‘ªã„â€¦ãŸã“ã€‚ã€";
    }
  }

  // tab buttons
  document.querySelectorAll(".takopi-tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".takopi-tab").forEach(x=>x.classList.remove("is-active"));
      b.classList.add("is-active");
      activeTab = b.getAttribute("data-takotab") || "seed";
      renderGoods();
    });
  });

  // ========= Inventory modal =========
  function buildInvCard(type, item){
    const inv = loadInv();
    const cnt = invGet(inv, type, item.id);
    const cntLabel = (cnt === Infinity) ? "âˆ" : String(cnt);
    const price = item.price ?? 0;

    return `
      <div class="goodCard">
        <img class="img" src="${item.img}" alt="${item.name}">
        <div class="body">
          <div class="name">${item.name}</div>
          <div class="meta"><span>æ‰€æŒ</span><b>Ã—${cntLabel}</b></div>
          <div class="meta"><span>ä¾¡æ ¼</span><span class="muted">${price===0 ? "ç„¡æ–™âˆ" : `${price}ã‚ªã‚¯ãƒˆ`}</span></div>
          <button class="buy" data-jump-buy="1" data-tab="${type}">
            ã“ã“ã‹ã‚‰è²·ã„ã«è¡Œã
          </button>
        </div>
      </div>
    `;
  }

  function openInvModal(startTab="seed"){
    const make = (tab) => {
      const items = tab==="seed" ? SEEDS : tab==="water" ? WATERS : FERTS;
      return items.map(it => buildInvCard(tab, it)).join("");
    };

    openModal("æ‰€æŒè³‡æï¼ˆãƒ•ã‚¡ãƒ¼ãƒ ã¨å…±æœ‰ï¼‰", `
      <div class="invTabs">
        <button class="invTab ${startTab==="seed"?"is-active":""}" data-itab="seed">ğŸŒ± ç¨®</button>
        <button class="invTab ${startTab==="water"?"is-active":""}" data-itab="water">ğŸ’§ æ°´</button>
        <button class="invTab ${startTab==="fert"?"is-active":""}" data-itab="fert">ğŸ§ª è‚¥æ–™</button>
      </div>
      <div class="invList" id="invListArea">${make(startTab)}</div>
      <div class="invNote">
        <b>åŒæœŸãƒ«ãƒ¼ãƒ«</b><br>
        ãƒ»æ‰€æŒè³‡æã¯ <b>tf_v1_inv</b>ï¼ˆãƒ•ã‚¡ãƒ¼ãƒ ï¼‰ã¨å…±é€šã€‚<br>
        ãƒ»ç„¡æ–™è³‡æã¯âˆæ‰±ã„ï¼ˆè²·ãˆãªã„ï¼æ¸›ã‚‰ãªã„ï¼‰ã€‚<br>
        ãƒ»å›³é‘‘ã®æ‰€æŒã¯ <b>tf_v1_book</b> ã‚’èª­ã‚€ã ã‘ã€‚
      </div>
    `);

    const listArea = document.getElementById("invListArea");
    modalBody.querySelectorAll(".invTab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        modalBody.querySelectorAll(".invTab").forEach(x=>x.classList.remove("is-active"));
        btn.classList.add("is-active");
        const t = btn.getAttribute("data-itab");
        listArea.innerHTML = make(t);
        wireJumpButtons();
      });
    });

    function wireJumpButtons(){
      modalBody.querySelectorAll("button[data-jump-buy]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const tab = btn.getAttribute("data-tab") || "seed";
          closeModal();
          // ã‚¿ãƒ–ç§»å‹•
          activeTab = tab;
          document.querySelectorAll(".takopi-tab").forEach(x=>{
            x.classList.toggle("is-active", x.getAttribute("data-takotab")===tab);
          });
          renderGoods();
        });
      });
    }
    wireJumpButtons();
  }

  btnOpenInv.addEventListener("click", ()=> openInvModal("seed"));
  btnTakopiInv.addEventListener("click", ()=> openInvModal(activeTab));

  // ========= Dex chip =========
  btnOpenDex.addEventListener("click", ()=>{
    const book = loadBook();
    const got = book.got || {};
    const kinds = Object.keys(got).length;
    const total = sumBookCount(book);

    openModal("å›³é‘‘ã®æ‰€æŒï¼ˆtf_v1_bookï¼‰", `
      <div class="invNote">
        <b>ç²å¾—ç¨®é¡ï¼š</b>${kinds} ç¨®<br>
        <b>ç·æšæ•°ï¼š</b>${total} æš<br>
        <small class="muted">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯å‚ç…§ã®ã¿ï¼ˆå›³é‘‘ã®ç·¨é›†ã¯ãƒ•ã‚¡ãƒ¼ãƒ å´ã§ï¼‰</small>
      </div>
    `);
  });

  // ========= Water rates memo =========
  btnTakopiRates.addEventListener("click", ()=>{
    openModal("æ°´ã®ãƒ¬ã‚¢ç‡ãƒ¡ãƒ¢ï¼ˆå‚è€ƒï¼‰", `
      <div class="invNote">
        <b>ã ã„ãŸã„ã®ãƒãƒª</b><br>
        ãƒ»ãŸã ã®æ°´ï¼šå®‰å…¨ï¼ˆUR/LRã»ã¼ç„¡ã—ï¼‰<br>
        ãƒ»ãªã‚“ã‹è‰¯ã•ãã†ï¼šã¡ã‚‡ã„ä¸ŠæŒ¯ã‚Œ<br>
        ãƒ»æ€ªã—ã„æ°´ï¼šç¾å®Ÿæº–æ‹ ï¼ˆæ¨™æº–ï¼‰<br>
        ãƒ»ã‚„ã‚Šã™ãï¼šå‹è² ï¼ˆä¸ŠæŒ¯ã‚Œå¼·ã‚ï¼‰<br>
        ãƒ»æŠ¼ã•ãªãã‚ƒã‚ˆã‹ã£ãŸï¼šäº‹ä»¶ï¼ˆæ¼”å‡ºæ ï¼‰<br>
      </div>
    `);
  });

  // ========= Takopi talk =========
  const TALKS = [
    "ã€Œã‚ªã‚¯ãƒˆã¯â€¦ç†±ã§æº¶ã‘ã‚‹å‰ã«ä½¿ã†ã®ãŒâ€¦ã‚³ãƒ„â€¦ãŸã“ã€",
    "ã€Œç„¡æ–™ã£ã¦â€¦ã ã„ãŸã„â€¦è£ãŒã‚ã‚‹â€¦ãŸã“ã€",
    "ã€Œå¢—ã‚„ã™ã»ã©â€¦ç®¡ç†ãŒåœ°ç„â€¦ãŸã“ã€",
    "ã€Œæ™‚çŸ­ã¯â€¦å¯¿å‘½ã‚‚ç¸®ã‚€â€¦ãŸã“ã€",
    "ã€Œãã¿ã®æŒ‡â€¦ä»Šæ—¥ã‚‚ç„¼ã‘ã¦ã‚‹â€¦ãŸã“ï¼Ÿã€",
  ];
  btnTakopiTalk.addEventListener("click", ()=>{
    const t = TALKS[Math.floor(Math.random()*TALKS.length)];
    takopiReveal.textContent = t;
  });

  // ========= Test octo =========
  btnGiveOcto.addEventListener("click", ()=>{
    saveOcto(loadOcto() + 100);
    refreshChips();
    renderGoods();
  });

  // ========= Gift (one-time) =========
  btnGift.addEventListener("click", ()=>{
    const claimed = localStorage.getItem(LS.giftClaimed) === "1";
    if(claimed){
      alert("å—ã‘å–ã‚Šæ¸ˆã¿â€¦ãŸã“ã€‚");
      return;
    }

    const ok = confirm(
      "ã€å…¬é–‹è¨˜å¿µãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€‘ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚\n\n" +
      "åº—é ­ã‚¿ãƒÃ—10 / å›ç·šã‚¿ãƒÃ—10 / ãŸã“ã´ã®ã‚¿ãƒÃ—1\n" +
      "æ°´ï¼ˆç„¡æ–™ä»¥å¤–ï¼‰å„Ã—3\n" +
      "è‚¥æ–™ï¼ˆç„¡æ–™ä»¥å¤–ï¼‰å„Ã—3\n\n" +
      "â€»1å›ã ã‘ã€‚OKï¼Ÿ"
    );
    if(!ok) return;

    const inv = loadInv();

    // seeds
    invAdd(inv, "seed", "seed_shop", 10);
    invAdd(inv, "seed", "seed_line", 10);
    invAdd(inv, "seed", "seed_special", 1);

    // waters (exclude free)
    WATERS.forEach(w=>{
      if(isFree("water", w.id)) return;
      invAdd(inv, "water", w.id, 3);
    });

    // ferts (exclude free)
    FERTS.forEach(f=>{
      if(isFree("fert", f.id)) return;
      invAdd(inv, "fert", f.id, 3);
    });

    saveInv(inv);
    localStorage.setItem(LS.giftClaimed, "1");

    alert("å—ã‘å–ã‚Šå®Œäº†ï¼ãƒ•ã‚¡ãƒ¼ãƒ ã®åœ¨åº«ã«è¿½åŠ ã—ãŸâ€¦ãŸã“ã€‚");
    refreshChips();
    renderGoods();
  });

  // ========= Mikuji (once per day) =========
  function mikujiAvailable(){
    const last = localStorage.getItem(LS.mikujiLast) || "";
    return last !== todayKey();
  }

  function pickMikujiReward(){
    // ã–ã£ãã‚Šï¼šç¨®ãŒå¤šã‚ã€ãŸã¾ã«æ°´è‚¥æ–™ã€ãƒ¬ã‚¢ã§ãŸã“ã´ã‚¿ãƒ
    const r = Math.random();

    // 1%ï¼šãŸã“ã´ã‚¿ãƒ
    if(r < 0.01){
      return { type:"seed", id:"seed_special", qty:1, name:"ã€ãŸã“ã´ã®ã‚¿ãƒã€‘Ã—1", img: SEEDS.find(s=>s.id==="seed_special")?.img };
    }
    // 12%ï¼šåº—é ­ or å›ç·šã‚¿ãƒ 3ã€œ6
    if(r < 0.13){
      const id = Math.random() < 0.5 ? "seed_shop" : "seed_line";
      const qty = 3 + Math.floor(Math.random()*4); // 3..6
      const it = SEEDS.find(x=>x.id===id);
      return { type:"seed", id, qty, name:`${it?.name||id} Ã—${qty}`, img: it?.img };
    }
    // 30%ï¼šæ°´ï¼ˆç„¡æ–™ä»¥å¤–ï¼‰ 1ã€œ2
    if(r < 0.43){
      const pool = WATERS.filter(x=>!isFree("water", x.id));
      const it = pool[Math.floor(Math.random()*pool.length)];
      const qty = 1 + (Math.random()<0.35 ? 1 : 0);
      return { type:"water", id: it.id, qty, name:`${it.name} Ã—${qty}`, img: it.img };
    }
    // 25%ï¼šè‚¥æ–™ï¼ˆç„¡æ–™ä»¥å¤–ï¼‰ 1ã€œ2
    if(r < 0.68){
      const pool = FERTS.filter(x=>!isFree("fert", x.id));
      const it = pool[Math.floor(Math.random()*pool.length)];
      const qty = 1 + (Math.random()<0.35 ? 1 : 0);
      return { type:"fert", id: it.id, qty, name:`${it.name} Ã—${qty}`, img: it.img };
    }
    // ãã‚Œä»¥å¤–ï¼šãªã«å‡ºã‚‹ã‚¿ãƒï¼ˆæ¼”å‡ºï¼šå®Ÿéš›ã¯ç„¡æ–™âˆã ã‹ã‚‰â€œè²·ã„è¶³ã—æ„Ÿâ€ã ã‘ï¼‰â†’ä»£ã‚ã‚Šã«åº—é ­/å›ç·šã‚’1
    {
      const id = Math.random() < 0.5 ? "seed_shop" : "seed_line";
      const it = SEEDS.find(x=>x.id===id);
      return { type:"seed", id, qty:1, name:`${it?.name||id} Ã—1`, img: it?.img };
    }
  }

  function openMikuji(){
    if(!mikujiAvailable()){
      alert("ä»Šæ—¥ã¯ã‚‚ã†å¼•ã„ãŸâ€¦ãŸã“ã€‚");
      return;
    }

    openModal("ãŸã“ç„¼ãã¿ãã˜ï¼ˆ1æ—¥1å›ï¼‰", `
      <div class="mikujiWrap">
        <div class="mikujiHint">
          ç„¼ãå°ã«ä¸¦ã‚“ã ãŸã“ç„¼ãã‹ã‚‰ <b>1ã¤</b> é¸ã¶â€¦ãŸã“ã€‚<br>
          é¸ã¶ã¨ã‚¢ãƒƒãƒ—ã«ãªã£ã¦å…‰ã‚Šã€ã‚¢ã‚¤ãƒ†ãƒ ãŒæ‰‹ã«å…¥ã‚‹ã€‚<br>
          <small class="muted">â€»å ±é…¬ã¯ãƒ•ã‚¡ãƒ¼ãƒ åœ¨åº«ï¼ˆtf_v1_invï¼‰ã«å…¥ã‚‹</small>
        </div>

        <div class="grill">
          <div class="grillGrid" id="grillGrid">
            ${Array.from({length:9}).map((_,i)=>`<button class="takoBtn" type="button" data-pick="${i}">ğŸ™</button>`).join("")}
          </div>
        </div>

        <div class="revealBig" id="revealArea" style="display:none;">
          <div class="bigTako sparkle">ğŸ™âœ¨</div>
          <div style="font-weight:1000; font-size:14px;">å½“ãŸã‚Šï¼</div>
          <div class="muted" id="rewardText">â€¦</div>
          <div style="display:flex; gap:8px; justify-content:center; margin-top:4px;">
            <button class="btn" id="btnOkReward" type="button">OK</button>
          </div>
        </div>
      </div>
    `);

    const grid = document.getElementById("grillGrid");
    const reveal = document.getElementById("revealArea");
    const rewardText = document.getElementById("rewardText");

    let picked = false;

    grid.querySelectorAll("button[data-pick]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(picked) return;
        picked = true;

        // å…¨éƒ¨æŠ¼ã›ãªãã™ã‚‹
        grid.querySelectorAll("button").forEach(b=>b.disabled = true);

        const reward = pickMikujiReward();

        // ä»˜ä¸
        const inv = loadInv();
        invAdd(inv, reward.type, reward.id, reward.qty);
        saveInv(inv);

        // ä»Šæ—¥æ¸ˆã¿ã«ã™ã‚‹
        localStorage.setItem(LS.mikujiLast, todayKey());

        // æ¼”å‡ºè¡¨ç¤º
        rewardText.textContent = reward.name;
        reveal.style.display = "grid";

        document.getElementById("btnOkReward").addEventListener("click", ()=>{
          closeModal();
          refreshChips();
          renderGoods();
        });
      });
    });
  }

  btnMikuji.addEventListener("click", openMikuji);

  // ========= Init =========
  refreshChips();
  renderGoods();

})();
