<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>ãƒã‚¤ãƒ›ãƒ¼ãƒ </title>

  <style>
    :root{
      --bg:#0b0f1a;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --text:#fff;
      --muted: rgba(255,255,255,.74);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --accent:#7fd4ff;
      --shadow: 0 12px 32px rgba(0,0,0,.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    html,body{ height:100%; background:var(--bg); color:var(--text); margin:0; }
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; overflow-x:hidden; }

    /* ã»ã‚“ã®ã‚Šãƒ¬ãƒˆãƒ­ãªç©ºæ°—ï¼ˆãƒ“ãƒãƒƒãƒˆï¼‰ */
    body::before{
      content:"";
      position: fixed;
      inset:0;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(ellipse at center, rgba(0,0,0,0) 55%, rgba(0,0,0,.26) 100%),
        radial-gradient(ellipse at 20% 10%, rgba(127,212,255,.18) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(ellipse at 80% 15%, rgba(159,255,168,.12) 0%, rgba(0,0,0,0) 55%);
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.25));
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1100px;
      margin:0 auto;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .back{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      touch-action:manipulation;
    }
    .titlebox{ min-width:0; }
    .title{
      font-weight:900;
      letter-spacing:.02em;
      line-height:1.1;
      font-size: 18px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      opacity:.8;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .stats{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size:12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
    }
    .pill b{ font-weight:900; }
    .pill .dot{
      width:10px; height:10px; border-radius:3px;
      background: var(--accent);
      box-shadow: 0 0 0 2px rgba(127,212,255,.18);
    }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding: 12px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* éƒ¨å±‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ */
    .stage-card{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
    }
    .stage-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px 8px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .hint{
      font-size:12px;
      opacity:.85;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .hint kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    .stage{
      position: relative;
      width:100%;
      aspect-ratio: 16 / 10;
      min-height: 320px;
      background:
        /* å£ */
        linear-gradient(#13203a 0%, #0e1630 50%, #0b0f1a 100%),
        /* åºŠæ ¼å­ */
        linear-gradient(transparent 0 60%, rgba(255,255,255,.06) 60% 61%, transparent 61% 100%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 32px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 1px, transparent 1px 32px);
      background-blend-mode: normal, normal, overlay, overlay;
      overflow:hidden;
      touch-action: none; /* é‡è¦ï¼šãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜»æ­¢ */
    }

    /* ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆé¢¨ */
    .stage::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:
        radial-gradient(circle at 30% 25%, rgba(127,212,255,.18), rgba(0,0,0,0) 40%),
        radial-gradient(circle at 70% 30%, rgba(159,255,168,.14), rgba(0,0,0,0) 40%),
        radial-gradient(circle at 50% 75%, rgba(255,211,138,.10), rgba(0,0,0,0) 45%);
      pointer-events:none;
      filter: blur(2px);
    }

    /* ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºï¼ˆONæ™‚ï¼‰ */
    .grid-on .stage{
      background:
        linear-gradient(#13203a 0%, #0e1630 50%, #0b0f1a 100%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 1px, transparent 1px 24px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.07) 0 1px, transparent 1px 24px);
      background-blend-mode: normal, overlay, overlay;
    }

    /* ç½®ãã‚¢ã‚¤ãƒ†ãƒ  */
    .item{
      position:absolute;
      left:50%;
      top:70%;
      transform: translate(-50%,-50%) rotate(0deg) scale(1);
      image-rendering: pixelated;
      user-select:none;
      -webkit-user-drag:none;
      touch-action:none;
      pointer-events:auto;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.45));
      /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
      padding: 10px;
      margin:-10px;
    }
    .item img{
      display:block;
      width: var(--w, 96px);
      height:auto;
    }
    .item.selected{
      outline: 2px solid rgba(127,212,255,.65);
      outline-offset: 2px;
      border-radius: 14px;
      background: rgba(127,212,255,.08);
    }

    /* å³ãƒ‘ãƒãƒ« */
    .side{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 10px 10px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .card-h b{ font-weight:900; }
    .card-b{ padding:10px; }

    .btnrow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight:800;
      touch-action:manipulation;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ background: rgba(159,255,168,.10); border-color: rgba(159,255,168,.22); }
    .btn.warn{ background: rgba(255,211,138,.10); border-color: rgba(255,211,138,.22); }
    .btn.bad{  background: rgba(255,154,165,.10); border-color: rgba(255,154,165,.22); }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius: 12px; }

    .toggle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      margin-bottom:10px;
    }
    .switch{
      width: 44px; height: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      position:relative;
      flex: none;
      cursor:pointer;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:50%; left: 3px;
      width:20px; height:20px;
      transform: translateY(-50%);
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      transition: left .15s ease;
    }
    .switch.on{ background: rgba(127,212,255,.22); border-color: rgba(127,212,255,.35); }
    .switch.on::after{ left: 20px; background: rgba(127,212,255,.92); }

    .inv{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:8px;
    }
    @media (max-width: 520px){
      .inv{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    .inv-item{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      touch-action:manipulation;
      min-height: 92px;
      justify-content:space-between;
    }
    .inv-item:hover{ background: rgba(255,255,255,.07); }
    .inv-item .name{
      font-size:12px;
      font-weight:900;
      line-height:1.15;
      opacity:.95;
    }
    .inv-item .meta{
      display:flex; align-items:center; justify-content:space-between;
      font-size:11px; opacity:.85;
    }
    .tag{
      font-family: var(--mono);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      opacity:.9;
      white-space:nowrap;
    }

    .mini{
      font-size:12px;
      opacity:.85;
      line-height:1.45;
    }

    /* ä¸‹ã®æ“ä½œãƒ‘ãƒãƒ« */
    .edit-tools{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-top:10px;
    }
    .edit-tools .btn{ font-size:12px; }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: min(680px, calc(100% - 24px));
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ */
    .modal{
      position: fixed;
      inset:0;
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal.on{ display:flex; }
    .modal-card{
      width: min(920px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(20,24,40,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
    }
    .modal-b{ padding: 12px; }
    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.4;
      outline:none;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <button class="back" id="backBtn" type="button" aria-label="æˆ»ã‚‹">â†</button>
        <div class="titlebox">
          <p class="title">ãƒã‚¤ãƒ›ãƒ¼ãƒ </p>
          <div class="subtitle">é›†ã‚ãŸã‚ªãƒ–ã‚¸ã‚§ã‚’è‡ªç”±ã«é£¾ã‚Œã‚‹ãŸã“ã€‚</div>
        </div>
      </div>

      <div class="stats">
        <div class="pill" title="æ‰€æŒã‚ªãƒ–ã‚¸ã‚§ï¼ˆtf_v1_decoï¼‰">
          <span class="dot"></span>
          <span>æ‰€æŒ</span>
          <b id="ownedCount">0</b>
        </div>
        <div class="pill" title="å®¶ã«é£¾ã£ã¦ã„ã‚‹æ•°ï¼ˆtf_v1_myhomeï¼‰">
          <span class="dot" style="background:var(--good)"></span>
          <span>é£¾ã‚Š</span>
          <b id="placedCount">0</b>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="pageRoot">
    <!-- å·¦ï¼šéƒ¨å±‹ -->
    <section class="stage-card" id="stageCard">
      <div class="stage-top">
        <div class="hint">
          <span>ğŸ–ï¸ ã‚¿ãƒƒãƒ—ã§é¸æŠ â†’ ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•</span>
          <span><kbd>å›è»¢</kbd> <kbd>å‰ã¸</kbd> <kbd>å‰Šé™¤</kbd></span>
        </div>
        <div class="hint">
          <span id="saveState" style="opacity:.85;">ä¿å­˜æ¸ˆã¿</span>
        </div>
      </div>

      <div class="stage" id="stage" aria-label="ãƒã‚¤ãƒ›ãƒ¼ãƒ éƒ¨å±‹">
        <!-- ã‚¢ã‚¤ãƒ†ãƒ ã¯JSã§ã“ã“ã«è¿½åŠ  -->
      </div>
    </section>

    <!-- å³ï¼šã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªï¼†æ“ä½œ -->
    <aside class="side">
      <section class="card">
        <div class="card-h">
          <b>è¨­å®š</b>
          <span class="tag" id="modeTag">ç·¨é›†ï¼šON</span>
        </div>
        <div class="card-b">
          <div class="toggle">
            <span>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯ï¼‰</span>
            <div class="switch on" id="editSwitch" role="switch" aria-checked="true"></div>
          </div>

          <div class="toggle">
            <span>ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º</span>
            <div class="switch" id="gridSwitch" role="switch" aria-checked="false"></div>
          </div>

          <div class="toggle" style="margin-bottom:0;">
            <span>ã‚¹ãƒŠãƒƒãƒ—ï¼ˆ24pxåˆ»ã¿ï¼‰</span>
            <div class="switch on" id="snapSwitch" role="switch" aria-checked="true"></div>
          </div>

          <div class="edit-tools">
            <button class="btn small" id="btnExport" type="button">æ›¸ãå‡ºã—</button>
            <button class="btn small" id="btnImport" type="button">èª­ã¿è¾¼ã¿</button>
            <button class="btn small bad" id="btnClear" type="button">å…¨æ¶ˆå»</button>
          </div>

          <p class="mini" style="margin:10px 2px 0;">
            â€» GitHub Pagesãªã®ã§ä¿å­˜ã¯ç«¯æœ«ã”ã¨ï¼ˆlocalStorageï¼‰ãŸã“ã€‚<br>
            ç«¯æœ«ç§»è¡Œã—ãŸã„æ™‚ã¯ã€Œæ›¸ãå‡ºã—â†’èª­ã¿è¾¼ã¿ã€ã§å¼•ã£è¶Šã—ã§ãã‚‹ãŸã“ã€‚
          </p>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <b>æ‰€æŒã‚ªãƒ–ã‚¸ã‚§</b>
          <span class="tag">ã‚¿ãƒƒãƒ—ã§é…ç½®</span>
        </div>
        <div class="card-b">
          <div class="mini" id="ownedHint" style="margin:0 0 10px;">
            ã¾ã æ‰€æŒã‚ªãƒ–ã‚¸ã‚§ãŒãªã„ãŸã“ã€‚å…ˆã«ã€ŒãŸã“ã´ã®ãŠåº—ã€ã§åˆæˆã™ã‚‹ã¨ã“ã“ã«å‡ºã‚‹ãŸã“ã€‚
          </div>
          <div class="inv" id="invGrid"></div>
        </div>
      </section>

      <section class="card">
        <div class="card-h">
          <b>é¸æŠä¸­</b>
          <span class="tag" id="selTag">ãªã—</span>
        </div>
        <div class="card-b">
          <div class="btnrow">
            <button class="btn warn" id="btnRotate" type="button">â†» å›è»¢</button>
            <button class="btn" id="btnFront" type="button">â¬† å‰ã¸</button>
            <button class="btn" id="btnBack" type="button">â¬‡ å¾Œã‚ã¸</button>
            <button class="btn bad" id="btnDelete" type="button">ğŸ—‘ å‰Šé™¤</button>
          </div>
          <p class="mini" style="margin:10px 2px 0;">
            ã‚³ãƒ„ï¼šå°ç‰©ãŒæ´ã¿ã«ãã„æ™‚ã¯ã€ã„ã£ãŸã‚“é¸æŠã—ã¦ã‹ã‚‰å‹•ã‹ã™ã¨å®‰å®šã™ã‚‹ãŸã“ã€‚
          </p>
        </div>
      </section>
    </aside>
  </main>

  <!-- Export/Import Modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-h">
        <b id="modalTitle">æ›¸ãå‡ºã—</b>
        <button class="btn small" id="modalClose" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modal-b">
        <textarea id="modalText" spellcheck="false"></textarea>
        <div class="btnrow" style="margin-top:10px;">
          <button class="btn good" id="modalCopy" type="button">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn warn" id="modalApply" type="button">é©ç”¨</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // =========================
  // Storage Keys
  // =========================
  const LS = {
    deco:   "tf_v1_deco",     // æ‰€æŒã‚ªãƒ–ã‚¸ã‚§ï¼ˆã‚ãªãŸã®ç„¦ã’ã‚¯ãƒ©ãƒ•ãƒˆãŒã“ã“ã«è¿½åŠ ã™ã‚‹æƒ³å®šï¼‰
    myhome: "tf_v1_myhome"    // å®¶ã®é…ç½®
  };

  // =========================
  // æ‰€æŒã‚ªãƒ–ã‚¸ã‚§ã®ã€Œè¡¨ç¤ºå/ç”»åƒ/ãƒ‡ãƒ•ã‚©ã‚µã‚¤ã‚ºã€
  // â€» ç”»åƒãŒç„¡ãã¦ã‚‚OKã€‚å¾Œã‹ã‚‰å·®ã—æ›¿ãˆå¯èƒ½ã€‚
  // =========================
  const CATALOG = {
    koge_small: { name:"ç„¦ã’ã®å±±",   img:"assets/img/koge_small.png", w:72  },
    koge_mid:   { name:"ç„¦ã’ã®ç¥­å£‡", img:"assets/img/koge_mid.png",   w:110 },
    koge_big:   { name:"ç„¦ã’ã‚¿ãƒ¯ãƒ¼", img:"assets/img/koge_big.png",   w:150 },

    // è¿½åŠ ã—ãŸããªã£ãŸã‚‰ã“ã“ã«å¢—ã‚„ã›ã‚‹
    // koge_lantern:{ name:"ç„¦ã’ãƒ©ãƒ³ã‚¿ãƒ³", img:"assets/img/koge_lantern.png", w:80 },
  };

  // =========================
  // DOM
  // =========================
  const backBtn     = document.getElementById("backBtn");
  const stage       = document.getElementById("stage");
  const stageCard   = document.getElementById("stageCard");
  const invGrid     = document.getElementById("invGrid");
  const ownedCount  = document.getElementById("ownedCount");
  const placedCount = document.getElementById("placedCount");
  const ownedHint   = document.getElementById("ownedHint");

  const editSwitch  = document.getElementById("editSwitch");
  const gridSwitch  = document.getElementById("gridSwitch");
  const snapSwitch  = document.getElementById("snapSwitch");
  const modeTag     = document.getElementById("modeTag");

  const selTag      = document.getElementById("selTag");
  const btnRotate   = document.getElementById("btnRotate");
  const btnFront    = document.getElementById("btnFront");
  const btnBack     = document.getElementById("btnBack");
  const btnDelete   = document.getElementById("btnDelete");

  const btnExport   = document.getElementById("btnExport");
  const btnImport   = document.getElementById("btnImport");
  const btnClear    = document.getElementById("btnClear");

  const saveState   = document.getElementById("saveState");

  const toastEl     = document.getElementById("toast");
  const modal       = document.getElementById("modal");
  const modalTitle  = document.getElementById("modalTitle");
  const modalText   = document.getElementById("modalText");
  const modalClose  = document.getElementById("modalClose");
  const modalCopy   = document.getElementById("modalCopy");
  const modalApply  = document.getElementById("modalApply");

  // =========================
  // State
  // =========================
  let editMode = true;
  let gridOn   = false;
  let snapOn   = true;

  let owned = []; // {type,count}
  let home  = loadHome(); // {ver, items:[{id,type,x,y,z,rot,scale}]}

  let selectedId = null;
  let drag = null; // {id, offsetX, offsetY}

  // =========================
  // Utils
  // =========================
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const rid = () => "mh_" + Date.now().toString(16) + "_" + Math.random().toString(16).slice(2);

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.classList.remove("show"), 1600);
  }

  function setDirty(){
    saveState.textContent = "ä¿å­˜ä¸­â€¦";
    saveState.style.opacity = "1";
    clearTimeout(setDirty._t);
    setDirty._t = setTimeout(() => {
      saveState.textContent = "ä¿å­˜æ¸ˆã¿";
      saveState.style.opacity = ".85";
    }, 400);
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(_){
      return fallback;
    }
  }
  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }

  function loadOwned(){
    // tf_v1_deco ã®æƒ³å®šï¼š { ver:1, items:[ {id,type,x,y,z} ... ] }
    // æ‰€æŒæ•°ã¨ã—ã¦ã¯ã€Œtypeé›†è¨ˆã€ã§è¡¨ç¤ºã™ã‚‹ï¼ˆæ‰€æŒï¼æœªè¨­ç½®å«ã‚€ã€ã¨ã„ã†ä¸–ç•Œè¦³ï¼‰
    const d = loadJSON(LS.deco, { ver:1, items:[] });
    const items = Array.isArray(d.items) ? d.items : [];
    const map = new Map();
    for(const it of items){
      const t = String(it?.type || "");
      if(!t) continue;
      map.set(t, (map.get(t) || 0) + 1);
    }
    const arr = [...map.entries()].map(([type,count]) => ({ type, count }));
    arr.sort((a,b) => a.type.localeCompare(b.type));
    return arr;
  }

  function loadHome(){
    const h = loadJSON(LS.myhome, { ver:1, items:[] });
    h.ver = h.ver || 1;
    h.items = Array.isArray(h.items) ? h.items : [];
    h.items = h.items
      .filter(x => x && typeof x === "object")
      .map(x => ({
        id: String(x.id || rid()),
        type: String(x.type || "koge_small"),
        x: clamp(Number(x.x ?? 50), 0, 100),
        y: clamp(Number(x.y ?? 70), 0, 100),
        z: clamp(Number(x.z ?? 1), 1, 999),
        rot: (Number(x.rot ?? 0) % 360 + 360) % 360,
        scale: clamp(Number(x.scale ?? 1), 0.5, 2)
      }));
    return h;
  }

  function saveHome(){
    saveJSON(LS.myhome, home);
    setDirty();
    updateCounts();
  }

  function getTypeMeta(type){
    return CATALOG[type] || { name:type, img:"", w:96 };
  }

  function updateCounts(){
    const ownedTotal = owned.reduce((s,x)=>s + (x.count|0), 0);
    ownedCount.textContent = String(ownedTotal);
    placedCount.textContent = String(home.items.length);
  }

  function setSwitch(el, on){
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", on ? "true" : "false");
  }

  // ã‚¹ãƒŠãƒƒãƒ—ï¼ˆpxå˜ä½ï¼‰
  function snapPx(v, step){
    return Math.round(v / step) * step;
  }

  function stageRect(){
    return stage.getBoundingClientRect();
  }

  function pxToPercent(px, total){
    return (px / total) * 100;
  }
  function percentToPx(p, total){
    return (p / 100) * total;
  }

  function findItem(id){
    const idx = home.items.findIndex(x => x.id === id);
    if(idx < 0) return null;
    return { idx, item: home.items[idx] };
  }

  function clearSelection(){
    selectedId = null;
    selTag.textContent = "ãªã—";
    stage.querySelectorAll(".item.selected").forEach(el => el.classList.remove("selected"));
  }

  function select(id){
    selectedId = id;
    stage.querySelectorAll(".item").forEach(el => {
      el.classList.toggle("selected", el.dataset.id === id);
    });
    const f = findItem(id);
    if(f){
      selTag.textContent = getTypeMeta(f.item.type).name;
    }else{
      selTag.textContent = "ãªã—";
    }
  }

  // =========================
  // Render
  // =========================
  function renderInventory(){
    invGrid.innerHTML = "";

    owned = loadOwned();
    updateCounts();

    if(owned.length === 0){
      ownedHint.style.display = "block";
      return;
    }
    ownedHint.style.display = "none";

    for(const entry of owned){
      const meta = getTypeMeta(entry.type);
      const card = document.createElement("div");
      card.className = "inv-item";
      card.dataset.type = entry.type;

      const safeName = meta.name || entry.type;
      const imgInfo = meta.img ? `<span class="tag">img</span>` : `<span class="tag">noimg</span>`;

      card.innerHTML = `
        <div class="name">${safeName}</div>
        <div class="meta">
          <span class="tag">Ã—${entry.count}</span>
          ${imgInfo}
        </div>
      `;

      card.addEventListener("click", () => {
        placeNew(entry.type);
      }, { passive:true });

      invGrid.appendChild(card);
    }
  }

  function renderStage(){
    stage.innerHTML = "";

    // zã§æç”»é †
    const items = [...home.items].sort((a,b)=> (a.z|0) - (b.z|0));

    for(const it of items){
      const meta = getTypeMeta(it.type);

      const wrap = document.createElement("div");
      wrap.className = "item";
      wrap.dataset.id = it.id;

      // transformã¯wrapå´ã§æŒã¤
      wrap.style.left = it.x + "%";
      wrap.style.top  = it.y + "%";
      wrap.style.zIndex = String(it.z);
      wrap.style.setProperty("--w", (meta.w || 96) + "px");
      wrap.style.transform = `translate(-50%,-50%) rotate(${it.rot}deg) scale(${it.scale})`;

      // img
      const img = document.createElement("img");
      img.alt = meta.name || it.type;
      if(meta.img){
        img.src = meta.img;
      }else{
        // ç”»åƒãŒç„¡ã„æ™‚ã®ãƒ€ãƒŸãƒ¼ï¼ˆé»’ã„ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        img.src = "data:image/svg+xml;utf8," + encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'>
             <rect width='96' height='96' rx='12' ry='12' fill='rgba(0,0,0,0.35)' stroke='rgba(255,255,255,0.25)'/>
             <text x='50%' y='54%' text-anchor='middle' font-family='monospace' font-size='12' fill='rgba(255,255,255,0.7)'>NO IMG</text>
           </svg>`
        );
      }

      wrap.appendChild(img);

      // é¸æŠçŠ¶æ…‹
      if(it.id === selectedId) wrap.classList.add("selected");

      // pointer
      wrap.addEventListener("pointerdown", (ev) => onPointerDown(ev, it.id), { passive:false });
      wrap.addEventListener("click", (ev) => {
        // ãƒ‰ãƒ©ãƒƒã‚°ç›´å¾Œã®clickèª¤çˆ†ã‚’é¿ã‘ãŸã„ã®ã§ã€å°ã•ãªæ¡ä»¶
        ev.stopPropagation();
        select(it.id);
      }, { passive:true });

      stage.appendChild(wrap);
    }

    updateCounts();
  }

  function placeNew(type){
    // æ‰€æŒãŒ0ã§ã‚‚ç½®ã‘ã¡ã‚ƒã†ã¨ä¸–ç•Œè¦³ãŒå´©ã‚Œã‚‹ã®ã§ã€æ‰€æŒãƒã‚§ãƒƒã‚¯ï¼ˆã‚†ã‚‹ãï¼‰
    const own = loadOwned().find(x => x.type === type);
    if(!own || (own.count|0) <= 0){
      toast("æ‰€æŒãŒè¶³ã‚Šãªã„ãŸã“â€¦");
      return;
    }

    const meta = getTypeMeta(type);
    const item = {
      id: rid(),
      type,
      x: 50,
      y: 70,
      z: nextZ(),
      rot: 0,
      scale: 1
    };
    home.items.push(item);
    saveHome();
    renderStage();
    select(item.id);
    toast(`é…ç½®ï¼š${meta.name}`);
  }

  function nextZ(){
    let z = 1;
    for(const it of home.items) z = Math.max(z, it.z|0);
    return clamp(z + 1, 1, 999);
  }

  // =========================
  // Drag
  // =========================
  function onPointerDown(ev, id){
    if(!editMode) return;

    // å³ã‚¯ãƒªãƒƒã‚¯ç­‰ç„¡è¦–
    if(ev.button != null && ev.button !== 0) return;

    ev.preventDefault();

    select(id);

    const r = stageRect();
    const f = findItem(id);
    if(!f) return;

    // ç¾åœ¨ä½ç½®ï¼ˆpxï¼‰
    const curX = percentToPx(f.item.x, r.width);
    const curY = percentToPx(f.item.y, r.height);

    drag = {
      id,
      startClientX: ev.clientX,
      startClientY: ev.clientY,
      startXpx: curX,
      startYpx: curY
    };

    // å‰é¢ã¸ï¼ˆè§¦ã£ã¦ã‚‹ã‚‚ã®ãŒåŸ‹ã‚‚ã‚Œã‚‹ã‚¹ãƒˆãƒ¬ã‚¹é˜²æ­¢ï¼‰
    f.item.z = nextZ();
    saveHome();

    renderStage();

    stage.setPointerCapture?.(ev.pointerId);
  }

  function onPointerMove(ev){
    if(!drag) return;
    ev.preventDefault();

    const r = stageRect();
    const dx = ev.clientX - drag.startClientX;
    const dy = ev.clientY - drag.startClientY;

    let xpx = drag.startXpx + dx;
    let ypx = drag.startYpx + dy;

    // ã‚¹ãƒŠãƒƒãƒ—
    if(snapOn){
      xpx = snapPx(xpx, 24);
      ypx = snapPx(ypx, 24);
    }

    xpx = clamp(xpx, 0, r.width);
    ypx = clamp(ypx, 0, r.height);

    const f = findItem(drag.id);
    if(!f) return;

    f.item.x = clamp(pxToPercent(xpx, r.width), 0, 100);
    f.item.y = clamp(pxToPercent(ypx, r.height), 0, 100);

    // è¦‹ãŸç›®ã ã‘å…ˆã«æ›´æ–°ï¼ˆä¿å­˜ã¯upã§ï¼‰
    const el = stage.querySelector(`.item[data-id="${drag.id}"]`);
    if(el){
      el.style.left = f.item.x + "%";
      el.style.top  = f.item.y + "%";
    }
  }

  function onPointerUp(ev){
    if(!drag) return;
    ev.preventDefault();
    drag = null;
    saveHome();
  }

  // =========================
  // Edit Actions
  // =========================
  function withSelected(fn){
    if(!selectedId){
      toast("å…ˆã«ã‚ªãƒ–ã‚¸ã‚§ã‚’é¸ã¶ãŸã“ã€‚");
      return;
    }
    const f = findItem(selectedId);
    if(!f){
      toast("é¸æŠãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã“â€¦");
      clearSelection();
      return;
    }
    fn(f.item);
    saveHome();
    renderStage();
    select(f.item.id);
  }

  btnRotate.addEventListener("click", () => {
    withSelected(it => { it.rot = (it.rot + 90) % 360; });
    toast("å›è»¢ã—ãŸãŸã“ã€‚");
  }, { passive:true });

  btnFront.addEventListener("click", () => {
    withSelected(it => { it.z = nextZ(); });
    toast("å‰ã¸å‡ºã—ãŸãŸã“ã€‚");
  }, { passive:true });

  btnBack.addEventListener("click", () => {
    // æœ€èƒŒé¢ã¯z=1ã«å¯„ã›ã‚‹ï¼ˆä»–ã‚‚è©°ã‚ã‚‹ï¼‰
    withSelected(it => {
      it.z = 1;
      // ä»–ã‚’1ã¤ä¸Šã’ã¦è¡çªå›é¿ï¼ˆç°¡æ˜“ï¼‰
      home.items.forEach(o => { if(o.id !== it.id) o.z = clamp((o.z|0) + 1, 1, 999); });
    });
    toast("å¾Œã‚ã¸ä¸‹ã’ãŸãŸã“ã€‚");
  }, { passive:true });

  btnDelete.addEventListener("click", () => {
    if(!selectedId){ toast("å…ˆã«é¸ã¶ãŸã“ã€‚"); return; }
    const f = findItem(selectedId);
    if(!f){ toast("è¦‹ã¤ã‹ã‚‰ãªã„ãŸã“â€¦"); clearSelection(); return; }

    const meta = getTypeMeta(f.item.type);
    home.items.splice(f.idx, 1);
    saveHome();
    renderStage();
    clearSelection();
    toast(`å‰Šé™¤ï¼š${meta.name}`);
  }, { passive:true });

  // =========================
  // Switches
  // =========================
  function applyModes(){
    setSwitch(editSwitch, editMode);
    setSwitch(gridSwitch, gridOn);
    setSwitch(snapSwitch, snapOn);

    modeTag.textContent = editMode ? "ç·¨é›†ï¼šON" : "ç·¨é›†ï¼šOFF";

    stageCard.classList.toggle("grid-on", gridOn);
  }

  editSwitch.addEventListener("click", () => {
    editMode = !editMode;
    applyModes();
    toast(editMode ? "ç·¨é›†ONï¼šå‹•ã‹ã›ã‚‹ãŸã“ã€‚" : "ç·¨é›†OFFï¼šè§¦ã£ã¦ã‚‚å‹•ã‹ãªã„ãŸã“ã€‚");
  }, { passive:true });

  gridSwitch.addEventListener("click", () => {
    gridOn = !gridOn;
    applyModes();
    toast(gridOn ? "ã‚°ãƒªãƒƒãƒ‰ON" : "ã‚°ãƒªãƒƒãƒ‰OFF");
  }, { passive:true });

  snapSwitch.addEventListener("click", () => {
    snapOn = !snapOn;
    applyModes();
    toast(snapOn ? "ã‚¹ãƒŠãƒƒãƒ—ON" : "ã‚¹ãƒŠãƒƒãƒ—OFF");
  }, { passive:true });

  // =========================
  // Export / Import
  // =========================
  function openModal(mode){
    modal.classList.add("on");
    modalText.value = "";
    modalText.focus();

    if(mode === "export"){
      modalTitle.textContent = "æ›¸ãå‡ºã—ï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ï¼‰";
      modalApply.style.display = "none";
      modalCopy.style.display  = "inline-flex";
      modalText.value = JSON.stringify({
        note:"tf_v1_myhome export",
        savedAt: new Date().toISOString(),
        data: home
      }, null, 2);
    }else{
      modalTitle.textContent = "èª­ã¿è¾¼ã¿ï¼ˆè²¼ã‚Šä»˜ã‘ã¦é©ç”¨ï¼‰";
      modalApply.style.display = "inline-flex";
      modalCopy.style.display  = "none";
      modalText.value = "";
    }
    modal.dataset.mode = mode;
  }

  function closeModal(){
    modal.classList.remove("on");
    modalText.value = "";
    modal.dataset.mode = "";
  }

  modalClose.addEventListener("click", closeModal, { passive:true });
  modal.addEventListener("click", (e) => {
    if(e.target === modal) closeModal();
  }, { passive:true });

  modalCopy.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(modalText.value);
      toast("ã‚³ãƒ”ãƒ¼ã—ãŸãŸã“ã€‚");
    }catch(_){
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé¸æŠ
      modalText.select();
      toast("é¸æŠã—ãŸãŸã“ï¼ˆæ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ã­ï¼‰ã€‚");
    }
  }, { passive:true });

  modalApply.addEventListener("click", () => {
    const raw = modalText.value.trim();
    if(!raw){ toast("ç©ºã£ã½ãŸã“ã€‚"); return; }
    try{
      const obj = JSON.parse(raw);
      const data = obj?.data || obj; // dataãƒ©ãƒƒãƒ—ã§ã‚‚ç›´ã§ã‚‚å—ã‘ã‚‹
      if(!data || !Array.isArray(data.items)){
        toast("å½¢å¼ãŒé•ã†ãŸã“â€¦");
        return;
      }
      home = {
        ver: 1,
        items: data.items.map(x => ({
          id: String(x.id || rid()),
          type: String(x.type || "koge_small"),
          x: clamp(Number(x.x ?? 50), 0, 100),
          y: clamp(Number(x.y ?? 70), 0, 100),
          z: clamp(Number(x.z ?? 1), 1, 999),
          rot: (Number(x.rot ?? 0) % 360 + 360) % 360,
          scale: clamp(Number(x.scale ?? 1), 0.5, 2)
        }))
      };
      saveHome();
      renderStage();
      clearSelection();
      closeModal();
      toast("èª­ã¿è¾¼ã¿å®Œäº†ãŸã“ã€‚");
    }catch(_){
      toast("JSONãŒå£Šã‚Œã¦ã‚‹ãŸã“â€¦");
    }
  }, { passive:true });

  btnExport.addEventListener("click", () => openModal("export"), { passive:true });
  btnImport.addEventListener("click", () => openModal("import"), { passive:true });

  btnClear.addEventListener("click", () => {
    if(!confirm("ãƒã‚¤ãƒ›ãƒ¼ãƒ ã®é…ç½®ã‚’å…¨æ¶ˆå»ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ãŸã“ï¼‰")) return;
    home.items = [];
    saveHome();
    renderStage();
    clearSelection();
    toast("å…¨æ¶ˆå»ã—ãŸãŸã“ã€‚");
  }, { passive:true });

  // =========================
  // Stage background click = clear selection
  // =========================
  stage.addEventListener("click", (ev) => {
    // ä½•ã‚‚ãªã„ã¨ã“ã‚ã‚¿ãƒƒãƒ—ã§è§£é™¤
    if(ev.target === stage) clearSelection();
  }, { passive:true });

  // =========================
  // Pointer events
  // =========================
  stage.addEventListener("pointermove", onPointerMove, { passive:false });
  stage.addEventListener("pointerup", onPointerUp, { passive:false });
  stage.addEventListener("pointercancel", onPointerUp, { passive:false });

  // =========================
  // Back
  // =========================
  backBtn.addEventListener("click", () => history.back(), { passive:true });

  // =========================
  // Boot
  // =========================
  function boot(){
    applyModes();
    renderInventory();
    renderStage();

    // ä»–ã‚¿ãƒ–ã§åˆæˆã—ãŸã‚‰åæ˜ ï¼ˆtf_v1_decoæ›´æ–°ï¼‰
    window.addEventListener("storage", (e) => {
      if(e.key === LS.deco){
        renderInventory();
        toast("æ‰€æŒã‚ªãƒ–ã‚¸ã‚§æ›´æ–°ãŸã“ã€‚");
      }
      if(e.key === LS.myhome){
        home = loadHome();
        renderStage();
        toast("é…ç½®æ›´æ–°ãŸã“ã€‚");
      }
    });
  }

  boot();

})();
</script>
</body>
</html>