<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ãŸã“ç„¼ãé‡£ã‚Šï½œTAKOFISH</title>
  <meta name="description" content="ãŸã“ç„¼ãé‡£ã‚Šã‚²ãƒ¼ãƒ ï¼ˆTAKOFISHï¼‰ã€‚æœ€é«˜å¾—ç‚¹ä¿å­˜ãƒ»çµæœæ—¥æ™‚è¡¨ç¤ºãƒ»SP-æŠ½é¸ã¤ãã€‚" />

  <style>
    :root{
      --bg0:#05060b;
      --bg1:#0c1025;
      --panel: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.14);
      --text:#fff;
      --muted: rgba(255,255,255,.75);
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --radius: 16px;
      --shadow: 0 18px 46px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 50% 20%, #1a2040 0%, #070812 60%),
        linear-gradient(var(--bg0), var(--bg1));
      min-height:100svh;
      overflow-x:hidden;
    }

    /* ===== layout: ç”»é¢å†…ã§å®Œçµï¼ˆã‚¹ãƒãƒ›ã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡ã—ã§é–‹å§‹ã§ãã‚‹ï¼‰ ===== */
    .page{
      min-height: 100svh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      backdrop-filter: blur(8px);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      max-width: 980px;
      margin: 0 auto;
    }
    .left-group{ display:flex; align-items:center; gap:10px; min-width: 0; }
    .backBtn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .titlebox{ min-width:0; }
    .title{
      font-weight: 950;
      letter-spacing:.02em;
      font-size: 18px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .right-group{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{ color:#fff; font-weight: 950; }

    .main{
      flex: 1;
      display:flex;
      align-items: stretch;
      justify-content:center;
      padding: 10px 12px 14px;
    }

    .card{
      width: min(560px, 100%);
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 0; /* é‡è¦ï¼šå†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘ãˆã‚‹ */
    }

    .hud{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      flex-wrap:wrap;
    }

    .hud-left{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ background: var(--btn2); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    .stats b{ color:#fff; }

    .stage{
      position: relative;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .canvasbox{
      position: relative;
      border: 2px solid rgba(255,255,255,.35);
      border-radius: 14px;
      overflow:hidden;
      background:#081425;
      /* ç”»é¢å†…ã§åã¾ã‚‹ã‚ˆã†ã«é«˜ã•ã‚’åˆ¶å¾¡ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘åˆ¶ï¼‰ */
      flex: 1;
      min-height: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    canvas#tfCanvas{
      width: 100%;
      height: auto;
      display:block;
      image-rendering: pixelated;
      touch-action: none; /* ã‚¹ãƒãƒ›ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¤çˆ†é˜²æ­¢ */
      user-select:none;
      -webkit-user-select:none;
    }

    .note{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.45;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* ===== overlays ===== */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.72);
      padding: 12px;
    }
    .panel{
      width: min(440px, 96%);
      max-height: 86vh;
      overflow:auto;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(10,14,24,.96);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 46px rgba(0,0,0,.7);
    }
    .panel h2{
      margin:0 0 8px;
      font-size: 15px;
      font-weight: 950;
      letter-spacing:.02em;
    }
    .panel .p{
      font-size: 12px;
      color: rgba(255,255,255,.88);
      line-height: 1.6;
      margin: 6px 0;
    }
    .panel .small{
      margin-top: 8px;
      font-size: 11px;
      color: rgba(255,255,255,.65);
      line-height: 1.55;
    }
    .panel .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.88);
    }
    .panel .grid b{ color:#fff; }
    .panel .actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    .panel .actions .btn{ flex:1; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      font-size: 12px;
      margin-bottom: 8px;
      color: rgba(255,255,255,.85);
    }
    .badge .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(0,255,255,.75);
      box-shadow: 0 0 14px rgba(0,255,255,.35);
    }

    /* ç«¯æœ«ãŒæ¥µç«¯ã«ä½ã„å ´åˆã§ã‚‚ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†èª¿æ•´ */
    @media (max-height: 740px){
      .stage{ padding: 10px; }
      .hud{ padding: 8px 10px; }
      .btn{ padding: 9px 11px; }
      .panel{ max-height: 82vh; }
    }
  </style>
</head>

<body>
<div class="page">
  <header class="topbar">
    <div class="topbar-inner">
      <div class="left-group">
        <button class="backBtn" id="backBtn" type="button" aria-label="æˆ»ã‚‹">â† æˆ»ã‚‹</button>
        <div class="titlebox">
          <div class="title">ãŸã“ç„¼ãé‡£ã‚Šï¼ˆTAKOFISHï¼‰</div>
          <div class="sub">ã‚¿ãƒƒãƒ—ã§ç³¸ã‚’è½ä¸‹ â†’ å½“ã¦ã‚‹ â†’ å·»ãä¸Šã’ã€‚å¤©æ•µã«æ³¨æ„ã€‚</div>
        </div>
      </div>

      <div class="right-group">
        <div class="pill">æœ€é«˜ï¼š<b id="bestLine">0</b></div>
        <div class="pill">SP-å…¥æ‰‹ï¼š<b id="spLine">0</b></div>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="card" aria-label="TAKOFISH">
      <div class="hud">
        <div class="hud-left">
          <button class="btn" id="btnStart" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button class="btn" id="btnRetry" type="button" disabled>ã‚‚ã†ä¸€å›</button>
        </div>
        <div class="stats" aria-label="ã‚²ãƒ¼ãƒ çŠ¶æ³">
          <span>ã‚¹ã‚³ã‚¢ï¼š<b id="tfScore">0</b></span>
          <span>æ®‹ã‚Šï¼š<b id="tfTime">--</b>s</span>
          <span>é€£ç¶šï¼š<b id="tfCombo">0</b></span>
          <span>å¤±æ•—ï¼š<b id="tfMiss">0</b></span>
        </div>
      </div>

      <div class="stage">
        <div class="canvasbox">
          <canvas id="tfCanvas" width="360" height="520"></canvas>

          <!-- ãƒ«ãƒ¼ãƒ« -->
          <div class="overlay" id="ovRules">
            <div class="panel" role="dialog" aria-modal="true" aria-label="ãƒ«ãƒ¼ãƒ«">
              <div class="badge"><span class="dot"></span> ãƒ«ãƒ¼ãƒ«</div>
              <h2>ã‚¿ãƒƒãƒ—ã—ãŸå ´æ‰€ã«ç³¸ï¼ˆãƒ”ãƒƒã‚¯ï¼‰ã‚’å‚ã‚‰ã—ã¦ã€ãŸã“ç„¼ãã«å½“ã¦ã¦é‡£ã‚Šä¸Šã’ã‚ˆã†ã€‚</h2>
              <div class="p">
                å¤©æ•µï¼ˆè¦³å…‰å®¢ãƒ»ã‚¤ã‚«ãƒ»æµã‚Œï¼‰ã«ã¶ã¤ã‹ã‚‹ã¨å¥ªã‚ã‚Œã‚‹ã€‚ç”Ÿç„¼ã‘ã¯ãƒã‚¤ãƒŠã‚¹ã€‚
              </div>

              <div class="grid">
                <div>æ¥µå°ï¼š<b>120</b></div>
                <div>æ™®é€šï¼š<b>70</b></div>
                <div>å·¨å¤§ï¼š<b>40</b></div>
              </div>

              <div class="p" style="margin-top:10px;font-weight:900;">ç¨®é¡ï¼ˆå€ç‡ / ãƒã‚¤ãƒŠã‚¹ï¼‰</div>
              <div class="p">
                ã‚½ãƒ¼ã‚¹ Ã—1.00 / ã„ã‹ã•ã¾ Ã—1.40 / ã‚´ãƒ¼ãƒ«ãƒ‰ Ã—2.80 / ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ Ã—5.50 / ç”Ÿç„¼ã‘ <b style="color:var(--bad)">-120</b>
              </div>

              <div class="p" style="margin-top:10px;font-weight:900;">æ™‚é–“</div>
              <div class="p">
                ã¾ãš<b>30ç§’</b>ã€‚30ç§’æ™‚ç‚¹ã§ã‚¹ã‚³ã‚¢ãŒ <b id="unlockTxt">600</b> ç‚¹ä»¥ä¸Šãªã‚‰<b>60ç§’</b>ã¾ã§å»¶é•·ã€‚<br>
                å»¶é•·ã§ããŸå ´åˆã€<b>45ç§’</b>ã‹ã‚‰<b style="color:rgba(0,255,255,.9)">é¬¼ãƒ¢ãƒ¼ãƒ‰</b>ï¼ˆçªå…¥æ™‚0.3ç§’åœæ­¢ãƒ»å¤©æ•µé€Ÿåº¦2.2å€ï¼‰
              </div>

              <div class="small">â€»ã“ã®ç”»é¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ï¼ˆã§ã‚‚é–‹å§‹ãƒœã‚¿ãƒ³ã¯å¿…ãšè¦‹ãˆã‚‹ä½ç½®ã«ã‚ã‚Šã¾ã™ï¼‰</div>

              <div class="actions">
                <button class="btn" id="btnRuleStart" type="button">é–‹å§‹</button>
                <button class="btn" id="btnRuleClose" type="button" style="opacity:.85;">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          </div>

          <!-- ãƒªã‚¶ãƒ«ãƒˆ -->
          <div class="overlay" id="ovResult" style="display:none;">
            <div class="panel" role="dialog" aria-modal="true" aria-label="çµæœ">
              <div class="badge"><span class="dot"></span> çµæœ</div>
              <h2 id="resTitle">çµæœ</h2>
              <div class="p" id="resMain" style="font-weight:950;font-size:18px;line-height:1.35;margin:10px 0 6px;"></div>
              <div class="p" id="resSub" style="opacity:.92;"></div>
              <div class="actions">
                <button class="btn" id="btnAgain" type="button">ã‚‚ã†ä¸€å›</button>
                <button class="btn" id="btnCloseResult" type="button" style="opacity:.85;">é–‰ã˜ã‚‹</button>
              </div>
            </div>
          </div>

        </div>

        <div class="note">
          ãƒ»ç‹™ã„ï¼šå°ã•ã„ã»ã©é«˜å¾—ç‚¹ã€‚<br>
          ãƒ»SP-æŠ½é¸ï¼šæœ€çµ‚ã‚¹ã‚³ã‚¢ãŒ <b>-500 / 1000 / 2000 / 3000</b> ã®ã¨ã <b>10%</b> ã§å…¥æ‰‹ã€‚<br>
          ãƒ»æœ€é«˜å¾—ç‚¹ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(() => {
  "use strict";

  /* =========================================================
     TAKOFISHï¼ˆtakofish.html ä¸€æœ¬åŒ–ãƒ»å®Œå…¨ç‰ˆï¼‰
     âœ… æœ€é«˜å¾—ç‚¹ã®ä¿å­˜ï¼†è¡¨ç¤º
     âœ… çµæœç”»é¢ã«ã€Œæ—¥æ™‚ã€è¡¨ç¤º
     âœ… æœ€çµ‚ã‚¹ã‚³ã‚¢ãŒ -500 / 1000 / 2000 / 3000 ã®ã¨ã 10% ã§ SP- å…¥æ‰‹
     âœ… ã‚¹ãƒãƒ›ã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡ã—ã§é–‹å§‹ã§ãã‚‹UIï¼ˆStartãƒœã‚¿ãƒ³å¸¸ã«è¦‹ãˆã‚‹ï¼‰
     âœ… å·¦ä¸Šã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
  ========================================================= */

  /* =========================
     0) localStorage keys
  ========================= */
  const LS = {
    best: "takoyakiFishing_best_points",
    last: "takoyakiFishing_last_points",
    playedAt: "takoyakiFishing_last_played",
    spCount: "takoyakiFishing_sp_count",
    spLog: "takoyakiFishing_sp_log", // JSON array (recent)
    // äº’æ›ï¼ˆã‚‚ã—åˆ¥ãƒšãƒ¼ã‚¸ã§å‚ç…§ã—ã¦ã„ã‚‹å ´åˆã®ä¿é™ºï¼‰
    fishState: "fish_v1_state",
    // å›³é‘‘ï¼ˆã‚‚ã—ä½¿ã£ã¦ã„ã‚‹å ´åˆã®ä¿é™ºï¼štf_v1_book ã« sp_fish ã‚’åŠ ç®—ï¼‰
    book: "tf_v1_book",
  };

  function readInt(key, def=0){
    const raw = localStorage.getItem(key);
    const n = Math.floor(Number(raw));
    return Number.isFinite(n) ? n : def;
  }
  function writeInt(key, n){
    localStorage.setItem(key, String(Math.floor(Number(n)||0)));
  }
  function safeJSONParse(raw, def){
    try{ return JSON.parse(raw); }catch(_){ return def; }
  }

  function fmtJPDateTime(d){
    try{
      return new Intl.DateTimeFormat("ja-JP", {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
      }).format(d);
    }catch(_){
      // fallback
      const pad = (v)=>String(v).padStart(2,"0");
      return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
  }

  function refreshTopLines(){
    const best = readInt(LS.best, 0);
    const sp = readInt(LS.spCount, 0);
    document.getElementById("bestLine").textContent = String(best);
    document.getElementById("spLine").textContent = String(sp);
  }

  function saveFishingRecord(score){
    score = Math.floor(Number(score) || 0);

    // ä»Šå›
    localStorage.setItem(LS.last, String(score));
    const playedISO = new Date().toISOString();
    localStorage.setItem(LS.playedAt, playedISO);

    // æœ€é«˜
    const best = readInt(LS.best, 0);
    const isNew = score > best;
    if (isNew) localStorage.setItem(LS.best, String(score));
    const newBest = Math.max(best, score);

    // äº’æ›ä¿å­˜ï¼ˆgateç­‰ã§å‚ç…§ã—ã¦ã„ã‚‹å ´åˆã®ä¿é™ºï¼‰
    try{
      const key = LS.fishState;
      let st = safeJSONParse(localStorage.getItem(key) || "{}", {});
      st.best = Math.max(Math.floor(Number(st.best)||0), newBest);
      st.last = score;
      st.updatedAt = Date.now();
      localStorage.setItem(key, JSON.stringify(st));
    }catch(_){}

    return { best:newBest, isNew, playedISO };
  }

  /* =========================
     1) SP- æŠ½é¸ï¼ˆæœ€çµ‚ã‚¹ã‚³ã‚¢ï¼‰
  ========================= */
  const SP_TARGETS = new Set([-500, 1000, 2000, 3000]);
  const SP_RATE = 0.10; // 10%

  function grantSPCardIfLucky(finalScore){
    if (!SP_TARGETS.has(finalScore)) return { ok:false, reason:"not_target" };

    const hit = Math.random() < SP_RATE;
    if (!hit) return { ok:false, reason:"miss" };

    const now = new Date();
    const when = now.toISOString();

    // count
    const cur = readInt(LS.spCount, 0) + 1;
    writeInt(LS.spCount, cur);

    // log (recent 30)
    const log = safeJSONParse(localStorage.getItem(LS.spLog) || "[]", []);
    log.unshift({ at: when, score: finalScore, id: "SP-FISH" });
    while (log.length > 30) log.pop();
    localStorage.setItem(LS.spLog, JSON.stringify(log));

    // å›³é‘‘ã¸åŠ ç®—ï¼ˆtf_v1_book ãŒã‚ã‚‹å ´åˆï¼‰
    try{
      let book = safeJSONParse(localStorage.getItem(LS.book) || "{}", {});
      if (!book.got) book.got = {};
      if (!book.got["sp_fish"]) book.got["sp_fish"] = { count: 0, lastAt: 0, note: "TAKOFISH SP-" };
      book.got["sp_fish"].count = (book.got["sp_fish"].count|0) + 1;
      book.got["sp_fish"].lastAt = Date.now();
      localStorage.setItem(LS.book, JSON.stringify(book));
    }catch(_){}

    // äº’æ› state
    try{
      let st = safeJSONParse(localStorage.getItem(LS.fishState) || "{}", {});
      st.sp = (st.sp|0) + 1;
      st.updatedAt = Date.now();
      localStorage.setItem(LS.fishState, JSON.stringify(st));
    }catch(_){}

    return { ok:true, score: finalScore, whenISO: when, total: cur };
  }

  /* =========================
     2) ç”»åƒURL
  ========================= */
  const CDN_BASE = "https://cdn.jsdelivr.net/gh/takoyaki-trc/takoyaki-gate@main/assets/takofish/";
  const V = "1"; // ç”»åƒå·®ã—æ›¿ãˆæ™‚ã«ä¸Šã’ã‚‹

  const IMG_URLS = {
    pick:          `${CDN_BASE}pick.png?v=${V}`,
    sauce:         `${CDN_BASE}tako_sauce.png?v=${V}`,
    ika_tako:      `${CDN_BASE}tako_ika.png?v=${V}`,
    gold:          `${CDN_BASE}tako_gold.png?v=${V}`,
    rainbow:       `${CDN_BASE}tako_rainbow.png?v=${V}`,
    raw:           `${CDN_BASE}tako_raw.png?v=${V}`,
    tourist_left:  `${CDN_BASE}tourist_left.png?v=${V}`,
    tourist_right: `${CDN_BASE}tourist_right.png?v=${V}`,
    squid:         `${CDN_BASE}ika.png?v=${V}`,
  };

  function loadImage(src){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(src));
      img.src = src;
    });
  }
  async function loadAllImages(){
    const keys = Object.keys(IMG_URLS);
    const images = {};
    const failed = [];
    for (const k of keys){
      try { images[k] = await loadImage(IMG_URLS[k]); }
      catch(e){ failed.push({ key:k, url:String(e.message || e) }); }
    }
    return { images, failed };
  }

  /* =========================
     3) ã‚²ãƒ¼ãƒ å®šæ•°ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰æº–æ‹ ï¼‰
  ========================= */
  const CFG = {
    W: 360,
    H: 520,

    BASE_LIMIT: 30,
    EXT_LIMIT: 60,
    EXT_SCORE: 600,
    ONI_AT: 45,
    ONI_FREEZE_MS: 300,
    ONI_SPEED_MUL: 2.2,

    HOOK_DROP: 680,
    HOOK_REEL: 260,
    HOOK_HIT_R: 10,
    TOP_Y: 18,
    FLOOR_Y_RATIO: 0.86,

    PICK_DRAW: 24,

    ITEM_COUNT: 7,
    ITEM_BASE_SPEED: 45,
    ITEM_MAX_SPEED: 130,
    ITEM_ACCEL: 240,

    GIANT_DROP_CHANCE: 0.18,
    GIANT_DROP_START_Y_RATIO: 0.62,

    SIZE: {
      tiny:   { label: "æ¥µå°",  draw: 24, base: 120 },
      normal: { label: "æ™®é€š",  draw: 40, base: 70  },
      giant:  { label: "å·¨å¤§",  draw: 56, base: 40  },
    },
    SIZE_WEIGHTS: [
      { key: "normal", w: 62 },
      { key: "tiny",   w: 28 },
      { key: "giant",  w: 10 },
    ],

    TYPE: {
      sauce:   { label: "ã‚½ãƒ¼ã‚¹",     mult: 1.00, kind: "plus",  imgKey: "sauce" },
      ika:     { label: "ã„ã‹ã•ã¾",   mult: 1.40, kind: "plus",  imgKey: "ika_tako" },
      gold:    { label: "ã‚´ãƒ¼ãƒ«ãƒ‰",   mult: 2.80, kind: "plus",  imgKey: "gold" },
      rainbow: { label: "ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼", mult: 5.50, kind: "plus",  imgKey: "rainbow" },
      raw:     { label: "ç”Ÿç„¼ã‘",     mult: 0.00, kind: "minus", imgKey: "raw", penalty: -120 },
    },
    TYPE_WEIGHTS: [
      { key: "sauce",   w: 55 },
      { key: "ika",     w: 20 },
      { key: "gold",    w: 10 },
      { key: "rainbow", w:  5 },
      { key: "raw",     w: 10 },
    ],

    ENEMY_CENTER_Y_RATIO: 0.45,
    ENEMY_GAP: 170,

    TOURIST: { w: 34, h: 18, speed: 90 },
    SQUID: { w: 58, h: 58, speed: 18, ampX: 10, ampY: 16, freq: 0.55 },

    DASH: {
      yBias: -12,
      w: 54,
      h: 10,
      speed: 950,
      minS: 10,
      maxS: 15,
      oniMinS: 4,
      oniMaxS: 7,
      trail: 4,
    },

    MARGIN_X: 10,
  };

  document.getElementById("unlockTxt").textContent = String(CFG.EXT_SCORE);

  /* =========================
     4) ãƒ©ãƒ³ã‚¯å®šç¾©ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰æº–æ‹ ï¼‰
  ========================= */
  const RANKS_MINUS = [
    { min: -1000, max: -1000, name: "ã€˜æœªæŠ•å…¥ã€™", line: "é‰„æ¿ã«ã€ç½®ã‹ã‚Œã¦ã„ãªã„ã€‚" },
    { min: -999,  max: -900,  name: "ã€˜ç„¼ã‹ã‚Œã¦ã„ãªã„å­˜åœ¨ã€™", line: "ã¾ã ã€å§‹ã¾ã£ã¦ã™ã‚‰ã„ãªã„ã€‚" },
    { min: -899,  max: -800,  name: "ã€˜ç”Ÿç„¼ã‘ä¿¡è€…ï¼ˆæœ«æœŸï¼‰ã€™", line: "ã“ã‚Œã¯â€œé€šâ€ã®å‘³ã€‚" },
    { min: -799,  max: -700,  name: "ã€˜å›åä¿‚ã«é¡”ã‚’è¦šãˆã‚‰ã‚ŒãŸã€™", line: "ã¾ãŸæ¥ãŸã‚“ã§ã™ã­ã€‚" },
    { min: -699,  max: -600,  name: "ã€˜ã‚½ãƒ¼ã‚¹æœªè£…å‚™ã€™", line: "æ­¦å™¨ã‚’å¿˜ã‚Œã¦ããŸã€‚" },
    { min: -599,  max: -500,  name: "ã€˜ç„¼ãå°ã«è¬ã£ã¦ã‚‹äººã€™", line: "é•ã†ã€ãã†ã˜ã‚ƒãªã„ã€‚" },
    { min: -499,  max: -400,  name: "ã€˜ç²‰ã«æˆ»ã£ãŸäººã€™", line: "æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã›ã‚‹ã¨æ€ã£ãŸï¼Ÿ" },
    { min: -399,  max: -300,  name: "ã€˜é‰„æ¿ã®å¤–å´ã€™", line: "ãã“ã€ç„¼ã‘ãªã„ã€‚" },
    { min: -299,  max: -200,  name: "ã€˜å›åå¯¾è±¡ï¼ˆä»®ï¼‰ã€™", line: "ã¾ã è¿”ã›ã‚‹ã¨æ€ã£ã¦ã„ã‚‹ã€‚" },
    { min: -199,  max: -100,  name: "ã€˜ç”Ÿç„¼ã‘è‚¯å®šæ´¾ã€™", line: "ã“ã‚Œã¯ã“ã‚Œã§ã€ã£ã¦è¨€ã„å§‹ã‚ãŸã€‚" },
    { min: -99,   max: -1,    name: "ã€˜ã²ã£ãã‚Šè¿”ã—å¿˜ã‚Œã€™", line: "ã‚ã£ã€ã£ã¦è¨€ã£ãŸã€‚" },
  ];
  const RANKS_PLUS = [
    { min: 0,    max: 149,  name: "ã€˜ç²‰ã®å¦–ç²¾ï¼ˆæœªç„¼æˆï¼‰ã€™", line: "ã¾ã ä¸¸ãã™ã‚‰ãªã„ã€‚äººç”Ÿã‚‚ã€‚" },
    { min: 150,  max: 299,  name: "ã€˜ã‚½ãƒ¼ã‚¹ã®ç´ æŒ¯ã‚Šãƒãƒ³ã€™", line: "ã‹ã‘ã¦ãªã„ã®ã«ã€æ°—æŒã¡ã ã‘æ¿ƒã„ã€‚" },
    { min: 300,  max: 449,  name: "ã€˜é’ã®ã‚Šæ•£ã‚‰ã—è·äººï¼ˆé¢¨ï¼‰ã€™", line: "è·äººâ€œé¢¨â€ã£ã¦è¨€ã£ãŸï¼Ÿè¨€ã£ãŸã­ï¼Ÿ" },
    { min: 450,  max: 599,  name: "ã€˜ç¥­å£‡ã®å‰ã§æ·±å‘¼å¸ã™ã‚‹äººã€™", line: "æ‰‰ã®å‰ã§å‘¼å¸ã™ã‚‹ãªã€‚ç„¼ã‘ã‚‹ã€‚" },
    { min: 600,  max: 699,  name: "ã€˜å»¶é•·ã®æ°‘ï¼ˆå¸°ã‚Œãªã„ï¼‰ã€™", line: "å¸°ã‚ã†ã¨æ€ã£ãŸç¬é–“ã€å»¶é•·ãŒå§‹ã¾ã‚‹ã€‚" },
    { min: 700,  max: 799,  name: "ã€˜æ½®ç›®ã®èª­ã¿é–“é•ã„ç‹ã€™", line: "èª­ã‚€ãªã€‚æ„Ÿã˜ã‚ã€‚ã ã„ãŸã„å¤–ã‚Œã‚‹ã€‚" },
    { min: 800,  max: 899,  name: "ã€˜é¬¼ãƒ¢ãƒ¼ãƒ‰äºˆå‚™è»ï¼ˆå±é™ºç‰©ï¼‰ã€™", line: "è¿‘ã¥ããªã€‚ç†±ã•ã«æ…£ã‚ŒãŸç›®ã‚’ã—ã¦ã‚‹ã€‚" },
    { min: 900,  max: 999,  name: "ã€˜å›åã•ã‚ŒãŒã¡ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã€™", line: "å–ã£ãŸã¨æ€ã£ãŸã‚‰ã€å–ã‚‰ã‚Œã¦ã‚‹ã€‚äººç”Ÿã€‚" },
    { min: 1000, max: 1149, name: "ã€˜ç„¼ãå°ã®åå¾©æ¨ªè·³ã³ã€™", line: "è¶³ãŒé€Ÿã„ã®ã«ã€ç›®çš„ãŒåˆ†ã‹ã‚‰ãªã„ã€‚" },
    { min: 1150, max: 1299, name: "ã€˜æ·±æµ·å¸‚å ´ã®å¸¸é€£ï¼ˆè²¡å¸ƒãŒä¸ç©ï¼‰ã€™", line: "è²·ã†ãªã€‚å›åã•ã‚Œã‚‹ã€‚ãªãœæ¥ãŸã€‚" },
    { min: 1300, max: 1449, name: "ã€˜å›³é‘‘ã‚’é–‹ãæ‰‹ãŒéœ‡ãˆã‚‹äººã€™", line: "ãƒšãƒ¼ã‚¸ã‚ãã‚‹ã¨ã€ãŸã“ç„¼ãå¢—ãˆã‚‹ã¨æ€ã£ã¦ã‚‹ï¼Ÿ" },
    { min: 1450, max: 1599, name: "ã€˜æ—…è·¯ã®è¨¼ã£ã½ã„ã‚‚ã®ä¿æŒè€…ã€™", line: "â€œã£ã½ã„ã‚‚ã®â€ã£ã¦è¨€ã£ãŸã‚‰å…¨éƒ¨è»½ããªã‚‹ã€‚" },
    { min: 1600, max: 1749, name: "ã€˜æµã‚Œã¨æ¡æ‰‹ã—ãŸäººã€™", line: "æ¡æ‰‹ã—ãŸæ‰‹ãŒã€ã‚‚ã†æˆ»ã£ã¦ã“ãªã„ã€‚" },
    { min: 1750, max: 1899, name: "ã€˜è¦³æ¸¬è€…ï¼ˆç¾å ´çŒ«ï¼‰ã€™", line: "ãƒ¨ã‚·ï¼ã£ã¦è¨€ã£ãŸç¬é–“ã€å…¨éƒ¨æŒã£ã¦ã‹ã‚ŒãŸã€‚" },
    { min: 1900, max: 1999, name: "ã€˜é»’æ½®ã¨åŒæ£²ä¸­ã€™", line: "å®¶è³ƒï¼Ÿæ‰•ã£ã¦ã‚‹ã®ã¯ãƒ¡ãƒ³ã‚¿ãƒ«ã€‚" },
    { min: 2000, max: 2199, name: "ã€˜ä»•æ§˜ã®å¤–ã§ç”Ÿãã¦ã‚‹äººã€™", line: "èª¬æ˜æ›¸ãŒé€ƒã’ãŸã€‚æˆ»ã£ã¦ã“ãªã„ã€‚" },
    { min: 2200, max: 2399, name: "ã€˜ç„¼ã‹ã‚ŒãŸä¼èª¬ï¼ˆèƒƒã‚‚ãŸã‚Œä»˜ãï¼‰ã€™", line: "ä¼èª¬ã¯é‡ã„ã€‚èƒƒã‚‚é‡ã„ã€‚" },
    { min: 2400, max: 2499, name: "ã€˜ç¦æ–­ã®å›åå…è¨±çš†ä¼ã€™", line: "å…è¨±ï¼Ÿè¿”ç´ã—ã‚ã€‚å±ãªã„ã€‚" },
    { min: 2500, max: 2699, name: "ã€˜è¦³æ¸¬ä¸èƒ½ï¼ˆæœ¬äººã‚‚ä¸æ˜ï¼‰ã€™", line: "ã‚ãªãŸèª°ï¼Ÿã“ã£ã¡ãŒèããŸã„ã€‚" },
    { min: 2700, max: 2899, name: "ã€˜ç¥­å£‡ãŒå…ˆã«ãŠè¾å„€ã—ãŸäººã€™", line: "å‰ã„ã®ã¯ã‚ãªãŸã˜ã‚ƒãªã„ã€‚ç¥­å£‡ã ã€‚" },
    { min: 2900, max: 2999, name: "ã€˜ä¸–ç•Œã®å¤–å´ã§ãŸã“ç„¼ãæ•°ãˆã¦ã‚‹äººã€™", line: "æ•°ãˆã‚‹ãªã€‚æˆ»ã‚Œãªããªã‚‹ã€‚" },

    { min: 3001, max: 3299, name: "ã€˜ä¸Šé™çªç ´ï¼šåºç« ã€™", line: "ã“ã“ã‹ã‚‰å…ˆã¯ã€èª¬æ˜æ›¸ãŒç‡ƒãˆã‚‹ã€‚" },
    { min: 3300, max: 3599, name: "ã€˜å›åç„¡åŠ¹åŒ–ã€™", line: "å¥ªã‚ã‚Œãªã„ã€‚å¥ªã‚ã›ãªã„ã€‚" },
    { min: 3600, max: 3999, name: "ã€˜é¬¼ã®æ‰‹å…ƒã€™", line: "æŒ‡å…ˆãŒç†±ã‚’è¦šãˆã¦ã„ã‚‹ã€‚" },
    { min: 4000, max: 4499, name: "ã€˜é‰„æ¿ã¨åŒèª¿ã€™", line: "æºã‚ŒãŒèª­ã‚ã‚‹ã€‚ä¸–ç•ŒãŒé…ã„ã€‚" },
    { min: 4500, max: 4999, name: "ã€˜æ½®ç›®æ”¯é…ã€™", line: "æµã‚Œã‚’é¿ã‘ã‚‹ã‚“ã˜ã‚ƒãªã„ã€‚ä½¿ã†ã€‚" },

    { min: 5000, max: 5499, name: "ã€˜ç„¼æˆç®¡ç†è€…ã€™", line: "ç«åŠ æ¸›ã§ã¯ãªãã€é‹å‘½ã‚’å›ã—ã¦ã„ã‚‹ã€‚" },
    { min: 5500, max: 5999, name: "ã€˜ç¥é€Ÿã®è¿”ã—ã€™", line: "æ‹¾ã†å‰ã«ã€ã‚‚ã†æ¬¡ã‚’å–ã£ã¦ã„ã‚‹ã€‚" },
    { min: 6000, max: 6499, name: "ã€˜å›åã®å¤–å´ã€™", line: "è¦³å…‰å®¢ãŒæ­¢ã¾ã£ã¦è¦‹ãˆã‚‹ã€‚" },
    { min: 6500, max: 6999, name: "ã€˜æ·±æµ·ã®é‡£ç¥ã€™", line: "æµ·ãŒé™ã‹ã«é“ã‚’ç©ºã‘ã‚‹ã€‚" },
    { min: 7000, max: 7499, name: "ã€˜ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼çµ±åˆ¶ã€™", line: "è‰²ãŒæ¥ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆ†ã‹ã‚‹ã€‚" },

    { min: 7500, max: 7999, name: "ã€˜é¬¼ãƒ¢ãƒ¼ãƒ‰å¸¸é§ã€™", line: "ã‚‚ã†æˆ»ã‚Œãªã„ã€‚æˆ»ã‚‹å¿…è¦ã‚‚ãªã„ã€‚" },
    { min: 8000, max: 8499, name: "ã€˜ç„¼ã‹ã‚ŒãŸä¼èª¬ï¼šçœŸã€™", line: "ä¼èª¬ã¯â€œçµæœâ€ã§ã¯ãªãâ€œæ“ä½œâ€ã ã£ãŸã€‚" },
    { min: 8500, max: 8999, name: "ã€˜é‰„æ¿ã®ç‹ã€™", line: "ç«å‚·ã—ãªã„ã€‚ç«å‚·ãŒé€ƒã’ã‚‹ã€‚" },
    { min: 9000, max: 9499, name: "ã€˜ä¸–ç•Œç·šå›ºå®šã€™", line: "æºã‚ŒãŒæ¶ˆãˆã‚‹ã€‚æ®‹ã‚‹ã®ã¯ç²¾åº¦ã€‚" },
    { min: 9500, max: 9999, name: "ã€˜é‡£ã‚Šå°ã®ç¥ã€™", line: "ã‚ãªãŸãŒå‹•ãå‰ã«ã€ãŸã“ç„¼ããŒå¯„ã‚‹ã€‚" },

    { min: 10000, max: 999999, name: "ã€˜é‹å–¶å´ã€™", line: "â€¦â€¦ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚" },
  ];
  const SCORE_3000_LINE = "ãã‚Œã§ã‚‚ã€ãŸã“ç„¼ãã¯æ®‹ã‚‰ãªã‹ã£ãŸã€‚";

  function getRank(score){
    if (score === 3000) return null;
    const list = (score < 0) ? RANKS_MINUS : RANKS_PLUS;
    if (score < list[0].min) return list[0];
    if (score > list[list.length - 1].max) return list[list.length - 1];
    for (const r of list){
      if (score >= r.min && score <= r.max) return r;
    }
    return list[list.length - 1];
  }

  /* =========================
     5) Helpers
  ========================= */
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function pickByWeight(list){
    let sum = 0;
    for (const it of list) sum += it.w;
    let r = Math.random() * sum;
    for (const it of list){
      r -= it.w;
      if (r <= 0) return it.key;
    }
    return list[list.length-1].key;
  }
  function circleHit(ax,ay,ar,bx,by,br){
    const dx=ax-bx, dy=ay-by;
    return (dx*dx+dy*dy) <= (ar+br)*(ar+br);
  }
  function circleRectHit(cx, cy, cr, rx, ry, rw, rh){
    const nx = clamp(cx, rx, rx + rw);
    const ny = clamp(cy, ry, ry + rh);
    const dx = cx - nx;
    const dy = cy - ny;
    return (dx*dx + dy*dy) <= cr*cr;
  }
  function nowMs(){ return performance.now(); }

  function buildTakoyakiSpec(){
    const sizeKey = pickByWeight(CFG.SIZE_WEIGHTS);
    const typeKey = pickByWeight(CFG.TYPE_WEIGHTS);
    const size = CFG.SIZE[sizeKey];
    const type = CFG.TYPE[typeKey];

    let points = 0;
    if (type.kind === "minus") points = type.penalty;
    else points = Math.round(size.base * type.mult);

    return { sizeKey, size, type, points };
  }

  function pointerToCanvasX(e, cvs){
    const rect = cvs.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (CFG.W / rect.width);
    return clamp(x, CFG.MARGIN_X, CFG.W - CFG.MARGIN_X);
  }

  /* =========================
     6) UI elements
  ========================= */
  const backBtn = document.getElementById("backBtn");
  const btnStart = document.getElementById("btnStart");
  const btnRetry = document.getElementById("btnRetry");

  const ovRules = document.getElementById("ovRules");
  const btnRuleStart = document.getElementById("btnRuleStart");
  const btnRuleClose = document.getElementById("btnRuleClose");

  const ovResult = document.getElementById("ovResult");
  const resTitle = document.getElementById("resTitle");
  const resMain  = document.getElementById("resMain");
  const resSub   = document.getElementById("resSub");
  const btnAgain = document.getElementById("btnAgain");
  const btnCloseResult = document.getElementById("btnCloseResult");

  const scoreEl = document.getElementById("tfScore");
  const timeEl  = document.getElementById("tfTime");
  const comboEl = document.getElementById("tfCombo");
  const missEl  = document.getElementById("tfMiss");

  const cvs = document.getElementById("tfCanvas");
  const ctx = cvs.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  backBtn.addEventListener("click", () => {
    // æˆ»ã‚Šå…ˆãŒç„¡ã„å ´åˆã¯ãƒˆãƒƒãƒ—ã¸é€ƒãŒã™ï¼ˆå¿…è¦ãªã‚‰URLå·®ã—æ›¿ãˆã¦OKï¼‰
    if (history.length > 1) history.back();
    else location.href = "./";
  });

  /* =========================
     7) Game state
  ========================= */
  let IMGS = null;

  let rafId = null;
  let timerId = null;
  let onPointer = null;

  let STATE = null;

  function stopGame(){
    if (timerId) clearInterval(timerId);
    timerId = null;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    if (onPointer){
      cvs.removeEventListener("pointerdown", onPointer);
      onPointer = null;
    }
    STATE = null;

    btnRetry.disabled = true;
  }

  function setButtonsIdle(){
    btnStart.disabled = false;
    btnRetry.disabled = true;
  }

  function setButtonsPlaying(){
    btnStart.disabled = true;
    btnRetry.disabled = false;
  }

  function showRules(){
    ovRules.style.display = "flex";
  }
  function hideRules(){
    ovRules.style.display = "none";
  }

  function showResultOverlay(){
    ovResult.style.display = "flex";
  }
  function hideResultOverlay(){
    ovResult.style.display = "none";
  }

  function flashText(msg, ms){
    if (!STATE) return;
    STATE.flashMsg = msg;
    STATE.flashUntil = nowMs() + ms;
  }

  function drawImageCentered(img, x, y, size){
    ctx.drawImage(img, Math.round(x - size/2), Math.round(y - size/2), size, size);
  }

  function drawBackground(now){
    const W = CFG.W, H = CFG.H;
    const FLOOR_Y = Math.floor(H * CFG.FLOOR_Y_RATIO);
    const isOni = STATE.oni;

    ctx.fillStyle = isOni ? "#060819" : "#081425";
    ctx.fillRect(0, 0, W, H);

    const t = now / 1000;
    const band1 = Math.floor(40 + 12 * Math.sin(t * 0.6));
    const band2 = Math.floor(70 + 18 * Math.cos(t * 0.42));
    ctx.fillStyle = isOni ? "rgba(120,70,170,0.07)" : "rgba(60,130,220,0.07)";
    ctx.fillRect(0, 0, W, band1);
    ctx.fillRect(0, band1 + 50, W, band2);

    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fillRect(0, FLOOR_Y, W, H - FLOOR_Y);
    ctx.fillStyle = "rgba(255,255,255,0.05)";
    ctx.fillRect(0, FLOOR_Y - 6, W, 6);

    if (isOni){
      ctx.fillStyle = "rgba(0,255,255,0.04)";
      ctx.fillRect(0,0,W,H);
    }
  }

  function drawItems(){
    for (const it of STATE.items){
      if (!it.alive) continue;
      const img = IMGS[it.spec.type.imgKey];
      drawImageCentered(img, it.x, it.y, it.spec.size.draw);
    }
  }

  function drawTourist(){
    const t = STATE.tourist;
    const img = (t.dir > 0) ? IMGS.tourist_right : IMGS.tourist_left;
    const size = 44;
    drawImageCentered(img, t.x + t.w/2, t.y, size);
  }

  function drawSquid(){
    const s = STATE.squid;
    const img = IMGS.squid;
    const cx = s.x + s.w/2;
    const cy = s.y;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(s.dir, 1);
    ctx.drawImage(img, Math.round(-s.w/2), Math.round(-s.h/2), s.w, s.h);
    ctx.restore();
  }

  function drawDash(now){
    const d = STATE.dash;
    if (!d.active) return;

    const trail = STATE.dashTrail;
    trail.unshift({ x: d.x, t: now });
    if (trail.length > CFG.DASH.trail) trail.pop();

    for (let i=trail.length-1; i>=0; i--){
      const a = (i+1) / (trail.length+1);
      const alpha = 0.12 + 0.22 * (1 - a);
      const wid = d.w + i * 14;
      const hi  = d.h + i * 2;

      const x = trail[i].x - i * 10;
      const y = d.y;

      ctx.fillStyle = `rgba(0, 220, 255, ${alpha})`;
      ctx.fillRect(Math.round(x), Math.round(y - hi/2), wid, hi);
    }

    ctx.fillStyle = "rgba(210, 255, 255, 0.35)";
    ctx.fillRect(Math.round(d.x), Math.round(d.y - d.h/2), d.w, d.h);

    ctx.fillStyle = "rgba(0, 255, 255, 0.35)";
    ctx.fillRect(Math.round(d.x + d.w - 6), Math.round(d.y - d.h/2), 6, d.h);
  }

  function drawHook(){
    const h = STATE.hook;

    ctx.strokeStyle = "rgba(255,255,255,.22)";
    ctx.beginPath();
    ctx.moveTo(h.x, CFG.TOP_Y);
    ctx.lineTo(h.x, h.y);
    ctx.stroke();

    drawImageCentered(IMGS.pick, h.x, h.y, CFG.PICK_DRAW);

    if (h.hasCatch && h.caught){
      const s = h.caught.size.draw;
      const ty = h.y + (CFG.PICK_DRAW/2) + (s/2) - 2;
      const img = IMGS[h.caught.type.imgKey];
      drawImageCentered(img, h.x, ty, s);
    }
  }

  function remaining(){
    return Math.max(0, STATE.limit - STATE.elapsed);
  }

  function drawHUD(now){
    const W = CFG.W, H = CFG.H;

    ctx.fillStyle = "#fff";
    ctx.font = "13px system-ui";

    const h = STATE.hook;
    if (h.phase === "idle") ctx.fillText("ã‚¿ãƒƒãƒ—ï¼šå¥½ããªä½ç½®ã«ç³¸ã‚’å‚ã‚‰ã™", 10, 18);
    else if (h.phase === "drop") ctx.fillText("è½ä¸‹ä¸­â€¦å½“ã¦ã‚ï¼", 10, 18);
    else ctx.fillText("å·»ãä¸Šã’ä¸­ï¼å¤©æ•µã«æ³¨æ„ï¼", 10, 18);

    if (STATE.extended){
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.font = "12px system-ui";
      ctx.fillText("å»¶é•·ä¸­", 10, 36);
    }
    if (STATE.oni){
      ctx.fillStyle = "rgba(0,255,255,.85)";
      ctx.font = "12px system-ui";
      ctx.fillText("é¬¼ãƒ¢ãƒ¼ãƒ‰", 60, 36);
    }

    if (now < STATE.flashUntil && STATE.flashMsg){
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0, 44, W, 26);
      ctx.fillStyle = "#fff";
      ctx.font = "13px system-ui";
      ctx.fillText(STATE.flashMsg, 12, 62);
    }

    if (STATE.freezeUntil && now < STATE.freezeUntil){
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "rgba(0,255,255,.9)";
      ctx.font = "18px system-ui";
      ctx.fillText("é¬¼ãƒ¢ãƒ¼ãƒ‰çªå…¥", 110, 230);
    }

    if (remaining() <= 0){
      ctx.fillStyle = "rgba(0,0,0,.65)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#fff";
      ctx.font = "22px system-ui";
      ctx.fillText("TIME UP!", 120, 230);
    }
  }

  function render(now){
    drawBackground(now);
    drawTourist();
    drawSquid();
    drawDash(now);

    if (!STATE.hook.hasCatch) drawItems();
    drawHook();
    drawHUD(now);
  }

  function resetCanvasMessage(msg){
    ctx.imageSmoothingEnabled = false;
    ctx.fillStyle = "#081425";
    ctx.fillRect(0,0,CFG.W,CFG.H);
    ctx.fillStyle = "#fff";
    ctx.font = "16px system-ui";
    ctx.fillText(msg, 90, 260);
  }

  /* =========================
     8) Result UIï¼ˆæœ€é«˜ + æ—¥æ™‚ + SPæŠ½é¸ï¼‰
  ========================= */
  function showResult(score, extended, oniReached){
    const rec = saveFishingRecord(score);
    const best = rec.best;
    const isNew = rec.isNew;

    // SPæŠ½é¸ï¼ˆæœ€çµ‚ã‚¹ã‚³ã‚¢ï¼‰
    const sp = grantSPCardIfLucky(score);

    refreshTopLines();

    const playedAt = new Date(rec.playedISO);
    const playedJP = fmtJPDateTime(playedAt);

    resTitle.textContent = isNew ? "çµæœï¼ˆNEW RECORD!ï¼‰" : "çµæœ";

    // 3000ç‚¹ã¡ã‚‡ã†ã©ï¼šä¸€æ–‡ã®ã¿ï¼ˆå…ƒä»•æ§˜ï¼‰
    if (score === 3000){
      resMain.textContent = SCORE_3000_LINE;
      const spLine = (sp.ok)
        ? `<div style="margin-top:8px;color:rgba(0,255,255,.95);font-weight:950;">ğŸ‰ SP-å…¥æ‰‹ï¼ï¼ˆåˆè¨ˆ ${sp.total}ï¼‰</div>`
        : (SP_TARGETS.has(score) ? `<div style="margin-top:8px;opacity:.85;">SP-æŠ½é¸ï¼šä»Šå›ã¯ãƒã‚ºãƒ¬</div>` : "");
      resSub.innerHTML = `
        <div>æ—¥æ™‚ï¼š<b>${playedJP}</b></div>
        <div>Scoreï¼š<b>${score}</b></div>
        <div>Bestï¼š<b>${best}</b>${isNew ? "ï¼ˆæ›´æ–°ï¼‰" : ""}</div>
        ${spLine}
      `;
      showResultOverlay();
      return;
    }

    const r = getRank(score);
    resMain.textContent = `ï¼» ${r.name} ï¼½`;

    const lines = [];
    lines.push(`<div style="opacity:.95">${r.line}</div>`);
    lines.push(`<div>æ—¥æ™‚ï¼š<b>${playedJP}</b></div>`);
    lines.push(`<div>Scoreï¼š<b>${score}</b></div>`);
    lines.push(`<div>Bestï¼š<b>${best}</b>${isNew ? "ï¼ˆæ›´æ–°ï¼‰" : ""}</div>`);
    lines.push(`<div>${extended ? "å»¶é•·ï¼šã‚ã‚Šï¼ˆ60ç§’ï¼‰" : "å»¶é•·ï¼šãªã—ï¼ˆ30ç§’ï¼‰"}</div>`);
    if (extended) lines.push(`<div>${oniReached ? "é¬¼ãƒ¢ãƒ¼ãƒ‰ï¼šåˆ°é”" : "é¬¼ãƒ¢ãƒ¼ãƒ‰ï¼šæœªåˆ°é”"}</div>`);

    if (SP_TARGETS.has(score)){
      if (sp.ok){
        lines.push(`<div style="margin-top:6px;color:rgba(0,255,255,.95);font-weight:950;">ğŸ‰ SP-å…¥æ‰‹ï¼ï¼ˆåˆè¨ˆ ${sp.total}ï¼‰</div>`);
      }else{
        lines.push(`<div style="margin-top:6px;opacity:.85;">SP-æŠ½é¸ï¼šä»Šå›ã¯ãƒã‚ºãƒ¬ï¼ˆ10%ï¼‰</div>`);
      }
    }

    resSub.innerHTML = lines.join("");
    showResultOverlay();
  }

  /* =========================
     9) Start / Game loopï¼ˆå…ƒãƒ­ã‚¸ãƒƒã‚¯æº–æ‹ ï¼‰
  ========================= */
  function startGame(){
    if (!IMGS){
      resetCanvasMessage("ç”»åƒãŒæœªãƒ­ãƒ¼ãƒ‰ã§ã™â€¦");
      return;
    }

    hideResultOverlay();
    hideRules();
    setButtonsPlaying();

    const W = CFG.W, H = CFG.H;
    const FLOOR_Y = Math.floor(H * CFG.FLOOR_Y_RATIO);
    const GIANT_DROP_START_Y = Math.floor(H * CFG.GIANT_DROP_START_Y_RATIO);

    const ENEMY_CENTER_Y = Math.floor(H * CFG.ENEMY_CENTER_Y_RATIO);
    const TOURIST_Y = ENEMY_CENTER_Y - Math.floor(CFG.ENEMY_GAP * 0.55);
    const SQUID_Y   = ENEMY_CENTER_Y + Math.floor(CFG.ENEMY_GAP * 0.55);

    STATE = {
      elapsed: 0,
      limit: CFG.BASE_LIMIT,
      extended: false,
      oni: false,
      oniReached: false,
      freezeUntil: 0,

      score: 0,
      combo: 0,
      miss: 0,

      flashMsg: "",
      flashUntil: 0,

      items: [],
      hook: null,
      tourist: null,
      squid: null,
      dash: null,

      dashTrail: [],
      ended: false,
    };

    // UI reset
    scoreEl.textContent = "0";
    comboEl.textContent = "0";
    missEl.textContent  = "0";
    timeEl.textContent  = String(CFG.BASE_LIMIT);

    for (let i=0; i<CFG.ITEM_COUNT; i++){
      const spec = buildTakoyakiSpec();
      const baseY = (FLOOR_Y - 14) + rand(-2, 2);
      STATE.items.push({
        x: rand(W*0.15, W*0.85),
        baseY,
        y: baseY,
        alive: true,
        spec,
        vx: (Math.random()<0.5?-1:1) * (CFG.ITEM_BASE_SPEED + rand(0,22)),
        vxTarget: (Math.random()<0.5?-1:1) * (CFG.ITEM_BASE_SPEED + rand(0,50)),
        bobAmp: rand(0.6,2.4),
        bobSpd: rand(3.0,7.8),
        bobPhase: rand(0, Math.PI*2),
        nextMind: nowMs() + rand(450,1100),
        pauseUntil: 0,
      });
    }

    function resetItem(it){
      it.spec = buildTakoyakiSpec();
      const baseY = (FLOOR_Y - 14) + rand(-2,2);
      it.x = rand(W*0.15, W*0.85);
      it.baseY = baseY;
      it.y = baseY;
      it.alive = true;
      it.vx = (Math.random()<0.5?-1:1) * (CFG.ITEM_BASE_SPEED + rand(0,22));
      it.vxTarget = (Math.random()<0.5?-1:1) * (CFG.ITEM_BASE_SPEED + rand(0,50));
      it.bobAmp = rand(0.6,2.4);
      it.bobSpd = rand(3.0,7.8);
      it.bobPhase = rand(0,Math.PI*2);
      it.nextMind = nowMs() + rand(450,1100);
      it.pauseUntil = 0;
    }

    STATE.hook = {
      x: W*0.5,
      y: CFG.TOP_Y,
      phase: "idle",
      hitR: CFG.HOOK_HIT_R,
      hasCatch: false,
      caught: null,
      giantDropArmed: false,
      giantDropRolled: false,
      giantWillDrop: false,
    };

    function setHookIdle(){
      const h = STATE.hook;
      h.phase = "idle";
      h.y = CFG.TOP_Y;
      h.hasCatch = false;
      h.caught = null;
      h.giantDropArmed = false;
      h.giantDropRolled = false;
      h.giantWillDrop = false;
    }

    STATE.tourist = {
      x: 0,
      y: TOURIST_Y,
      w: CFG.TOURIST.w,
      h: CFG.TOURIST.h,
      dir: 1,
      speed: CFG.TOURIST.speed,
    };

    STATE.squid = {
      baseX: W - CFG.SQUID.w,
      baseY: SQUID_Y,
      x: W - CFG.SQUID.w,
      y: SQUID_Y,
      w: CFG.SQUID.w,
      h: CFG.SQUID.h,
      dir: -1,
      speed: CFG.SQUID.speed,
      ampX: CFG.SQUID.ampX,
      ampY: CFG.SQUID.ampY,
      freq: CFG.SQUID.freq,
      phase: Math.random()*Math.PI*2,
    };

    const dashY = Math.floor((TOURIST_Y + SQUID_Y) * 0.5) + CFG.DASH.yBias;
    STATE.dash = {
      active: false,
      x: W + 60,
      y: dashY,
      w: CFG.DASH.w,
      h: CFG.DASH.h,
      vx: -CFG.DASH.speed,
      nextAt: nowMs() + (CFG.DASH.minS*1000 + Math.random()*(CFG.DASH.maxS-CFG.DASH.minS)*1000),
    };

    function spawnDash(now){
      const d = STATE.dash;
      d.active = true;
      d.x = W + d.w + 10;
      d.vx = -CFG.DASH.speed * (STATE.oni ? 1.15 : 1.0);

      const minS = STATE.oni ? CFG.DASH.oniMinS : CFG.DASH.minS;
      const maxS = STATE.oni ? CFG.DASH.oniMaxS : CFG.DASH.maxS;
      d.nextAt = now + (minS*1000 + Math.random()*(maxS-minS)*1000);

      STATE.dashTrail.length = 0;
      flashText("âš  æµã‚ŒãŒæ¥ãŸ", 520);
    }
    function despawnDash(){
      const d = STATE.dash;
      d.active = false;
      d.x = W + d.w + 10;
    }

    function applyCatchScore(spec){
      if (spec.type.kind === "minus"){
        STATE.score += spec.points;
        STATE.combo = 0;
        STATE.miss++;
        flashText(`ãƒã‚ºãƒ¬ï¼${spec.type.label} ${spec.points}`, 900);
        return;
      }
      STATE.combo++;
      const comboBonus = Math.min(120, STATE.combo * 6);
      STATE.score += spec.points + comboBonus;
      flashText(`GET! +${spec.points}ï¼ˆ${spec.size.label}/${spec.type.label}ï¼‰`, 850);
    }

    function onStolen(who){
      STATE.combo = 0;
      STATE.miss++;
      if (who === "squid"){
        STATE.score -= 40;
        flashText("ã‚¤ã‚«ã«å¥ªã‚ã‚ŒãŸâ€¦ -40", 950);
      } else {
        flashText("è¦³å…‰å®¢ã«æ¨ªå–ã‚Šã•ã‚ŒãŸï¼", 850);
      }
      setHookIdle();
    }

    function onDropGiant(){
      STATE.combo = 0;
      STATE.miss++;
      flashText("å·¨å¤§ãŸã“ç„¼ãã€è½ã¡ãŸï¼ï¼", 950);
      setHookIdle();
    }

    function startDropAt(x){
      if (remaining() <= 0) return;
      const h = STATE.hook;
      if (h.phase !== "idle") return;

      h.x = clamp(x, CFG.MARGIN_X, W - CFG.MARGIN_X);
      h.phase = "drop";
      h.hasCatch = false;
      h.caught = null;
      h.giantDropArmed = false;
      h.giantDropRolled = false;
      h.giantWillDrop = false;
    }

    onPointer = (e) => {
      e.preventDefault();
      startDropAt(pointerToCanvasX(e, cvs));
    };
    cvs.addEventListener("pointerdown", onPointer, { passive:false });

    // timer (1s)
    timerId = setInterval(() => {
      if (remaining() <= 0) return;
      STATE.elapsed++;

      if (STATE.elapsed === CFG.BASE_LIMIT){
        if (STATE.score >= CFG.EXT_SCORE){
          STATE.extended = true;
          STATE.limit = CFG.EXT_LIMIT;
          flashText(`å»¶é•·è§£æ”¾ï¼60ç§’ã¸ï¼ˆ30ç§’æ™‚ç‚¹ ${STATE.score}ç‚¹ï¼‰`, 1200);
        } else {
          STATE.limit = CFG.BASE_LIMIT;
          flashText(`çµ‚äº†ï¼å»¶é•·æ¡ä»¶ï¼š${CFG.EXT_SCORE}ç‚¹ï¼ˆã„ã¾ ${STATE.score}ç‚¹ï¼‰`, 1400);
        }
      }

      if (STATE.extended && STATE.elapsed === CFG.ONI_AT){
        STATE.oni = true;
        STATE.oniReached = true;
        STATE.freezeUntil = nowMs() + CFG.ONI_FREEZE_MS;
        flashText("é¬¼ãƒ¢ãƒ¼ãƒ‰çªå…¥ï¼ï¼", 1000);
      }

      timeEl.textContent  = String(remaining());
      scoreEl.textContent = String(STATE.score);
      comboEl.textContent = String(STATE.combo);
      missEl.textContent  = String(STATE.miss);

      if (remaining() <= 0 && !STATE.ended){
        STATE.ended = true;
        setTimeout(() => {
          setButtonsIdle();
          btnRetry.disabled = false;
          showResult(STATE.score, STATE.extended, STATE.oniReached);
        }, 120);
      }
    }, 1000);

    let last = nowMs();

    function step(now){
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      if (remaining() > 0){
        if (STATE.freezeUntil && now < STATE.freezeUntil){
          render(now);
          rafId = requestAnimationFrame(step);
          return;
        }

        const mul = STATE.oni ? CFG.ONI_SPEED_MUL : 1.0;

        for (const it of STATE.items){
          if (!it.alive) continue;

          if (now < it.pauseUntil){
            it.vx *= 0.90;
          } else {
            if (now >= it.nextMind){
              if (Math.random() < 0.10) it.pauseUntil = now + rand(260, 620);

              const flip = (Math.random() < 0.18) ? -1 : 1;
              const spd = CFG.ITEM_BASE_SPEED + rand(-18, 60);
              it.vxTarget = clamp(flip * (Math.random()<0.5?-1:1) * spd, -CFG.ITEM_MAX_SPEED, CFG.ITEM_MAX_SPEED);

              it.bobAmp = clamp(it.bobAmp + rand(-0.6, 0.9), 0.5, 3.4);
              it.bobSpd = clamp(it.bobSpd + rand(-1.2, 1.4), 2.0, 9.0);
              it.nextMind = now + rand(350, 1300);
            }

            const dv = it.vxTarget - it.vx;
            const stepV = clamp(dv, -CFG.ITEM_ACCEL*dt, CFG.ITEM_ACCEL*dt);
            it.vx += stepV;
            it.vx += rand(-6, 6) * dt;
            it.vx = clamp(it.vx, -CFG.ITEM_MAX_SPEED, CFG.ITEM_MAX_SPEED);
          }

          it.x += it.vx * dt;

          const half = it.spec.size.draw / 2;
          if (it.x - half < CFG.MARGIN_X){
            it.x = CFG.MARGIN_X + half;
            it.vx = Math.abs(it.vx) * (0.85 + Math.random()*0.25);
            it.vxTarget = Math.abs(it.vxTarget) * (0.8 + Math.random()*0.4);
            it.nextMind = Math.min(it.nextMind, now + rand(120, 420));
          }
          if (it.x + half > W - CFG.MARGIN_X){
            it.x = (W - CFG.MARGIN_X) - half;
            it.vx = -Math.abs(it.vx) * (0.85 + Math.random()*0.25);
            it.vxTarget = -Math.abs(it.vxTarget) * (0.8 + Math.random()*0.4);
            it.nextMind = Math.min(it.nextMind, now + rand(120, 420));
          }

          it.y = it.baseY + Math.sin((now/1000) * it.bobSpd + it.bobPhase) * it.bobAmp;
        }

        const t = STATE.tourist;
        t.x += t.dir * t.speed * mul * dt;
        if (t.x < 0){ t.x = 0; t.dir *= -1; }
        if (t.x + t.w > W){ t.x = W - t.w; t.dir *= -1; }

        const s = STATE.squid;
        s.baseX += s.dir * s.speed * mul * dt;
        if (s.baseX < 0){ s.baseX = 0; s.dir *= -1; }
        if (s.baseX + s.w > W){ s.baseX = W - s.w; s.dir *= -1; }

        const sec = (now/1000) * (Math.PI*2) * s.freq + s.phase;
        s.x = s.baseX + Math.sin(sec) * s.ampX;
        s.y = s.baseY + Math.cos(sec * 0.85) * s.ampY;

        const d = STATE.dash;
        if (!d.active && now >= d.nextAt){
          spawnDash(now);
        }
        if (d.active){
          d.x += d.vx * dt;
          if (d.x + d.w < -40) despawnDash();
        }

        const h = STATE.hook;

        if (h.phase === "drop"){
          h.y += CFG.HOOK_DROP * dt;

          if (!h.hasCatch){
            for (const it of STATE.items){
              if (!it.alive) continue;
              const rr = it.spec.size.draw * 0.38;
              if (circleHit(h.x, h.y, h.hitR, it.x, it.y, rr)){
                h.hasCatch = true;
                h.phase = "reel";
                h.caught = it.spec;

                h.giantDropArmed = (it.spec.sizeKey === "giant");
                h.giantDropRolled = false;
                h.giantWillDrop = false;

                it.alive = false;
                flashText(`HIT!ï¼ˆ${it.spec.size.label}/${it.spec.type.label}ï¼‰`, 750);
                break;
              }
            }
          }

          if (h.y >= FLOOR_Y - 10){
            h.y = FLOOR_Y - 10;
            h.phase = "reel";
            if (!h.hasCatch){
              STATE.combo = 0;
              flashText("ç©ºæŒ¯ã‚Šâ€¦ï¼", 600);
            }
          }
        }

        if (h.phase === "reel"){
          h.y -= CFG.HOOK_REEL * dt;

          if (h.hasCatch && h.caught && h.giantDropArmed){
            if (!h.giantDropRolled && h.y < GIANT_DROP_START_Y){
              h.giantDropRolled = true;
              h.giantWillDrop = (Math.random() < CFG.GIANT_DROP_CHANCE);
            }
            if (h.giantWillDrop && h.y < (GIANT_DROP_START_Y - 40)){
              const dead = STATE.items.find(v => !v.alive);
              if (dead) resetItem(dead);

              h.hasCatch = false;
              h.caught = null;
              onDropGiant();
            }
          }

          if (h.hasCatch && h.caught){
            const fishSize = h.caught.size.draw;
            const fishR = fishSize * 0.38;
            const fishX = h.x;
            const fishY = h.y + (CFG.PICK_DRAW/2) + (fishSize/2) - 2;

            if (circleRectHit(fishX, fishY, fishR, t.x, t.y - t.h/2, t.w, t.h)){
              const dead = STATE.items.find(v => !v.alive);
              if (dead) resetItem(dead);
              h.hasCatch = false;
              h.caught = null;
              onStolen("tourist");
            }

            if (h.hasCatch && circleRectHit(fishX, fishY, fishR, s.x, s.y - s.h/2, s.w, s.h)){
              const dead = STATE.items.find(v => !v.alive);
              if (dead) resetItem(dead);
              h.hasCatch = false;
              h.caught = null;
              onStolen("squid");
            }

            if (h.hasCatch && d.active){
              if (circleRectHit(fishX, fishY, fishR, d.x, d.y - d.h/2, d.w, d.h)){
                const dead = STATE.items.find(v => !v.alive);
                if (dead) resetItem(dead);
                h.hasCatch = false;
                h.caught = null;
                onStolen("tourist");
                despawnDash();
              }
            }
          }

          if (h.y <= CFG.TOP_Y){
            h.y = CFG.TOP_Y;
            if (h.hasCatch && h.caught){
              const dead = STATE.items.find(v => !v.alive);
              if (dead) resetItem(dead);

              applyCatchScore(h.caught);

              h.hasCatch = false;
              h.caught = null;
              setHookIdle();
            } else {
              setHookIdle();
            }
          }
        }
      }

      scoreEl.textContent = String(STATE.score);
      comboEl.textContent = String(STATE.combo);
      missEl.textContent  = String(STATE.miss);
      timeEl.textContent  = String(remaining());

      render(now);
      rafId = requestAnimationFrame(step);
    }

    setHookIdle();
    flashText("", 0);
    rafId = requestAnimationFrame(step);
  }

  /* =========================
     10) Init (images + first view)
  ========================= */
  async function init(){
    refreshTopLines();
    resetCanvasMessage("ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­â€¦");

    const { images, failed } = await loadAllImages();
    if (failed.length){
      ctx.fillStyle = "#081425";
      ctx.fillRect(0,0,CFG.W,CFG.H);
      ctx.fillStyle = "#fff";
      ctx.font = "14px system-ui";
      ctx.fillText("ç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„ã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼š", 18, 40);
      ctx.font = "11px system-ui";
      let y=70;
      for (const f of failed){
        ctx.fillText(`- ${f.key}: ${f.url}`, 18, y);
        y += 16;
        if (y > CFG.H - 30) break;
      }
      ctx.fillText("CDN_BASE / ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 18, CFG.H-16);
      return;
    }

    IMGS = images;
    resetCanvasMessage("æº–å‚™OKï¼ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã§é–‹å§‹");
    showRules();
    setButtonsIdle();
  }

  /* =========================
     11) UI events
  ========================= */
  btnStart.addEventListener("click", () => {
    // ã¾ãšãƒ«ãƒ¼ãƒ«ã‚’è¦‹ã›ã‚‹ï¼ˆé–‹å§‹ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¦‹ãˆã‚‹ï¼‰
    showRules();
  });

  btnRuleStart.addEventListener("click", () => {
    startGame();
  });

  btnRuleClose.addEventListener("click", () => {
    hideRules();
  });

  btnRetry.addEventListener("click", () => {
    // ã‚²ãƒ¼ãƒ ã‚’æ­¢ã‚ã¦æœ€åˆã‹ã‚‰
    stopGame();
    hideResultOverlay();
    showRules();
    resetCanvasMessage("æº–å‚™OKï¼ã€Œé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ");
  });

  btnAgain.addEventListener("click", () => {
    stopGame();
    hideResultOverlay();
    showRules();
    resetCanvasMessage("æº–å‚™OKï¼ã€Œé–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ");
  });

  btnCloseResult.addEventListener("click", () => {
    hideResultOverlay();
    // çµæœé–‰ã˜ã¦ã‚‚å†æŒ‘æˆ¦ã§ãã‚‹ã‚ˆã†ã«
    btnRetry.disabled = false;
  });

  // çµæœ/ãƒ«ãƒ¼ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
  // â€»å¿…è¦ãªã‚‰å®Ÿè£…å¯

  // åˆæœŸåŒ–
  init();

})();
</script>
</body>
</html>
