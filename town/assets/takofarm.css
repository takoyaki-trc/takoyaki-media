<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>たこ焼きファーム</title>

  <style>
:root{
  --bg:#0f1220;
  --panel:rgba(255,255,255,.06);
  --line:rgba(255,255,255,.14);
  --text:#fff;
  --muted:rgba(255,255,255,.72);
  --good:#9fffa8;
  --warn:#ffd38a;
  --bad:#ff9aa5;
  --btn:rgba(255,255,255,.10);
  --btn2:rgba(255,255,255,.14);
  --lock:rgba(255,255,255,.06);
}

/* ===== 背景 ===== */
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
  color:var(--text);
  background:
    linear-gradient(rgba(15,18,32,.72), rgba(15,18,32,.72)),
    url("https://ul.h3z.jp/8DNhFtiC.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.wrap{max-width:520px;margin:0 auto;padding:12px 14px 18px}

/* ===== 上部：ヘッダー ===== */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.topbar a{
  color:var(--text);
  text-decoration:none;
  border:1px solid var(--line);
  padding:7px 10px;
  border-radius:12px;
  background:rgba(255,255,255,.05);
  font-weight:800;
  line-height:1;
}

h1{
  font-size:18px;
  margin:6px 0 6px;
  letter-spacing:.02em;
}
.hint{
  font-size:12px;
  color:var(--muted);
  line-height:1.5;
  margin-bottom:10px;
}
.hint b{color:#fff}

/* ===== ステータス：pill群 ===== */
.stats{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:10px;
}
.pill{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  line-height:1.2;
  display:flex;
  align-items:baseline;
  gap:6px;
  white-space:nowrap;
}
.pill b{font-weight:1000}
.pill small{opacity:.85}

/* ===== XPパネル ===== */
.xpPanel{
  width:100%;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  border-radius:16px;
  padding:10px 12px;
  margin-top:2px;
  margin-bottom: 25px;
}
.xpTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:baseline;
  font-size:12px;
  line-height:1.2;
  margin-bottom:8px;
}
.xpTop b{font-weight:1000}
.xpBarWrap{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  border-radius:999px;
  overflow:hidden;
  height:10px;
}
.xpBar{
  height:100%;
  width:0%;
  background:rgba(159,255,168,.55);
}

/* ====== Farm Grid ====== */
.farm{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:8px;
  user-select:none;
}
.plot{
  aspect-ratio:1/1;
  border:1px solid var(--line);
  border-radius:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}
.plot button{
  width:100%;
  height:100%;
  background:transparent;
  border:0;
  color:var(--text);
  font-weight:800;
  padding:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  position:relative;
}
.plot .tag{font-size:10px;opacity:.8}
.plot[data-state="EMPTY"] .tag{opacity:.6}
.plot[data-state="GROW"]{outline:2px solid rgba(255,211,138,.25)}
.plot[data-state="READY"]{outline:2px solid rgba(159,255,168,.35)}
.plot[data-state="BURN"]{outline:2px solid rgba(255,154,165,.35)}
.plot[data-state="LOCK"]{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  outline:2px solid rgba(255,255,255,.06);
}

.badge{
  position:absolute;top:8px;left:8px;
  font-size:10px;font-weight:900;
  padding:4px 8px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  z-index:2;
}
.badge.good{color:var(--good)}
.badge.warn{color:var(--warn)}
.badge.bad{color:var(--bad)}
.badge.lock{color:rgba(255,255,255,.85)}
.lockOverlay{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;
  background:rgba(0,0,0,.25);
  backdrop-filter:blur(1px);
  z-index:1;
  pointer-events:none;
}
.lockOverlay .lk1{font-weight:1000;font-size:12px}
.lockOverlay .lk2{font-size:10px;opacity:.85}

/* ====== Modal ====== */
.modal{
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,.55);
  align-items:flex-end;justify-content:center;
  padding:14px;
  z-index:9999;
}
.modal[aria-hidden="false"]{display:flex}
.sheet{
  width:min(520px, 100%);
  border:1px solid var(--line);
  background:rgba(15,18,32,.92);
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.sheetHead{
  padding:12px 14px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.04);
}
.sheetHead .ttl{font-weight:900}
.sheetHead button{
  border:1px solid var(--line);
  background:var(--btn);
  color:var(--text);
  padding:8px 10px;border-radius:12px;
  font-weight:900;
}

/* ★ここは「伸びすぎ防止」だけ。スクロールは #mBody に任せる */
.sheetBody{ padding:12px 14px 14px; }

.step{font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.5}

/* ✅ モーダル本文は縦スクロールOK */
#mBody{
  max-height: 72vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  touch-action: pan-y;
}

/* =========================
   ✅ 装備HUD
========================= */
.loadoutWrap{
  margin: 14px 0 10px;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid var(--line, rgba(255,255,255,.14));
  background: rgba(255,255,255,.06);
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
}
.loadoutHead{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.loadoutTtl{ font-weight: 900; letter-spacing: .02em; }
.loadoutSub{ font-size: 12px; opacity: .75; white-space: nowrap; }

.loadout{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.equipCard{
  position: relative;
  border-radius: 16px;
  border: 1px solid var(--line, rgba(255,255,255,.14));
  background: rgba(255,255,255,.06);
  color: #fff;
  padding: 10px;
  text-align: left;
  box-shadow: 0 10px 20px rgba(0,0,0,.22);
}
.equipCard button{
  all:unset;
  display:block;
  cursor:pointer;
}
.equipTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-bottom: 8px;
}
.equipTag{
  font-size: 11px;
  font-weight: 900;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid var(--line, rgba(255,255,255,.14));
  background: rgba(255,255,255,.08);
}
.equipCnt{ font-size: 12px; font-weight: 900; opacity: .9; }

.equipImg{
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 14px;
  overflow:hidden;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
}

/* HUDは“詰まって見える”方が気持ちいいので cover のままOK */
.equipImg img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  image-rendering: pixelated;
}

.equipName{
  margin-top: 8px;
  font-weight: 900;
  font-size: 12px;
  line-height: 1.2;
  opacity: .95;
  min-height: 2.4em;
}
.loadoutHint{
  margin-top: 10px;
  font-size: 12px;
  opacity: .8;
}

/* =========================
   ✅ 選択グリッド（モーダル内スクロール＋サイズ統一＋画像の“ズレ見え”対策）
========================= */
.gridWrap{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 10px;

  max-height: 56vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;

  padding: 2px 2px 6px;
  overscroll-behavior: contain;
  touch-action: pan-y;

  align-items: stretch;
  grid-auto-rows: 1fr;
}

.gridCard{
  border-radius: 16px;
  border: 1px solid var(--line, rgba(255,255,255,.14));
  background: rgba(255,255,255,.06);
  color: #fff;
  padding: 10px;
  text-align: left;
  box-shadow: 0 10px 20px rgba(0,0,0,.22);

  height: 100%;
  display:flex;
  flex-direction:column;
}
.gridCard:disabled{ opacity: .55; }
.gridCard.isSelected{ outline: 2px solid rgba(255,255,255,.35); }

/* ✅ 画像枠：必ず中央に見えるようにする */
.gridImg{
  position: relative;
  width: 100%;
  height: 92px;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);

  /* ★中央寄せ固定（ズレ“見え”対策の本命） */
  display:flex;
  align-items:center;
  justify-content:center;

  /* ★枠の中の余白を一定に */
  padding: 8px;

  /* ★カード内で左右ズレ“見え”を起こさない */
  margin: 0 auto;
}

/* ✅ 画像：枠いっぱいに「contain」で中央固定（切れ/片寄りを止める） */
.gridImg img{
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;

  object-fit: contain;          /* ★切れない */
  object-position: center;      /* ★中央固定 */

  image-rendering: pixelated;
  display:block;

  /* 透明余白が非対称な素材も“見え”を安定させる */
  margin: 0 auto;
}

/* バッジ */
.gridCnt{
  position:absolute;
  right:8px;
  bottom:8px;
  font-weight: 900;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.14);
}
.gridSel{
  position:absolute;
  left:8px;
  top:8px;
  font-weight: 900;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,.14);
  border: 1px solid rgba(255,255,255,.18);
}
.gridEmpty{
  position:absolute;
  left:8px;
  bottom:8px;
  font-weight: 900;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,80,90,.35);
  border: 1px solid rgba(255,80,90,.35);
}

.gridName{ margin-top: 8px; font-weight: 900; font-size: 13px; }

.gridDesc{
  margin-top: 4px;
  font-size: 12px;
  opacity: .85;
  line-height: 1.35;

  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 3;
  overflow: hidden;
  min-height: calc(1.35em * 3);
}

.gridFx{
  margin-top: auto;
  padding-top: 6px;
  font-size: 12px;
  opacity: .95;
}

.gridSmallBtn{
  margin-top: 8px;
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--line, rgba(255,255,255,.14));
  background: rgba(255,255,255,.10);
  color:#fff;
  font-weight: 900;
}

@media (max-width: 380px){
  .gridWrap{ grid-template-columns: repeat(2, 1fr); }
  .gridDesc{ display:none; }
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="./town.html">← 戻る</a>
      <a href="./zukan.html">図鑑</a>
    </div>

    <h1>たこ焼きファーム</h1>
    <div class="hint">マスをタップ→<b>装備のタネ/水/肥料</b>で植える。</div>

    <div class="stats">
      <div class="pill"><small>オクト</small> <b id="octo">0</b></div>
      <div class="pill"><small>Lv</small> <b id="lv">1</b></div>
      <div class="pill"><small>XP</small> <b id="xp">0</b></div>
    </div>

    <div class="xpPanel">
      <div class="xpTop">
        <div><b>経験値</b>（次のレベルまで <span id="xpNeed">100</span>）</div>
        <div><b id="xpPct">0%</b></div>
      </div>
      <div class="xpBarWrap"><div class="xpBar" id="xpBar"></div></div>
    </div>

    <!-- ✅ 装備HUD -->
    <div class="loadoutWrap">
      <div class="loadoutHead">
        <div>
          <div class="loadoutTtl">装備</div>
          <div class="loadoutSub">タップで変更</div>
        </div>
      </div>

      <div class="loadout">
        <div class="equipCard">
          <button type="button" data-eq="seed">
            <div class="equipTop">
              <span class="equipTag">タネ</span>
              <span class="equipCnt" id="seedCnt">×0</span>
            </div>
            <div class="equipImg"><img id="seedImg" alt=""></div>
            <div class="equipName" id="seedName">未装備</div>
          </button>
        </div>

        <div class="equipCard">
          <button type="button" data-eq="water">
            <div class="equipTop">
              <span class="equipTag">水</span>
              <span class="equipCnt" id="waterCnt">×0</span>
            </div>
            <div class="equipImg"><img id="waterImg" alt=""></div>
            <div class="equipName" id="waterName">未装備</div>
          </button>
        </div>

        <div class="equipCard">
          <button type="button" data-eq="fert">
            <div class="equipTop">
              <span class="equipTag">肥料</span>
              <span class="equipCnt" id="fertCnt">×0</span>
            </div>
            <div class="equipImg"><img id="fertImg" alt=""></div>
            <div class="equipName" id="fertName">未装備</div>
          </button>
        </div>
      </div>

      <div class="loadoutHint">※すべて在庫制。露店で買って増やす。装備は消費しない（植えた時に消費）。</div>
    </div>

    <!-- 畑（見た目だけの簡易） -->
    <div class="farm" id="farm"></div>
  </div>

  <!-- モーダル -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="装備を選ぶ">
      <div class="sheetHead">
        <div class="ttl" id="mTitle">選ぶ</div>
        <button id="mClose" type="button">閉じる</button>
      </div>
      <div class="sheetBody" id="mBody">
        <div class="step" id="mStep">選択してください。</div>
        <div class="gridWrap" id="grid"></div>
      </div>
    </div>
  </div>

  <script>
(() => {
  "use strict";

  // -------------------------
  // データ（例：あなたの実データ構造に合わせて差し替えてOK）
  // -------------------------
  const ITEMS = {
    seed: [
      { id:"seed_random", name:"なに出るタネ", desc:"何が育つかは完全ランダム。", fx:"完全ランダム", img:"https://ul.h3z.jp/7moREJnl.png" },
      { id:"seed_shop",   name:"店頭タネ",     desc:"店で生まれたタネ。",       fx:"店頭の気配",   img:"https://ul.h3z.jp/SvLLVa7m.png" },
      { id:"seed_line",   name:"回線タネ",     desc:"画面の向こうから届いたタネ。", fx:"回線由来", img:"https://ul.h3z.jp/TWaE9GsS.png" },
      { id:"seed_takopi", name:"たこぴのタネ", desc:"このタネを植えたら…",     fx:"たこぴ案件",   img:"https://ul.h3z.jp/AFW27Fek.png" },
      { id:"seed_bussashi", name:"ブッ刺さりタネ", desc:"刺さるのは心だけ。",   fx:"致命的刺さり", img:"https://ul.h3z.jp/hYp9l9G5.png" },
      { id:"seed_namara", name:"なまら買わさるタネ", desc:"気付いたら買ってる。", fx:"財布が焼ける", img:"https://ul.h3z.jp/zzh1fJrR.png" },
    ],
    water: [
      { id:"water_plain_free", name:"ただの水", desc:"基本の水。", fx:"変化なし", img:"https://ul.h3z.jp/9d2h2x7a.png" },
    ],
    fert: [
      { id:"fert_agedama", name:"ただの揚げ玉", desc:"時短。", fx:"時短", img:"https://ul.h3z.jp/1u9uH1k7.png" },
    ],
  };

  // 在庫（例）
  const inv = {
    seed: { seed_random:1, seed_shop:5, seed_line:17, seed_takopi:1, seed_bussashi:1, seed_namara:0 },
    water:{ water_plain_free:99 },
    fert: { fert_agedama:99 }
  };

  // 装備状態
  const eq = {
    seed: "seed_shop",
    water: "water_plain_free",
    fert: "fert_agedama"
  };

  // -------------------------
  // DOM
  // -------------------------
  const $ = (s)=>document.querySelector(s);
  const modal = $("#modal");
  const grid  = $("#grid");
  const mTitle= $("#mTitle");
  const mStep = $("#mStep");
  const mClose= $("#mClose");

  // HUD
  const hud = {
    seed:  { img:$("#seedImg"),  name:$("#seedName"),  cnt:$("#seedCnt") },
    water: { img:$("#waterImg"), name:$("#waterName"), cnt:$("#waterCnt") },
    fert:  { img:$("#fertImg"),  name:$("#fertName"),  cnt:$("#fertCnt") },
  };

  let currentType = "seed";

  // -------------------------
  // モーダル開閉
  // -------------------------
  function openModal(type){
    currentType = type;
    mTitle.textContent = (type==="seed"?"種を選ぶ":type==="water"?"水を選ぶ":"肥料を選ぶ");
    mStep.textContent = "※すべて在庫制。露店で買って増やす。装備は消費しない（植えた時に消費）。";
    renderGrid(type);
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.setAttribute("aria-hidden","true");
  }
  mClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

  // -------------------------
  // グリッド描画
  // -------------------------
  function renderGrid(type){
    const list = ITEMS[type] || [];
    const selectedId = eq[type];

    grid.innerHTML = "";
    for(const it of list){
      const cnt = Number((inv[type]||{})[it.id] || 0);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "gridCard" + (it.id===selectedId ? " isSelected" : "");
      btn.disabled = false;

      btn.innerHTML = `
        <div class="gridImg">
          ${it.id===selectedId ? `<div class="gridSel">装備中</div>` : ``}
          <img src="${it.img}" alt="${escapeHtml(it.name)}">
          ${cnt<=0 ? `<div class="gridEmpty">在庫なし</div>` : ``}
          <div class="gridCnt">×${cnt}</div>
        </div>
        <div class="gridName">${escapeHtml(it.name)}</div>
        <div class="gridDesc">${escapeHtml(it.desc||"")}</div>
        <div class="gridFx">効果：${escapeHtml(it.fx||"")}</div>
        <div class="gridSmallBtn">${it.id===selectedId ? "選択中" : "装備する"}</div>
      `;

      btn.addEventListener("click", ()=>{
        // 在庫0でも「装備」は可能（あなたの仕様次第）。不可にしたいならここで return
        eq[type] = it.id;
        syncHUD();
        renderGrid(type);
      });

      grid.appendChild(btn);
    }
  }

  function syncHUD(){
    for(const type of ["seed","water","fert"]){
      const id = eq[type];
      const it = (ITEMS[type]||[]).find(x=>x.id===id);
      const cnt = Number((inv[type]||{})[id] || 0);

      hud[type].cnt.textContent = `×${cnt}`;
      hud[type].name.textContent = it ? it.name : "未装備";
      hud[type].img.src = it ? it.img : "";
      hud[type].img.alt = it ? it.name : "";
    }
  }

  // -------------------------
  // 畑（ダミー表示）
  // -------------------------
  function renderFarm(){
    const farm = $("#farm");
    farm.innerHTML = "";
    for(let i=0;i<25;i++){
      const cell = document.createElement("div");
      cell.className = "plot";
      cell.dataset.state = "EMPTY";
      const b = document.createElement("button");
      b.type = "button";
      b.innerHTML = `<div class="tag">EMPTY</div>`;
      cell.appendChild(b);
      farm.appendChild(cell);
    }
  }

  // -------------------------
  // イベント
  // -------------------------
  document.querySelectorAll(".equipCard button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      openModal(btn.dataset.eq);
    });
  });

  // -------------------------
  // util
  // -------------------------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // init
  renderFarm();
  syncHUD();
})();
  </script>
</body>
</html>

