<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>マイ露店</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --btn:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    .mono{font-family:var(--mono)}
    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:active{transform:translateY(1px)}
    .btn.warn{background:linear-gradient(180deg, rgba(255,211,138,.18), rgba(255,255,255,.10));}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:12px;
      white-space:nowrap;
    }

    /* header */
    .header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(to bottom, rgba(15,18,32,.95), rgba(15,18,32,.55));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .head-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
    .back{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:var(--btn); color:var(--text); font-size:18px; cursor:pointer;
    }
    .titlebox{flex:1;min-width:0}
    .title{font-size:16px;font-weight:900;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.25}
    .top-actions{display:flex;gap:8px}

    /* cards */
    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card-title{font-weight:900;font-size:14px}
    .card-desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}
    .card-b{padding:12px}

    /* stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px;
      min-height:62px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:900;margin-top:4px;display:flex;align-items:baseline;gap:6px}
    .stat .v small{font-size:11px;color:var(--muted);font-weight:700}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* ===== 来店ステージ（背景＋客） ===== */
    .stage-card{margin-bottom:12px}
    .stage{
      position:relative;
      width:100%;
      max-width:980px;
      height:192px;               /* 表示高：固定（ドット感のため） */
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    @media (max-width: 520px){
      .stage{height:180px;}
    }
    .stage-bg{
      width:100%; height:100%;
      object-fit:cover;
      image-rendering: pixelated;
      display:block;
    }
    .stage-visitor{
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      height:150px;              /* 客の表示高さ（基準） */
      image-rendering: pixelated;
      display:none;
      pointer-events:none;
    }
    .stage-visitor.show{display:block;}
    .stage-ui{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .bubble{
      pointer-events:none;
      max-width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      border-radius:14px;
      padding:8px 10px;
      line-height:1.25;
    }
    .bubble .n{font-weight:900;font-size:12px}
    .bubble .m{color:rgba(255,255,255,.80);font-size:12px;margin-top:3px}
    .stage-tags{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      pointer-events:none;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* layout grid */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    /* shelves */
    .shelves{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .shelves{grid-template-columns:1fr} }
    .shelf{
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08));
      overflow:hidden;
    }
    .shelf.locked{opacity:.6;filter:saturate(.7)}
    .shelf-top{
      padding:10px 10px 8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px dashed rgba(255,255,255,.16);
    }
    .shelf-name{font-weight:900;font-size:13px}
    .shelf-tag{font-size:11px;color:var(--muted)}
    .shelf-body{padding:10px;display:flex;gap:10px;align-items:flex-start}
    .slot{
      width:76px; height:108px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
    }
    .slot img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated;display:block}
    .slot .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.65);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .slot .tier{
      position:absolute;left:6px;top:6px;
      font-size:10px;font-weight:900;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
    }
    .shelf-info{flex:1;min-width:0}
    .line{font-size:12px;color:var(--muted);line-height:1.35}
    .line b{color:var(--text)}
    .line + .line{margin-top:6px}
    .shelf-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}
    .visitor-mini{
      margin-top:10px;
      border-top:1px dashed rgba(255,255,255,.14);
      padding-top:10px;
      display:flex;gap:10px;align-items:flex-start;
      min-height:52px;
    }
    .avatar{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;display:block;image-rendering:pixelated}
    .vtext{min-width:0}
    .vname{font-weight:900;font-size:12px}
    .vmsg{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}

    /* inventory */
    .invlist{display:flex;flex-direction:column;gap:10px}
    .invrow{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.14);
      padding:10px;
    }
    .invrow .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .invrow .h b{font-size:13px}
    .invrow .h span{font-size:11px;color:var(--muted)}
    .invrow .body{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;align-items:center;gap:6px;
    }
    .chip .n{font-family:var(--mono);font-weight:900}

    /* log */
    .log{
      font-size:12px;color:var(--muted);
      line-height:1.35;
      display:flex;flex-direction:column;gap:8px;
      max-height:260px; overflow:auto;
      padding-right:6px;
    }
    .log .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:8px 10px;
    }
    .log .t{color:rgba(255,255,255,.8);font-weight:900}
    .log .m{margin-top:3px}
    .log .s{margin-top:3px;font-family:var(--mono);font-size:11px;opacity:.85}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding:14px 12px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background:rgba(15,18,32,.98);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet-h{
      padding:12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sheet-h b{font-size:14px}
    .sheet-b{padding:12px}
    .sheet-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid var(--line)}
    .close{width:40px;height:40px;border-radius:12px}
    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 760px){ .cards{grid-template-columns: repeat(3, minmax(0,1fr))} }
    @media (max-width: 520px){ .cards{grid-template-columns: repeat(2, minmax(0,1fr))} }
    .citem{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
      display:flex; flex-direction:column;
      min-height:160px;
    }
    .citem:active{transform:translateY(1px)}
    .cimg{
      height:120px; background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .cimg img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
    .cimg .ph{
      color:rgba(255,255,255,.6);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .cimg .cnt{
      position:absolute; right:6px; top:6px;
      font-size:11px; font-weight:900;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
      font-family:var(--mono);
    }
    .cmeta{padding:8px 10px}
    .cname{font-size:12px;font-weight:900;line-height:1.2}
    .csub{font-size:11px;color:var(--muted);margin-top:4px;display:flex;justify-content:space-between;gap:8px}
    .csub span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* toast */
    .toast{
      position:fixed; left:12px; right:12px; bottom:14px;
      display:flex; justify-content:center;
      pointer-events:none;
      z-index:200;
    }
    .toast .box{
      width:min(680px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.65);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      pointer-events:none;
      display:none;
    }
    .toast .box.show{display:block}
    .toast .box b{font-weight:900}
    .toast .box .small{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
  </style>
</head>
<body>
  <div class="header">
    <div class="head-inner">
      <button class="back" id="backBtn" type="button" aria-label="戻る">←</button>
      <div class="titlebox">
        <div class="title">マイ露店</div>
        <div class="sub">3〜5分ごとに来客。売れなくても育つ。売れたらもっと伸びる。</div>
      </div>
      <div class="top-actions">
        <button class="btn warn" id="shoutBtn" type="button">呼び込み</button>
        <button class="btn ghost" id="helpBtn" type="button">？</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- stats -->
    <div class="stats" id="stats"></div>

    <!-- 来店ステージ -->
    <div class="card stage-card">
      <div class="card-h">
        <div>
          <div class="card-title">来店ステージ</div>
          <div class="card-desc">背景（昼/夜）に、客タコ民（透過）を重ねて表示。誰もいない時は背景だけ。</div>
        </div>
        <div class="pill">
          <span>評判</span>
          <b id="repText" class="mono">—</b>
        </div>
      </div>
      <div class="card-b">
        <div class="stage" id="stage">
          <img id="stageBg" class="stage-bg" alt="" src="">
          <img id="stageVisitor" class="stage-visitor" alt="" src="">
          <div class="stage-ui">
            <div class="bubble">
              <div class="n" id="stageName">—</div>
              <div class="m" id="stageMsg">まだ誰も来ていない。</div>
            </div>
            <div class="stage-tags">
              <div class="tag" id="stageTimeTag">—</div>
              <div class="tag" id="stageNextTag">次：—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- main grid -->
    <div class="grid">
      <!-- left -->
      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">棚（出品）</div>
            <div class="card-desc">棚をタップして出品。出品中は棚ごとに3〜5分で来客判定。来客だけでもEXPが入る。</div>
          </div>
          <button class="btn" id="refreshBtn" type="button">更新</button>
        </div>
        <div class="card-b">
          <div class="shelves" id="shelves"></div>
        </div>
      </div>

      <!-- right -->
      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">所持・連動</div>
            <div class="card-desc">ファーム資材（種/水/肥料）と図鑑（所持カード）を表示。</div>
          </div>
          <div class="pill"><span>表示</span><b class="mono">自動</b></div>
        </div>
        <div class="card-b">
          <div class="invlist">
            <div class="invrow">
              <div class="h"><b>資材（tf_v1_inv）</b><span>無料枠は∞でもOK</span></div>
              <div class="body" id="invChips"></div>
            </div>
            <div class="invrow">
              <div class="h"><b>図鑑（tf_v1_book）</b><span>所持カード（出品で減る）</span></div>
              <div class="body" id="bookChips"></div>
              <div style="margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35">
                ※ 出品すると所持数（count）が1減り、取り下げると戻ります。
              </div>
            </div>
            <div class="invrow">
              <div class="h"><b>最近の出来事</b><span>ログ</span></div>
              <div class="log" id="log"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- modal: pick card -->
  <div class="modal" id="pickModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="出品するカードを選ぶ">
      <div class="sheet-h">
        <div>
          <b id="pickTitle">出品するカード</b>
          <div style="margin-top:4px;font-size:12px;color:var(--muted)" id="pickHint">棚を選んでからカードを選択。</div>
        </div>
        <button class="btn close" id="pickClose" type="button" aria-label="閉じる">×</button>
      </div>
      <div class="sheet-b">
        <div class="cards" id="pickCards"></div>
        <div style="margin-top:10px;font-size:12px;color:var(--muted);display:none" id="pickEmpty">
          所持カードがありません。まずはファームで収穫して図鑑に追加してね。
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="pickCancel" type="button">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- modal: help -->
  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="ヘルプ">
      <div class="sheet-h">
        <b>露店の遊び方</b>
        <button class="btn close" id="helpClose" type="button" aria-label="閉じる">×</button>
      </div>
      <div class="sheet-b">
        <div style="font-size:12px;color:rgba(255,255,255,.86);line-height:1.65">
          ・棚をタップ → 所持カードから出品<br>
          ・出品中は棚ごとに 3〜5分で来客判定（売れる/売れない）<br>
          ・来客だけでも EXP +1（育つ）<br>
          ・売れたら EXP 追加 +4（合計+5）<br>
          ・王様が買うとボーナス（評判UP）<br>
          ・転売タコ民が買うと評判DOWN（でも売上は入る）<br>
          ・評判が高いほど売れやすい<br>
          ・「呼び込み」は60秒に1回、即来客を起こせる<br><br>
          <b>棚解放</b><br>
          Lv1: 棚1-2 / Lv2: 棚3 / Lv3: 棚4 / Lv4: 棚5
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="helpOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" aria-live="polite" aria-atomic="true">
    <div class="box" id="toastBox">
      <b id="toastTitle">—</b>
      <div class="small" id="toastSub">—</div>
    </div>
  </div>
<script>
(() => {
  "use strict";

  /* =========================================================
     ASSETS
  ========================================================= */
  const ASSETS = {
    bgDay:   "https://ul.h3z.jp/lqCNnwQH.png",
    bgNight: "https://ul.h3z.jp/UtPlWaZz.png",
    visitors: [
      { id:"v01", name:"慎重タコ民", type:"careful", url:"https://ul.h3z.jp/lsTSkndD.png" },
      { id:"v02", name:"即決タコ民", type:"impulse", url:"https://ul.h3z.jp/YckjGopx.png" },
      { id:"v03", name:"冷やかしタコ民", type:"looker",  url:"https://ul.h3z.jp/PIsx6jd0.png" },
      { id:"v04", name:"こだわりタコ民", type:"picky",   url:"https://ul.h3z.jp/j8ZOooGi.png" },
      { id:"v05", name:"王様タコ民",   type:"king",    url:"https://ul.h3z.jp/CaRoJGA6.png" },
      { id:"v06", name:"転売タコ民",   type:"flipper", url:"https://ul.h3z.jp/C015QuqC.png" }
    ]
  };

  const VISITOR_LINES = {
    careful:  ["どうしようかな…","今日は見送るべきか…","悪くはないけど…"],
    impulse: ["おっ、これいい！","今買わないと後悔するかも","直感がそう言ってる"],
    looker:  ["ふーん","見るだけ見る","賑やかだなあ"],
    picky:   ["匂いは悪くない","焼きにムラがないか…","慎重に選びたい"],
    king:    ["よい","余は迷わぬ","この棚、気に入った"],
    flipper: ["回るか…？","これは動く","利益の匂いがする"]
  };

  /* =========================================================
     LocalStorage Keys
  ========================================================= */
  const LS = {
    stage: "roten_v1_stage",
    shout: "roten_v1_shout_cd"
  };

  /* =========================================================
     DOM
  ========================================================= */
  const $ = (q, el=document)=>el.querySelector(q);
  const stageBg      = $("#stageBg");
  const stageVisitor = $("#stageVisitor");
  const stageName    = $("#stageName");
  const stageMsg     = $("#stageMsg");
  const stageTimeTag = $("#stageTimeTag");

  /* =========================================================
     Utils
  ========================================================= */
  const now = ()=>Date.now();
  const pick = (a)=>a[Math.floor(Math.random()*a.length)];
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function isNight(){
    const h = new Date().getHours();
    return h>=18 || h<=5;
  }

  function applyDayNight(){
    stageBg.src = isNight() ? ASSETS.bgNight : ASSETS.bgDay;
    stageTimeTag.textContent = isNight() ? "夜" : "昼";
  }

  /* =========================================================
     来店ステージ（滞在管理）
  ========================================================= */
  let stayTimer = null;
  let talkTimer = null;

  function clearStageTimers(){
    if(stayTimer){ clearTimeout(stayTimer); stayTimer=null; }
    if(talkTimer){ clearInterval(talkTimer); talkTimer=null; }
  }

  function setStageEmpty(msg="まだ誰も来ていない。"){
    clearStageTimers();
    stageVisitor.classList.remove("show");
    stageName.textContent = "—";
    stageMsg.textContent  = msg;
  }

  function showVisitor(visitor){
    clearStageTimers();

    stageVisitor.src = visitor.url;
    stageVisitor.classList.add("show");
    stageName.textContent = visitor.name;

    const lines = VISITOR_LINES[visitor.type] || ["……"];
    stageMsg.textContent = pick(lines);

    /* セリフ切り替え */
    talkTimer = setInterval(()=>{
      stageMsg.textContent = pick(lines);
    }, rand(3000,6000));

    /* 滞在時間 */
    stayTimer = setTimeout(()=>{
      setStageEmpty("……考えた末、去っていった。");
    }, rand(10000,30000));
  }

  /* =========================================================
     呼び込み
  ========================================================= */
  $("#shoutBtn").addEventListener("click", ()=>{
    const cd = JSON.parse(localStorage.getItem(LS.shout)||'{"next":0}');
    if(cd.next > now()) return;

    const v = pick(ASSETS.visitors);
    showVisitor(v);

    cd.next = now() + 60000;
    localStorage.setItem(LS.shout, JSON.stringify(cd));
  });

  /* =========================================================
     CSS微調整（位置）
  ========================================================= */
  stageVisitor.style.position = "absolute";
  stageVisitor.style.bottom   = "32px";   // ← 少し上
  stageVisitor.style.left     = "50%";
  stageVisitor.style.transform= "translateX(-50%)";
  stageVisitor.style.height   = "150px";
  stageVisitor.style.imageRendering = "pixelated";

  /* =========================================================
     boot
  ========================================================= */
  function boot(){
    applyDayNight();
    setStageEmpty();
    setInterval(applyDayNight, 60000);
  }
  boot();
})();
</script>


</body>
</html>


