<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒã‚¤éœ²åº—</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --btn:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* å›³é‘‘å¯„ã›ï¼ˆã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼‰ */
      --tile:84px;
      --thumbPad:5px;
      --gap:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    body.noscroll{ overflow:hidden; touch-action:none; }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 110px}
    .mono{font-family:var(--mono)}
    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn.warn{background:linear-gradient(180deg, rgba(255,211,138,.18), rgba(255,255,255,.10));}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:12px;
      white-space:nowrap;
    }

    /* header */
    .header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(to bottom, rgba(15,18,32,.95), rgba(15,18,32,.55));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .head-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
    .back{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:var(--btn); color:var(--text); font-size:18px; cursor:pointer;
    }
    .titlebox{flex:1;min-width:0}
    .title{font-size:16px;font-weight:900;letter-spacing:.02em}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* cards */
    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card-title{font-weight:900;font-size:14px}
    .card-desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}
    .card-b{padding:12px}

    /* stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px;
      min-height:62px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:900;margin-top:4px;display:flex;align-items:baseline;gap:6px}
    .stat .v small{font-size:11px;color:var(--muted);font-weight:700}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ */
    .stage-card{margin-bottom:12px}
    .stage{
      position:relative;
      width:100%;
      max-width:980px;
      height:192px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    @media (max-width: 520px){ .stage{height:180px;} }
    .stage-bg{width:100%;height:100%;object-fit:cover;image-rendering:pixelated;display:block}
    .stage-visitor{
      position:absolute;
      bottom:28px; left:50%;
      height:150px;
      image-rendering: pixelated;
      pointer-events:none;
      opacity:0;
      transform:translateX(-50%) translateY(8px);
      transition: opacity .45s ease, transform .45s ease;
      will-change: opacity, transform;
    }
    .stage-visitor.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .stage-ui{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .bubble{
      max-width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      border-radius:14px;
      padding:8px 10px;
      line-height:1.25;
    }
    .bubble .n{font-weight:900;font-size:12px}
    .bubble .m{color:rgba(255,255,255,.80);font-size:12px;margin-top:3px}
    .stage-tags{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .tag{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* layout (å³ã‚«ãƒ©ãƒ å‰Šé™¤ â†’ 1ã‚«ãƒ©ãƒ ) */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}

    /* shelves */
    .shelves{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:10px;}
    @media (max-width: 560px){ .shelves{grid-template-columns:1fr} }
    .shelf{
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08));
      overflow:hidden;
    }
    .shelf.locked{opacity:.6;filter:saturate(.7)}
    .shelf-top{
      padding:10px 10px 8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px dashed rgba(255,255,255,.16);
    }
    .shelf-name{font-weight:900;font-size:13px}
    .shelf-tag{font-size:11px;color:var(--muted)}
    .shelf-body{padding:10px;display:flex;gap:10px;align-items:flex-start}
    .slot{
      width:76px; height:108px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .slot img{
      width:100%;height:100%;
      object-fit:contain;
      padding:3px;
      image-rendering:pixelated;
      display:block;
    }
    .slot .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.65);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .slot .tier{
      position:absolute;left:6px;top:6px;
      font-size:10px;font-weight:900;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
    }
    .shelf-info{flex:1;min-width:0}
    .line{font-size:12px;color:var(--muted);line-height:1.35}
    .line b{color:var(--text)}
    .line + .line{margin-top:6px}
    .shelf-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}

    /* log */
    .log{
      font-size:12px;color:var(--muted);
      line-height:1.35;
      display:flex;flex-direction:column;gap:8px;
      max-height:260px; overflow:auto;
      padding-right:6px;
      -webkit-overflow-scrolling: touch;
    }
    .log .item{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.14);border-radius:12px;padding:8px 10px;}
    .log .t{color:rgba(255,255,255,.8);font-weight:900}
    .log .m{margin-top:3px}
    .log .s{margin-top:3px;font-family:var(--mono);font-size:11px;opacity:.85}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding:14px 12px;
      overscroll-behavior: contain;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background:rgba(15,18,32,.98);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 86vh;
      display:flex;
      flex-direction:column;
    }
    .sheet-h{
      padding:12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .sheet-h b{font-size:14px}
    .sheet-b{
      padding:12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
      touch-action: pan-y;
    }
    .sheet-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid var(--line);flex:0 0 auto}
    .close{width:40px;height:40px;border-radius:12px}

    /* å‡ºå“ã‚«ãƒ¼ãƒ‰é¸æŠ */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(var(--tile), 1fr));
      gap:var(--gap);
      align-items:stretch;
    }
    .citem{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      min-height:calc(var(--tile) + 34px);
      transition:transform .12s ease, filter .12s ease;
      display:flex;
      flex-direction:column;
    }
    .citem:active{transform:scale(.985)}
    .cimg{width:100%;height:var(--tile);display:block;background:rgba(0,0,0,.14);position:relative;}
    .cimg img{
      width:100%;height:100%;
      object-fit:contain;
      padding:var(--thumbPad);
      image-rendering:pixelated;
      image-rendering:crisp-edges;
      display:block;
    }
    .cimg .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.6);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .cimg .cnt{
      position:absolute; right:6px; top:6px;
      font-size:11px; font-weight:900;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.18);
      padding:3px 8px;border-radius:999px;
      font-family:var(--mono);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .cmeta{padding:7px 8px 9px;display:flex;flex-direction:column;gap:4px}
    .cname{font-size:12px;font-weight:900;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .csub{display:flex;align-items:center;justify-content:space-between;gap:6px;color:var(--muted);font-size:11px}
    .csub .tagmini{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--muted);max-width:100%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .csub .tagmini b{color:var(--text);font-weight:700}

    /* toastï¼ˆé€šå¸¸ï¼‰ */
    .toast{
      position:fixed;
      left:12px;
      right:12px;
      bottom:50%;
      transform: translateY(50%);
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:200;
    }
    .toast .box{
      width:min(680px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.65);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      pointer-events:none;
      display:none;
    }
    .toast .box.show{display:block;animation: popIn .18s ease-out;}
    @keyframes popIn{
      from{ transform: translateY(8px) scale(.98); opacity: 0; }
      to  { transform: translateY(0)   scale(1);   opacity: 1; }
    }

    /* â˜…å£²ã‚ŒãŸï¼šã•ã‚‰ã«ç›®ç«‹ãŸã›ã‚‹ï¼ˆã‚°ãƒ­ãƒ¼ï¼‹æ‹¡å¤§ï¼‹å¼·ã„æ ï¼‰ */
    .toast .box.toast--sale{
      border-color: rgba(255,211,138,.90);
      background: linear-gradient(180deg, rgba(255,211,138,.28), rgba(0,0,0,.80));
      box-shadow:
        0 22px 70px rgba(0,0,0,.70),
        0 0 0 1px rgba(255,211,138,.25) inset,
        0 0 40px rgba(255,211,138,.20);
      transform-origin:center;
      animation: salePop .20s ease-out, salePulse 1.2s ease-in-out infinite;
    }
    @keyframes salePop{
      from{ transform: translateY(16px) scale(.92); opacity:0; }
      to  { transform: translateY(0)    scale(1);   opacity:1; }
    }
    @keyframes salePulse{
      0%,100%{ filter: drop-shadow(0 0 0 rgba(255,211,138,0)); }
      50%{ filter: drop-shadow(0 0 14px rgba(255,211,138,.35)); }
    }
    .toast .box.toast--sale b{
      font-size:18px;
      letter-spacing:.02em;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
    }
    .toast .box.toast--sale .small{
      font-size:14px;
      color:rgba(255,255,255,.96);
    }

    /* â˜…å£²ã‚ŒãŸæ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆç”»é¢ãŒä¸€ç¬å…‰ã‚‹ï¼‰ */
    .sale-flash{
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(circle at 50% 55%, rgba(255,211,138,.22), rgba(0,0,0,0) 55%);
      opacity:0;
      z-index:190;
    }
    .sale-flash.show{
      animation: flash .55s ease-out;
    }
    @keyframes flash{
      0%{ opacity:0; }
      18%{ opacity:1; }
      100%{ opacity:0; }
    }

    /* å‘¼ã³è¾¼ã¿ãƒœã‚¿ãƒ³ã®å°ã•ãªã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
    .cd{
      font-size:11px;
      color:var(--muted);
      margin-left:8px;
      align-self:center;
    }
    .head-actions-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* â˜…å³ä¸‹å›ºå®šï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ */
    .fab-wrap{
      position:fixed;
      right:12px;
      bottom:12px;
      z-index:60;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .fab-wrap .btn{
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      border-radius:14px;
      padding:10px 12px;
    }
    .fab-wrap .btn.ghost{
      background: rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="head-inner">
      <button class="back" id="backBtn" type="button" aria-label="æˆ»ã‚‹">â†</button>
      <div class="titlebox">
        <div class="title">ãƒã‚¤éœ²åº—</div>
      </div>
      <div class="top-actions">
        <button class="btn ghost" id="helpBtn" type="button">ï¼Ÿ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="stats" id="stats"></div>

    <div class="card stage-card">
      <div class="card-h">
        <div>
          <div class="card-title">æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸</div>
          <div class="card-desc">èƒŒæ™¯ï¼ˆæ˜¼/å¤œï¼‰ã«ã€å®¢ã‚¿ã‚³æ°‘ï¼ˆé€éï¼‰ã‚’é‡ã­ã¦è¡¨ç¤ºã€‚èª°ã‚‚ã„ãªã„æ™‚ã¯èƒŒæ™¯ã ã‘ã€‚</div>
        </div>

        <!-- â˜…è©•åˆ¤ãƒ”ãƒ«ã‚’å‰Šé™¤ã—ã€ã“ã“ã«ä¿®ç†ã‚’ç§»å‹• -->
        <button class="btn ghost" id="fixBtn" type="button">ä¿®ç†</button>
      </div>
      <div class="card-b">
        <div class="stage" id="stage">
          <img id="stageBg" class="stage-bg" alt="" src="">
          <img id="stageVisitor" class="stage-visitor" alt="" src="">
          <div class="stage-ui">
            <div class="bubble">
              <div class="n" id="stageName">â€”</div>
              <div class="m" id="stageMsg">ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚</div>
            </div>
            <div class="stage-tags">
              <div class="tag" id="stageTimeTag">â€”</div>
              <div class="tag" id="stageNextTag">æ¬¡ï¼šâ€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æ£šï¼ˆå‡ºå“ï¼‰</div>
            <div class="card-desc">æ£šã«ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã ã‘ã€‚å£²è²·ã¯æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã§ç™ºç”Ÿã€‚</div>
          </div>

          <div class="head-actions-row">
            <button class="btn warn" id="shoutBtn" type="button">å‘¼ã³è¾¼ã¿</button>
            <div class="cd mono" id="shoutCd">â€”</div>
          </div>
        </div>
        <div class="card-b">
          <div class="shelves" id="shelves"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æœ€è¿‘ã®å‡ºæ¥äº‹</div>
            <div class="card-desc">ãƒ­ã‚°</div>
          </div>
        </div>
        <div class="card-b">
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â˜…å³ä¸‹å›ºå®šï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ -->
  <div class="fab-wrap" aria-label="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ">
    <button class="btn ghost" id="backupBtn" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <button class="btn ghost" id="restoreBtn" type="button">å¾©å…ƒ</button>
  </div>

  <div class="modal" id="pickModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶">
      <div class="sheet-h">
        <div>
          <b id="pickTitle">å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰</b>
          <div style="margin-top:4px;font-size:12px;color:var(--muted)" id="pickHint">æ£šã‚’é¸ã‚“ã§ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã€‚</div>
        </div>
        <button class="btn close" id="pickClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div class="cards" id="pickCards"></div>
        <div style="margin-top:10px;font-size:12px;color:var(--muted);display:none" id="pickEmpty">
          ãƒ€ãƒ–ã‚Šã‚«ãƒ¼ãƒ‰ï¼ˆå›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="pickCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="ãƒ˜ãƒ«ãƒ—">
      <div class="sheet-h">
        <b>éœ²åº—ã®éŠã³æ–¹</b>
        <button class="btn close" id="helpClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div style="font-size:12px;color:rgba(255,255,255,.86);line-height:1.65">
          ãƒ»æ£šã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ã€ã‹ã‚‰å‡ºå“<br>
          ãƒ»å£²è²·ã¯ã€Œæ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã€ã§ã®ã¿ç™ºç”Ÿ<br>
          ãƒ»æ¥å®¢ã ã‘ã§ã‚‚ EXP +1ï¼ˆè‚²ã¤ï¼‰<br>
          ãƒ»å£²ã‚ŒãŸã‚‰ EXP è¿½åŠ  +4ï¼ˆåˆè¨ˆ+5ï¼‰<br>
          ãƒ»ç‹æ§˜ãŒè²·ã†ã¨è©•åˆ¤UP / è»¢å£²ãŒè²·ã†ã¨è©•åˆ¤DOWN<br>
          ãƒ»ã€Œå‘¼ã³è¾¼ã¿ã€ã¯60ç§’ã«1å›ã€<b>é€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¬¡ï¼šxxxï¼‰ã¯å¤‰ãˆãšã«</b>ã€å‘¼ã³è¾¼ã‚“ã å®¢ã ã‘å…ˆã«æ¥ã‚‹<br>
          ãƒ»ã‚‚ã—é€šå¸¸ã®æ¥å®¢ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨è¢«ã£ãŸã‚‰ã€é€šå¸¸ã®æ–¹ã¯<b>å¾…æ©Ÿ</b>ã—ã¦ã€å‘¼ã³è¾¼ã¿å®¢ãŒå¸°ã£ãŸã‚‰æ¥ã‚‹<br><br>
          <b>æ£šè§£æ”¾</b><br>
          Lv1: æ£š1-2 / Lv2: æ£š3 / Lv3: æ£š4 / Lv4: æ£š5
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="helpOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <div class="sale-flash" id="saleFlash" aria-hidden="true"></div>

  <div class="toast" aria-live="polite" aria-atomic="true">
    <div class="box" id="toastBox">
      <b id="toastTitle">â€”</b>
      <div class="small" id="toastSub">â€”</div>
    </div>
  </div>

  <input id="restoreFile" type="file" accept="application/json" style="display:none" />

<script>
(() => {
  "use strict";

  /* =========================================================
     ã‚¢ã‚»ãƒƒãƒˆï¼ˆã‚ãªãŸã®ã¾ã¾ï¼‰
  ========================================================= */
   const ASSETS = {
    bgDay:   "https://ul.h3z.jp/lqCNnwQH.png",
    bgNight: "https://ul.h3z.jp/UtPlWaZz.png",
    visitors: [
      { id:"v01", name:"ã¤ã¶ã‚„ãã‚¿ã‚³æ°‘", type:"careful", url:"https://ul.h3z.jp/RpLPCRTc.png" },
      { id:"v02", name:"å³æ±ºã‚¿ã‚³æ°‘", type:"impulse", url:"https://ul.h3z.jp/TMXU9ztW.png" },
      { id:"v03", name:"å†·ã‚„ã‹ã—ã‚¿ã‚³æ°‘", type:"looker", url:"https://ul.h3z.jp/7NpD4FDk.png" },
      { id:"v04", name:"è¦‹ãˆãªã„ã‚¿ã‚³æ°‘", type:"picky",   url:"https://ul.h3z.jp/MZYfusKm.png" },
      { id:"v05", name:"ç‹æ§˜ã‚¿ã‚³æ°‘",   type:"king",    url:"https://ul.h3z.jp/wMM8PrcP.png" },
      { id:"v06", name:"ã‚ˆã£ã±ã‚‰ã„ã‚¿ã‚³æ°‘",   type:"flipper", url:"https://ul.h3z.jp/GLholN7M.png" },

      { id:"v07", name:"æœ­æŸã‚¿ã‚³æ°‘",     type:"rich",     url:"https://ul.h3z.jp/pZKu3lSE.png" },
      { id:"v08", name:"è¸ç ´ã‚¿ã‚³æ°‘",     type:"climber",  url:"https://ul.h3z.jp/45QUKopT.png" },
      { id:"v09", name:"ãƒŠãƒ“ã‚¿ã‚³æ°‘",     type:"guide",    url:"https://ul.h3z.jp/1RRwKTMt.png" },
      { id:"v10", name:"ã»ãã—ã‚¿ã‚³æ°‘",   type:"relax",    url:"https://ul.h3z.jp/dbBbLypa.png" },
      { id:"v11", name:"è¿”ã—è·äººã‚¿ã‚³æ°‘", type:"artisan",  url:"https://ul.h3z.jp/OA5StkvT.png" },
      { id:"v12", name:"ã‚¼ãƒ­ç†è«–ã‚¿ã‚³æ°‘", type:"diet",     url:"https://ul.h3z.jp/KVImBYZ8.png" },
      { id:"v13", name:"æ å¤–ã‚¿ã‚³æ°‘",     type:"overflow", url:"https://ul.h3z.jp/q4UllqyX.png" },
      { id:"v14", name:"æœªé–‹å°ä¿è­·ã‚¿ã‚³æ°‘",type:"collector",url:"https://ul.h3z.jp/zSvGyVq9.png" },
      { id:"v15", name:"è£æ£šã‚¿ã‚³æ°‘",     type:"shadow",   url:"https://ul.h3z.jp/IBKDrVAm.png" },
      { id:"v16", name:"æ›¿ãˆç‰ã‚¿ã‚³æ°‘",   type:"ramen",    url:"https://ul.h3z.jp/NViRwhdj.png" },
      { id:"v17", name:"æŠ•ã’éŠ­ã‚¿ã‚³æ°‘",   type:"streamer", url:"https://ul.h3z.jp/8PukOegd.png" },
      { id:"v18", name:"èˆŒåˆ¤å®šã‚¿ã‚³æ°‘",   type:"gourmet",  url:"https://ul.h3z.jp/We4UXFSI.png" },
      { id:"v19", name:"å³ãƒãƒªã‚¿ã‚³æ°‘",   type:"opener",   url:"https://ul.h3z.jp/9usFHTdU.png" },
      { id:"v20", name:"å®´ã‚¿ã‚³æ°‘",       type:"party",    url:"https://ul.h3z.jp/pByCAUMC.png" },
      { id:"v21", name:"è¦šæ‚Ÿã‚¿ã‚³æ°‘",     type:"pilgrim",  url:"https://ul.h3z.jp/eW2dluw2.png" }
    ]
  };


  const VISITOR_LINES = {
    careful: ["ã©ã†ã—ã‚ˆã†ã‹ãªâ€¦","ã‚‚ã†å°‘ã—è¦‹ã¦ã‹ã‚‰â€¦","ä»Šæ—¥ã¯è²·ã†ã¹ãã‹â€¦","è²¡å¸ƒã«ç›¸è«‡ä¸­â€¦ï¼ˆæ—¢èª­ã‚¹ãƒ«ãƒ¼ï¼‰"],
    impulse: ["ãŠã£ã€ã„ã„ã˜ã‚ƒã‚“","ä»ŠãŒè²·ã„æ™‚ã‹ã‚‚ï¼","ã“ã‚Œã„ã£ã¨ãï¼Ÿ","å‹¢ã„ã§è²·ã†ï¼â€¦ãŸã¶ã‚“ï¼"],
    looker:  ["ãµãƒ¼ã‚“","è¦‹ã‚‹ã ã‘è¦‹ã‚ˆ","è³‘ã‚„ã‹ã ãªã‚","æ’®ã£ã¦å¸°ã‚‹ã‚ï¼ˆè²·ã‚ãªã„ï¼‰"],
    picky:   ["åŒ‚ã„ã¯æ‚ªããªã„â€¦","ç„¼ãã®ãƒ ãƒ©ã¯â€¦ï¼Ÿ","æ…é‡ã«é¸ã³ãŸã„","ä»Šæ—¥ã¯â€œæ™®é€šâ€ãŒå¼·ã„æ—¥â€¦"],
    king:    ["ã‚ˆã„ã€‚","ä½™ã¯è¿·ã‚ã¬ã€‚","ã“ã®æ£šâ€¦æ ¼ãŒã‚ã‚‹ã€‚","è²·ã†ã€‚ç•°è«–ã¯ãªã„ã€‚"],
    flipper: ["å›ã‚‹ã‹â€¦ï¼Ÿ","ã“ã‚Œã¯å‹•ãã€‚","åˆ©ç›Šã®åŒ‚ã„ãŒã™ã‚‹","è²·ã†ã€‚è©•åˆ¤ã¯çŸ¥ã‚‰ã‚“ã€‚"],
    rich: ["å€¤æ®µï¼Ÿ ã‚ã‚ã€é›°å›²æ°—ä»£ã ã‚ã†","é«˜ã„ï¼Ÿ ãã‚Œã¯â€œå¸Œå°‘â€ã¨ã„ã†æ„å‘³ã ","æ£šã”ã¨æ¬²ã—ã„ãŒâ€¦ä»Šæ—¥ã¯æˆ‘æ…¢ã™ã‚‹","ç„¼ãã®æ ¼ãŒé•ã†"],
    climber:["ã“ã®æ£šâ€¦ç™»ã‚Œã‚‹ãª","é…¸ç´ ãŒè–„ã„ã€‚ãƒ¬ã‚¢ã®é«˜åº¦ã ","é ‚ä¸Šï¼ˆURï¼‰ã¯è¿‘ã„â€¦æ°—ãŒã™ã‚‹","ã“ã“ã§æ’¤é€€ã¯æ¥ã "],
    guide:["ã“ã¡ã‚‰ãŒâ€œå¾Œæ‚”ã‚¾ãƒ¼ãƒ³â€ã§ã™","å³ã‚’è¦‹ã‚‹ã¨è²¡å¸ƒã€å·¦ã‚’è¦‹ã‚‹ã¨æ¬²æœ›","ä»Šè²·ã†ã¨â€œèªã‚Œã‚‹æ€ã„å‡ºâ€ã«ãªã‚Šã¾ã™","å‡ºå£ã¯â€¦ã‚ã€é–‰ã¾ã‚Šã¾ã—ãŸ"],
    relax:["è‚©ã®åŠ›ã€æŠœã„ã¦â€¦è²·ã„ãªï¼Ÿ","æ‚©ã¿ã¯ç­‹è‚‰ã«å‡ºã‚‹","ã“ã®æ£šã€ãƒ„ãƒœæŠ¼ã—ã¦ãã‚‹","ç‰©æ¬²ãƒªãƒ³ãƒ‘æµã‚Œã¦ã‚‹"],
    artisan:["ç„¼ãé¢â€¦ç¾ã—ã„","ã“ã‚Œã¯è¿”ã—ãŒç¥","æ‰‹ãŒå‹æ‰‹ã«å›è»¢ã‚’æƒ³åƒã™ã‚‹","â€¦è²·ã†ç†ç”±ãŒå¤šã™ãã‚‹"],
    diet:["ã“ã‚Œã¯ã‚«ãƒ¼ãƒ‰ã€‚ã¤ã¾ã‚Š0ã‚«ãƒ­ãƒªãƒ¼","è²·ã£ã¦ã‚‚å¤ªã‚‰ãªã„ã€‚ã‚€ã—ã‚ç—©ã›ã‚‹","ç½ªæ‚ªæ„ŸãŒç„¼ã‹ã‚Œã¦ã„ã‚‹","ç†è«–ä¸Šã€ç„¡é™ã«è²·ãˆã‚‹"],
    overflow:["ã‚ã€ä¿ºã¡ã‚‡ã£ã¨ã¯ã¿å‡ºã¦ã‚‹ï¼Ÿ","æ£šã‹ã‚‰å‡ºã¦ã‚‹ã®ãŒå‘³","è¦æ ¼å¤–ãŒä¸€ç•ªã†ã¾ã„","æ ã«åã¾ã‚‰ãªã„äººç”Ÿã§ã­"],
    collector:["è§¦ã‚‰ãªã„ã€‚çœºã‚ã‚‹","è²·ã†ã‹â€¦ä¿å­˜ã‹â€¦","ã“ã‚Œã¯2æšå¿…è¦ãªã‚„ã¤","æœªæ‰€æŒã®åŒ‚ã„ãŒã™ã‚‹"],
    shadow:["è¡¨ã«å‡ºã¦ã‚‹ã®ãŒå…¨ã¦ã¨ã¯é™ã‚‰ã‚“","ã“ã®æ£šã€è£ãŒã‚ã‚‹","ç›¸å ´ã¯â€¦ã¾ã é™ã‹ã ãª","ç„¼ã‹ã‚Œã¦ã„ã‚‹ã®ã¯èª°ã ï¼Ÿ"],
    ramen:["ã“ã‚Œã¯â€¦æ¿ƒã„","æ›¿ãˆç‰ï¼ˆè¿½åŠ è³¼å…¥ï¼‰ã§ãã‚‹ï¼Ÿ","ã‚¹ãƒ¼ãƒ—ã¯ç„¡ã„ãŒæ·±ã¿ã¯ã‚ã‚‹","ã€†ã«1æšã€ã„ã£ã¨ãã‹"],
    streamer:["ã¿ã‚“ãªè¦‹ã¦ã‚‹ã€œï¼Ÿ","ä»Šã‹ã‚‰é‹è©¦ã—ã™ã‚‹ã‚ˆã€œ","å½“ãŸã£ãŸã‚‰ç¥å›","å¤–ã‚Œã¦ã‚‚â€œç¾å‘³ã—ã„â€"],
    gourmet:["é¦™ã‚ŠãŒèªã‚Šã‹ã‘ã¦ãã‚‹","ç„¼ãã®æ€æƒ³ãŒã‚ã‚‹","ã“ã‚Œã¯â€œé£Ÿå¾Œã«èªã‚Œã‚‹â€","è»½ç‡ã«ã¯è²·ãˆãªã„"],
    opener:["é–‹ã‘ãŸã„","ä»Šã™ãé–‹ã‘ãŸã„","çµæœã‚ˆã‚Šâ€œéŸ³â€","æˆ‘æ…¢ï¼Ÿ ãªã«ãã‚Œï¼Ÿ"],
    party:["ä»Šæ—¥ã¯å…¨éƒ¨ç¥­ã‚Š","è²¡å¸ƒï¼Ÿ é…”ã£ã¦ã‚‹","æ™¯æ°—ã‚ˆãç„¼ã“ã†","è²·ã†ç†ç”±ã—ã‹ãªã„"],
    pilgrim:["ã“ã“ã¾ã§6æ™‚é–“","è²·ã‚ãªã„é¸æŠè‚¢ã¯ç„¡ã„","å¸°ã‚Šã‚‚6æ™‚é–“","è¨˜å¿µã«ãªã‚‹ã‚„ã¤é ¼ã‚€"]
  };

  const LEAVE_LINES = [
    "â€¦â€¦è²¡å¸ƒã¨å¿ƒãŒã€ä»Šæ—¥ã¯å™›ã¿åˆã‚ãªã‹ã£ãŸã€‚",
    "â€¦â€¦ã¾ãŸæ¥ã‚‹ã€‚ç„¼ã‹ã‚Œã‚‹è¦šæ‚ŸãŒã§ããŸã‚‰ã€‚",
    "â€¦â€¦è²·ã‚ãªã„å‹‡æ°—ã‚‚ã€ç«‹æ´¾ãªæ¶ˆè²»è¡Œå‹•ã ã‚ˆã­ã€‚",
    "â€¦â€¦ä»Šã¯ãã®æ™‚ã˜ã‚ƒãªã„ã€‚ãŸã“ç„¼ããŒãã†è¨€ã£ãŸã€‚",
    "â€¦â€¦æ£šã®åœ§ãŒå¼·ã™ãã¦ã€ä¿ºãŒç„¼ã‘ãŸã€‚",
    "â€¦â€¦å¸°å®…ã—ã¦ã‹ã‚‰å¾Œæ‚”ã™ã‚‹äºˆå®šã§ã™ã€‚",
    "â€¦â€¦ä»Šæ—¥ã¯è²·ã‚ãªã‹ã£ãŸã€‚é€†ã«ä¸€ç”Ÿè¦šãˆã¦ã‚‹"
  ];

  const GOALS = [
    { id:"cheap", label:"å®‰ã„ã®ã‚’ç‹™ã£ã¦ã‚‹" },
    { id:"rare",  label:"SRä»¥ä¸ŠãŒæ¬²ã—ã„" },
    { id:"ur",    label:"URä»¥ä¸Šã—ã‹å‹ãŸã‚“" },
    { id:"any",   label:"ãªã‚“ã§ã‚‚ã„ã„ã€æ°—åˆ†" }
  ];
  function goalLines(goalId){
    const map = {
      cheap: ["ã‚³ã‚¹ãƒ‘â€¦ã‚³ã‚¹ãƒ‘â€¦","å®‰ãç„¼ã‹ã‚ŒãŸã„â€¦","å€¤æœ­ã«ç„¼ã‹ã‚Œã‚‹æº–å‚™OK","è²¡å¸ƒãŒè»½ã„ã€‚è»½ã„æ£šé ¼ã‚€ã€‚"],
      rare:  ["SRä»¥ä¸Šâ€¦æ¥ã„â€¦","å…‰ã£ã¦ãã‚Œâ€¦é ¼ã‚€â€¦","ãƒ¬ã‚¢ã®æ³¢ãŒæ¥ã¦ã‚‹æ°—ãŒã™ã‚‹","ã‚­ãƒ©ã®æ°—é…â€¦ï¼ˆå¹»ï¼‰"],
      ur:    ["URä»¥ä¸ŠãŒç„¡ã„ãªã‚‰å¸°ã‚‹ã€‚","URâ€¦URâ€¦ï¼ˆå‘ªæ–‡ï¼‰","å…‰ã®åœ§ã‚’æ„Ÿã˜ãŸã„","æ´¾æ‰‹ã«ç„¼ã‹ã‚ŒãŸã„"],
      any:   ["ä»Šæ—¥ã¯ãƒãƒªã§æ±ºã‚ã‚‹ã€‚","é‹å‘½ã«ä»»ã›ã‚‹ã€‚","æ£šã«å‘¼ã°ã‚ŒãŸæ°—ãŒã™ã‚‹ã€‚","è„³å†…ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ã§æ±ºã‚ã‚‹ã€‚"]
    };
    return map[goalId] || ["â€¦â€¦"];
  }

  const LS = {
    octo:     "roten_v1_octo",
    myshop:   "roten_v1_myshop",
    log:      "roten_v1_log",
    lvl:      "roten_v1_level",
    rep:      "roten_v1_rep",
    tick:     "roten_v1_shop_tick",
    shout:    "roten_v1_shout_cd",
    farmBook: "tf_v1_book",
    stage:    "roten_v1_stage",

    // â˜…è¿½åŠ ï¼šå‘¼ã³è¾¼ã¿/å¾…æ©Ÿã‚­ãƒ¥ãƒ¼ï¼ˆæ¬¡è¡¨ç¤ºã«å½±éŸ¿ã—ãªã„ï¼‰
    queue:    "roten_v1_queue"
  };

  const $ = (q, el=document) => el.querySelector(q);

  const statsEl = $("#stats");
  const shelvesEl = $("#shelves");
  const logEl = $("#log");

  const stageBg = $("#stageBg");
  const stageVisitor = $("#stageVisitor");
  const stageName = $("#stageName");
  const stageMsg = $("#stageMsg");
  const stageTimeTag = $("#stageTimeTag");
  const stageNextTag = $("#stageNextTag");

  const pickModal = $("#pickModal");
  const pickCardsEl = $("#pickCards");
  const pickEmptyEl = $("#pickEmpty");
  const pickTitleEl = $("#pickTitle");
  const pickHintEl = $("#pickHint");
  const pickCloseBtn = $("#pickClose");
  const pickCancelBtn = $("#pickCancel");

  const helpModal = $("#helpModal");
  const helpBtn = $("#helpBtn");
  const helpClose = $("#helpClose");
  const helpOk = $("#helpOk");

  const toastBox = $("#toastBox");
  const toastTitle = $("#toastTitle");
  const toastSub = $("#toastSub");
  const saleFlash = $("#saleFlash");

  const backBtn = $("#backBtn");
  const shoutBtn = $("#shoutBtn");
  const shoutCdEl = $("#shoutCd");
  const backupBtn = $("#backupBtn");
  const restoreBtn = $("#restoreBtn");
  const restoreFile = $("#restoreFile");
  const fixBtn = $("#fixBtn");

  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const now = () => Date.now();
  const fmt = (n) => (Number(n||0)).toLocaleString("ja-JP");
  const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
  /* ==========================
   â˜…ã“ã“ã«è¿½åŠ ï¼ˆå‘¼ã³è¾¼ã¿å°‚ç”¨ã‚»ãƒªãƒ•ï¼‰
========================== */
const SHOUT_LINES = [
  "ğŸ”¥ ç„¼ãã®åŒ‚ã„ã‚’æ’’ã„ãŸï¼ã‚¿ã‚³æ°‘ã®è¶³ãŒå‘ãâ€¦ï¼",
  "å±‹å°å‰ãŒã–ã‚ã¤ã„ã¦ããŸâ€¦ï¼ã„ã¾ãªã‚‰é‡£ã‚Œã‚‹ï¼",
  "ã‚¿ã‚³æ°‘ãƒ›ã‚¤ãƒ›ã‚¤ç™ºå‹•ï¼â€¦â€¦å¯„ã£ã¦ãã‚‹ã€å¯„ã£ã¦ãã‚‹ï¼",
  "ã€Šå®¢å¼•ãã€‹ç™ºå‹•ï¼æ£šã«è¦–ç·šãŒåˆºã•ã£ã¦ã‚‹â€¦ï¼",
  "ç„¼ããŸã¦ã‚ªãƒ¼ãƒ©æ”¾å‡ºï¼â€œè²·ã†æ°—ã®æ°—é…â€ãŒå¢—ãˆãŸï¼",
  "ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆç‡UPï¼â€¦â€¦èª°ã‹ãŒè¿‘ã¥ã„ã¦ã„ã‚‹ã€‚",
  "åŒ‚ã„ãƒ¬ãƒ™ãƒ«MAXï¼è²¡å¸ƒãŒéœ‡ãˆã‚‹éŸ³ãŒã™ã‚‹â€¦",
  "è¡Œåˆ—ã®èŠ½ãŒå‡ºãŸï¼ã“ã®ã¾ã¾è‚²ã¦â€¦ï¼",
  "å±‹å°ãƒ‘ãƒ¯ãƒ¼å……å¡«å®Œäº†ã€‚ã‚ã¨ã¯å®¢ãŒç„¼ã‹ã‚Œã‚‹ã ã‘ã€‚",
  "â€¦â€¦åŒ‚ã„ãŒé¢¨ã«ä¹—ã£ãŸã€‚ç„¼ã‹ã‚Œã«æ¥ã‚‹æ°—é…ã€‚",
  "å®¢å¯„ã›æˆåŠŸï¼ã‚¿ã‚³æ°‘ãƒ¬ãƒ¼ãƒ€ãƒ¼ç‚¹æ»…ä¸­ï¼",
  "æ£šã®å‰ã ã‘ç©ºæ°—ãŒé•ã†â€¦ã„ã¾æ¥ã‚‹ã€‚"
];

let lastShoutLine = "";

function pickShoutLine(){
  if(SHOUT_LINES.length === 0) return "å‘¼ã³è¾¼ã¿ï¼";
  if(SHOUT_LINES.length === 1) return SHOUT_LINES[0];

  let s = pick(SHOUT_LINES);
  if(s === lastShoutLine){
    s = pick(SHOUT_LINES);
  }
  lastShoutLine = s;
  return s;
}

  const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  function safeJSON(raw, fallback){ try{ return JSON.parse(raw);}catch(e){ return fallback; } }
  function lsGet(key, fallback){
    const raw = localStorage.getItem(key);
    if(raw==null) return fallback;
    return safeJSON(raw, fallback);
  }
  function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function triggerSaleFlash(){
    saleFlash.classList.remove("show");
    void saleFlash.offsetWidth;
    saleFlash.classList.add("show");
  }

  function toast(t, s, type){
    toastTitle.textContent = t;
    toastSub.textContent = s || "";
    toastBox.classList.remove("toast--sale");
    if(type === "sale"){
      toastBox.classList.add("toast--sale");
      triggerSaleFlash();
    }
    toastBox.classList.add("show");
    clearTimeout(toastBox.__t);
    toastBox.__t = setTimeout(()=>{
      toastBox.classList.remove("show");
      toastBox.classList.remove("toast--sale");
    }, (type==="sale" ? 4200 : 3000));
  }

  function pushLog(title, msg, meta){
    const log = lsGet(LS.log, { ver:1, items:[] });
    log.items = Array.isArray(log.items) ? log.items : [];
    log.items.unshift({ at: now(), title, msg, meta: meta || "" });
    log.items = log.items.slice(0, 60);
    lsSet(LS.log, log);
    renderLog();
  }

  function renderLog(){
    const log = lsGet(LS.log, { ver:1, items:[] });
    const items = Array.isArray(log.items) ? log.items : [];
    if(items.length === 0){
      logEl.innerHTML = `<div class="item"><div class="t">ã¾ã ä½•ã‚‚èµ·ãã¦ã„ãªã„</div><div class="m">æ£šã«ãƒ€ãƒ–ã‚Šã‚«ãƒ¼ãƒ‰ã‚’å‡ºå“ã™ã‚‹ã¨ã€æ¥å®¢ãŒå§‹ã¾ã‚‹ã‚ˆã€‚</div></div>`;
      return;
    }
    logEl.innerHTML = items.map(it => {
      const d = new Date(it.at);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `
        <div class="item">
          <div class="t">${hh}:${mm}ï½œ${escapeHTML(it.title)}</div>
          <div class="m">${escapeHTML(it.msg)}</div>
          ${it.meta ? `<div class="s">${escapeHTML(it.meta)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  function isNight(){
    const h = new Date().getHours();
    return (h >= 18 || h <= 5);
  }
  function applyDayNight(){
    const night = isNight();
    stageBg.src = night ? ASSETS.bgNight : ASSETS.bgDay;
    stageTimeTag.textContent = night ? "å¤œ" : "æ˜¼";
  }

  /* ==========================
     ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹
  ========================== */
  const STAGE_DEFAULT = {
    ver:1,
    hasVisitor:false,
    leaving:false,
    vUrl:"",
    vName:"â€”",
    vMsg:"ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚",
    vType:"",
    vGoal:"",
    stayMs:0,
    targetSlot:-1,
    updatedAt:0,
    source:"" // "normal" | "shout"
  };
  function loadStage(){
    const s = lsGet(LS.stage, STAGE_DEFAULT);
    return { ...STAGE_DEFAULT, ...s };
  }
  function saveStage(s){
    s.updatedAt = now();
    lsSet(LS.stage, s);
  }

  let stageTalkTimer=null;
  let stageSellTimer=null;
  let stageLeaveTimer=null;

  function clearStageTimers(){
    if(stageTalkTimer){ clearInterval(stageTalkTimer); stageTalkTimer=null; }
    if(stageSellTimer){ clearTimeout(stageSellTimer); stageSellTimer=null; }
    if(stageLeaveTimer){ clearTimeout(stageLeaveTimer); stageLeaveTimer=null; }
  }

  function renderStage(){
    const s = loadStage();
    stageName.textContent = s.vName || "â€”";
    stageMsg.textContent  = s.vMsg  || "â€”";
    if(s.vUrl) stageVisitor.src = s.vUrl;

    if(s.hasVisitor && s.vUrl && !s.leaving){
      stageVisitor.classList.add("show");
    }else{
      stageVisitor.classList.remove("show");
    }
  }

  /* ==========================
     â˜…å‘¼ã³è¾¼ã¿/å¾…æ©Ÿã‚­ãƒ¥ãƒ¼
     - shoutPending: å‘¼ã³è¾¼ã¿å®¢ã®å‡ºç¾äºˆç´„ï¼ˆé€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯è§¦ã‚‰ãªã„ï¼‰
     - normalPending: é€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã€Œåˆ°é”æ¸ˆã¿ã€ã«ãªã£ãŸæ¥å®¢ã‚’å¾…æ©Ÿã•ã›ã‚‹
  ========================== */
  const QUEUE_DEFAULT = {
    ver:1,
    shoutPending:false,
    shoutTargetSlot:null,
    shoutSpawnAt:0,   // äºˆç´„ã®å®Ÿè¡Œæ™‚åˆ»ï¼ˆ3ç§’å¾Œãªã©ï¼‰
    normalPending:false,
    normalTargetSlot:null,
    queuedAt:0
  };
  function loadQueue(){
    const q = lsGet(LS.queue, QUEUE_DEFAULT);
    return { ...QUEUE_DEFAULT, ...q };
  }
  function saveQueue(q){ lsSet(LS.queue, q); }

  function clearNormalPending(){
    const q = loadQueue();
    q.normalPending = false;
    q.normalTargetSlot = null;
    q.queuedAt = 0;
    saveQueue(q);
  }

  // ã€Œé€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ°é”ã—ãŸã®ã«ã€ä»Šã¯æ¥ã‚Œãªã„ã€æ™‚ã«å¾…æ©Ÿã•ã›ã‚‹
  function checkDueAndQueueNormal(){
    const st = loadStage();
    if(st.hasVisitor) {
      // å®¢ãŒã„ã‚‹é–“ã ã‘ã§ãªãã€å‘¼ã³è¾¼ã¿äºˆç´„ä¸­ã‚‚å¾…æ©Ÿåˆ¤å®šã«ä½¿ã†
    }

    const q = loadQueue();
    if(q.normalPending) return; // æ—¢ã«å¾…æ©Ÿä¸­

    const lv = loadLevel().lv;
    const shop = loadMyShop();
    const t = ensureNextAtForActiveSlots();
    const nowMs = now();

    const activeIdx = [];
    shop.slots.forEach((s, idx)=>{
      if(s.item && canUseSlot(idx, lv)) activeIdx.push(idx);
    });
    if(activeIdx.length===0) return;

    const due = activeIdx.filter(i => Number(t.nextAtBySlot[String(i)]||0) <= nowMs);
    if(due.length===0) return;

    // ã©ã‚Œã‚’å¾…æ©Ÿã•ã›ã‚‹ã‹ï¼šå¾“æ¥åŒæ§˜ã«ãƒ©ãƒ³ãƒ€ãƒ 
    const targetSlot = pick(due);

    q.normalPending = true;
    q.normalTargetSlot = targetSlot;
    q.queuedAt = nowMs;
    saveQueue(q);

    // è¡¨ç¤ºã¯è§¦ã‚‰ãªã„ï¼ˆæ¬¡ï¼šxxx ã®ã‚«ã‚¦ãƒ³ãƒˆã¯ãã®ã¾ã¾ 0 ã«ãªã‚‹ã ã‘ï¼‰
    pushLog("å¾…æ©Ÿ", `é€šå¸¸æ¥å®¢ï¼ˆæ£š${targetSlot+1}ï¼‰ãŒå¾…æ©Ÿã«ãªã£ãŸ`, "");
  }

  function setStageEmpty(msg){
    clearStageTimers();
    const s = loadStage();
    s.hasVisitor=false;
    s.leaving=false;
    s.vUrl="";
    s.vName="â€”";
    s.vMsg=msg || "ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚";
    s.vType="";
    s.vGoal="";
    s.stayMs=0;
    s.targetSlot=-1;
    s.source="";
    saveStage(s);
    renderStage();

    // â˜…å®¢ãŒå¸°ã£ãŸç¬é–“ã«ã€å¾…æ©Ÿã—ã¦ã„ã‚‹é€šå¸¸æ¥å®¢ãŒã„ã‚Œã°å³æ¥åº—ï¼ˆãŸã ã—å‘¼ã³è¾¼ã¿äºˆç´„ãŒå„ªå…ˆï¼‰
    trySpawnQueuedIfPossible();
  }

  function beginLeave(msg){
    const s = loadStage();
    if(!s.hasVisitor) return;
    s.leaving = true;
    saveStage(s);
    renderStage();
    setTimeout(()=> setStageEmpty(msg || pick(LEAVE_LINES)), 650);
  }

  /* ==========================
     é€šè²¨/ãƒ¬ãƒ™ãƒ«/è©•åˆ¤
  ========================== */
  function loadOcto(){
    const v = Number(localStorage.getItem(LS.octo) || 0);
    return isFinite(v) ? v : 0;
  }
  function saveOcto(v){
    localStorage.setItem(LS.octo, String(Math.max(0, Math.floor(Number(v||0)))));
  }

  const LEVEL_DEFAULT = { ver:1, lv:1, exp:0, totalVisit:0, totalSold:0, updatedAt: now() };
  function needExpFor(lv){
    const table = [0, 20, 35, 55, 80, 110, 145, 185];
    if(lv < table.length) return table[lv];
    return table[table.length-1] + (lv - (table.length-1)) * 50;
  }
  function loadLevel(){
    const v = lsGet(LS.lvl, LEVEL_DEFAULT);
    v.lv = Math.max(1, Number(v.lv||1));
    v.exp = Math.max(0, Number(v.exp||0));
    v.totalVisit = Math.max(0, Number(v.totalVisit||0));
    v.totalSold = Math.max(0, Number(v.totalSold||0));
    return v;
  }
  function saveLevel(v){ v.updatedAt = now(); lsSet(LS.lvl, v); }
  function addExp(delta){
    delta = Math.max(0, Math.floor(Number(delta||0)));
    const s = loadLevel();
    s.exp += delta;
    let leveled = false;
    while(s.exp >= needExpFor(s.lv)){
      s.exp -= needExpFor(s.lv);
      s.lv += 1;
      leveled = true;
    }
    saveLevel(s);
    return { state:s, leveled };
  }

  function loadRep(){
    const v = lsGet(LS.rep, { ver:1, rep:50 });
    v.rep = clamp(Number(v.rep ?? 50), 0, 100);
    v.rep = Math.round(v.rep);
    return v;
  }
  function saveRep(v){ v.rep = Math.round(clamp(Number(v.rep||0),0,100)); lsSet(LS.rep, v); }
  function addRep(delta){
    const s = loadRep();
    s.rep = Math.round(clamp(s.rep + Number(delta||0), 0, 100));
    saveRep(s);
    return s;
  }

  /* ==========================
     å›³é‘‘ï¼ˆtf_v1_bookï¼‰
  ========================== */
  function loadFarmBook(){
    const book = lsGet(LS.farmBook, { ver:1, got:{} });
    book.got = book.got || {};
    return book;
  }

  function findGotKeyByCardId(book, cardId){
    if(!book || !book.got) return null;
    const id = String(cardId||"");
    if(book.got[id]) return id;
    for(const k of Object.keys(book.got)){
      const c = book.got[k];
      const cid = String(c?.id ?? k);
      if(cid === id) return k;
    }
    return null;
  }

  function decrementBookCountById(cardId){
    const book = loadFarmBook();
    const key = findGotKeyByCardId(book, cardId);
    if(!key) return false;
    const c = book.got[key];
    const cnt = Math.max(0, Number(c?.count||0));
    if(cnt <= 0) return false;
    c.count = cnt - 1;
    book.got[key] = c;
    lsSet(LS.farmBook, book);
    return true;
  }

  function incrementBookCountById(cardId, cardSnapshot){
    const book = loadFarmBook();
    const key = findGotKeyByCardId(book, cardId) || String(cardId||"");
    const exist = book.got[key] || (cardSnapshot ? {...cardSnapshot} : { id: cardId, name: `ã‚«ãƒ¼ãƒ‰ ${cardId}` });
    const cnt = Math.max(0, Number(exist.count||0));
    exist.count = cnt + 1;

    if(cardSnapshot){
      if(!exist.id) exist.id = cardSnapshot.id || cardId;
      if(!exist.name && cardSnapshot.name) exist.name = cardSnapshot.name;
      if(!exist.img  && cardSnapshot.img)  exist.img  = cardSnapshot.img;
      if(!exist.rarity && cardSnapshot.rarity) exist.rarity = cardSnapshot.rarity;
    }
    book.got[key] = exist;
    lsSet(LS.farmBook, book);
    return true;
  }

  function listOwnedCardsFromBook(){
    const book = loadFarmBook();
    const got = book.got || {};
    const arr = Object.keys(got).map(k => {
      const c = got[k] || {};
      const count = Math.max(0, Number(c.count||0));
      const id = String(c.id || k);
      return {
        id,
        name: String(c.name || c.title || c.label || `ã‚«ãƒ¼ãƒ‰ ${id}`),
        img: c.img || c.image || c.url || c.src || "",
        rarity: String(c.rarity || c.rare || c.rank || ""),
        count,
        raw: c,
        _key: k
      };
    }).filter(x => x.count > 0);

    arr.sort((a,b)=> (b.count-a.count) || a.name.localeCompare(b.name, "ja"));
    return arr;
  }

  /* ==========================
     åº—ï¼ˆæ£šï¼‰
  ========================== */
  const SHOP_DEFAULT = {
    ver:1,
    slots: [
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
    ]
  };
  function loadMyShop(){
    const s = lsGet(LS.myshop, SHOP_DEFAULT);
    if(!Array.isArray(s.slots)) s.slots = SHOP_DEFAULT.slots.map(x=>({...x}));
    while(s.slots.length < 5) s.slots.push({ item:null, priceTier:"æ™®é€š", createdAt:0 });
    s.slots = s.slots.slice(0,5).map(x => ({
      item: x.item || null,
      priceTier: x.priceTier || "æ™®é€š",
      createdAt: Number(x.createdAt||0),
    }));
    return s;
  }
  function saveMyShop(s){ lsSet(LS.myshop, s); }

  function loadTick(){
    const t = lsGet(LS.tick, { ver:1, nextAtBySlot:{} });
    t.nextAtBySlot = t.nextAtBySlot || {};
    return t;
  }
  function saveTick(t){ lsSet(LS.tick, t); }

  function nextVisitDelayMs(){
    return (180 + Math.floor(Math.random()*121)) * 1000;
  }
  const SHELF_UNLOCK = [1,1,2,3,4];
  function canUseSlot(idx, lv){ return lv >= (SHELF_UNLOCK[idx] || 99); }

  function ensureNextAtForActiveSlots(){
    const shop = loadMyShop();
    const lv = loadLevel().lv;
    const t = loadTick();
    const n = now();

    shop.slots.forEach((slot, idx)=>{
      const active = !!slot.item && canUseSlot(idx, lv);
      const key = String(idx);
      if(!active){
        delete t.nextAtBySlot[key];
        return;
      }
      const cur = Number(t.nextAtBySlot[key]||0);
      if(!cur || cur < n - 60*1000){
        t.nextAtBySlot[key] = n + nextVisitDelayMs();
      }
    });

    saveTick(t);
    return t;
  }

  function updateNextTag(){
    const t = loadTick();
    const nowMs = now();
    const list = Object.values(t.nextAtBySlot || {}).map(v=>Number(v||0)).filter(v=>v>0);
    if(list.length === 0){
      stageNextTag.textContent = "æ¬¡ï¼šâ€”";
      return;
    }
    const nextAt = Math.min(...list);
    const sec = Math.max(0, Math.ceil((nextAt - nowMs)/1000));
    stageNextTag.textContent = `æ¬¡ï¼š${sec}s`;
  }

  function loadShout(){ return lsGet(LS.shout, { ver:1, nextOkAt:0 }); }
  function saveShout(s){ lsSet(LS.shout, s); }

  function updateShoutUI(){
    const cd = loadShout();
    const n = now();
    const remainMs = Math.max(0, Number(cd.nextOkAt||0) - n);
    const remain = Math.ceil(remainMs/1000);

    shoutBtn.textContent = "å‘¼ã³è¾¼ã¿";
    if(remain > 0){
      shoutBtn.disabled = true;
      shoutCdEl.textContent = `CD: ${remain}s`;
    }else{
      shoutBtn.disabled = false;
      shoutCdEl.textContent = "CD: OK";
    }
  }

  function basePriceFor(card){
    const p = Number(card?.raw?.price ?? card?.raw?.basePrice ?? card?.price ?? 0);
    if(isFinite(p) && p > 0) return Math.floor(p);

    const r = String(card?.rarity || "").toUpperCase();
    const map = { "N":500, "R":800, "SR":2000, "UR":5000, "LR":10000 };
    for(const k of Object.keys(map)){
      if(r === k || r.includes(k)) return map[k];
    }
    return 500;
  }
  function tierMult(tier){
    if(tier === "å®‰ã„") return 0.80;
    if(tier === "é«˜ã„") return 1.30;
    return 1.00;
  }
  function repFactor(rep){
    return 0.80 + (rep/100)*0.40;
  }

  const CUSTOMER_TYPES = [
    { id:"impulse",  name:"å³æ±ºã‚¿ã‚³æ°‘",       repDeltaOnBuy:+1, baseBuy:0.42 },
    { id:"picky",    name:"ã“ã ã‚ã‚Šã‚¿ã‚³æ°‘",   repDeltaOnBuy:+1, baseBuy:0.45 },
    { id:"king",     name:"ç‹æ§˜ã‚¿ã‚³æ°‘",       repDeltaOnBuy:+3, baseBuy:0.55 },
    { id:"flipper",  name:"è»¢å£²ã‚¿ã‚³æ°‘",       repDeltaOnBuy:-4, baseBuy:0.44 },
    { id:"careful",  name:"æ…é‡ã‚¿ã‚³æ°‘",       repDeltaOnBuy:+1, baseBuy:0.38 },
    { id:"looker",   name:"å†·ã‚„ã‹ã—ã‚¿ã‚³æ°‘",   repDeltaOnBuy:-1, baseBuy:0.22 },

    { id:"rich",     name:"æœ­æŸã‚¿ã‚³æ°‘",        repDeltaOnBuy:+2, baseBuy:0.50 },
    { id:"climber",  name:"è¸ç ´ã‚¿ã‚³æ°‘",        repDeltaOnBuy:+1, baseBuy:0.40 },
    { id:"guide",    name:"ãƒŠãƒ“ã‚¿ã‚³æ°‘",        repDeltaOnBuy: 0, baseBuy:0.30 },
    { id:"relax",    name:"ã»ãã—ã‚¿ã‚³æ°‘",      repDeltaOnBuy:+1, baseBuy:0.36 },
    { id:"artisan",  name:"è¿”ã—è·äººã‚¿ã‚³æ°‘",    repDeltaOnBuy:+2, baseBuy:0.46 },
    { id:"diet",     name:"ã‚¼ãƒ­ç†è«–ã‚¿ã‚³æ°‘",    repDeltaOnBuy:+1, baseBuy:0.48 },
    { id:"overflow", name:"æ å¤–ã‚¿ã‚³æ°‘",        repDeltaOnBuy: 0, baseBuy:0.33 },
    { id:"collector",name:"æœªé–‹å°ä¿è­·ã‚¿ã‚³æ°‘",  repDeltaOnBuy:+1, baseBuy:0.41 },
    { id:"shadow",   name:"è£æ£šã‚¿ã‚³æ°‘",        repDeltaOnBuy:-2, baseBuy:0.35 },
    { id:"ramen",    name:"æ›¿ãˆç‰ã‚¿ã‚³æ°‘",      repDeltaOnBuy:+1, baseBuy:0.44 },
    { id:"streamer", name:"æŠ•ã’éŠ­ã‚¿ã‚³æ°‘",      repDeltaOnBuy:+2, baseBuy:0.39 },
    { id:"gourmet",  name:"èˆŒåˆ¤å®šã‚¿ã‚³æ°‘",      repDeltaOnBuy:+2, baseBuy:0.37 },
    { id:"opener",   name:"å³ãƒãƒªã‚¿ã‚³æ°‘",      repDeltaOnBuy:+1, baseBuy:0.52 },
    { id:"party",    name:"å®´ã‚¿ã‚³æ°‘",          repDeltaOnBuy:-1, baseBuy:0.47 },
    { id:"pilgrim",  name:"è¦šæ‚Ÿã‚¿ã‚³æ°‘",        repDeltaOnBuy:+3, baseBuy:0.58 }
  ];

  function chooseCustomer(rep){
    const night = isNight();
    const weights = CUSTOMER_TYPES.map(t=>{
      if(t.id==="king")     return rep>=55 ? 7 : 3;
      if(t.id==="flipper")  return rep>=70 ? 4 : 7;
      if(t.id==="looker")   return night ? 10 : 14;
      if(t.id==="impulse")  return rep<40 ? 18 : 22;
      if(t.id==="careful")  return 16;
      if(t.id==="picky")    return rep>=60 ? 24 : 20;
      if(t.id==="rich")     return rep>=60 ? 10 : 6;
      if(t.id==="climber")  return night ? 6 : 9;
      if(t.id==="guide")    return 8;
      if(t.id==="relax")    return night ? 10 : 7;
      if(t.id==="artisan")  return rep>=55 ? 10 : 7;
      if(t.id==="diet")     return 9;
      if(t.id==="overflow") return 7;
      if(t.id==="collector")return rep>=50 ? 10 : 8;
      if(t.id==="shadow")   return night ? 11 : 6;
      if(t.id==="ramen")    return 9;
      if(t.id==="streamer") return rep>=45 ? 9 : 6;
      if(t.id==="gourmet")  return rep>=65 ? 10 : 6;
      if(t.id==="opener")   return 10;
      if(t.id==="party")    return night ? 10 : 6;
      if(t.id==="pilgrim")  return rep>=45 ? 8 : 5;
      return 8;
    });

    if(rep>=70){
      ["picky","gourmet","artisan","king","pilgrim"].forEach(id=>{
        const idx = CUSTOMER_TYPES.findIndex(x=>x.id===id);
        if(idx>=0) weights[idx] += 6;
      });
    }

    const total = weights.reduce((a,b)=>a+b,0) || 1;
    let r = Math.random() * total;
    for(let i=0;i<CUSTOMER_TYPES.length;i++){
      r -= weights[i];
      if(r <= 0) return CUSTOMER_TYPES[i];
    }
    return CUSTOMER_TYPES[0];
  }

  function pickVisitorAsset(customerId){
    const v = ASSETS.visitors.find(x=>x.type===customerId);
    return v || pick(ASSETS.visitors);
  }

  function chooseGoal(customerId){
    if(customerId==="king") return "rare";
    if(customerId==="flipper") return "cheap";
    if(customerId==="rich") return (Math.random()<0.55 ? "ur" : "rare");
    if(customerId==="collector") return "rare";
    if(customerId==="gourmet") return "rare";
    if(customerId==="opener") return "any";
    if(customerId==="pilgrim") return "ur";
    return pick(GOALS).id;
  }

  /* ==========================
     å‡ºå“å¯èƒ½ãƒ€ãƒ–ã‚Šç®—å‡º
  ========================== */
  function countListedById(){
    const shop = loadMyShop();
    const map = {};
    for(const s of shop.slots){
      const id = s?.item?.id;
      if(!id) continue;
      map[id] = (map[id]||0) + 1;
    }
    return map;
  }

  function listPickableDuplicateCards(){
    const owned = listOwnedCardsFromBook();
    const listedMap = countListedById();

    const pickable = [];
    for(const c of owned){
      const listed = Number(listedMap[c.id]||0);
      const spare = (Number(c.count||0) - 1 - listed);
      if(spare >= 1){
        pickable.push({
          id: c.id,
          name: c.name,
          img: c.img,
          rarity: c.rarity,
          spare,
          count: c.count,
          raw: c.raw
        });
      }
    }
    pickable.sort((a,b)=> (b.spare-a.spare) || a.name.localeCompare(b.name,"ja"));
    return pickable;
  }

  /* ==========================
     UIï¼šæ£š
  ========================== */
  function renderShelves(){
    const shop = loadMyShop();
    const lv = loadLevel().lv;

    shelvesEl.innerHTML = "";

    shop.slots.forEach((slot, idx)=>{
      const locked = !canUseSlot(idx, lv);
      const wrap = document.createElement("div");
      wrap.className = "shelf" + (locked ? " locked" : "");

      const top = document.createElement("div");
      top.className = "shelf-top";
      top.innerHTML = `
        <div>
          <div class="shelf-name">æ£š${idx+1}</div>
          <div class="shelf-tag">è§£æ”¾ï¼šLv${SHELF_UNLOCK[idx] || "?"}</div>
        </div>
        <div class="shelf-tag mono">${escapeHTML(slot.priceTier || "æ™®é€š")}</div>
      `;

      const body = document.createElement("div");
      body.className = "shelf-body";

      const slotEl = document.createElement("div");
      slotEl.className = "slot";
      slotEl.title = locked ? "æœªè§£æ”¾" : "ã‚¿ãƒƒãƒ—ã§å‡ºå“/å¤‰æ›´";

      if(slot.item && slot.item.img){
        slotEl.innerHTML = `
          <div class="tier">${escapeHTML(slot.priceTier||"æ™®é€š")}</div>
          <img alt="" src="${escapeHTML(slot.item.img)}">
        `;
      }else{
        slotEl.innerHTML = `<div class="ph">ç©ºã<br>ï¼ˆã‚¿ãƒƒãƒ—ã§å‡ºå“ï¼‰</div>`;
      }

      slotEl.addEventListener("click", ()=>{
        if(locked){
          toast("æœªè§£æ”¾", `ã“ã®æ£šã¯ Lv${SHELF_UNLOCK[idx]} ã§è§£æ”¾`, "");
          return;
        }
        openPickModal(idx);
      });

      const info = document.createElement("div");
      info.className = "shelf-info";

      const name = slot.item ? (slot.item.name || slot.item.id) : "ï¼ˆç©ºï¼‰";
      const rar  = slot.item ? (slot.item.rarity || "-") : "-";
      const base = slot.item ? basePriceFor(slot.item) : 0;
      const rep = loadRep().rep;
      const price = slot.item ? Math.max(1, Math.floor(base * tierMult(slot.priceTier) * repFactor(rep))) : 0;

      info.innerHTML = `
        <div class="line"><b>${escapeHTML(name)}</b></div>
        <div class="line">ãƒ¬ã‚¢ï¼š<b>${escapeHTML(rar)}</b></div>
        <div class="line">ç›®å®‰ä¾¡æ ¼ï¼š<b>${slot.item ? fmt(price) : "-"}</b></div>
        <div class="shelf-actions"></div>
      `;

      const actions = info.querySelector(".shelf-actions");

      const tierBtn = document.createElement("button");
      tierBtn.className = "btn mini";
      tierBtn.textContent = "å€¤æ®µï¼šåˆ‡æ›¿";
      tierBtn.disabled = locked;
      tierBtn.addEventListener("click", ()=>{
        const s = loadMyShop();
        const cur = s.slots[idx].priceTier || "æ™®é€š";
        const next = (cur==="æ™®é€š") ? "å®‰ã„" : (cur==="å®‰ã„") ? "é«˜ã„" : "æ™®é€š";
        s.slots[idx].priceTier = next;
        saveMyShop(s);
        renderAll();
      });

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn mini ghost";
      removeBtn.textContent = "å–ã‚Šä¸‹ã’";
      removeBtn.disabled = locked || !slot.item;
      removeBtn.addEventListener("click", ()=>{
        const s = loadMyShop();
        const it = s.slots[idx].item;
        if(!it) return;
        s.slots[idx].item = null;
        s.slots[idx].createdAt = 0;
        saveMyShop(s);

        incrementBookCountById(it.id, it.raw || it);
        pushLog("å–ã‚Šä¸‹ã’", `${it.name||it.id} ã‚’æ£š${idx+1}ã‹ã‚‰æˆ»ã—ãŸ`, it.id);
        renderAll();
      });

      actions.appendChild(tierBtn);
      actions.appendChild(removeBtn);

      body.appendChild(slotEl);
      body.appendChild(info);

      wrap.appendChild(top);
      wrap.appendChild(body);
      shelvesEl.appendChild(wrap);
    });

    ensureNextAtForActiveSlots();
    updateNextTag();
  }

  /* ==========================
     UIï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  ========================== */
  function renderStats(){
    const lv = loadLevel();
    const rep = loadRep().rep;

    const shop = loadMyShop();
    const listed = shop.slots.filter(s=>!!s.item).length;

    statsEl.innerHTML = `
      <div class="stat"><div class="k">ã‚ªã‚¯ãƒˆ</div><div class="v"><span class="good">${fmt(loadOcto())}</span><small>OCTO</small></div></div>
      <div class="stat"><div class="k">ãƒ¬ãƒ™ãƒ«</div><div class="v">${lv.lv}<small>EXP ${fmt(lv.exp)}/${fmt(needExpFor(lv.lv))}</small></div></div>
      <div class="stat"><div class="k">è©•åˆ¤</div><div class="v"><span class="${rep>=60?'good':rep>=40?'warn':'bad'}">${rep}</span><small>/100</small></div></div>
      <div class="stat"><div class="k">å‡ºå“</div><div class="v">${listed}<small>/5</small></div></div>
    `;
  }

  /* ==========================
     ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‰
  ========================== */
  function lockBodyScroll(){ document.body.classList.add("noscroll"); }
  function unlockBodyScroll(){ document.body.classList.remove("noscroll"); }

  /* ==========================
     å‡ºå“ãƒ”ãƒƒã‚«ãƒ¼
  ========================== */
  let pickTargetIdx = -1;

  function openPickModal(slotIdx){
    pickTargetIdx = slotIdx;

    const lv = loadLevel().lv;
    if(!canUseSlot(slotIdx, lv)){
      toast("æœªè§£æ”¾", `æ£š${slotIdx+1}ã¯Lv${SHELF_UNLOCK[slotIdx]}ã§è§£æ”¾`, "");
      return;
    }

    const shop = loadMyShop();
    const current = shop.slots[slotIdx]?.item;

    pickTitleEl.textContent = `æ£š${slotIdx+1} ã«å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰`;
    pickHintEl.textContent = current
      ? `ç¾åœ¨ï¼š${current.name||current.id}ï¼ˆå¤‰æ›´ã§ãã¾ã™ï¼‰`
      : "ãƒ€ãƒ–ã‚Šï¼ˆå›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ï¼‰ã‹ã‚‰é¸ã¹ã¾ã™ã€‚";

    renderPickCards();

    pickModal.classList.add("show");
    pickModal.setAttribute("aria-hidden","false");
    lockBodyScroll();
  }

  function closePickModal(){
    pickModal.classList.remove("show");
    pickModal.setAttribute("aria-hidden","true");
    pickCardsEl.innerHTML = "";
    pickEmptyEl.style.display = "none";
    pickTargetIdx = -1;
    unlockBodyScroll();
  }

  function renderPickCards(){
    const list = listPickableDuplicateCards();

    pickCardsEl.innerHTML = "";
    if(list.length === 0){
      pickEmptyEl.style.display = "block";
      return;
    }
    pickEmptyEl.style.display = "none";

    const frag = document.createDocumentFragment();

    for(const c of list){
      const item = document.createElement("div");
      item.className = "citem";
      item.setAttribute("role","button");
      item.setAttribute("tabindex","0");

      const imgWrap = document.createElement("div");
      imgWrap.className = "cimg";

      if(c.img){
        imgWrap.innerHTML = `
          <img alt="${escapeHTML(c.name||c.id)}" loading="lazy" decoding="async" src="${escapeHTML(c.img)}">
          <div class="cnt">Ã—${escapeHTML(c.spare)}</div>
        `;
      }else{
        imgWrap.innerHTML = `<div class="ph">ç”»åƒãªã—</div><div class="cnt">Ã—${escapeHTML(c.spare)}</div>`;
      }

      const meta = document.createElement("div");
      meta.className = "cmeta";
      meta.innerHTML = `
        <div class="cname">${escapeHTML(c.name||"(no name)")}</div>
        <div class="csub">
          <div class="tagmini"><span>#${escapeHTML(c.id)}</span></div>
          <div class="tagmini"><b>${escapeHTML(c.rarity||"-")}</b></div>
        </div>
      `;

      item.appendChild(imgWrap);
      item.appendChild(meta);

      const onSelect = ()=> selectCardForSlot(pickTargetIdx, c);

      item.addEventListener("click", onSelect);
      item.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" || e.key===" "){
          e.preventDefault();
          onSelect();
        }
      });

      frag.appendChild(item);
    }

    pickCardsEl.appendChild(frag);
  }

  function selectCardForSlot(slotIdx, pickedCard){
    const shop = loadMyShop();
    const slot = shop.slots[slotIdx];
    if(!slot) return;

    if(slot.item){
      incrementBookCountById(slot.item.id, slot.item.raw || slot.item);
    }

    const ok = decrementBookCountById(pickedCard.id);
    if(!ok){
      toast("å‡ºå“ã§ããªã„", "å›³é‘‘å´ã®æ•°ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆåŒæœŸãšã‚Œã®å¯èƒ½æ€§ï¼‰", "");
      renderAll();
      closePickModal();
      return;
    }

    slot.item = {
      id: pickedCard.id,
      name: pickedCard.name,
      img: pickedCard.img,
      rarity: pickedCard.rarity,
      raw: pickedCard.raw
    };
    slot.createdAt = now();
    shop.slots[slotIdx] = slot;
    saveMyShop(shop);

    pushLog("å‡ºå“", `${pickedCard.name||pickedCard.id} ã‚’æ£š${slotIdx+1}ã«ç½®ã„ãŸ`, pickedCard.id);
    toast("å‡ºå“OK", `æ£š${slotIdx+1}ã« ${pickedCard.name||pickedCard.id}`, "");

    ensureNextAtForActiveSlots();
    renderAll();
    closePickModal();
  }

  /* ==========================
     å£²è²·
  ========================== */
  function saleProcess(){
    const st = loadStage();
    if(!st.hasVisitor || st.leaving) return;

    const shop = loadMyShop();
    const slotIdx = st.targetSlot;
    const slot = shop.slots[slotIdx];
    if(!slot || !slot.item){
      beginLeave("â€¦â€¦ç›®å½“ã¦ã®æ£šãŒç©ºã ã£ãŸã€‚å®¢ã¯é»™ã£ã¦å¸°ã£ãŸã€‚");
      return;
    }

    const rep = loadRep().rep;
    const cust = CUSTOMER_TYPES.find(x=>x.id===st.vType) || CUSTOMER_TYPES[0];
    const base = basePriceFor(slot.item);
    const price = Math.max(1, Math.floor(base * tierMult(slot.priceTier) * repFactor(rep)));

    const stayMs = Number(st.stayMs||0);
    const stayFactor = clamp(stayMs/16000, 0.6, 1.25);

    let buyP = cust.baseBuy * stayFactor;

    const rar = String(slot.item.rarity||"").toUpperCase();
    const isSR = rar.includes("SR") || rar.includes("UR") || rar.includes("LR") || rar.includes("HR") || rar.includes("XR");
    const isUR = rar.includes("UR") || rar.includes("LR") || rar.includes("HR") || rar.includes("XR");

    if(st.vGoal==="cheap"){
      buyP *= (slot.priceTier==="å®‰ã„" ? 1.15 : slot.priceTier==="é«˜ã„" ? 0.80 : 1.0);
    }else if(st.vGoal==="rare"){
      buyP *= (isSR ? 1.15 : 0.92);
    }else if(st.vGoal==="ur"){
      buyP *= (isUR ? 1.18 : 0.78);
    }

    buyP = clamp(buyP, 0.05, 0.92);

    const willBuy = Math.random() < buyP;
    if(!willBuy){
      beginLeave(pick(LEAVE_LINES));
      return;
    }

    // å£²ã‚ŒãŸ
    saveOcto(loadOcto() + price);

    const lv = addExp(4);
    const repState = addRep(cust.repDeltaOnBuy);

    const soldItem = slot.item;
    shop.slots[slotIdx].item = null;
    shop.slots[slotIdx].createdAt = 0;
    saveMyShop(shop);

    // â˜…é€šå¸¸æ¥å®¢ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°ã¯ã€Œæ¥åº—ã—ãŸç¬é–“ã€æ‰±ã„ãªã®ã§ã€ã“ã“ã§æ¬¡å›ã‚’å†è¨­å®š
    const t = loadTick();
    t.nextAtBySlot = t.nextAtBySlot || {};
    t.nextAtBySlot[String(slotIdx)] = now() + nextVisitDelayMs();
    saveTick(t);

    pushLog("å£²ã‚ŒãŸï¼", `${soldItem.name||soldItem.id} ãŒ ${fmt(price)} OCTOã§å£²ã‚ŒãŸ`, `æ£š${slotIdx+1} / rep ${repState.rep}`);
    toast("ğŸ”¥ å£²ã‚ŒãŸï¼ï¼ ğŸ”¥", `${soldItem.name||soldItem.id} ï¼ +${fmt(price)} OCTO`, "sale");

    if(lv.leveled){
      pushLog("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—", `Lv${lv.state.lv}ã«ãªã£ãŸï¼`, "");
      toast("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼", `Lv${lv.state.lv}`, "");
    }

    beginLeave("â€¦â€¦æº€è¶³ã’ã«å¸°ã£ã¦ã„ã£ãŸã€‚");
    renderAll();
  }

  /* ==========================
     ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆè¡¨ç¤º/å†é–‹ï¼‰
  ========================== */
  function scheduleStage(){
    applyDayNight();
    renderStage();
    const st = loadStage();
    if(st.hasVisitor && !st.leaving){
      clearStageTimers();
      stageTalkTimer = setInterval(()=>{
        const s2 = loadStage();
        if(!s2.hasVisitor || s2.leaving) return;
        const baseLines = VISITOR_LINES[s2.vType] || ["â€¦â€¦"];
        const gLines = goalLines(s2.vGoal);
        s2.vMsg = (Math.random()<0.55) ? pick(baseLines) : pick(gLines);
        saveStage(s2);
        renderStage();
      }, rand(3000, 6000));

      stageSellTimer = setTimeout(()=> saleProcess(), Math.max(1000, Math.floor((st.stayMs||12000) - 1000)));
      stageLeaveTimer = setTimeout(()=> beginLeave(pick(LEAVE_LINES)), Math.max(5000, Math.floor(st.stayMs||12000)));
      return;
    }
    setStageEmpty("ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚");
  }

  let spawnLockUntil = 0;

  /* ==========================
     â˜…å…±é€šï¼šæ¥å®¢ç”Ÿæˆï¼ˆnormal / shout / queued normalï¼‰
     - type: "normal" or "shout"
     - IMPORTANT: shout ã¯ tick(nextAtBySlot) ã‚’å¤‰æ›´ã—ãªã„ï¼ˆæ¬¡ï¼šxxxè¡¨ç¤ºãŒå‹•ã‹ãªã„ï¼‰
  ========================== */
  function spawnVisitorSoon(targetSlot, type){
    const typeLabel = (type==="shout") ? "å‘¼ã³è¾¼ã¿" : "é€šå¸¸";
    toast("èª°ã‹ãã‚‹ï¼", `${typeLabel}ï¼šæ£š${targetSlot+1} ã‚’è¦‹ã¦ã‚‹æ°—é…â€¦`, "");

    spawnLockUntil = now() + 3500;

    setTimeout(()=>{
      const st2 = loadStage();
      if(st2.hasVisitor) return;

      const rep = loadRep().rep;
      const cust = chooseCustomer(rep);
      const asset = pickVisitorAsset(cust.id);
      const goal = chooseGoal(cust.id);

      const stayMs = rand(9000, 18000);
      const msg = pick(VISITOR_LINES[cust.id] || ["â€¦â€¦"]);

      const s = loadStage();
      s.hasVisitor = true;
      s.leaving = false;
      s.vType = cust.id;
      s.vName = asset.name || cust.name;
      s.vUrl = asset.url || "";
      s.vGoal = goal;
      s.vMsg = msg;
      s.stayMs = stayMs;
      s.targetSlot = targetSlot;
      s.source = (type==="shout") ? "shout" : "normal";
      saveStage(s);
      renderStage();

      const lvup = addExp(1);
      if(lvup.leveled){
        pushLog("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—", `Lv${lvup.state.lv}ã«ãªã£ãŸï¼`, "");
        toast("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼", `Lv${lvup.state.lv}`, "");
      }

      clearStageTimers();
      stageTalkTimer = setInterval(()=>{
        const s2 = loadStage();
        if(!s2.hasVisitor || s2.leaving) return;
        const baseLines = VISITOR_LINES[s2.vType] || ["â€¦â€¦"];
        const gLines = goalLines(s2.vGoal);
        s2.vMsg = (Math.random()<0.55) ? pick(baseLines) : pick(gLines);
        saveStage(s2);
        renderStage();
      }, rand(3000, 6000));

      stageSellTimer = setTimeout(()=> saleProcess(), Math.max(1000, stayMs - 1000));
      stageLeaveTimer = setTimeout(()=> beginLeave(pick(LEAVE_LINES)), stayMs);

      // â˜…é€šå¸¸/å¾…æ©Ÿã®é€šå¸¸ã ã‘ï¼šã“ã“ã§ã€Œæ¥åº—ã—ãŸã€æ‰±ã„ã«ã—ã¦æ¬¡å›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°
      if(type !== "shout"){
        const tickObj = loadTick();
        tickObj.nextAtBySlot[String(targetSlot)] = now() + nextVisitDelayMs();
        saveTick(tickObj);

        // å¾…æ©Ÿã ã£ãŸé€šå¸¸æ¥å®¢ã‚’æ¶ˆåŒ–ã—ãŸã®ã§ã‚¯ãƒªã‚¢
        const q = loadQueue();
        if(q.normalPending && Number(q.normalTargetSlot) === Number(targetSlot)){
          clearNormalPending();
        }
      }else{
        // â˜…å‘¼ã³è¾¼ã¿ã¯ nextAtBySlot ã‚’ä¸€åˆ‡è§¦ã‚‰ãªã„ï¼ˆæ¬¡ï¼šxxxè¡¨ç¤ºã¯å¤‰åŒ–ã•ã›ãªã„ï¼‰
        // ãŸã ã—ã€ãƒ­ã‚°ã¯æ®‹ã™
        pushLog("å‘¼ã³è¾¼ã¿æ¥åº—", `æ£š${targetSlot+1} ã«å‘¼ã³è¾¼ã¿å®¢ãŒæ¥ãŸ`, "");
      }

      renderAll();
    }, 3000);
  }

  // å®¢ãŒã„ãªã„ç¬é–“ã«ã€Œå¾…æ©Ÿä¸­ã®é€šå¸¸æ¥å®¢ã€ã‚’å„ªå…ˆçš„ã«å‡ºã™ï¼ˆãŸã ã—å‘¼ã³è¾¼ã¿äºˆç´„ãŒã‚ã‚‹ãªã‚‰å…ˆã«ãã£ã¡ï¼‰
  function trySpawnQueuedIfPossible(){
    const st = loadStage();
    if(st.hasVisitor) return;
    const nowMs = now();
    if(nowMs < spawnLockUntil) return;

    const q = loadQueue();

    // 1) å‘¼ã³è¾¼ã¿äºˆç´„ãŒã‚ã‚‹ãªã‚‰ã€äºˆç´„ã®æ™‚åˆ»ã‚’å¾…ã¤/å®Ÿè¡Œã™ã‚‹
    if(q.shoutPending){
      if(nowMs >= Number(q.shoutSpawnAt||0)){
        const target = Number(q.shoutTargetSlot);
        q.shoutPending = false;
        q.shoutTargetSlot = null;
        q.shoutSpawnAt = 0;
        saveQueue(q);
        spawnVisitorSoon(target, "shout");
      }
      return;
    }

    // 2) å¾…æ©Ÿä¸­ã®é€šå¸¸æ¥å®¢ãŒã„ã‚‹ãªã‚‰å³å‡ºã™
    if(q.normalPending && q.normalTargetSlot != null){
      const target = Number(q.normalTargetSlot);
      spawnVisitorSoon(target, "normal");
      return;
    }
  }

  function tick(){
    updateNextTag();
    updateShoutUI();

    const st = loadStage();
    const nowMs = now();

    // â˜…å®¢ãŒã„ã‚‹æ™‚ï¼šé€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒåˆ°é”ã—ã¦ã„ãŸã‚‰ã€Œå¾…æ©Ÿã€ã«ç©ã‚€ï¼ˆè¡¨ç¤ºã¯ãã®ã¾ã¾ï¼‰
    if(st.hasVisitor){
      checkDueAndQueueNormal();
      return;
    }

    // â˜…ã‚¹ãƒãƒ¼ãƒ³ãƒ­ãƒƒã‚¯ä¸­ã¯ä½•ã‚‚ã—ãªã„ï¼ˆè¡¨ç¤ºã ã‘æ›´æ–°ï¼‰
    if(nowMs < spawnLockUntil) return;

    // â˜…å‘¼ã³è¾¼ã¿äºˆç´„ãŒã‚ã‚‹å ´åˆï¼šé€šå¸¸ã¯æ­¢ã‚ã¦ã€è¢«ã‚ŠãŒã‚ã‚Œã°å¾…æ©Ÿã¸
    const q = loadQueue();
    if(q.shoutPending){
      // è¢«ã‚Šå¯¾ç­–ï¼šã“ã“ã§é€šå¸¸ãŒdueã«ãªã£ãŸã‚‰å¾…æ©Ÿã«ç©ã‚€ï¼ˆæ¬¡è¡¨ç¤ºã¯å¤‰ãˆãªã„ï¼‰
      checkDueAndQueueNormal();

      // äºˆç´„æ™‚åˆ»ã«ãªã£ãŸã‚‰å‘¼ã³è¾¼ã¿ã‚’å®Ÿè¡Œ
      if(nowMs >= Number(q.shoutSpawnAt||0)){
        const target = Number(q.shoutTargetSlot);
        q.shoutPending = false;
        q.shoutTargetSlot = null;
        q.shoutSpawnAt = 0;
        saveQueue(q);
        spawnVisitorSoon(target, "shout");
      }
      return;
    }

    // â˜…å¾…æ©Ÿä¸­ã®é€šå¸¸ãŒã‚ã‚‹ãªã‚‰å…ˆã«å‡ºã™ï¼ˆæ¬¡è¡¨ç¤ºã¯ 0s ã«ãªã£ã¦ã„ã‚‹ã¯ãšï¼‰
    if(q.normalPending && q.normalTargetSlot != null){
      spawnVisitorSoon(Number(q.normalTargetSlot), "normal");
      return;
    }

    // â˜…é€šå¸¸ã®æ¥å®¢åˆ¤å®šï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const lv = loadLevel().lv;
    const shop = loadMyShop();
    const t = ensureNextAtForActiveSlots();

    const activeIdx = [];
    shop.slots.forEach((s, idx)=>{
      if(s.item && canUseSlot(idx, lv)) activeIdx.push(idx);
    });
    if(activeIdx.length===0) return;

    const due = activeIdx.filter(i => Number(t.nextAtBySlot[String(i)]||0) <= nowMs);
    if(due.length===0) return;

    const targetSlot = pick(due);
    spawnVisitorSoon(targetSlot, "normal");
  }

  /* ==========================
     å‘¼ã³è¾¼ã¿ï¼ˆæ¬¡ï¼šxxxè¡¨ç¤ºã‚’å¤‰ãˆãªã„ï¼‰
     - nextAtBySlot ã‚’è§¦ã‚‰ãšã€å‘¼ã³è¾¼ã¿å®¢ã ã‘äºˆç´„ã—ã¦å‡ºã™
     - è¢«ã‚Šï¼ˆé€šå¸¸ã®dueï¼‰ã«ãªã£ãŸã‚‰é€šå¸¸ã‚’å¾…æ©Ÿã•ã›ã‚‹
  ========================== */
  function shout(){
    const st = loadStage();
    if(st.hasVisitor){
      toast("ã„ã¾ã¯ç„¡ç†", "å®¢ãŒã„ã‚‹é–“ã¯å‘¼ã³è¾¼ã¿ã§ãã¾ã›ã‚“", "");
      return;
    }

    const cd = loadShout();
    const n = now();
    if(Number(cd.nextOkAt||0) > n){
      const sec = Math.ceil((cd.nextOkAt - n)/1000);
      toast("ã¾ã ç„¡ç†", `å‘¼ã³è¾¼ã¿ã¯ ${sec}s å¾Œ`, "");
      updateShoutUI();
      return;
    }

    const shop = loadMyShop();
    const lv = loadLevel().lv;

    const active = [];
    shop.slots.forEach((s, idx)=>{
      if(s.item && canUseSlot(idx, lv)) active.push(idx);
    });
    if(active.length===0){
      toast("å‘¼ã³è¾¼ã¿å¤±æ•—", "å‡ºå“ä¸­ã®æ£šãŒã‚ã‚Šã¾ã›ã‚“", "");
      return;
    }

    // â˜…ã“ã“ã§åˆã‚ã¦CDæ¶ˆè²»
    cd.nextOkAt = n + 60000;
    saveShout(cd);
    updateShoutUI();

    // å‘¼ã³è¾¼ã¿å¯¾è±¡ï¼šæ¬¡ãŒä¸€ç•ªæ—©ã„æ£šï¼ˆå¾“æ¥ã®æ€æƒ³ï¼‰
    const t = ensureNextAtForActiveSlots();
    let target = active[0];
    let best = Infinity;
    for(const idx of active){
      const at = Number((t.nextAtBySlot||{})[String(idx)]||Infinity);
      if(at < best){ best = at; target = idx; }
    }

    // â˜…æ¬¡ï¼šxxxï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºï¼‰ã‚’ä¸€åˆ‡å¤‰ãˆãªã„ã®ã§ã€tickã¯è§¦ã‚‰ãªã„

    // â˜…å‘¼ã³è¾¼ã¿äºˆç´„ã‚’ç©ã‚€ï¼ˆ3ç§’å¾Œã«æ¥ã‚‹ï¼‰
    const q = loadQueue();
    q.shoutPending = true;
    q.shoutTargetSlot = target;
    q.shoutSpawnAt = n + 3000;
    saveQueue(q);

    // â˜…ã‚‚ã—ã“ã®ç¬é–“ã«é€šå¸¸ã®dueãŒã‚ã‚‹ãªã‚‰å¾…æ©Ÿã«ç©ã‚€ï¼ˆè¡¨ç¤ºã¯ãã®ã¾ã¾ï¼‰
    checkDueAndQueueNormal();

    toast("å‘¼ã³è¾¼ã¿ï¼", `æ£š${target+1}ï½œ${pickShoutLine()}`, "");
    pushLog("å‘¼ã³è¾¼ã¿", `æ£š${target+1} ã«å®¢ã®æ°—é…ãŒé›†ã¾ã£ãŸ`, "");
    renderAll();
  }

  /* ==========================
     â˜…ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
  ========================== */
  function downloadText(filename, text){
    const blob = new Blob([text], { type:"application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }

  function makeBackup(){
    const keys = [
      LS.octo, LS.myshop, LS.log, LS.lvl, LS.rep, LS.tick, LS.shout, LS.stage,
      LS.farmBook,
      "tf_v1_inv",
      LS.queue
    ];

    const data = {};
    for(const k of keys){
      const raw = localStorage.getItem(k);
      if(raw == null){
        data[k] = null;
        continue;
      }
      const parsed = safeJSON(raw, null);
      data[k] = (parsed !== null) ? parsed : raw;
    }

    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    const stamp = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    const filename = `takoyaki-myshop-backup-${stamp}.json`;

    const payload = {
      exportedAt: d.toISOString(),
      note: "ãƒã‚¤éœ²åº—ã®localStorageãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¾©å…ƒã¯å¾©å…ƒãƒœã‚¿ãƒ³ã§å¯èƒ½ï¼‰",
      keys,
      data
    };

    downloadText(filename, JSON.stringify(payload, null, 2));
    toast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ", `${filename} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, "");
    pushLog("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—", "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’JSONã«æ›¸ãå‡ºã—ãŸ", filename);
  }

  /* ==========================
     â˜…å¾©å…ƒï¼ˆJSONã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ localStorageæ›¸ãæˆ»ã—ï¼‰
  ========================== */
  function restoreFromPayload(payload){
    if(!payload || typeof payload !== "object"){
      toast("å¾©å…ƒå¤±æ•—", "JSONã®å½¢å¼ãŒä¸æ­£ã§ã™", "");
      return false;
    }
    const data = payload.data;
    if(!data || typeof data !== "object"){
      toast("å¾©å…ƒå¤±æ•—", "data ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "");
      return false;
    }

    const keys = Array.isArray(payload.keys) ? payload.keys : Object.keys(data);

    for(const k of keys){
      if(!(k in data)) continue;
      const v = data[k];

      if(v === null || v === undefined){
        localStorage.removeItem(k);
        continue;
      }

      if(typeof v === "string"){
        localStorage.setItem(k, v);
      }else{
        localStorage.setItem(k, JSON.stringify(v));
      }
    }
    return true;
  }

  function openRestoreDialog(){
    restoreFile.value = "";
    restoreFile.click();
  }

  restoreFile.addEventListener("change", async ()=>{
    const file = restoreFile.files && restoreFile.files[0];
    if(!file) return;

    try{
      const text = await file.text();
      const payload = JSON.parse(text);

      if(!confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰")) return;

      const ok = restoreFromPayload(payload);
      if(ok){
        pushLog("å¾©å…ƒ", "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ãŸ", file.name);
        toast("å¾©å…ƒOK", "ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™", "");
        setTimeout(()=> location.reload(), 650);
      }
    }catch(e){
      toast("å¾©å…ƒå¤±æ•—", "JSONã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ", "");
    }
  });

  /* ==========================
     ä¿®ç†ãƒœã‚¿ãƒ³
     - ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹ã¨ tick ã‚’ä¿®ç†
     - â˜…ã‚­ãƒ¥ãƒ¼ã‚‚å®‰å…¨ã«ã‚¯ãƒªã‚¢ï¼ˆå¤‰ãªå¾…æ©ŸãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
  ========================== */
  fixBtn.addEventListener("click", ()=>{
    const STAGE_DEFAULT2 = {
      ver:1,
      hasVisitor:false,
      leaving:false,
      vUrl:"",
      vName:"â€”",
      vMsg:"ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚",
      vType:"",
      vGoal:"",
      stayMs:0,
      targetSlot:-1,
      updatedAt: Date.now(),
      source:""
    };

    localStorage.setItem(LS.stage, JSON.stringify(STAGE_DEFAULT2));
    localStorage.removeItem(LS.tick);

    localStorage.setItem(LS.queue, JSON.stringify(QUEUE_DEFAULT));

    alert("å®¢çŠ¶æ…‹ã ã‘ä¿®ç†ã—ã¾ã—ãŸï¼ˆå‘¼ã³è¾¼ã¿CDãƒ»ãƒ¬ãƒ™ãƒ«ã¯ä¿æŒï¼‰");
    location.reload();
  });

  /* ==========================
     å…¨æç”»
  ========================== */
  function renderAll(){
    renderStats();
    renderShelves();
    renderLog();
    applyDayNight();
    updateNextTag();
    updateShoutUI();
  }

  /* ==========================
     ãƒ˜ãƒ«ãƒ—
  ========================== */
  function openHelp(){
    helpModal.classList.add("show");
    helpModal.setAttribute("aria-hidden","false");
    lockBodyScroll();
  }
  function closeHelp(){
    helpModal.classList.remove("show");
    helpModal.setAttribute("aria-hidden","true");
    unlockBodyScroll();
  }

  pickCloseBtn.addEventListener("click", closePickModal);
  pickCancelBtn.addEventListener("click", closePickModal);
  pickModal.addEventListener("click", (e)=>{ if(e.target===pickModal) closePickModal(); });

  helpBtn.addEventListener("click", openHelp);
  helpClose.addEventListener("click", closeHelp);
  helpOk.addEventListener("click", closeHelp);
  helpModal.addEventListener("click", (e)=>{ if(e.target===helpModal) closeHelp(); });

  backBtn.addEventListener("click", ()=>{
    if(history.length > 1) history.back();
    else location.href = "./index.html";
  });

  shoutBtn.addEventListener("click", shout);

  backupBtn.addEventListener("click", makeBackup);
  restoreBtn.addEventListener("click", openRestoreDialog);

  /* ==========================
     èµ·å‹•
  ========================== */
  applyDayNight();
  renderAll();
  scheduleStage();

  // â˜…èµ·å‹•ç›´å¾Œã«ã€ã‚‚ã—å¾…æ©Ÿ/å‘¼ã³è¾¼ã¿äºˆç´„ãŒã‚ã‚Œã°å®Ÿè¡Œæ¡ä»¶ã ã‘æ•´ãˆã‚‹
  trySpawnQueuedIfPossible();

  setInterval(tick, 1000);

})();
</script>
</body>
</html>


