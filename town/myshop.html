<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒã‚¤éœ²åº—</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --btn:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    .mono{font-family:var(--mono)}
    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:active{transform:translateY(1px)}
    .btn.warn{background:linear-gradient(180deg, rgba(255,211,138,.18), rgba(255,255,255,.10));}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:12px;
      white-space:nowrap;
    }

    /* header */
    .header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(to bottom, rgba(15,18,32,.95), rgba(15,18,32,.55));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .head-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
    .back{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:var(--btn); color:var(--text); font-size:18px; cursor:pointer;
    }
    .titlebox{flex:1;min-width:0}
    .title{font-size:16px;font-weight:900;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.25}
    .top-actions{display:flex;gap:8px}

    /* cards */
    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card-title{font-weight:900;font-size:14px}
    .card-desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}
    .card-b{padding:12px}

    /* stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px;
      min-height:62px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:900;margin-top:4px;display:flex;align-items:baseline;gap:6px}
    .stat .v small{font-size:11px;color:var(--muted);font-weight:700}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* ===== æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆèƒŒæ™¯ï¼‹å®¢ï¼‰ ===== */
    .stage-card{margin-bottom:12px}
    .stage{
      position:relative;
      width:100%;
      max-width:980px;
      height:192px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    @media (max-width: 520px){
      .stage{height:180px;}
    }
    .stage-bg{
      width:100%; height:100%;
      object-fit:cover;
      image-rendering: pixelated;
      display:block;
    }

    /* â˜…å®¢ã¯å¸¸ã«DOMä¸Šã«ã„ã¦opacityã§å‡ºå…¥ã‚Š */
    .stage-visitor{
      position:absolute;
      bottom:28px;              /* ã“ã“ã§ä¸Šä¸‹èª¿æ•´ */
      left:50%;
      transform:translateX(-50%);
      height:150px;
      image-rendering: pixelated;
      pointer-events:none;

      opacity:0;
      visibility:hidden;
      transition: opacity .55s ease, visibility .55s ease;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.35));
    }
    .stage-visitor.show{
      opacity:1;
      visibility:visible;
    }

    .stage-ui{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .bubble{
      pointer-events:none;
      max-width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      border-radius:14px;
      padding:8px 10px;
      line-height:1.25;
    }
    .bubble .n{font-weight:900;font-size:12px}
    .bubble .m{color:rgba(255,255,255,.84);font-size:12px;margin-top:3px}
    .stage-tags{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      pointer-events:none;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* stage flash effects */
    .stage.flash-gold{ animation: flashGold .35s ease-out; }
    .stage.flash-pink{ animation: flashPink .35s ease-out; }
    @keyframes flashGold{
      from{ box-shadow: 0 0 0 rgba(255,211,138,0); }
      40%{ box-shadow: 0 0 0 4px rgba(255,211,138,.35), 0 0 28px rgba(255,211,138,.25); }
      to{ box-shadow:none; }
    }
    @keyframes flashPink{
      from{ box-shadow: 0 0 0 rgba(255,60,160,0); }
      40%{ box-shadow: 0 0 0 4px rgba(255,60,160,.25), 0 0 28px rgba(255,60,160,.20); }
      to{ box-shadow:none; }
    }

    /* layout grid */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    /* shelves */
    .shelves{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .shelves{grid-template-columns:1fr} }
    .shelf{
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08));
      overflow:hidden;
    }
    .shelf.locked{opacity:.6;filter:saturate(.7)}
    .shelf-top{
      padding:10px 10px 8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px dashed rgba(255,255,255,.16);
    }
    .shelf-name{font-weight:900;font-size:13px}
    .shelf-tag{font-size:11px;color:var(--muted)}
    .shelf-body{padding:10px;display:flex;gap:10px;align-items:flex-start}
    .slot{
      width:76px; height:108px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
    }
    .slot img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated;display:block}
    .slot .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.65);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .slot .tier{
      position:absolute;left:6px;top:6px;
      font-size:10px;font-weight:900;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
    }
    .shelf-info{flex:1;min-width:0}
    .line{font-size:12px;color:var(--muted);line-height:1.35}
    .line b{color:var(--text)}
    .line + .line{margin-top:6px}
    .shelf-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}

    /* inventory */
    .invlist{display:flex;flex-direction:column;gap:10px}
    .invrow{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.14);
      padding:10px;
    }
    .invrow .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .invrow .h b{font-size:13px}
    .invrow .h span{font-size:11px;color:var(--muted)}
    .invrow .body{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;align-items:center;gap:6px;
    }
    .chip .n{font-family:var(--mono);font-weight:900}

    /* log */
    .log{
      font-size:12px;color:var(--muted);
      line-height:1.35;
      display:flex;flex-direction:column;gap:8px;
      max-height:260px; overflow:auto;
      padding-right:6px;
    }
    .log .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:8px 10px;
    }
    .log .t{color:rgba(255,255,255,.8);font-weight:900}
    .log .m{margin-top:3px}
    .log .s{margin-top:3px;font-family:var(--mono);font-size:11px;opacity:.85}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding:14px 12px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background:rgba(15,18,32,.98);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 78vh;
      display:flex;
      flex-direction:column;
    }
    .sheet-h{
      padding:12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .sheet-h b{font-size:14px}
    .sheet-b{
      padding:12px;
      overflow:auto;
      flex:1 1 auto;
    }
    .sheet-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid var(--line);flex:0 0 auto}
    .close{width:40px;height:40px;border-radius:12px}

    /* â˜…ã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼šã¯ã¿å‡ºã—å¯¾ç­–ï¼ˆå›³é‘‘å¯„ã›ï¼‰ */
    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 760px){ .cards{grid-template-columns: repeat(3, minmax(0,1fr))} }
    @media (max-width: 520px){ .cards{grid-template-columns: repeat(2, minmax(0,1fr))} }

    .citem{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
      display:flex; flex-direction:column;
      min-height:140px;
    }
    .citem:active{transform:translateY(1px)}
    .cimg{
      height:96px; /* â˜…å°ã•ã‚ã§ä¸€è¦§ãŒè¦‹ã‚„ã™ã„ */
      background:rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .cimg img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated;display:block}
    .cimg .ph{
      height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.6);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .cimg .cnt{
      position:absolute; right:6px; top:6px;
      font-size:11px; font-weight:900;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
      font-family:var(--mono);
    }
    .cmeta{padding:8px 10px}
    .cname{font-size:12px;font-weight:900;line-height:1.2}
    .csub{font-size:11px;color:var(--muted);margin-top:4px;display:flex;justify-content:space-between;gap:8px}
    .csub span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* toast */
    .toast{
      position:fixed;
      left:12px;
      right:12px;
      top:14%;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:200;
    }
    .toast .box{
      width:min(680px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.65);
      color:var(--text);
      border-radius:14px;
      padding:12px 14px;
      box-shadow: var(--shadow);
      pointer-events:none;
      display:none;
    }
    .toast .box.show{
      display:block;
      animation: popIn .18s ease-out;
    }
    @keyframes popIn{
      from{ transform: translateY(8px) scale(.98); opacity: 0; }
      to  { transform: translateY(0)   scale(1);   opacity: 1; }
    }
    .toast .box b{font-weight:900}
    .toast .box .small{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}

    .toast .box.toast--sale{
      border-color: rgba(255,211,138,.55);
      background: linear-gradient(180deg, rgba(255,211,138,.22), rgba(0,0,0,.78));
      box-shadow: 0 16px 44px rgba(0,0,0,.55);
    }
    .toast .box.toast--sale b{
      font-size: 15px;
      letter-spacing: .02em;
    }
    .toast .box.toast--sale .small{
      font-size: 14px;
      color: rgba(255,255,255,.92);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="head-inner">
      <button class="back" id="backBtn" type="button" aria-label="æˆ»ã‚‹">â†</button>
      <div class="titlebox">
        <div class="title">ãƒã‚¤éœ²åº—</div>
        <div class="sub">3ã€œ5åˆ†ã”ã¨ã«æ¥å®¢ã€‚å£²ã‚Œãªãã¦ã‚‚è‚²ã¤ã€‚å£²ã‚ŒãŸã‚‰ã‚‚ã£ã¨ä¼¸ã³ã‚‹ã€‚</div>
      </div>
      <div class="top-actions">
        <button class="btn warn" id="shoutBtn" type="button">å‘¼ã³è¾¼ã¿</button>
        <button class="btn ghost" id="helpBtn" type="button">ï¼Ÿ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="stats" id="stats"></div>

    <div class="card stage-card">
      <div class="card-h">
        <div>
          <div class="card-title">æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸</div>
          <div class="card-desc">èƒŒæ™¯ï¼ˆæ˜¼/å¤œï¼‰ã«ã€å®¢ã‚¿ã‚³æ°‘ï¼ˆé€éï¼‰ã‚’é‡ã­ã¦è¡¨ç¤ºã€‚å£²è²·ã¯ã“ã“ã ã‘ã§ç™ºç”Ÿã€‚</div>
        </div>
        <div class="pill">
          <span>è©•åˆ¤</span>
          <b id="repText" class="mono">â€”</b>
        </div>
      </div>
      <div class="card-b">
        <div class="stage" id="stage">
          <img id="stageBg" class="stage-bg" alt="" src="">
          <img id="stageVisitor" class="stage-visitor" alt="" src="">
          <div class="stage-ui">
            <div class="bubble">
              <div class="n" id="stageName">â€”</div>
              <div class="m" id="stageMsg">ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚</div>
            </div>
            <div class="stage-tags">
              <div class="tag" id="stageTimeTag">â€”</div>
              <div class="tag" id="stageNextTag">æ¬¡ï¼šâ€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æ£šï¼ˆå‡ºå“ï¼‰</div>
            <div class="card-desc">æ£šã«ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã ã‘ã€‚æ¥å®¢ã¯æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã§ç™ºç”Ÿã—ã€ã©ã‚ŒãŒå£²ã‚Œã‚‹ã‹ã¯å®¢æ¬¡ç¬¬ã€‚</div>
          </div>
          <button class="btn" id="refreshBtn" type="button">æ›´æ–°</button>
        </div>
        <div class="card-b">
          <div class="shelves" id="shelves"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æ‰€æŒãƒ»é€£å‹•</div>
            <div class="card-desc">ãƒ•ã‚¡ãƒ¼ãƒ è³‡æï¼ˆç¨®/æ°´/è‚¥æ–™ï¼‰ã¨å›³é‘‘ï¼ˆæ‰€æŒã‚«ãƒ¼ãƒ‰ï¼‰ã‚’è¡¨ç¤ºã€‚</div>
          </div>
          <div class="pill"><span>è¡¨ç¤º</span><b class="mono">è‡ªå‹•</b></div>
        </div>
        <div class="card-b">
          <div class="invlist">
            <div class="invrow">
              <div class="h"><b>è³‡æï¼ˆtf_v1_invï¼‰</b><span>ç„¡æ–™æ ã¯âˆã§ã‚‚OK</span></div>
              <div class="body" id="invChips"></div>
            </div>
            <div class="invrow">
              <div class="h"><b>å›³é‘‘ï¼ˆtf_v1_bookï¼‰</b><span>æ‰€æŒã‚«ãƒ¼ãƒ‰ï¼ˆå‡ºå“ã§æ¸›ã‚‹ï¼‰</span></div>
              <div class="body" id="bookChips"></div>
              <div style="margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35">
                â€» å‡ºå“ã™ã‚‹ã¨æ‰€æŒæ•°ï¼ˆcountï¼‰ãŒ1æ¸›ã‚Šã€å–ã‚Šä¸‹ã’ã‚‹ã¨æˆ»ã‚Šã¾ã™ã€‚
              </div>
            </div>
            <div class="invrow">
              <div class="h"><b>æœ€è¿‘ã®å‡ºæ¥äº‹</b><span>ãƒ­ã‚°</span></div>
              <div class="log" id="log"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal: pick card -->
  <div class="modal" id="pickModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶">
      <div class="sheet-h">
        <div>
          <b id="pickTitle">å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰</b>
          <div style="margin-top:4px;font-size:12px;color:var(--muted)" id="pickHint">æ£šã‚’é¸ã‚“ã§ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã€‚</div>
        </div>
        <button class="btn close" id="pickClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div class="cards" id="pickCards"></div>
        <div style="margin-top:10px;font-size:12px;color:var(--muted);display:none" id="pickEmpty">
          æ‰€æŒã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ãƒ•ã‚¡ãƒ¼ãƒ ã§åç©«ã—ã¦å›³é‘‘ã«è¿½åŠ ã—ã¦ã­ã€‚
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="pickCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- modal: help -->
  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="ãƒ˜ãƒ«ãƒ—">
      <div class="sheet-h">
        <b>éœ²åº—ã®éŠã³æ–¹</b>
        <button class="btn close" id="helpClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div style="font-size:12px;color:rgba(255,255,255,.86);line-height:1.65">
          ãƒ»æ£šã‚’ã‚¿ãƒƒãƒ— â†’ æ‰€æŒã‚«ãƒ¼ãƒ‰ã‹ã‚‰å‡ºå“<br>
          ãƒ»æ¥å®¢ã¯ã€Œæ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã€ã«å‡ºç¾ï¼ˆ10ã€œ30ç§’æ»åœ¨ï¼‰<br>
          ãƒ»æ»åœ¨ãŒé•·ã„ã»ã©è³¼å…¥ã—ã‚„ã™ã„<br>
          ãƒ»å£²è²·åˆ¤å®šã¯å®¢ãŒå»ã‚‹1ç§’å‰<br>
          ãƒ»æ¥å®¢ã ã‘ã§ã‚‚ EXP +1ï¼ˆè‚²ã¤ï¼‰<br>
          ãƒ»å£²ã‚ŒãŸã‚‰ EXP è¿½åŠ  +4ï¼ˆåˆè¨ˆ+5ï¼‰<br>
          ãƒ»ç‹æ§˜/è»¢å£²ã¯ç‰¹åˆ¥æ¼”å‡º<br>
          ãƒ»å¤œã¯å¤œé™å®šå®¢ãŒæ¥ã‚„ã™ã„<br>
          ãƒ»è©•åˆ¤70ä»¥ä¸Šã§â€œå¸¸é€£â€è§£æ”¾<br><br>
          <b>æ£šè§£æ”¾</b><br>
          Lv1: æ£š1-2 / Lv2: æ£š3 / Lv3: æ£š4 / Lv4: æ£š5
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="helpOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast" aria-live="polite" aria-atomic="true">
    <div class="box" id="toastBox">
      <b id="toastTitle">â€”</b>
      <div class="small" id="toastSub">â€”</div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  /* =========================
     URLsï¼ˆç¢ºå®šï¼‰ï¼‹å®¢6äºº
  ========================= */
  const ASSETS = {
    bgDay:   "https://ul.h3z.jp/lqCNnwQH.png",
    bgNight: "https://ul.h3z.jp/UtPlWaZz.png",
    visitors: [
      { id:"careful", name:"æ…é‡ã‚¿ã‚³æ°‘", type:"careful", url:"https://ul.h3z.jp/lsTSkndD.png" },
      { id:"impulse", name:"å³æ±ºã‚¿ã‚³æ°‘", type:"impulse", url:"https://ul.h3z.jp/YckjGopx.png" },
      { id:"looker",  name:"å†·ã‚„ã‹ã—ã‚¿ã‚³æ°‘", type:"looker",  url:"https://ul.h3z.jp/PIsx6jd0.png" },
      { id:"picky",   name:"ã“ã ã‚ã‚Šã‚¿ã‚³æ°‘", type:"picky",   url:"https://ul.h3z.jp/j8ZOooGi.png" },
      { id:"king",    name:"ç‹æ§˜ã‚¿ã‚³æ°‘", type:"king", url:"https://ul.h3z.jp/CaRoJGA6.png" },
      { id:"flipper", name:"è»¢å£²ã‚¿ã‚³æ°‘", type:"flipper", url:"https://ul.h3z.jp/C015QuqC.png" }
    ]
  };

  /* =========================
     æ»åœ¨ä¸­ã‚»ãƒªãƒ•ï¼ˆæ€§æ ¼ï¼‰
  ========================= */
  const VISITOR_LINES = {
    careful: [
      "ã©ã†ã—ã‚ˆã†ã‹ãªâ€¦",
      "ã‚‚ã†å°‘ã—è¦‹ã¦ã‹ã‚‰â€¦",
      "ä»Šæ—¥ã¯è²·ã†ã¹ãã‹â€¦",
      "è²¡å¸ƒã«ç›¸è«‡ä¸­â€¦ï¼ˆæ—¢èª­ã‚¹ãƒ«ãƒ¼ï¼‰"
    ],
    impulse: [
      "ãŠã£ã€ã„ã„ã˜ã‚ƒã‚“",
      "ä»ŠãŒè²·ã„æ™‚ã‹ã‚‚ï¼",
      "ã“ã‚Œã„ã£ã¨ãï¼Ÿ",
      "å‹¢ã„ã§è²·ã†ï¼â€¦ãŸã¶ã‚“ï¼"
    ],
    looker: [
      "ãµãƒ¼ã‚“",
      "è¦‹ã‚‹ã ã‘è¦‹ã‚ˆ",
      "è³‘ã‚„ã‹ã ãªã‚",
      "æ’®ã£ã¦å¸°ã‚‹ã‚ï¼ˆè²·ã‚ãªã„ï¼‰"
    ],
    picky: [
      "åŒ‚ã„ã¯æ‚ªããªã„â€¦",
      "ç„¼ãã®ãƒ ãƒ©ã¯â€¦ï¼Ÿ",
      "æ…é‡ã«é¸ã³ãŸã„",
      "ä»Šæ—¥ã¯â€œæ™®é€šâ€ãŒå¼·ã„æ—¥â€¦"
    ],
    king: [
      "ã‚ˆã„ã€‚",
      "ä½™ã¯è¿·ã‚ã¬ã€‚",
      "ã“ã®æ£šâ€¦æ ¼ãŒã‚ã‚‹ã€‚",
      "è²·ã†ã€‚ç•°è«–ã¯ãªã„ã€‚"
    ],
    flipper: [
      "å›ã‚‹ã‹â€¦ï¼Ÿ",
      "ã“ã‚Œã¯å‹•ãã€‚",
      "åˆ©ç›Šã®åŒ‚ã„ãŒã™ã‚‹",
      "è²·ã†ã€‚è©•åˆ¤ã¯çŸ¥ã‚‰ã‚“ã€‚"
    ]
  };

  /* =========================
     å»ã‚Šéš›ã‚»ãƒªãƒ•ï¼ˆå¢—é‡ï¼‰
  ========================= */
  const LEAVE_LINES = [
    "â€¦â€¦è²¡å¸ƒã¨å¿ƒãŒã€ä»Šæ—¥ã¯å™›ã¿åˆã‚ãªã‹ã£ãŸã€‚",
    "â€¦â€¦ã¾ãŸæ¥ã‚‹ã€‚ç„¼ã‹ã‚Œã‚‹è¦šæ‚ŸãŒã§ããŸã‚‰ã€‚",
    "â€¦â€¦è²·ã‚ãªã„å‹‡æ°—ã‚‚ã€ç«‹æ´¾ãªæ¶ˆè²»è¡Œå‹•ã ã‚ˆã­ã€‚",
    "â€¦â€¦ä»Šã¯ãã®æ™‚ã˜ã‚ƒãªã„ã€‚ãŸã“ç„¼ããŒãã†è¨€ã£ãŸã€‚",
    "â€¦â€¦ã“ã‚Œã¯è©¦ç·´ã ã€‚æ¬¡ã«æ¥ãŸæ™‚ãŒæœ¬ç•ªã ã€‚",
    "â€¦â€¦åŒ‚ã„ã ã‘ã§æº€è…¹ã«ãªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€‚",
    "â€¦â€¦ã“ã®æ£šã€å¼·ã™ãã‚‹ã€‚ä»Šæ—¥ã¯æ’¤é€€ã€‚",
    "â€¦â€¦è²·ã‚ãªã‹ã£ãŸã€‚ã§ã‚‚ã€è² ã‘ãŸæ°—ã¯ã—ã¦ã„ã‚‹ã€‚",
    "â€¦â€¦ãŸã“ç„¼ãã¯é€ƒã’ãªã„ã€‚ä»Šæ—¥ã¯ä¿ºãŒé€ƒã’ã‚‹ã€‚",
    "â€¦â€¦è„³å†…ä¼šè­°ã€å¦æ±ºã§çµ‚äº†ã€‚",
    "â€¦â€¦è²¡å¸ƒãŒâ€œã¾ã ç„¼ã‘ã¦ãªã„â€ã€‚",
    "â€¦â€¦è²·ã£ãŸã‚‰å„ªå‹ã—ã¡ã‚ƒã†æ°—ãŒã—ãŸã€‚",
    "â€¦â€¦ä»Šæ—¥ã¯â€œè¦‹å­¦è€…â€ã¨ã„ã†å½¹ã‚’æ¼”ã˜ãŸã€‚",
    "â€¦â€¦æ‰‹ã¯ä¼¸ã³ãŸã€‚å¿ƒãŒæˆ»ã—ãŸã€‚",
    "â€¦â€¦è²·ã†ç†ç”±ã¯100å€‹ã€‚è²·ã‚ãªã„ç†ç”±ã¯1å€‹ï¼ˆæ®‹é«˜ï¼‰ã€‚",
    "â€¦â€¦å¸°ã‚‹ã€‚ã ãŒã‚¹ã‚¯ã‚·ãƒ§ã¯æ’®ã£ãŸã€‚",
    "â€¦â€¦ãŠè…¹ã¯ç©ºã„ãŸã€‚æ±ºæ–­ã¯ç©ºæŒ¯ã£ãŸã€‚",
    "â€¦â€¦æ¬¡ã¯è²·ã†ã€‚ãŸã¶ã‚“ã€‚ãŠãã‚‰ãã€‚",
    "â€¦â€¦è²·ã‚ãšã«å¸°ã‚‹ã®ãŒä¸€ç•ªé«˜ã„è²·ã„ç‰©ã ã£ãŸã€‚",
    "â€¦â€¦æ£šã®åœ§ãŒå¼·ã™ãã¦ã€ä¿ºãŒç„¼ã‘ãŸã€‚"
  ];

  /* =========================
     ç›®çš„ï¼ˆæœ€å„ªå…ˆï¼‰
  ========================= */
  const GOALS = [
    { id:"cheap", label:"å®‰ã„ã®ã‚’ç‹™ã£ã¦ã‚‹", hint:"å®‰ã„æ£šã«å¯„ã‚ŠãŒã¡" },
    { id:"rare",  label:"SRä»¥ä¸ŠãŒæ¬²ã—ã„", hint:"SR/UR/LRå„ªå…ˆ" },
    { id:"ur",    label:"URä»¥ä¸Šã—ã‹å‹ãŸã‚“", hint:"UR/LRãŒç„¡ã„ã¨å¸°ã‚ŠãŒã¡" },
    { id:"any",   label:"ãªã‚“ã§ã‚‚ã„ã„ã€æ°—åˆ†", hint:"ãƒ©ãƒ³ãƒ€ãƒ " }
  ];

  function goalLines(goalId){
    const map = {
      cheap: [
        "ä»Šæ—¥ã¯å®‰ãç„¼ã‹ã‚ŒãŸã„â€¦",
        "ã‚³ã‚¹ãƒ‘â€¦ã‚³ã‚¹ãƒ‘â€¦",
        "å€¤æœ­ã«ç„¼ã‹ã‚Œã‚‹æº–å‚™OK"
      ],
      rare: [
        "SRä»¥ä¸Šâ€¦åŒ‚ã„ã§åˆ†ã‹ã‚‹â€¦ã¯ãšã€‚",
        "ä»Šæ—¥ã¯ãƒ¬ã‚¢ã®æ³¢ãŒæ¥ã¦ã‚‹æ°—ãŒã™ã‚‹ã€‚",
        "å…‰ã£ã¦ãã‚Œâ€¦é ¼ã‚€â€¦"
      ],
      ur: [
        "URä»¥ä¸ŠãŒç„¡ã„ãªã‚‰â€¦å¸°ã‚‹ã€‚",
        "æ´¾æ‰‹ã«ç„¼ã‹ã‚ŒãŸã„ã€‚",
        "å…‰ã®åœ§ã‚’æ„Ÿã˜ãŸã„ã€‚"
      ],
      any: [
        "ä»Šæ—¥ã¯ãƒãƒªã§æ±ºã‚ã‚‹ã€‚",
        "é‹å‘½ã«ä»»ã›ã‚‹ã€‚",
        "æ£šã«å‘¼ã°ã‚ŒãŸæ°—ãŒã™ã‚‹ã€‚"
      ]
    };
    return map[goalId] || ["â€¦â€¦"];
  }

  /* =========================
     LocalStorage Keysï¼ˆæ—¢å­˜ã¨é€£å‹•ï¼‰
  ========================= */
  const LS = {
    octo:     "roten_v1_octo",
    myshop:   "roten_v1_myshop",
    log:      "roten_v1_log",
    lvl:      "roten_v1_level",
    rep:      "roten_v1_rep",
    tick:     "roten_v1_shop_tick",
    shout:    "roten_v1_shout_cd",
    farmInv:  "tf_v1_inv",
    farmBook: "tf_v1_book",
    stage:    "roten_v1_stage"
  };

  /* =========================
     DOM
  ========================= */
  const $ = (q, el=document) => el.querySelector(q);

  const statsEl = $("#stats");
  const shelvesEl = $("#shelves");
  const invChipsEl = $("#invChips");
  const bookChipsEl = $("#bookChips");
  const logEl = $("#log");
  const repTextEl = $("#repText");

  const stageEl = $("#stage");
  const stageBg = $("#stageBg");
  const stageVisitor = $("#stageVisitor");
  const stageName = $("#stageName");
  const stageMsg = $("#stageMsg");
  const stageTimeTag = $("#stageTimeTag");
  const stageNextTag = $("#stageNextTag");

  const pickModal = $("#pickModal");
  const pickCardsEl = $("#pickCards");
  const pickEmptyEl = $("#pickEmpty");
  const pickTitleEl = $("#pickTitle");
  const pickHintEl = $("#pickHint");

  const helpModal = $("#helpModal");

  const toastBox = $("#toastBox");
  const toastTitle = $("#toastTitle");
  const toastSub = $("#toastSub");

  /* =========================
     Utils
  ========================= */
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const now = () => Date.now();
  const fmt = (n) => (Number(n||0)).toLocaleString("ja-JP");
  const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  function safeJSON(raw, fallback){ try{ return JSON.parse(raw);}catch(e){ return fallback; } }
  function lsGet(key, fallback){
    const raw = localStorage.getItem(key);
    if(raw==null) return fallback;
    return safeJSON(raw, fallback);
  }
  function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function toast(t, s, type){
    toastTitle.textContent = t;
    toastSub.textContent = s || "";
    toastBox.classList.remove("toast--sale");
    if(type === "sale") toastBox.classList.add("toast--sale");
    toastBox.classList.add("show");
    clearTimeout(toastBox.__t);
    toastBox.__t = setTimeout(()=>{
      toastBox.classList.remove("show");
      toastBox.classList.remove("toast--sale");
    }, 3000);
  }

  function pushLog(title, msg, meta){
    const log = lsGet(LS.log, { ver:1, items:[] });
    log.items = Array.isArray(log.items) ? log.items : [];
    log.items.unshift({ at: now(), title, msg, meta: meta || "" });
    log.items = log.items.slice(0, 60);
    lsSet(LS.log, log);
    renderLog();
  }

  function renderLog(){
    const log = lsGet(LS.log, { ver:1, items:[] });
    const items = Array.isArray(log.items) ? log.items : [];
    if(items.length === 0){
      logEl.innerHTML = `<div class="item"><div class="t">ã¾ã ä½•ã‚‚èµ·ãã¦ã„ãªã„</div><div class="m">æ£šã«å‡ºå“ã™ã‚‹ã¨ã€æ¥å®¢ãŒå§‹ã¾ã‚‹ã‚ˆã€‚</div></div>`;
      return;
    }
    logEl.innerHTML = items.map(it => {
      const d = new Date(it.at);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `
        <div class="item">
          <div class="t">${hh}:${mm}ï½œ${escapeHTML(it.title)}</div>
          <div class="m">${escapeHTML(it.msg)}</div>
          ${it.meta ? `<div class="s">${escapeHTML(it.meta)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  /* =========================
     æ˜¼å¤œåˆ¤å®š
  ========================= */
  function isNight(){
    const h = new Date().getHours();
    return (h >= 18 || h <= 5);
  }
  function applyDayNight(){
    const night = isNight();
    stageBg.src = night ? ASSETS.bgNight : ASSETS.bgDay;
    stageTimeTag.textContent = night ? "å¤œ" : "æ˜¼";
  }

  /* =========================
     ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹
  ========================= */
  const STAGE_DEFAULT = {
    ver:1,
    hasVisitor:false,
    vUrl:"",
    vName:"â€”",
    vMsg:"ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚",
    vType:"",
    vGoal:"",
    stayMs:0,
    willBuy:false,
    targetSlot:-1,
    updatedAt:0
  };
  function loadStage(){
    const s = lsGet(LS.stage, STAGE_DEFAULT);
    return { ...STAGE_DEFAULT, ...s };
  }
  function saveStage(s){
    s.updatedAt = now();
    lsSet(LS.stage, s);
  }

  /* =========================
     ã‚¹ãƒ†ãƒ¼ã‚¸ ã‚¿ã‚¤ãƒãƒ¼
  ========================= */
  let stageTalkTimer=null;
  let stageSellTimer=null;
  let stageLeaveTimer=null;

  function clearStageTimers(){
    if(stageTalkTimer){ clearInterval(stageTalkTimer); stageTalkTimer=null; }
    if(stageSellTimer){ clearTimeout(stageSellTimer); stageSellTimer=null; }
    if(stageLeaveTimer){ clearTimeout(stageLeaveTimer); stageLeaveTimer=null; }
  }

  function setStageEmpty(msg){
    clearStageTimers();
    const s = loadStage();
    s.hasVisitor=false;
    s.vUrl="";
    s.vName="â€”";
    s.vMsg=msg || "ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚";
    s.vType="";
    s.vGoal="";
    s.stayMs=0;
    s.willBuy=false;
    s.targetSlot=-1;
    saveStage(s);
    renderStage();
  }

  function renderStage(){
    const s = loadStage();
    stageName.textContent = s.vName || "â€”";
    stageMsg.textContent  = s.vMsg  || "â€”";

    if(s.vUrl){
      stageVisitor.src = s.vUrl;
    }

    if(s.hasVisitor && s.vUrl){
      stageVisitor.classList.add("show");
    }else{
      stageVisitor.classList.remove("show");
    }
  }

  function stageFlash(kind){
    stageEl.classList.remove("flash-gold","flash-pink");
    if(kind==="gold") stageEl.classList.add("flash-gold");
    if(kind==="pink") stageEl.classList.add("flash-pink");
    setTimeout(()=> stageEl.classList.remove("flash-gold","flash-pink"), 420);
  }

  /* =========================
     core state
  ========================= */
  function loadOcto(){
    const v = Number(localStorage.getItem(LS.octo) || 0);
    return isFinite(v) ? v : 0;
  }
  function saveOcto(v){
    localStorage.setItem(LS.octo, String(Math.max(0, Math.floor(Number(v||0)))));
  }

  const LEVEL_DEFAULT = { ver:1, lv:1, exp:0, totalVisit:0, totalSold:0, updatedAt: now() };
  function needExpFor(lv){
    const table = [0, 20, 35, 55, 80, 110, 145, 185];
    if(lv < table.length) return table[lv];
    return table[table.length-1] + (lv - (table.length-1)) * 50;
  }
  function loadLevel(){
    const v = lsGet(LS.lvl, LEVEL_DEFAULT);
    v.lv = Math.max(1, Number(v.lv||1));
    v.exp = Math.max(0, Number(v.exp||0));
    v.totalVisit = Math.max(0, Number(v.totalVisit||0));
    v.totalSold = Math.max(0, Number(v.totalSold||0));
    return v;
  }
  function saveLevel(v){ v.updatedAt = now(); lsSet(LS.lvl, v); }
  function addExp(delta){
    delta = Math.max(0, Math.floor(Number(delta||0)));
    const s = loadLevel();
    s.exp += delta;
    let leveled = false;
    while(s.exp >= needExpFor(s.lv)){
      s.exp -= needExpFor(s.lv);
      s.lv += 1;
      leveled = true;
    }
    saveLevel(s);
    return { state:s, leveled };
  }

  function loadRep(){
    const v = lsGet(LS.rep, { ver:1, rep:50 });
    v.rep = clamp(Number(v.rep ?? 50), 0, 100);
    return v;
  }
  function saveRep(v){ lsSet(LS.rep, v); }
  function addRep(delta){
    const s = loadRep();
    s.rep = clamp(s.rep + Number(delta||0), 0, 100);
    saveRep(s);
    return s;
  }

  /* =========================
     Farm Inv / Book
  ========================= */
  function loadFarmInv(){
    const inv = lsGet(LS.farmInv, { ver:1, seed:{}, water:{}, fert:{} });
    inv.seed = inv.seed || {};
    inv.water = inv.water || {};
    inv.fert = inv.fert || {};
    return inv;
  }
  function loadFarmBook(){
    const book = lsGet(LS.farmBook, { ver:1, got:{} });
    book.got = book.got || {};
    return book;
  }
  function listOwnedCardsFromBook(){
    const book = loadFarmBook();
    const got = book.got || {};
    const arr = Object.keys(got).map(id => {
      const c = got[id] || {};
      const count = Math.max(0, Number(c.count||0));
      return {
        id: String(c.id || id),
        name: String(c.name || c.title || c.label || `ã‚«ãƒ¼ãƒ‰ ${id}`),
        img: c.img || c.image || c.url || c.src || "",
        rarity: String(c.rarity || c.rare || c.rank || ""),
        count,
        raw: c
      };
    }).filter(x => x.count > 0);
    arr.sort((a,b)=> (b.count-a.count) || a.name.localeCompare(b.name, "ja"));
    return arr;
  }
  function decrementBookCountById(cardId){
    const book = loadFarmBook();
    if(!book.got) book.got = {};
    const c = book.got[cardId];
    if(!c) return false;
    const cnt = Math.max(0, Number(c.count||0));
    if(cnt <= 0) return false;
    c.count = cnt - 1;
    book.got[cardId] = c;
    lsSet(LS.farmBook, book);
    return true;
  }
  function incrementBookCountById(cardId, cardSnapshot){
    const book = loadFarmBook();
    if(!book.got) book.got = {};
    const c = book.got[cardId] || (cardSnapshot ? {...cardSnapshot} : { id: cardId, name: `ã‚«ãƒ¼ãƒ‰ ${cardId}` });
    const cnt = Math.max(0, Number(c.count||0));
    c.count = cnt + 1;
    if(cardSnapshot){
      if(!c.name && cardSnapshot.name) c.name = cardSnapshot.name;
      if(!c.img && cardSnapshot.img) c.img = cardSnapshot.img;
      if(!c.rarity && cardSnapshot.rarity) c.rarity = cardSnapshot.rarity;
    }
    book.got[cardId] = c;
    lsSet(LS.farmBook, book);
    return true;
  }

  /* =========================
     MyShop shelves
  ========================= */
  const SHOP_DEFAULT = {
    ver:1,
    slots: [
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
      { item:null, priceTier:"æ™®é€š", createdAt:0 },
    ]
  };
  function loadMyShop(){
    const s = lsGet(LS.myshop, SHOP_DEFAULT);
    if(!Array.isArray(s.slots)) s.slots = SHOP_DEFAULT.slots.map(x=>({...x}));
    while(s.slots.length < 5) s.slots.push({ item:null, priceTier:"æ™®é€š", createdAt:0 });
    s.slots = s.slots.slice(0,5).map(x => ({
      item: x.item || null,
      priceTier: x.priceTier || "æ™®é€š",
      createdAt: Number(x.createdAt||0),
    }));
    return s;
  }
  function saveMyShop(s){ lsSet(LS.myshop, s); }

  /* =========================
     Tick (æ¥å®¢ã®äºˆå®š)
     â€»æ—¢å­˜ã‚­ãƒ¼ã‚’ç¶­æŒã—ã¤ã¤ã€nextAtBySlot ã‚’ç¶™ç¶šåˆ©ç”¨
  ========================= */
  function loadTick(){
    const t = lsGet(LS.tick, { ver:1, nextAtBySlot:{} });
    t.nextAtBySlot = t.nextAtBySlot || {};
    return t;
  }
  function saveTick(t){ lsSet(LS.tick, t); }

  function nextVisitDelayMs(){
    return (180 + Math.floor(Math.random()*121)) * 1000; // 3ã€œ5åˆ†
  }

  function ensureNextAtForActiveSlots(){
    const shop = loadMyShop();
    const lv = loadLevel().lv;
    const t = loadTick();
    t.nextAtBySlot = t.nextAtBySlot || {};
    const n = now();

    shop.slots.forEach((slot, idx)=>{
      const active = !!slot.item && canUseSlot(idx, lv);
      const key = String(idx);
      if(!active){
        delete t.nextAtBySlot[key];
        return;
      }
      const cur = Number(t.nextAtBySlot[key]||0);
      if(!cur || cur < n - 60*1000){
        t.nextAtBySlot[key] = n + nextVisitDelayMs();
      }
    });

    saveTick(t);
    return t;
  }

  function updateNextTag(){
    const t = loadTick();
    const nowMs = now();
    const list = Object.values(t.nextAtBySlot || {}).map(v=>Number(v||0)).filter(v=>v>0);
    if(list.length === 0){
      stageNextTag.textContent = "æ¬¡ï¼šâ€”";
      return;
    }
    const nextAt = Math.min(...list);
    const sec = Math.max(0, Math.ceil((nextAt - nowMs)/1000));
    stageNextTag.textContent = `æ¬¡ï¼š${sec}s`;
  }

  /* =========================
     å‘¼ã³è¾¼ã¿ CT
  ========================= */
  function loadShout(){ return lsGet(LS.shout, { ver:1, nextOkAt:0 }); }
  function saveShout(s){ lsSet(LS.shout, s); }

  /* =========================
     Price base (å¤‰æ›´æ¸ˆã¿)
  ========================= */
  function basePriceFor(card){
    const p = Number(card?.raw?.price ?? card?.raw?.basePrice ?? card?.price ?? 0);
    if(isFinite(p) && p > 0) return Math.floor(p);

    const r = String(card?.rarity || "").toUpperCase();
    const map = { "N":500, "R":800, "SR":2000, "UR":5000, "LR":10000 };
    for(const k of Object.keys(map)){
      if(r === k || r.includes(k)) return map[k];
    }
    return 500; // ä¸æ˜ã¯N
  }
  function tierMult(tier){
    if(tier === "å®‰ã„") return 0.80;
    if(tier === "é«˜ã„") return 1.30;
    return 1.00;
  }
  function repFactor(rep){
    return 0.80 + (rep/100)*0.40; // 0.8..1.2
  }

  /* =========================
     Customer typesï¼ˆè³¼å…¥ç‡ï¼‹è©•åˆ¤ï¼‰
  ========================= */
  const CUSTOMER_TYPES = [
    {
      id:"impulse",
      name:"å³æ±ºã‚¿ã‚³æ°‘",
      repDeltaOnBuy:+1,
      baseBuy: 0.42,
      lines: VISITOR_LINES.impulse
    },
    {
      id:"picky",
      name:"ã“ã ã‚ã‚Šã‚¿ã‚³æ°‘",
      repDeltaOnBuy:+1,
      baseBuy: 0.45,
      lines: VISITOR_LINES.picky
    },
    {
      id:"king",
      name:"ç‹æ§˜ã‚¿ã‚³æ°‘",
      repDeltaOnBuy:+3,
      baseBuy: 0.55,
      lines: VISITOR_LINES.king
    },
    {
      id:"flipper",
      name:"è»¢å£²ã‚¿ã‚³æ°‘",
      repDeltaOnBuy:-4,
      baseBuy: 0.44,
      lines: VISITOR_LINES.flipper
    },
    {
      id:"careful",
      name:"æ…é‡ã‚¿ã‚³æ°‘",
      repDeltaOnBuy:+1,
      baseBuy: 0.38,
      lines: VISITOR_LINES.careful
    },
    {
      id:"looker",
      name:"å†·ã‚„ã‹ã—ã‚¿ã‚³æ°‘",
      repDeltaOnBuy:-1,
      baseBuy: 0.22,
      lines: VISITOR_LINES.looker
    }
  ];

  function chooseCustomer(rep){
    // å¤œï¼†è©•åˆ¤ã§é‡ã¿å¤‰åŒ–
    const night = isNight();
    const weights = CUSTOMER_TYPES.map(t=>{
      if(t.id==="king") return rep>=55 ? 7 : 3;
      if(t.id==="flipper") return rep>=70 ? 4 : 7;
      if(t.id==="looker") return night ? 10 : 14;
      if(t.id==="impulse") return rep<40 ? 18 : 22;
      if(t.id==="careful") return 16;
      return rep>=60 ? 24 : 20; // picky
    });

    // è©•åˆ¤70ä»¥ä¸Šã§å¸¸é€£ç™ºç”Ÿï¼ˆpickyã‚’å¸¸é€£æ‰±ã„ã§å¢—ï¼‰
    if(rep>=70){
      const idx = CUSTOMER_TYPES.findIndex(x=>x.id==="picky");
      if(idx>=0) weights[idx] += 10;
    }

    const total = weights.reduce((a,b)=>a+b,0) || 1;
    let r = Math.random() * total;
    for(let i=0;i<CUSTOMER_TYPES.length;i++){
      r -= weights[i];
      if(r <= 0) return CUSTOMER_TYPES[i];
    }
    return CUSTOMER_TYPES[0];
  }

  function pickVisitorAsset(customerId){
    const v = ASSETS.visitors.find(x=>x.type===customerId);
    return v || pick(ASSETS.visitors);
  }

  /* =========================
     Goal selection
  ========================= */
  function chooseGoal(customerId, rep){
    // ç‹æ§˜ã¯ãƒ¬ã‚¢ç‹™ã„å¯„ã‚Šã€è»¢å£²ã¯å®‰ç‹™ã„å¯„ã‚Š
    if(customerId==="king") return "rare";
    if(customerId==="flipper") return "cheap";
    // è©•åˆ¤é«˜ã„ã»ã©ãƒ¬ã‚¢ç‹™ã„å¢—
    const roll = Math.random();
    if(rep>=70){
      if(roll<0.22) return "ur";
      if(roll<0.62) return "rare";
      if(roll<0.78) return "cheap";
      return "any";
    }else{
      if(roll<0.10) return "ur";
      if(roll<0.42) return "rare";
      if(roll<0.62) return "cheap";
      return "any";
    }
  }

  /* =========================
     Shelves UI
  ========================= */
  const SHELF_UNLOCK = [1,1,2,3,4];
  const PRICE_TIERS = ["å®‰ã„","æ™®é€š","é«˜ã„"];
  let currentPickSlot = -1;

  function canUseSlot(idx, lv){ return lv >= (SHELF_UNLOCK[idx] || 99); }

  function slotSummaryText(slot){
    if(!slot.item) return { t:"æœªå‡ºå“", d:"æ£šã®ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å‡ºå“ã€‚" };
    const c = slot.item;
    const base = basePriceFor({ rarity:c.rarity, raw:c.raw, price:c.price });
    const price = Math.max(1, Math.floor(base * tierMult(slot.priceTier)));
    return { t:`${c.name}`, d:`ä¾¡æ ¼å¸¯ï¼š${slot.priceTier}ï¼ç›®å®‰ ${price}ã‚ªã‚¯ãƒˆ` };
  }

  function renderShelves(){
    const shop = loadMyShop();
    const lv = loadLevel().lv;

    shelvesEl.innerHTML = shop.slots.map((slot, idx) => {
      const unlocked = canUseSlot(idx, lv);
      const sum = slotSummaryText(slot);
      const lockText = unlocked ? "" : `Lv${SHELF_UNLOCK[idx]}ã§è§£æ”¾`;
      const c = slot.item;

      const imgHtml = c?.img
        ? `<img alt="" src="${escapeHTML(c.img)}" loading="lazy">`
        : `<div class="ph">ï¼ˆç©ºï¼‰<br>ã‚¿ãƒƒãƒ—ã§å‡ºå“</div>`;

      const tierTag = slot.item ? `<div class="tier">${escapeHTML(slot.priceTier)}</div>` : "";

      return `
      <div class="shelf ${unlocked ? "" : "locked"}" data-idx="${idx}">
        <div class="shelf-top">
          <div>
            <div class="shelf-name">æ£š${idx+1}</div>
            <div class="shelf-tag">${unlocked ? "å‡ºå“ä¸­" : `ğŸ”’ ${lockText}`}</div>
          </div>
          <div class="pill"><span>ä¾¡æ ¼</span><b class="mono">${escapeHTML(slot.priceTier||"æ™®é€š")}</b></div>
        </div>

        <div class="shelf-body">
          <div class="slot" data-act="pickSlot" data-idx="${idx}">
            ${imgHtml}${tierTag}
          </div>

          <div class="shelf-info">
            <div class="line"><b>${escapeHTML(sum.t)}</b></div>
            <div class="line">${escapeHTML(sum.d)}</div>

            <div class="shelf-actions">
              <button class="btn mini" data-act="pick" data-idx="${idx}" ${unlocked ? "" : "disabled"}>${slot.item ? "å…¥ã‚Œæ›¿ãˆ" : "å‡ºå“"}</button>
              <button class="btn mini" data-act="tier" data-idx="${idx}" ${unlocked ? "" : "disabled"}>ä¾¡æ ¼å¸¯å¤‰æ›´</button>
              <button class="btn mini" data-act="remove" data-idx="${idx}" ${slot.item && unlocked ? "" : "disabled"}>å–ã‚Šä¸‹ã’</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  /* =========================
     Stats / Inv / Book
  ========================= */
  function renderStats(){
    const lv = loadLevel();
    const rep = loadRep().rep;
    const octo = loadOcto();
    const nextNeed = needExpFor(lv.lv);
    const pct = nextNeed ? Math.floor((lv.exp/nextNeed)*100) : 0;

    repTextEl.textContent = `${Math.round(rep)}/100`;

    const repLabel = rep>=70 ? "å¥½èª¿" : rep>=45 ? "æ™®é€š" : "ä¸ç©";
    const repClass = rep>=70 ? "good" : rep>=45 ? "warn" : "bad";

    statsEl.innerHTML = `
      <div class="stat">
        <div class="k">ã‚ªã‚¯ãƒˆ</div>
        <div class="v"><span class="mono">${fmt(octo)}</span><small>ã€Šã‚ªã‚¯ãƒˆã€‹</small></div>
      </div>
      <div class="stat">
        <div class="k">éœ²åº—Lv</div>
        <div class="v"><span class="mono">${lv.lv}</span><small>EXP ${lv.exp}/${nextNeed} (${pct}%)</small></div>
      </div>
      <div class="stat">
        <div class="k">è©•åˆ¤</div>
        <div class="v"><span class="${repClass} mono">${Math.round(rep)}</span><small>${repLabel}</small></div>
      </div>
      <div class="stat">
        <div class="k">å®Ÿç¸¾</div>
        <div class="v"><span class="mono">${lv.totalSold}</span><small>è²©å£² / æ¥å®¢ ${lv.totalVisit}</small></div>
      </div>
    `;
  }

  function renderInv(){
    const inv = loadFarmInv();
    const chips = [];
    const sumObj = (obj) => Object.keys(obj||{}).reduce((a,k)=> a + Math.max(0, Number(obj[k]||0)), 0);

    const seedSum = sumObj(inv.seed);
    const waterSum = sumObj(inv.water);
    const fertSum = sumObj(inv.fert);

    chips.push(`<span class="chip">ğŸŒ± ç¨® <span class="n">${fmt(seedSum)}</span></span>`);
    chips.push(`<span class="chip">ğŸ’§ æ°´ <span class="n">${fmt(waterSum)}</span></span>`);
    chips.push(`<span class="chip">ğŸ§ª è‚¥æ–™ <span class="n">${fmt(fertSum)}</span></span>`);

    invChipsEl.innerHTML = chips.join("");
  }

  function renderBookSummary(){
    const owned = listOwnedCardsFromBook();
    const totalKinds = owned.length;
    const totalCount = owned.reduce((a,c)=>a + c.count, 0);

    const top = owned.slice(0, 6);
    let html = `
      <span class="chip">ğŸ“š ç¨®é¡ <span class="n">${fmt(totalKinds)}</span></span>
      <span class="chip">ğŸ§¾ æšæ•° <span class="n">${fmt(totalCount)}</span></span>
    `;
    top.forEach(c=>{
      html += `<span class="chip">ğŸƒ ${escapeHTML(c.name)} <span class="n">Ã—${fmt(c.count)}</span></span>`;
    });
    bookChipsEl.innerHTML = html;
  }

  /* =========================
     Modal pick
  ========================= */
  function openPickModal(slotIdx){
    currentPickSlot = slotIdx;
    const lv = loadLevel().lv;
    if(!canUseSlot(slotIdx, lv)){
      toast("ã¾ã è§£æ”¾ã•ã‚Œã¦ã„ãªã„æ£š", `Lv${SHELF_UNLOCK[slotIdx]}ã§æ£š${slotIdx+1}ãŒè§£æ”¾`);
      return;
    }

    const shop = loadMyShop();
    const slot = shop.slots[slotIdx];

    pickTitleEl.textContent = `æ£š${slotIdx+1}ã«å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰`;
    pickHintEl.textContent = `æ‰€æŒæ•°ï¼ˆcountï¼‰ãŒ1ä»¥ä¸Šã®ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å‡ºå“ã™ã‚‹ã¨æ‰€æŒæ•°ãŒ1æ¸›ã‚Šã¾ã™ã€‚`;
    pickEmptyEl.style.display = "none";

    const owned = listOwnedCardsFromBook();
    if(owned.length === 0){
      pickCardsEl.innerHTML = "";
      pickEmptyEl.style.display = "block";
    }else{
      pickCardsEl.innerHTML = owned.map(c=>{
        const base = basePriceFor(c);
        const est = Math.max(1, Math.floor(base * tierMult(slot.priceTier)));
        const img = c.img
          ? `<img alt="" src="${escapeHTML(c.img)}" loading="lazy">`
          : `<div class="ph">ç”»åƒãªã—<br>ï¼ˆOKï¼‰</div>`;
        const r = c.rarity ? String(c.rarity) : "â€”";
        return `
          <div class="citem" data-card="${escapeHTML(c.id)}">
            <div class="cimg">
              ${img}
              <div class="cnt">Ã—${fmt(c.count)}</div>
            </div>
            <div class="cmeta">
              <div class="cname">${escapeHTML(c.name)}</div>
              <div class="csub"><span>å¸Œå°‘ï¼š${escapeHTML(r)}</span><span>${fmt(est)}ã‚ªã‚¯ãƒˆ</span></div>
            </div>
          </div>
        `;
      }).join("");
    }

    pickModal.classList.add("show");
    pickModal.setAttribute("aria-hidden","false");
  }

  function closePickModal(){
    pickModal.classList.remove("show");
    pickModal.setAttribute("aria-hidden","true");
    currentPickSlot = -1;
  }

  pickCardsEl.addEventListener("click", (e)=>{
    const item = e.target.closest(".citem");
    if(!item) return;
    const cardId = item.getAttribute("data-card");
    if(!cardId) return;

    const shop = loadMyShop();
    const slot = shop.slots[currentPickSlot];
    if(!slot) return;

    // æ—¢ã«å‡ºå“ä¸­ãªã‚‰ä¸€æ—¦æˆ»ã™
    if(slot.item){
      incrementBookCountById(String(slot.item.id), slot.item.raw || slot.item);
    }

    // æ‰€æŒã‚’æ¸›ã‚‰ã™
    const ok = decrementBookCountById(cardId);
    if(!ok){
      toast("æ‰€æŒæ•°ãŒè¶³ã‚Šãªã„", "ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­");
      return;
    }

    // snapshot
    const book = loadFarmBook();
    const raw = book.got[cardId] || {};
    const snap = {
      id: String(raw.id || cardId),
      name: String(raw.name || raw.title || `ã‚«ãƒ¼ãƒ‰ ${cardId}`),
      img: raw.img || raw.image || raw.url || raw.src || "",
      rarity: String(raw.rarity || raw.rare || raw.rank || ""),
      raw
    };

    slot.item = snap;
    slot.createdAt = now();

    shop.slots[currentPickSlot] = slot;
    saveMyShop(shop);

    // tickã‚»ãƒƒãƒˆ
    const t = loadTick();
    t.nextAtBySlot = t.nextAtBySlot || {};
    t.nextAtBySlot[String(currentPickSlot)] = now() + nextVisitDelayMs();
    saveTick(t);

    pushLog(`æ£š${currentPickSlot+1} å‡ºå“`, `${snap.name} ã‚’å‡ºå“ã—ãŸ`, `tier=${slot.priceTier}`);

    closePickModal();
    renderAll();
    toast("å‡ºå“å®Œäº†", `æ£š${currentPickSlot+1}ã«ã€Œ${snap.name}ã€ã‚’ç½®ã„ãŸ`);
  });

  /* =========================
     Shelf actions
  ========================= */
  shelvesEl.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    const slotTap = e.target.closest(".slot");
    const shelf = e.target.closest(".shelf");
    const idx = btn ? Number(btn.getAttribute("data-idx"))
              : slotTap ? Number(slotTap.getAttribute("data-idx"))
              : shelf ? Number(shelf.getAttribute("data-idx")) : -1;
    if(!isFinite(idx) || idx<0) return;

    const act = btn ? btn.getAttribute("data-act")
              : slotTap ? slotTap.getAttribute("data-act")
              : null;

    // ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ã‚¿ãƒƒãƒ—ã§ã‚‚å‡ºå“ãƒ¢ãƒ¼ãƒ€ãƒ«
    if(act === "pickSlot"){
      const lv = loadLevel().lv;
      if(!canUseSlot(idx, lv)){
        toast("æ£šãŒã¾ã é–‰ã¾ã£ã¦ã„ã‚‹", `Lv${SHELF_UNLOCK[idx]}ã§æ£š${idx+1}ãŒè§£æ”¾`);
        return;
      }
      openPickModal(idx);
      return;
    }

    if(!act && shelf){
      const lv = loadLevel().lv;
      if(!canUseSlot(idx, lv)){
        toast("æ£šãŒã¾ã é–‰ã¾ã£ã¦ã„ã‚‹", `Lv${SHELF_UNLOCK[idx]}ã§æ£š${idx+1}ãŒè§£æ”¾`);
        return;
      }
      openPickModal(idx);
      return;
    }

    if(act === "pick"){ openPickModal(idx); return; }

    if(act === "tier"){
      const lv = loadLevel().lv;
      if(!canUseSlot(idx, lv)) return;

      const shop = loadMyShop();
      const slot = shop.slots[idx];
      const cur = slot.priceTier || "æ™®é€š";
      const next = PRICE_TIERS[(PRICE_TIERS.indexOf(cur)+1+PRICE_TIERS.length)%PRICE_TIERS.length];
      slot.priceTier = next;
      shop.slots[idx] = slot;
      saveMyShop(shop);

      pushLog(`æ£š${idx+1} ä¾¡æ ¼å¸¯`, `ä¾¡æ ¼å¸¯ã‚’ã€Œ${next}ã€ã«å¤‰æ›´`, "");

      // æ¬¡æ¥å®¢ã‚’å°‘ã—æ—©ã‚ã‚‹
      const t = loadTick();
      t.nextAtBySlot = t.nextAtBySlot || {};
      if(slot.item){
        t.nextAtBySlot[String(idx)] = Math.min(Number(t.nextAtBySlot[String(idx)]||Infinity), now() + 60*1000);
      }
      saveTick(t);

      renderAll();
      toast("ä¾¡æ ¼å¸¯å¤‰æ›´", `æ£š${idx+1}ï¼š${next}`);
      return;
    }

    if(act === "remove"){
      const lv = loadLevel().lv;
      if(!canUseSlot(idx, lv)) return;

      const shop = loadMyShop();
      const slot = shop.slots[idx];
      if(!slot.item) return;

      incrementBookCountById(String(slot.item.id), slot.item.raw || slot.item);

      pushLog(`æ£š${idx+1} å–ã‚Šä¸‹ã’`, `${slot.item.name} ã‚’å–ã‚Šä¸‹ã’ãŸ`, "");

      slot.item = null;
      slot.createdAt = 0;
      shop.slots[idx] = slot;
      saveMyShop(shop);

      const t = loadTick();
      if(t.nextAtBySlot) delete t.nextAtBySlot[String(idx)];
      saveTick(t);

      renderAll();
      toast("å–ã‚Šä¸‹ã’å®Œäº†", `æ£š${idx+1} ã‚’ç©ºã«ã—ãŸ`);
      return;
    }
  });

  /* =========================
     æ¥å®¢ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šå£²è²·ã®ä¸­å¿ƒ
  ========================= */

  function getActiveSlots(){
    const shop = loadMyShop();
    const lv = loadLevel().lv;
    return shop.slots
      .map((s,i)=>({slot:s, idx:i}))
      .filter(x => x.slot.item && canUseSlot(x.idx, lv));
  }

  // ç›®çš„ã«åˆã‚ã›ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ£šã‚’é¸ã¶
  function chooseTargetSlot(active, goalId){
    if(active.length===0) return -1;

    const scored = active.map(x=>{
      const item = x.slot.item;
      const rarity = String(item?.rarity||"").toUpperCase();
      const base = basePriceFor({ rarity, raw:item?.raw, price:item?.price });
      const tiered = Math.max(1, Math.floor(base * tierMult(x.slot.priceTier)));

      const isSR = rarity.includes("SR");
      const isUR = rarity.includes("UR");
      const isLR = rarity.includes("LR");

      let score = 10;

      if(goalId==="cheap"){
        score += (x.slot.priceTier==="å®‰ã„") ? 18 : (x.slot.priceTier==="æ™®é€š" ? 6 : -6);
        score += (tiered<=800) ? 10 : -4;
      }
      if(goalId==="rare"){
        score += (isLR?26:isUR?20:isSR?12:0);
        score += (x.slot.priceTier==="é«˜ã„") ? 3 : 0;
      }
      if(goalId==="ur"){
        score += (isLR?40:isUR?30:-20);
      }
      if(goalId==="any"){
        score += rand(0,8);
      }

      return { idx:x.idx, score };
    });

    scored.sort((a,b)=>b.score-a.score);
    // ä¸Šä½2ã¤ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆå˜èª¿é˜²æ­¢ï¼‰
    const top = scored.slice(0, Math.min(2, scored.length));
    return pick(top).idx;
  }

  // è³¼å…¥ç¢ºç‡ï¼šæ»åœ¨é•·ã„ã»ã©UP + è©•åˆ¤ + å®¢ã‚¿ã‚¤ãƒ— + ç›®çš„é”æˆåº¦
  function computeBuyChance(customer, goalId, targetSlotIdx, stayMs){
    const rep = loadRep().rep;

    // åŸºç¤
    let p = Number(customer.baseBuy || 0.35);

    // æ»åœ¨ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ10sâ†’+0, 30sâ†’+0.25ï¼‰
    const stayBoost = clamp((stayMs - 10000) / 20000, 0, 1) * 0.25;
    p += stayBoost;

    // è©•åˆ¤ä¿‚æ•°
    p *= repFactor(rep);

    // ç›®çš„è£œæ­£ï¼ˆç‹™ã„ã®æ£šãŒæ¡ä»¶æº€ãŸã•ãªã„ã¨ä¸‹ãŒã‚‹ï¼‰
    const shop = loadMyShop();
    const slot = shop.slots[targetSlotIdx];
    const rarity = String(slot?.item?.rarity||"").toUpperCase();

    const isSR = rarity.includes("SR");
    const isUR = rarity.includes("UR");
    const isLR = rarity.includes("LR");

    if(goalId==="ur" && !(isUR || isLR)) p *= 0.25;
    if(goalId==="rare" && !(isSR || isUR || isLR)) p *= 0.65;

    // è»¢å£²ã¯è²·ã„ã‚„ã™ã„ãŒè©•åˆ¤ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ˆæ—¢ã«repDeltaã§è¡¨ç¾ï¼‰
    if(customer.id==="flipper") p *= 1.08;
    // ç‹æ§˜ã¯æ³¢ãŒã‚ã‚‹ï¼ˆè²·ã†æ™‚ã¯è²·ã†ï¼‰
    if(customer.id==="king") p *= 1.05;

    return clamp(p, 0.05, 0.95);
  }

  // ä¾¡æ ¼æ±ºå®š
  function computePrice(slot){
    const item = slot.item;
    const base = basePriceFor({ rarity:item.rarity, raw:item.raw, price:item.price });
    return Math.max(1, Math.floor(base * tierMult(slot.priceTier)));
  }

  // å®¢ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«å‡ºã™ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã¯CSSã®showã§å‹æ‰‹ã«ï¼‰
  function spawnVisitor(){
    // æ—¢ã«å®¢ãŒå±…ã‚‹ãªã‚‰ç™ºç”Ÿã•ã›ãªã„
    const cur = loadStage();
    if(cur.hasVisitor) return;

    const active = getActiveSlots();
    if(active.length===0){
      // åœ¨åº«ã‚¼ãƒ­ã¯é™ã‹
      setStageEmpty("â€¦â€¦æ£šãŒç©ºã ã€‚èª°ã‚‚æ¥ãªã„ã€‚");
      return;
    }

    const rep = loadRep().rep;
    const customer = chooseCustomer(rep);

    // å¤œé™å®šã‚¤ãƒ™ãƒ³ãƒˆå®¢ï¼ˆlookerã‚’å¤œã‚¤ãƒ™ãƒ³ãƒˆåŒ–ï¼‰
    const night = isNight();
    let eventNight = false;
    if(night && Math.random()<0.22){
      eventNight = true;
    }

    // è©•åˆ¤70ä»¥ä¸Š å¸¸é€£è§£æ”¾ï¼ˆpickyã‚’å¸¸é€£åŒ–ã—ã¦æ¼”å‡ºï¼‰
    let isRegular = false;
    if(rep>=70 && Math.random()<0.28){
      isRegular = true;
    }

    const goalId = chooseGoal(customer.id, rep);
    const targetIdx = chooseTargetSlot(active, goalId);

    const stayMs = rand(10000, 30000);
    const willBuyChance = computeBuyChance(customer, goalId, targetIdx, stayMs);
    const willBuy = Math.random() < willBuyChance;

    // ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹æ›´æ–°
    const vAsset = pickVisitorAsset(customer.id);
    const s = loadStage();
    s.hasVisitor = true;
    s.vUrl = vAsset.url;
    s.vName = isRegular ? "å¸¸é€£ã‚¿ã‚³æ°‘" : (eventNight ? "å¤œé™å®šã‚¿ã‚³æ°‘" : customer.name);
    s.vType = customer.id;
    s.vGoal = goalId;
    s.stayMs = stayMs;
    s.willBuy = willBuy;
    s.targetSlot = targetIdx;
    s.vMsg = pick(goalLines(goalId)); // ã¾ãšç›®çš„ã‚»ãƒªãƒ•
    saveStage(s);

    // æ¥å®¢EXP +1ï¼ˆæ¥ã‚‹ã ã‘ã§è‚²ã¤ï¼‰
    const a = addExp(1);
    const lvState = a.state;
    lvState.totalVisit += 1;
    saveLevel(lvState);

    // ç‰¹åˆ¥æ¼”å‡º
    if(customer.id==="king") stageFlash("gold");
    if(customer.id==="flipper") stageFlash("pink");

    renderStage();

    // æ»åœ¨ä¸­ï¼šæ€§æ ¼ã‚»ãƒªãƒ•ï¼‹ç›®çš„ã‚»ãƒªãƒ•æ··ãœã‚‹ï¼ˆ3ã€œ6ç§’ï¼‰
    clearStageTimers();
    stageTalkTimer = setInterval(()=>{
      const cur2 = loadStage();
      if(!cur2.hasVisitor) return;
      const baseLines = VISITOR_LINES[cur2.vType] || ["â€¦â€¦"];
      const gLines = goalLines(cur2.vGoal);
      cur2.vMsg = (Math.random()<0.55) ? pick(baseLines) : pick(gLines);
      saveStage(cur2);
      renderStage();
    }, rand(3000, 6000));

    // å£²è²·åˆ¤å®šï¼šå»ã‚‹1ç§’å‰
    stageSellTimer = setTimeout(()=>{
      const cur3 = loadStage();
      if(!cur3.hasVisitor) return;
      resolveSaleAtStage();
    }, Math.max(0, stayMs - 1000));

    // å»ã‚‹ï¼ˆ1ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†ï¼†ã‚»ãƒªãƒ•ï¼‰
    stageLeaveTimer = setTimeout(()=>{
      const cur4 = loadStage();
      // ã“ã“ã§ â€œå£²ã‚ŒãŸå¾Œâ€ ã§ã‚‚ â€œå£²ã‚Œãªã‹ã£ãŸå¾Œâ€ ã§ã‚‚å¿…ãšå»ã‚‹
      stageVisitor.classList.remove("show");
      setTimeout(()=>{
        // ãƒ•ã‚§ãƒ¼ãƒ‰ãŒçµ‚ã‚ã£ãŸé ƒã«ç„¡äººçŠ¶æ…‹ã¸
        setStageEmpty(pick(LEAVE_LINES));
      }, 650);
    }, stayMs);
  }

  // å£²è²·å‡¦ç†ï¼ˆæ£šã®ã©ã‚Œã‹ãŒå£²ã‚Œã‚‹ï¼‰
  function resolveSaleAtStage(){
    const st = loadStage();
    if(!st.hasVisitor) return;

    const shop = loadMyShop();
    const idx = st.targetSlot;
    const slot = shop.slots[idx];

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ£šãŒç©ºã ã£ãŸï¼ˆå…¥æ›¿ã‚„å–ã‚Šä¸‹ã’ãŒèµ·ããŸï¼‰â†’ãã®æ™‚ç‚¹ã§å£²è²·ãªã—
    if(!slot || !slot.item){
      st.vMsg = "â€¦â€¦æ£šãŒå¤‰ã‚ã£ãŸã€‚ä»Šæ—¥ã¯ç¸ãŒãªã‹ã£ãŸã€‚";
      saveStage(st);
      renderStage();
      return;
    }

    const customer = CUSTOMER_TYPES.find(c=>c.id===st.vType) || { id:st.vType, name:st.vName, repDeltaOnBuy:0, baseBuy:0.3 };

    // willBuy ã¯æ¥åº—æ™‚ã«æ±ºã‚ãŸãŒã€æ£šçŠ¶æ³å¤‰åŒ–ã‚‚ã‚ã‚‹ã®ã§å¾®èª¿æ•´
    // ç›®çš„æœªé”ãªã‚‰è²·ã‚ãªã„æ–¹å‘ã«å¯„ã›ã‚‹
    const rep = loadRep().rep;
    const stayMs = st.stayMs || 15000;
    const chance = computeBuyChance(customer, st.vGoal, idx, stayMs);
    const sold = st.willBuy ? (Math.random() < Math.max(chance, 0.18)) : (Math.random() < Math.min(chance, 0.35));

    if(!sold){
      // å£²ã‚Œãªã„ï¼šè©•åˆ¤ã¡ã‚‡ã„ä¸‹ã’
      addRep(-0.4);
      pushLog("å£²ã‚Œãªã‹ã£ãŸ", `${st.vName} ã¯è¦‹ãŸã ã‘ã§å»ã‚Šãã†ã `, `æ£š${idx+1} / p=${Math.round(chance*100)}%`);
      // ã“ã“ã§ã¯å»ã‚‰ãªã„ï¼ˆå»ã‚Šã‚¿ã‚¤ãƒãƒ¼ãŒæ‹…å½“ï¼‰
      return;
    }

    // å£²ã‚ŒãŸ
    const price = computePrice(slot);
    const cardName = slot.item.name;

    // å£²ä¸Šãƒ»EXP
    saveOcto(loadOcto() + price);

    const r2 = addExp(4);
    const lv2 = r2.state;
    lv2.totalSold += 1;
    saveLevel(lv2);

    // è©•åˆ¤å¤‰å‹•
    addRep(customer.repDeltaOnBuy);

    // ãƒ­ã‚° & ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰åå…¥ã‚Šï¼‰
    pushLog("å£²ã‚ŒãŸï¼", `${st.vName} ãŒã€Œ${cardName}ã€ã‚’è²·ã£ãŸ`, `æ£š${idx+1} / +${price}octo`);
    toast("ğŸ’° å£²ã‚ŒãŸï¼", `ã€Œ${cardName}ã€ +${price}ã‚ªã‚¯ãƒˆ`, "sale");

    // ç‰¹åˆ¥æ¼”å‡º
    if(st.vType==="king") stageFlash("gold");
    if(st.vType==="flipper") stageFlash("pink");

    // æ£šã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆã™ï¼ˆå‡ºå“æ™‚ã«å›³é‘‘countã¯æ¸›ã£ã¦ã„ã‚‹ã®ã§æˆ»ã•ãªã„ï¼‰
    slot.item = null;
    slot.createdAt = 0;
    shop.slots[idx] = slot;
    saveMyShop(shop);

    // tickæ¶ˆã™ï¼ˆãã®æ£šã¯ã‚‚ã†å£²ã‚‹ç‰©ãŒç„¡ã„ï¼‰
    const t = loadTick();
    if(t.nextAtBySlot) delete t.nextAtBySlot[String(idx)];
    saveTick(t);

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚»ãƒªãƒ•ã‚’è³¼å…¥å¾Œã«å¤‰æ›´ï¼ˆå»ã‚‹ç›´å‰ãªã®ã§çŸ­ãï¼‰
    const st2 = loadStage();
    st2.vMsg = (st.vType==="king")
      ? "â€¦â€¦ä½™ã¯æº€è¶³ã—ãŸã€‚"
      : (st.vType==="flipper")
      ? "â€¦â€¦å›ã£ãŸã€‚æ’¤åã€‚"
      : "â€¦â€¦è²·ã£ãŸã€‚ç„¼ã‹ã‚ŒãŸã€‚";
    saveStage(st2);
    renderStage();

    // UIæ›´æ–°
    renderAll();
  }

  /* =========================
     Loopï¼šæ¥å®¢ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°
  ========================= */
  let loopTimer = null;

  function startLoop(){
    if(loopTimer) clearInterval(loopTimer);
    ensureNextAtForActiveSlots();

    loopTimer = setInterval(()=>{
      try{
        applyDayNight();
        updateNextTag();

        // æ—¢ã«å®¢ãŒå±…ã‚‹ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆå£²è²·ã¯ã‚¿ã‚¤ãƒãƒ¼ã§èµ°ã‚‹ï¼‰
        const st = loadStage();
        if(st.hasVisitor) return;

        // æœ€çŸ­nextAtã«åˆ°é”ã—ãŸã‚‰æ¥å®¢
        const t = ensureNextAtForActiveSlots();
        const n = now();
        const list = Object.entries(t.nextAtBySlot||{})
          .map(([k,v])=>({k, v:Number(v||0)}))
          .filter(x=>x.v>0);

        if(list.length===0) return;

        const nextAt = Math.min(...list.map(x=>x.v));
        if(n >= nextAt){
          // ã„ãšã‚Œã‹ã®æ£šã®æ¥å®¢ã‚¿ã‚¤ãƒŸãƒ³ã‚° â†’ ã‚¹ãƒ†ãƒ¼ã‚¸ã«æ¥å®¢ï¼ˆã©ã®æ£šãŒå£²ã‚Œã‚‹ã‹ã¯ç›®çš„ã§æ±ºã‚ã‚‹ï¼‰
          spawnVisitor();

          // å…¨æ£šã®nextAtã‚’å°‘ã—å…ˆé€ã‚Šï¼ˆæ¥å®¢ã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã¨ã‚ã¦æ‰±ã†ï¼‰
          // â€» æ—¢å­˜ä»•æ§˜ã«è¿‘ãã€éå‰°ç™ºç”Ÿã‚’é˜²ã
          const tt = loadTick();
          Object.keys(tt.nextAtBySlot||{}).forEach(k=>{
            if(tt.nextAtBySlot[k]) tt.nextAtBySlot[k] = n + nextVisitDelayMs();
          });
          saveTick(tt);

          renderAll();
        }
      }catch(e){
        // è½ã¡ãªã„
      }
    }, 1000);
  }

  /* =========================
     å‘¼ã³è¾¼ã¿ï¼ˆå³æ¥å®¢ï¼‰
  ========================= */
  async function doShout(){
    const cd = loadShout();
    const n = now();
    const remain = Number(cd.nextOkAt||0) - n;
    if(remain > 0){
      toast("å‘¼ã³è¾¼ã¿ã¯ã¾ã æ—©ã„", `ã‚ã¨ ${Math.ceil(remain/1000)} ç§’`);
      return;
    }

    const active = getActiveSlots();
    if(active.length === 0){
      toast("å‘¼ã³è¾¼ã¿å¤±æ•—", "å‡ºå“ä¸­ã®æ£šãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    // æ—¢ã«å®¢ãŒã„ã‚‹ãªã‚‰å¤±æ•—ï¼ˆä½“é¨“ã®çµ±ä¸€ï¼‰
    if(loadStage().hasVisitor){
      toast("å‘¼ã³è¾¼ã¿å¤±æ•—", "ã„ã¾å®¢ãŒã„ã‚‹ï¼");
      return;
    }

    // CT 60ç§’
    cd.nextOkAt = now() + 60*1000;
    saveShout(cd);

    pushLog("å‘¼ã³è¾¼ã¿", "å®¢ã‚’å‘¼ã‚“ã ", "CT=60s");
    toast("ğŸ“£ å‘¼ã³è¾¼ã¿ï¼", "èª°ã‹æ¥ã‚‹â€¦");

    await sleep(250);
    spawnVisitor();
    renderAll();
  }

  function updateShoutBtn(){
    const cd = loadShout();
    const n = now();
    const remain = Number(cd.nextOkAt||0) - n;
    const btn = $("#shoutBtn");
    if(remain > 0){
      btn.disabled = true;
      btn.textContent = `å‘¼ã³è¾¼ã¿ï¼ˆ${Math.ceil(remain/1000)}sï¼‰`;
    }else{
      btn.disabled = false;
      btn.textContent = "å‘¼ã³è¾¼ã¿";
    }
  }

  /* =========================
     Render all
  ========================= */
  function renderAll(){
    renderStats();
    renderShelves();
    renderInv();
    renderBookSummary();
    renderLog();
    renderStage();
    updateShoutBtn();
    applyDayNight();
    updateNextTag();
  }

  /* =========================
     Events
  ========================= */
  $("#backBtn").addEventListener("click", ()=>{
    location.href = "./roten.html";
  });

  $("#refreshBtn").addEventListener("click", ()=>{
    renderAll();
    toast("æ›´æ–°ã—ãŸ", "æ‰€æŒãƒ»æ£šçŠ¶æ…‹ã‚’èª­ã¿ç›´ã—ãŸ");
  });

  $("#pickClose").addEventListener("click", closePickModal);
  $("#pickCancel").addEventListener("click", closePickModal);
  pickModal.addEventListener("click", (e)=>{
    if(e.target === pickModal) closePickModal();
  });

  $("#helpBtn").addEventListener("click", ()=>{
    helpModal.classList.add("show");
    helpModal.setAttribute("aria-hidden","false");
  });
  const closeHelp = ()=>{
    helpModal.classList.remove("show");
    helpModal.setAttribute("aria-hidden","true");
  };
  $("#helpClose").addEventListener("click", closeHelp);
  $("#helpOk").addEventListener("click", closeHelp);
  helpModal.addEventListener("click", (e)=>{
    if(e.target === helpModal) closeHelp();
  });

  $("#shoutBtn").addEventListener("click", doShout);

  /* =========================
     Boot
  ========================= */
  function boot(){
    if(localStorage.getItem(LS.octo) == null) saveOcto(0);
    if(localStorage.getItem(LS.lvl) == null) lsSet(LS.lvl, LEVEL_DEFAULT);
    if(localStorage.getItem(LS.rep) == null) lsSet(LS.rep, { ver:1, rep:50 });
    if(localStorage.getItem(LS.myshop) == null) lsSet(LS.myshop, SHOP_DEFAULT);
    if(localStorage.getItem(LS.log) == null) lsSet(LS.log, { ver:1, items:[] });
    if(localStorage.getItem(LS.stage) == null) lsSet(LS.stage, STAGE_DEFAULT);

    // æ—§ç‰ˆã®lastEventç­‰ãŒæ®‹ã£ã¦ã¦ã‚‚å‹•ãã‚ˆã†ã«åˆæœŸåŒ–ï¼ˆå®‰å…¨ï¼‰
    const shop = loadMyShop();
    saveMyShop(shop);

    if(!loadStage().updatedAt){
      setStageEmpty("ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚");
    }

    renderAll();
    startLoop();
    setInterval(updateShoutBtn, 250);
  }

  boot();
})();
</script>
</body>
</html>




