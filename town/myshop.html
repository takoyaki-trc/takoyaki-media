<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒã‚¤éœ²åº—</title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff5a6a;
      --blue:#6bb7ff;
      --btn:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --tile:84px;
      --thumbPad:5px;
      --gap:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    }
    body.noscroll{ overflow:hidden; touch-action:none; }

    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 90px}
    .mono{font-family:var(--mono)}
    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
    }
    .btn:active{transform:translateY(1px)}
    .btn.warn obvious{background:linear-gradient(180deg, rgba(255,211,138,.18), rgba(255,255,255,.10));}
    .btn.warn{background:linear-gradient(180deg, rgba(255,211,138,.18), rgba(255,255,255,.10));}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:12px;
      white-space:nowrap;
    }

    /* header */
    .header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(to bottom, rgba(15,18,32,.95), rgba(15,18,32,.55));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .head-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
    .back{
      width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
      background:var(--btn); color:var(--text); font-size:18px; cursor:pointer;
    }
    .titlebox{flex:1;min-width:0}
    .title{font-size:16px;font-weight:900;letter-spacing:.02em}
    .top-actions{display:flex;gap:8px;align-items:center}
    .shout-wrap{display:flex;flex-direction:column;gap:4px;align-items:flex-end}
    .shout-sub{
      font-size:11px; color:rgba(255,255,255,.70);
      line-height:1;
      min-height:12px;
    }

    /* cards */
    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card-title{font-weight:900;font-size:14px}
    .card-desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}
    .card-b{padding:12px}

    /* stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      margin-bottom:12px;
    }
    @media (max-width: 560px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px;
      min-height:62px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:900;margin-top:4px;display:flex;align-items:baseline;gap:6px}
    .stat .v small{font-size:11px;color:var(--muted);font-weight:700}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)} .blue{color:var(--blue)}

    /* æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ */
    .stage-card{margin-bottom:12px}
    .stage{
      position:relative;
      width:100%;
      max-width:980px;
      height:192px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    @media (max-width: 520px){ .stage{height:180px;} }
    .stage-bg{width:100%;height:100%;object-fit:cover;image-rendering:pixelated;display:block}
    .stage-visitor{
      position:absolute;
      bottom:28px; left:50%;
      height:150px;
      image-rendering: pixelated;
      pointer-events:none;
      opacity:0;
      transform:translateX(-50%) translateY(8px);
      transition: opacity .45s ease, transform .45s ease;
      will-change: opacity, transform;
    }
    .stage-visitor.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .stage-ui{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .bubble{
      max-width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.58);
      border-radius:14px;
      note: none;
      padding:8px 10px;
      line-height:1.25;
    }
    .bubble .n{font-weight:1000;font-size:12px}
    .bubble .n.badname{color:var(--bad)}
    .bubble .n.bluename{color:var(--blue)}
    .bubble .m{color:rgba(255,255,255,.86);font-size:12px;margin-top:3px}
    .stage-tags{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .tag{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.45);
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* layout */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}

    /* shelves */
    .shelves{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:10px;}
    @media (max-width: 560px){ .shelves{grid-template-columns:1fr} }
    .shelf{
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08));
      overflow:hidden;
    }
    .shelf.locked{opacity:.6;filter:saturate(.7)}
    .shelf-top{
      padding:10px 10px 8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px dashed rgba(255,255,255,.16);
    }
    .shelf-name{font-weight:900;font-size:13px}
    .shelf-tag{font-size:11px;color:var(--muted)}
    .shelf-body{padding:10px;display:flex;gap:10px;align-items:flex-start}
    .slot{
      width:76px; height:108px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .slot img{
      width:100%;height:100%;
      object-fit:contain;
      padding:3px;
      image-rendering:pixelated;
      display:block;
    }
    .slot .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.65);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .slot .tier{
      position:absolute;left:6px;top:6px;
      font-size:10px;font-weight:1000;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      padding:2px 6px;border-radius:999px;
    }
    .shelf-info{flex:1;min-width:0}
    .line{font-size:12px;color:var(--muted);line-height:1.35}
    .line b{color:var(--text)}
    .line + .line{margin-top:6px}
    .shelf-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}

    /* log */
    .log{
      font-size:12px;color:var(--muted);
      line-height:1.35;
      display:flex;flex-direction:column;gap:8px;
      max-height:260px; overflow:auto;
      padding-right:6px;
      -webkit-overflow-scrolling: touch;
      border-radius:12px;
    }
    .log .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:12px;padding:8px 10px;
    }
    .log .t{color:rgba(255,255,255,.86);font-weight:1000}
    .log .m{margin-top:3px}
    .log .s{margin-top:3px;font-family:var(--mono);font-size:11px;opacity:.85}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding:14px 12px;
      overscroll-behavior: contain;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background:rgba(15,18,32,.98);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 86vh;
      display:flex;
      flex-direction:column;
    }
    .sheet-h{
      padding:12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .sheet-h b{font-size:14px}
    .sheet-b{
      padding:12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
      touch-action: pan-y;
    }
    .sheet-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid var(--line);flex:0 0 auto}
    .close{width:40px;height:40px;border-radius:12px}

    /* å‡ºå“ã‚«ãƒ¼ãƒ‰é¸æŠ */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(var(--tile), 1fr));
      gap:var(--gap);
      align-items:stretch;
    }
    .citem{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      min-height:calc(var(--tile) + 34px);
      transition:transform .12s ease, filter .12s ease;
      display:flex;
      flex-direction:column;
    }
    .citem:active{transform:scale(.985)}
    .cimg{width:100%;height:var(--tile);display:block;background:rgba(0,0,0,.14);position:relative;}
    .cimg img{
      width:100%;height:100%;
      object-fit:contain;
      padding:var(--thumbPad);
      image-rendering:pixelated;
      image-rendering:crisp-edges;
      display:block;
    }
    .cimg .ph{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.6);
      font-size:11px;text-align:center;padding:8px;line-height:1.2;
    }
    .cimg .cnt{
      position:absolute; right:6px; top:6px;
      font-size:11px; font-weight:1000;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.18);
      padding:3px 8px;border-radius:999px;
      font-family:var(--mono);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .cmeta{padding:7px 8px 9px;display:flex;flex-direction:column;gap:4px}
    .cname{font-size:12px;font-weight:1000;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .csub{display:flex;align-items:center;justify-content:space-between;gap:6px;color:var(--muted);font-size:11px}
    .csub .tagmini{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--muted);max-width:100%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .csub .tagmini b{color:var(--text);font-weight:800}

    /* toastï¼ˆå£²ã‚ŒãŸæ™‚ã¯è¶…ç›®ç«‹ã¤ï¼‰ */
    .toast{
      position:fixed;
      left:12px;
      right:12px;
      top:50%;
      transform: translateY(-50%);
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:200;
    }
    .toast .box{
      width:min(720px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.65);
      color:var(--text);
      border-radius:16px;
      padding:12px 14px;
      box-shadow: var(--shadow);
      pointer-events:none;
      display:none;
      text-align:left;
    }
    .toast .box.show{display:block;animation: popIn .18s ease-out;}
    @keyframes popIn{
      from{ transform: translateY(10px) scale(.98); opacity: 0; }
      to  { transform: translateY(0)   scale(1);   opacity: 1; }
    }

    .toast .box.toast--sale{
      width:min(760px, 100%);
      border:2px solid rgba(107,183,255,.55);
      background: radial-gradient(1200px 500px at 30% 10%, rgba(255,211,138,.25), rgba(0,0,0,.78)),
                  linear-gradient(180deg, rgba(107,183,255,.14), rgba(0,0,0,.72));
      box-shadow: 0 22px 70px rgba(0,0,0,.62);
      padding:16px 16px 14px;
    }
    .toast .box.toast--sale b{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
    }
    .toast .box.toast--sale .small{
      font-size:14px;
      color:rgba(255,255,255,.92);
      margin-top:8px;
      line-height:1.35
    }
    .toast .box .small{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}

    .sale-line{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .sale-pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      font-size:12px;
      font-family:var(--mono);
      color:rgba(255,255,255,.92);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="head-inner">
      <button class="back" id="backBtn" type="button" aria-label="æˆ»ã‚‹">â†</button>
      <div class="titlebox">
        <div class="title">ãƒã‚¤éœ²åº—</div>
      </div>

      <div class="top-actions">
        <div class="shout-wrap">
          <button class="btn warn" id="shoutBtn" type="button">å‘¼ã³è¾¼ã¿</button>
          <div class="shout-sub" id="shoutSub">â€”</div>
        </div>
        <button class="btn ghost" id="helpBtn" type="button">ï¼Ÿ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="stats" id="stats"></div>

    <div class="card stage-card">
      <div class="card-h">
        <div>
          <div class="card-title">æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸</div>
          <div class="card-desc">èƒŒæ™¯ï¼ˆæ˜¼/å¤œï¼‰ã«ã€å®¢ã‚¿ã‚³æ°‘ï¼ˆé€éï¼‰ã‚’é‡ã­ã¦è¡¨ç¤ºã€‚äºˆç´„ä¸­ã¯ã€Œæº–å‚™ä¸­ã€ã«ãªã‚‹ã€‚</div>
        </div>
        <div class="pill">
          <span>è©•åˆ¤</span>
          <b id="repText" class="mono">â€”</b>
        </div>
      </div>
      <div class="card-b">
        <div class="stage" id="stage">
          <img id="stageBg" class="stage-bg" alt="" src="">
          <img id="stageVisitor" class="stage-visitor" alt="" src="">
          <div class="stage-ui">
            <div class="bubble">
              <div class="n" id="stageName">â€”</div>
              <div class="m" id="stageMsg">ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚</div>
            </div>
            <div class="stage-tags">
              <div class="tag" id="stageTimeTag">â€”</div>
              <div class="tag" id="stageNextTag">æ¬¡ï¼šâ€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æ£šï¼ˆå‡ºå“ï¼‰</div>
            <div class="card-desc">æ£šã«ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã€‚å£²è²·ã¯æ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã§ç™ºç”Ÿã€‚</div>
          </div>
          <button class="btn" id="refreshBtn" type="button">æ›´æ–°</button>
        </div>
        <div class="card-b">
          <div class="shelves" id="shelves"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <div class="card-title">æœ€è¿‘ã®å‡ºæ¥äº‹</div>
            <div class="card-desc">ãƒ­ã‚°ï¼ˆå¿…ãšè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ç¨¼åƒï¼‰</div>
          </div>
          <button class="btn ghost" id="clearLogBtn" type="button">ãƒ­ã‚°æ¶ˆå»</button>
        </div>
        <div class="card-b">
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="pickModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶">
      <div class="sheet-h">
        <div>
          <b id="pickTitle">å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰</b>
          <div style="margin-top:4px;font-size:12px;color:var(--muted)" id="pickHint">æ£šã‚’é¸ã‚“ã§ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã€‚</div>
        </div>
        <button class="btn close" id="pickClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div class="cards" id="pickCards"></div>
        <div style="margin-top:10px;font-size:12px;color:var(--muted);display:none" id="pickEmpty">
          ãƒ€ãƒ–ã‚Šã‚«ãƒ¼ãƒ‰ï¼ˆå›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="pickCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="ãƒ˜ãƒ«ãƒ—">
      <div class="sheet-h">
        <b>éœ²åº—ã®éŠã³æ–¹</b>
        <button class="btn close" id="helpClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div style="font-size:12px;color:rgba(255,255,255,.86);line-height:1.65">
          ãƒ»æ£šã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ã€ã‹ã‚‰å‡ºå“<br>
          ãƒ»å£²è²·ã¯ã€Œæ¥åº—ã‚¹ãƒ†ãƒ¼ã‚¸ã€ã§ã®ã¿ç™ºç”Ÿ<br>
          ãƒ»æ¥å®¢ã ã‘ã§ã‚‚ EXP +1ï¼ˆè‚²ã¤ï¼‰<br>
          ãƒ»å£²ã‚ŒãŸã‚‰ EXP è¿½åŠ  +4ï¼ˆåˆè¨ˆ+5ï¼‰<br>
          ãƒ»ã€Œå‘¼ã³è¾¼ã¿ã€ã¯60ç§’ã«1å›ã€<b>æ¬¡ã®æ¥å®¢ã‚’â€œäºˆç´„â€</b>ã§ãã‚‹ï¼ˆnextã‚¿ã‚¤ãƒãƒ¼ã¯å¼„ã‚‰ãªã„ï¼‰<br>
          ãƒ»è©•åˆ¤ãŒä¸‹ãŒã‚‹å®¢ã¯åå‰ãŒèµ¤ã€ç¢ºå®Ÿã«é«˜å€¤ã§è²·ã†å®¢ã¯åå‰ãŒé’<br><br>
          <b>æ£šè§£æ”¾</b><br>
          Lv1: æ£š1-2 / Lv2: æ£š3 / Lv3: æ£š4 / Lv4: æ£š5
        </div>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="helpOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <div class="toast" aria-live="polite" aria-atomic="true">
    <div class="box" id="toastBox">
      <b id="toastTitle">â€”</b>
      <div class="small" id="toastSub">â€”</div>
      <div class="sale-line" id="toastExtra" style="display:none"></div>
    </div>
  </div>
<script>
(() => {
  "use strict";

  /* =========================
     localStorage keys
  ========================= */
  const LS = {
    octo:     "roten_v1_octo",
    myshop:   "roten_v1_myshop",
    log:      "roten_v1_log",
    lvl:      "roten_v1_level",
    rep:      "roten_v1_rep",
    tick:     "roten_v1_shop_tick",
    shout:    "roten_v1_shout_cd",
    farmBook: "tf_v1_book",
    stage:    "roten_v1_stage"
  };

  /* =========================
     DOM
  ========================= */
  const $ = (q, el=document) => el.querySelector(q);

  const shelvesEl = $("#shelves");
  const logEl = $("#log");
  const statsEl = $("#stats");
  const repTextEl = $("#repText");

  const stageBg = $("#stageBg");
  const stageVisitor = $("#stageVisitor");
  const stageName = $("#stageName");
  const stageMsg = $("#stageMsg");
  const stageTimeTag = $("#stageTimeTag");
  const stageNextTag = $("#stageNextTag");

  const refreshBtn = $("#refreshBtn");
  const clearLogBtn = $("#clearLogBtn");
  const shoutBtn = $("#shoutBtn");
  const shoutSub = $("#shoutSub");
  const backBtn = $("#backBtn");

  // å‡ºå“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚ãªãŸã®HTMLãŒã‚ã‚‹å‰æï¼‰
  const pickModal = $("#pickModal");
  const pickCardsEl = $("#pickCards");
  const pickEmptyEl = $("#pickEmpty");
  const pickTitleEl = $("#pickTitle");
  const pickHintEl = $("#pickHint");
  const pickCloseBtn = $("#pickClose");
  const pickCancelBtn = $("#pickCancel");

  const helpModal = $("#helpModal");
  const helpBtn = $("#helpBtn");
  const helpClose = $("#helpClose");
  const helpOk = $("#helpOk");

  const toastBox = $("#toastBox");
  const toastTitle = $("#toastTitle");
  const toastSub = $("#toastSub");
  const toastExtra = $("#toastExtra");

  /* =========================
     Utilities
  ========================= */
  const now = () => Date.now();
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const fmt = (n)=>(Number(n||0)).toLocaleString("ja-JP");

  function safeJSON(raw, fallback){ try{ return JSON.parse(raw);}catch(e){ return fallback; } }
  function lsGet(key, fallback){
    const raw = localStorage.getItem(key);
    if(raw==null) return fallback;
    return safeJSON(raw, fallback);
  }
  function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  /* =========================
     Assetsï¼ˆã‚ãªãŸã®URLã®ã¾ã¾ï¼‰
  ========================= */
  const ASSETS = {
    bgDay:   "https://ul.h3z.jp/lqCNnwQH.png",
    bgNight: "https://ul.h3z.jp/UtPlWaZz.png",
    visitors: [
      { id:"v01", name:"æ…é‡ã‚¿ã‚³æ°‘", type:"careful", url:"https://ul.h3z.jp/6uaLx3AV.png" },
      { id:"v02", name:"å³æ±ºã‚¿ã‚³æ°‘", type:"impulse", url:"https://ul.h3z.jp/W1dFrooC.png" },
      { id:"v03", name:"å†·ã‚„ã‹ã—ã‚¿ã‚³æ°‘", type:"looker",  url:"https://ul.h3z.jp/mD6ZkWGr.png" },
      { id:"v04", name:"ã“ã ã‚ã‚Šã‚¿ã‚³æ°‘", type:"picky",   url:"https://ul.h3z.jp/Qd8XI65E.png" },
      { id:"v05", name:"ç‹æ§˜ã‚¿ã‚³æ°‘",   type:"king",    url:"https://ul.h3z.jp/rb2bib3m.png" },
      { id:"v06", name:"è»¢å£²ã‚¿ã‚³æ°‘",   type:"flipper", url:"https://ul.h3z.jp/L2XIaBYd.png" },
      { id:"v07", name:"æœ­æŸã‚¿ã‚³æ°‘",     type:"rich",     url:"https://ul.h3z.jp/pZKu3lSE.png" },
      { id:"v08", name:"è¸ç ´ã‚¿ã‚³æ°‘",     type:"climber",  url:"https://ul.h3z.jp/45QUKopT.png" },
      { id:"v09", name:"ãƒŠãƒ“ã‚¿ã‚³æ°‘",     type:"guide",    url:"https://ul.h3z.jp/1RRwKTMt.png" },
      { id:"v10", name:"ã»ãã—ã‚¿ã‚³æ°‘",   type:"relax",    url:"https://ul.h3z.jp/dbBbLypa.png" },
      { id:"v11", name:"è¿”ã—è·äººã‚¿ã‚³æ°‘", type:"artisan",  url:"https://ul.h3z.jp/OA5StkvT.png" },
      { id:"v12", name:"ã‚¼ãƒ­ç†è«–ã‚¿ã‚³æ°‘", type:"diet",     url:"https://ul.h3z.jp/KVImBYZ8.png" },
      { id:"v13", name:"æ å¤–ã‚¿ã‚³æ°‘",     type:"overflow", url:"https://ul.h3z.jp/q4UllqyX.png" },
      { id:"v14", name:"æœªé–‹å°ä¿è­·ã‚¿ã‚³æ°‘",type:"collector",url:"https://ul.h3z.jp/zSvGyVq9.png" },
      { id:"v15", name:"è£æ£šã‚¿ã‚³æ°‘",     type:"shadow",   url:"https://ul.h3z.jp/IBKDrVAm.png" },
      { id:"v16", name:"æ›¿ãˆç‰ã‚¿ã‚³æ°‘",   type:"ramen",    url:"https://ul.h3z.jp/NViRwhdj.png" },
      { id:"v17", name:"æŠ•ã’éŠ­ã‚¿ã‚³æ°‘",   type:"streamer", url:"https://ul.h3z.jp/8PukOegd.png" },
      { id:"v18", name:"èˆŒåˆ¤å®šã‚¿ã‚³æ°‘",   type:"gourmet",  url:"https://ul.h3z.jp/We4UXFSI.png" },
      { id:"v19", name:"å³ãƒãƒªã‚¿ã‚³æ°‘",   type:"opener",   url:"https://ul.h3z.jp/9usFHTdU.png" },
      { id:"v20", name:"å®´ã‚¿ã‚³æ°‘",       type:"party",    url:"https://ul.h3z.jp/pByCAUMC.png" },
      { id:"v21", name:"è¦šæ‚Ÿã‚¿ã‚³æ°‘",     type:"pilgrim",  url:"https://ul.h3z.jp/eW2dluw2.png" }
    ]
  };

  /* =========================
     Lines
  ========================= */
  const VISITOR_LINES = {
    careful: ["ã©ã†ã—ã‚ˆã†ã‹ãªâ€¦","ã‚‚ã†å°‘ã—è¦‹ã¦ã‹ã‚‰â€¦","ä»Šæ—¥ã¯è²·ã†ã¹ãã‹â€¦","è²¡å¸ƒã«ç›¸è«‡ä¸­â€¦ï¼ˆæ—¢èª­ã‚¹ãƒ«ãƒ¼ï¼‰"],
    impulse: ["ãŠã£ã€ã„ã„ã˜ã‚ƒã‚“","ä»ŠãŒè²·ã„æ™‚ã‹ã‚‚ï¼","ã“ã‚Œã„ã£ã¨ãï¼Ÿ","å‹¢ã„ã§è²·ã†ï¼â€¦ãŸã¶ã‚“ï¼"],
    looker:  ["ãµãƒ¼ã‚“","è¦‹ã‚‹ã ã‘è¦‹ã‚ˆ","è³‘ã‚„ã‹ã ãªã‚","æ’®ã£ã¦å¸°ã‚‹ã‚ï¼ˆè²·ã‚ãªã„ï¼‰"],
    picky:   ["åŒ‚ã„ã¯æ‚ªããªã„â€¦","ç„¼ãã®ãƒ ãƒ©ã¯â€¦ï¼Ÿ","æ…é‡ã«é¸ã³ãŸã„","ä»Šæ—¥ã¯â€œæ™®é€šâ€ãŒå¼·ã„æ—¥â€¦"],
    king:    ["ã‚ˆã„ã€‚","ä½™ã¯è¿·ã‚ã¬ã€‚","ã“ã®æ£šâ€¦æ ¼ãŒã‚ã‚‹ã€‚","è²·ã†ã€‚ç•°è«–ã¯ãªã„ã€‚"],
    flipper: ["å›ã‚‹ã‹â€¦ï¼Ÿ","ã“ã‚Œã¯å‹•ãã€‚","åˆ©ç›Šã®åŒ‚ã„ãŒã™ã‚‹","è²·ã†ã€‚è©•åˆ¤ã¯çŸ¥ã‚‰ã‚“ã€‚"],
    rich: ["å€¤æ®µï¼Ÿ ã‚ã‚ã€é›°å›²æ°—ä»£ã ã‚ã†","é«˜ã„ï¼Ÿ ãã‚Œã¯â€œå¸Œå°‘â€ã¨ã„ã†æ„å‘³ã ","æ£šã”ã¨æ¬²ã—ã„ãŒâ€¦ä»Šæ—¥ã¯æˆ‘æ…¢ã™ã‚‹","ç„¼ãã®æ ¼ãŒé•ã†"],
    climber:["ã“ã®æ£šâ€¦ç™»ã‚Œã‚‹ãª","é…¸ç´ ãŒè–„ã„ã€‚ãƒ¬ã‚¢ã®é«˜åº¦ã ","é ‚ä¸Šï¼ˆURï¼‰ã¯è¿‘ã„â€¦æ°—ãŒã™ã‚‹","ã“ã“ã§æ’¤é€€ã¯æ¥ã "],
    guide:["ã“ã¡ã‚‰ãŒâ€œå¾Œæ‚”ã‚¾ãƒ¼ãƒ³â€ã§ã™","å³ã‚’è¦‹ã‚‹ã¨è²¡å¸ƒã€å·¦ã‚’è¦‹ã‚‹ã¨æ¬²æœ›","ä»Šè²·ã†ã¨â€œèªã‚Œã‚‹æ€ã„å‡ºâ€ã«ãªã‚Šã¾ã™","å‡ºå£ã¯â€¦ã‚ã€é–‰ã¾ã‚Šã¾ã—ãŸ"],
    relax:["è‚©ã®åŠ›ã€æŠœã„ã¦â€¦è²·ã„ãªï¼Ÿ","æ‚©ã¿ã¯ç­‹è‚‰ã«å‡ºã‚‹","ã“ã®æ£šã€ãƒ„ãƒœæŠ¼ã—ã¦ãã‚‹","ç‰©æ¬²ãƒªãƒ³ãƒ‘æµã‚Œã¦ã‚‹"],
    artisan:["ç„¼ãé¢â€¦ç¾ã—ã„","ã“ã‚Œã¯è¿”ã—ãŒç¥","æ‰‹ãŒå‹æ‰‹ã«å›è»¢ã‚’æƒ³åƒã™ã‚‹","â€¦è²·ã†ç†ç”±ãŒå¤šã™ãã‚‹"],
    diet:["ã“ã‚Œã¯ã‚«ãƒ¼ãƒ‰ã€‚ã¤ã¾ã‚Š0ã‚«ãƒ­ãƒªãƒ¼","è²·ã£ã¦ã‚‚å¤ªã‚‰ãªã„ã€‚ã‚€ã—ã‚ç—©ã›ã‚‹","ç½ªæ‚ªæ„ŸãŒç„¼ã‹ã‚Œã¦ã„ã‚‹","ç†è«–ä¸Šã€ç„¡é™ã«è²·ãˆã‚‹"],
    overflow:["ã‚ã€ä¿ºã¡ã‚‡ã£ã¨ã¯ã¿å‡ºã¦ã‚‹ï¼Ÿ","æ£šã‹ã‚‰å‡ºã¦ã‚‹ã®ãŒå‘³","è¦æ ¼å¤–ãŒä¸€ç•ªã†ã¾ã„","æ ã«åã¾ã‚‰ãªã„äººç”Ÿã§ã­"],
    collector:["è§¦ã‚‰ãªã„ã€‚çœºã‚ã‚‹","è²·ã†ã‹â€¦ä¿å­˜ã‹â€¦","ã“ã‚Œã¯2æšå¿…è¦ãªã‚„ã¤","æœªæ‰€æŒã®åŒ‚ã„ãŒã™ã‚‹"],
    shadow:["è¡¨ã«å‡ºã¦ã‚‹ã®ãŒå…¨ã¦ã¨ã¯é™ã‚‰ã‚“","ã“ã®æ£šã€è£ãŒã‚ã‚‹","ç›¸å ´ã¯â€¦ã¾ã é™ã‹ã ãª","ç„¼ã‹ã‚Œã¦ã„ã‚‹ã®ã¯èª°ã ï¼Ÿ"],
    ramen:["ã“ã‚Œã¯â€¦æ¿ƒã„","æ›¿ãˆç‰ï¼ˆè¿½åŠ è³¼å…¥ï¼‰ã§ãã‚‹ï¼Ÿ","ã‚¹ãƒ¼ãƒ—ã¯ç„¡ã„ãŒæ·±ã¿ã¯ã‚ã‚‹","ã€†ã«1æšã€ã„ã£ã¨ãã‹"],
    streamer:["ã¿ã‚“ãªè¦‹ã¦ã‚‹ã€œï¼Ÿ","ä»Šã‹ã‚‰é‹è©¦ã—ã™ã‚‹ã‚ˆã€œ","å½“ãŸã£ãŸã‚‰ç¥å›","å¤–ã‚Œã¦ã‚‚â€œç¾å‘³ã—ã„â€"],
    gourmet:["é¦™ã‚ŠãŒèªã‚Šã‹ã‘ã¦ãã‚‹","ç„¼ãã®æ€æƒ³ãŒã‚ã‚‹","ã“ã‚Œã¯â€œé£Ÿå¾Œã«èªã‚Œã‚‹â€","è»½ç‡ã«ã¯è²·ãˆãªã„"],
    opener:["é–‹ã‘ãŸã„","ä»Šã™ãé–‹ã‘ãŸã„","çµæœã‚ˆã‚Šâ€œéŸ³â€","æˆ‘æ…¢ï¼Ÿ ãªã«ãã‚Œï¼Ÿ"],
    party:["ä»Šæ—¥ã¯å…¨éƒ¨ç¥­ã‚Š","è²¡å¸ƒï¼Ÿ é…”ã£ã¦ã‚‹","æ™¯æ°—ã‚ˆãç„¼ã“ã†","è²·ã†ç†ç”±ã—ã‹ãªã„"],
    pilgrim:["ã“ã“ã¾ã§6æ™‚é–“","è²·ã‚ãªã„é¸æŠè‚¢ã¯ç„¡ã„","å¸°ã‚Šã‚‚6æ™‚é–“","è¨˜å¿µã«ãªã‚‹ã‚„ã¤é ¼ã‚€"]
  };

  const LEAVE_LINES = [
    "â€¦â€¦è²¡å¸ƒã¨å¿ƒãŒã€ä»Šæ—¥ã¯å™›ã¿åˆã‚ãªã‹ã£ãŸã€‚",
    "â€¦â€¦ã¾ãŸæ¥ã‚‹ã€‚ç„¼ã‹ã‚Œã‚‹è¦šæ‚ŸãŒã§ããŸã‚‰ã€‚",
    "â€¦â€¦è²·ã‚ãªã„å‹‡æ°—ã‚‚ã€ç«‹æ´¾ãªæ¶ˆè²»è¡Œå‹•ã ã‚ˆã­ã€‚",
    "â€¦â€¦ä»Šã¯ãã®æ™‚ã˜ã‚ƒãªã„ã€‚ãŸã“ç„¼ããŒãã†è¨€ã£ãŸã€‚",
    "â€¦â€¦æ£šã®åœ§ãŒå¼·ã™ãã¦ã€ä¿ºãŒç„¼ã‘ãŸã€‚",
    "â€¦â€¦å¸°å®…ã—ã¦ã‹ã‚‰å¾Œæ‚”ã™ã‚‹äºˆå®šã§ã™ã€‚",
    "â€¦â€¦ä»Šæ—¥ã¯è²·ã‚ãªã‹ã£ãŸã€‚é€†ã«ä¸€ç”Ÿè¦šãˆã¦ã‚‹"
  ];

  /* =========================
     Toast
  ========================= */
  function toast(t, s, type, extraPills){
    if(!toastBox) return;
    toastTitle.textContent = t;
    toastSub.textContent = s || "";
    toastBox.classList.remove("toast--sale");
    toastExtra.style.display = "none";
    toastExtra.innerHTML = "";

    if(type === "sale"){
      toastBox.classList.add("toast--sale");
      if(Array.isArray(extraPills) && extraPills.length){
        toastExtra.style.display = "flex";
        toastExtra.innerHTML = extraPills.map(x => `<span class="sale-pill">${escapeHTML(x)}</span>`).join("");
      }
    }

    toastBox.classList.add("show");
    clearTimeout(toastBox.__t);

    const dur = (type==="sale") ? 5200 : 3000;
    toastBox.__t = setTimeout(()=>{
      toastBox.classList.remove("show");
      toastBox.classList.remove("toast--sale");
      toastExtra.style.display = "none";
      toastExtra.innerHTML = "";
    }, dur);
  }

  /* =========================
     Log
  ========================= */
  function pushLog(title, msg, meta){
    const log = lsGet(LS.log, { ver:1, items:[] });
    log.items = Array.isArray(log.items) ? log.items : [];
    log.items.unshift({ at: now(), title, msg, meta: meta || "" });
    log.items = log.items.slice(0, 80);
    lsSet(LS.log, log);
    renderLog();
  }

  function renderLog(){
    if(!logEl) return;
    const log = lsGet(LS.log, { ver:1, items:[] });
    const items = Array.isArray(log.items) ? log.items : [];

    if(items.length === 0){
      logEl.innerHTML = `
        <div class="item">
          <div class="t">ã¾ã ä½•ã‚‚èµ·ãã¦ã„ãªã„</div>
          <div class="m">æ£šã«ãƒ€ãƒ–ã‚Šã‚«ãƒ¼ãƒ‰ã‚’å‡ºå“ã™ã‚‹ã¨ã€æ¥å®¢ãŒå§‹ã¾ã‚‹ã‚ˆã€‚</div>
          <div class="s">â€»å£²ã‚ŒãŸ/å‘¼ã³è¾¼ã¿/å–ã‚Šä¸‹ã’/ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒã“ã“ã«è¨˜éŒ²ã•ã‚Œã¾ã™</div>
        </div>
      `;
      return;
    }

    logEl.innerHTML = items.map(it => {
      const d = new Date(it.at);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `
        <div class="item">
          <div class="t">${hh}:${mm}ï½œ${escapeHTML(it.title)}</div>
          <div class="m">${escapeHTML(it.msg)}</div>
          ${it.meta ? `<div class="s">${escapeHTML(it.meta)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  /* =========================
     Stage Stateï¼ˆã“ã“ãŒä»Šå›ã®ä¿®æ­£ã®æ ¸ï¼‰
  ========================= */
  const STAGE_DEFAULT = {
    ver:2,
    hasVisitor:false,
    leaving:false,

    // â€œé€šå¸¸æ¥åº—â€ or â€œå‘¼ã³è¾¼ã¿äºˆç´„â€
    pending:false,
    pendingSlot:-1,
    pendingAt:0,

    vUrl:"",
    vName:"â€”",
    vMsg:"ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚",
    vType:"",
    vGoal:"",
    stayMs:0,
    targetSlot:-1,

    // â˜…å¾©å…ƒç”¨ï¼šæ™‚åˆ»ã‚’å¿…ãšä¿å­˜ã™ã‚‹
    arrivedAt:0,
    sellAt:0,
    leaveAt:0,

    updatedAt:0
  };

  function loadStage(){
    const st = lsGet(LS.stage, STAGE_DEFAULT);
    // è¶³ã‚Šãªã„ã‚­ãƒ¼è£œå®Œ
    for(const k of Object.keys(STAGE_DEFAULT)){
      if(st[k] === undefined) st[k] = STAGE_DEFAULT[k];
    }
    return st;
  }
  function saveStage(st){
    st.updatedAt = now();
    lsSet(LS.stage, st);
  }

  /* =========================
     Shop dataï¼ˆæ£šï¼‰
  ========================= */
  const SHOP_DEFAULT = {
    ver:2,
    exp:0,
    level:1,
    slots:[
      { id:1, item:null, priceTier:1, nextAt:0 },
      { id:2, item:null, priceTier:1, nextAt:0 },
      { id:3, item:null, priceTier:1, nextAt:0 },
      { id:4, item:null, priceTier:1, nextAt:0 },
      { id:5, item:null, priceTier:1, nextAt:0 }
    ]
  };

  function loadShop(){
    const s = lsGet(LS.myshop, SHOP_DEFAULT);
    s.slots = Array.isArray(s.slots) ? s.slots : SHOP_DEFAULT.slots;
    // nextAtãªã„æ£šãŒã‚ã‚‹ã¨å£Šã‚Œã‚‹ã®ã§è£œå®Œ
    s.slots = s.slots.map((x,i)=>({
      id: x.id ?? (i+1),
      item: x.item ?? null,
      priceTier: x.priceTier ?? 1,
      nextAt: Number(x.nextAt||0)
    }));
    return s;
  }
  function saveShop(s){ lsSet(LS.myshop, s); }

  function loadRep(){ return clamp(Number(lsGet(LS.rep, 0) || 0), -99, 99); }
  function saveRep(v){ lsSet(LS.rep, clamp(Number(v||0), -99, 99)); }

  function addOcto(n){
    const cur = Number(lsGet(LS.octo, 0) || 0);
    lsSet(LS.octo, cur + Number(n||0));
  }

  /* =========================
     UI renderï¼ˆæœ€ä½é™ï¼‰
  ========================= */
  function isNight(){
    const h = new Date().getHours();
    return (h>=18 || h<6);
  }
  function setStageBg(){
    if(!stageBg) return;
    stageBg.src = isNight() ? ASSETS.bgNight : ASSETS.bgDay;
  }

  function renderStage(){
    const st = loadStage();
    setStageBg();

    if(!stageVisitor) return;

    if(st.hasVisitor){
      stageVisitor.src = st.vUrl || "";
      stageVisitor.classList.add("show");
      stageName.textContent = st.vName || "ã‚¿ã‚³æ°‘";
      stageMsg.textContent = st.vMsg || "â€¦â€¦";
      stageTimeTag.textContent = `æ»åœ¨: ${Math.max(0, Math.ceil((st.leaveAt - now())/1000))}s`;
    }else{
      stageVisitor.src = "";
      stageVisitor.classList.remove("show");
      stageName.textContent = "â€”";
      stageMsg.textContent = st.pending ? "ï¼ˆæº–å‚™ä¸­â€¦ï¼‰" : "ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚";
      stageTimeTag.textContent = "â€”";
    }

    // æ¬¡ã®å®¢ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    const shop = loadShop();
    const nextAtAll = shop.slots
      .filter(s=>s.item)
      .map(s=>s.nextAt||0)
      .filter(t=>t>0)
      .sort((a,b)=>a-b)[0] || 0;

    if(nextAtAll>0){
      const sec = Math.max(0, Math.ceil((nextAtAll - now())/1000));
      stageNextTag.textContent = `æ¬¡: ${sec}s`;
    }else{
      stageNextTag.textContent = `æ¬¡: â€”`;
    }

    const rep = loadRep();
    if(repTextEl) repTextEl.textContent = (rep>=0?`+${rep}`:`${rep}`);
  }

  function renderStats(){
    if(!statsEl) return;
    const shop = loadShop();
    const octo = Number(lsGet(LS.octo, 0) || 0);
    const rep = loadRep();
    const listed = shop.slots.filter(s=>!!s.item).length;

    statsEl.innerHTML = `
      <div class="stat"><div class="k">ã‚ªã‚¯ãƒˆ</div><div class="v"><span class="mono">${fmt(octo)}</span><small>ğŸª™</small></div></div>
      <div class="stat"><div class="k">è©•åˆ¤</div><div class="v"><span class="mono">${rep>=0?`+${rep}`:rep}</span><small>â­</small></div></div>
      <div class="stat"><div class="k">ãƒ¬ãƒ™ãƒ«</div><div class="v"><span class="mono">${shop.level||1}</span><small>Lv</small></div></div>
      <div class="stat"><div class="k">å‡ºå“æ•°</div><div class="v"><span class="mono">${listed}</span><small>æ£š</small></div></div>
    `;
  }

  /* =========================
     ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼ˆå®¢ãŒå¸°ã‚‰ãªã„å¯¾ç­–ï¼‰
  ========================= */
  const timers = {
    arrive:null,
    sell:null,
    leave:null,
    tick:null
  };
  function clearTimers(){
    for(const k of Object.keys(timers)){
      if(timers[k]) clearTimeout(timers[k]);
      timers[k] = null;
    }
  }

  function scheduleFromState(){
    clearTimers();
    const st = loadStage();

    // ã™ã§ã«å®¢ãŒã„ã‚‹ â†’ å£²ã‚‹/å¸°ã‚‹ã‚’æ®‹ã‚Šæ™‚é–“ã‹ã‚‰å¾©å…ƒ
    if(st.hasVisitor){
      const tNow = now();
      const msToSell  = st.sellAt  ? (st.sellAt  - tNow) : 0;
      const msToLeave = st.leaveAt ? (st.leaveAt - tNow) : 0;

      // å£²ã‚‹äºˆå®šãŒæœªæ¥ãªã‚‰ã‚»ãƒƒãƒˆï¼ˆå£²ã‚‹å‡¦ç†ãŒäºŒé‡ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰ã¯å£²ã‚‹é–¢æ•°å†…ï¼‰
      if(msToSell > 0){
        timers.sell = setTimeout(() => {
          trySellOrLeave("sell");
        }, msToSell);
      }

      // â˜…å¸°ã‚‹äºˆå®šãŒæœªæ¥ãªã‚‰å¿…ãšã‚»ãƒƒãƒˆï¼ˆã“ã“ãŒã€Œå¸°ã‚‰ãªã„ã€æ ¹çµ¶ï¼‰
      if(msToLeave > 0){
        timers.leave = setTimeout(() => {
          forceLeave("leave");
        }, msToLeave);
      }else{
        // äºˆå®šæ™‚åˆ»ã‚’éãã¦ã‚‹ãªã‚‰å³å¸°ã™ï¼ˆå¾©å¸°æ™‚ã«å›ºã¾ã£ã¦ã‚‹ã®ã‚’è§£é™¤ï¼‰
        forceLeave("late_leave");
      }
    }

    // nextã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ£šã”ã¨ï¼‰ç›£è¦– â†’ ä¸€ç•ªæ—©ã„nextAtã«åˆã‚ã›ã¦â€œåˆ°ç€äºˆç´„â€
    timers.tick = setTimeout(tickLoop, 500);
  }

  function tickLoop(){
    const st = loadStage();
    const shop = loadShop();

    // å®¢ãŒã„ã‚‹ or ã™ã§ã«pendingãªã‚‰ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    if(st.hasVisitor || st.pending){
      renderStage();
      timers.tick = setTimeout(tickLoop, 500);
      return;
    }

    const tNow = now();
    // ã„ã¾å‡ºå“ã•ã‚Œã¦ã„ã‚‹æ£šã® nextAt ãŒéå»ã«ãªã£ãŸã‚‰ã€Œåˆ°ç€äºˆç´„ã€ã‚’ä½œã‚‹
    const due = shop.slots
      .map((s,idx)=>({ s, idx }))
      .filter(x => x.s.item && (x.s.nextAt||0) > 0 && (x.s.nextAt||0) <= tNow)
      .sort((a,b)=>(a.s.nextAt||0)-(b.s.nextAt||0))[0];

    if(due){
      const slotIndex = due.idx;

      // â˜…ã“ã“ãŒè¶…é‡è¦ï¼špendingä½œã‚‹ç¬é–“ã« nextAt ã‚’æœªæ¥ã¸é€²ã‚ã¦ãŠãï¼ˆé€£ç¶šæ¹§ãé˜²æ­¢ï¼‰
      shop.slots[slotIndex].nextAt = tNow + rand(18_000, 30_000);
      saveShop(shop);

      // åˆ°ç€ã¯ã€Œ3ç§’å¾Œã€ï¼ˆã‚ãªãŸã®è¦æœ›ï¼‰
      const st2 = loadStage();
      st2.pending = true;
      st2.pendingSlot = slotIndex;
      st2.pendingAt = tNow + 3000;
      saveStage(st2);

      timers.arrive = setTimeout(() => {
        arriveVisitorFromSlot(slotIndex, "next_due");
      }, 3000);

      renderStage();
      pushLog("èª°ã‹æ¥ã‚‹â€¦", `æ£š${slotIndex+1}ã«èˆˆå‘³ã‚ã‚Šãã†ãªæ°—é…ã€‚`, `nextAt advanced`);
    }

    renderStage();
    timers.tick = setTimeout(tickLoop, 500);
  }

  /* =========================
     æ¥å®¢ã€œå£²è²·ã€œé€€åº—
  ========================= */
  function pickVisitor(){
    const v = pick(ASSETS.visitors);
    const line = pick((VISITOR_LINES[v.type] || ["â€¦â€¦"]));
    return { ...v, line };
  }

  function arriveVisitorFromSlot(slotIndex, reason){
    const shop = loadShop();
    const slot = shop.slots[slotIndex];
    const st = loadStage();

    // é€”ä¸­ã§å‡ºå“ãŒç„¡ããªã£ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    if(!slot || !slot.item){
      st.pending = false;
      st.pendingSlot = -1;
      st.pendingAt = 0;
      saveStage(st);
      renderStage();
      return;
    }
    if(st.hasVisitor) return; // å¿µã®ãŸã‚

    const v = pickVisitor();
    const stayMs = rand(7000, 12000);
    const arriveAt = now();

    // å£²ã‚‹åˆ¤å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆå¸°ã‚‹1ç§’å‰ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‡ºã™è¦ä»¶ï¼‰
    const sellAt  = arriveAt + Math.max(1000, stayMs - 1000);
    const leaveAt = arriveAt + stayMs;

    const st2 = loadStage();
    st2.hasVisitor = true;
    st2.leaving = false;
    st2.pending = false;
    st2.pendingSlot = -1;
    st2.pendingAt = 0;

    st2.vUrl = v.url;
    st2.vName = v.name;
    st2.vType = v.type;
    st2.vMsg = v.line;
    st2.targetSlot = slotIndex;
    st2.stayMs = stayMs;

    // â˜…ä¿å­˜ã—ã¦å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    st2.arrivedAt = arriveAt;
    st2.sellAt = sellAt;
    st2.leaveAt = leaveAt;

    saveStage(st2);
    renderStage();

    // åˆ°ç€ãƒ­ã‚°
    pushLog("æ¥åº—", `${v.name} ãŒç¾ã‚ŒãŸã€‚`, `reason=${reason}`);

    // äºˆç´„ï¼ˆå¿…ãšã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
    scheduleFromState();
  }

  // å£²ã‚‹ or å£²ã‚‰ãšã«å¸°ã‚‹ï¼ˆsellAtã§å‘¼ã¶ï¼‰
  function trySellOrLeave(trigger){
    const st = loadStage();
    if(!st.hasVisitor) return;

    // ã™ã§ã«leavingãªã‚‰äºŒé‡å®Ÿè¡Œã—ãªã„
    if(st.leaving) return;

    const shop = loadShop();
    const slotIndex = st.targetSlot;
    const slot = shop.slots[slotIndex];

    // å‡ºå“ãŒæ¶ˆãˆã¦ã„ãŸã‚‰å³å¸°ã™
    if(!slot || !slot.item){
      forceLeave("no_item");
      return;
    }

    const willBuy = decideBuy(st, slot);

    if(willBuy){
      // å£²ã‚ŒãŸå‡¦ç†ï¼ˆã“ã“ã¯ã‚ãªãŸã®å…ƒãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã¦æ‹¡å¼µOKï¼‰
      const price = calcPrice(slot, st);
      addOcto(price);

      // çµŒé¨“å€¤ï¼ˆæ¥å®¢ã ã‘ã§ã‚‚+1ã€å£²ã‚ŒãŸã‚‰+4è¿½åŠ ã§åˆè¨ˆ+5ï¼‰
      shop.exp = Number(shop.exp||0) + 5;
      // itemã¯1æšå£²ã‚ŒãŸæƒ³å®šï¼šã“ã“ã¯ã€Œå›³é‘‘countæ¸›ã‚‰ã™ã€é€£æºã‚’å…¥ã‚Œã¦OK
      slot.item = null;
      saveShop(shop);

      toast("å£²ã‚ŒãŸï¼", `æ£š${slotIndex+1} ãŒ ${fmt(price)}ã‚ªã‚¯ãƒˆã§å£²ã‚ŒãŸ`, "sale",
        [`+${fmt(price)} octo`, `æ£š${slotIndex+1}`]
      );
      pushLog("å£²å´", `æ£š${slotIndex+1} ãŒå£²ã‚ŒãŸï¼`, `+${fmt(price)} octo`);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å·®ã—æ›¿ãˆ
      const st2 = loadStage();
      st2.vMsg = "è²·ã£ãŸã€‚â€¦å¾Œæ‚”ã¯ã€å¾Œã§ç„¼ãã€‚";
      st2.leaving = true;
      saveStage(st2);
      renderStage();

      // é€€åº—ã¯å…ƒã®leaveAtã§è¡Œã†ï¼ˆã“ã“ã‚’å‹•ã‹ã•ãªã„ã®ãŒãƒã‚¤ãƒ³ãƒˆï¼‰
    }else{
      // è²·ã‚ãšã«å¸°ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const st2 = loadStage();
      st2.vMsg = pick(LEAVE_LINES);
      st2.leaving = true;
      saveStage(st2);
      renderStage();
      pushLog("é€€åº—äºˆå‘Š", `${st2.vName} ã¯è²·ã‚ãšã«å»ã‚‹æ°—é…ã€‚`, `trigger=${trigger}`);
    }
  }

  function forceLeave(reason){
    const st = loadStage();
    if(!st.hasVisitor) {
      // pendingã ã‘æ®‹ã£ã¦ã‚‹ãªã‚‰æ¶ˆã™ï¼ˆå¾©å¸°æ™‚ã®å›ºã¾ã‚Šå¯¾ç­–ï¼‰
      if(st.pending){
        st.pending = false; st.pendingSlot=-1; st.pendingAt=0;
        saveStage(st);
      }
      renderStage();
      return;
    }

    const name = st.vName || "ã‚¿ã‚³æ°‘";

    // é€€åº—ï¼ˆçŠ¶æ…‹å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼‰
    const st2 = loadStage();
    st2.hasVisitor = false;
    st2.leaving = false;
    st2.pending = false;
    st2.pendingSlot = -1;
    st2.pendingAt = 0;

    st2.vUrl = "";
    st2.vName = "â€”";
    st2.vMsg = "ã¾ã èª°ã‚‚æ¥ã¦ã„ãªã„ã€‚";
    st2.vType = "";
    st2.vGoal = "";
    st2.stayMs = 0;
    st2.targetSlot = -1;

    st2.arrivedAt = 0;
    st2.sellAt = 0;
    st2.leaveAt = 0;

    saveStage(st2);
    renderStage();
    pushLog("é€€åº—", `${name} ãŒå»ã£ãŸã€‚`, `reason=${reason}`);

    // æ¬¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å¿…ãšå†æ§‹ç¯‰
    scheduleFromState();
    renderShelves();
    renderStats();
  }

  /* =========================
     Buy logicï¼ˆç°¡æ˜“ï¼‰
  ========================= */
  function decideBuy(st, slot){
    // ä¾‹ï¼šç‹æ§˜ã¯è²·ã„ã‚„ã™ã„ã€è»¢å£²ã¯è²·ã†ã‘ã©è©•åˆ¤ä¸‹ã’ã‚‹ç­‰
    let p = 0.28; // åŸºæœ¬è²·ã†ç¢ºç‡

    if(st.vType === "king") p += 0.55;
    if(st.vType === "impulse") p += 0.18;
    if(st.vType === "looker") p -= 0.18;
    if(st.vType === "picky")  p -= 0.10;
    if(st.vType === "flipper") p += 0.20;

    // ä¾¡æ ¼å¸¯ã§å¾®èª¿æ•´
    const tier = Number(slot.priceTier||1);
    if(tier >= 3) p -= 0.07;

    p = clamp(p, 0.05, 0.92);
    return Math.random() < p;
  }

  function calcPrice(slot, st){
    const base = 80; // ä»®
    const tier = Number(slot.priceTier||1);
    let m = 1;

    if(tier === 1) m = 1.0;
    if(tier === 2) m = 1.6;
    if(tier === 3) m = 2.4;
    if(tier === 4) m = 3.5;

    if(st.vType === "king") m *= 3.0;
    if(st.vType === "rich") m *= 2.2;
    if(st.vType === "flipper") m *= 1.4;

    return Math.max(1, Math.floor(base * m));
  }

  /* =========================
     Shelvesï¼ˆæœ€ä½é™ã®æç”»ï¼†å‡ºå“ï¼‰
  ========================= */
  function renderShelves(){
    if(!shelvesEl) return;
    const shop = loadShop();

    shelvesEl.innerHTML = shop.slots.map((s, idx) => {
      const has = !!s.item;
      const nextSec = has && s.nextAt ? Math.max(0, Math.ceil((s.nextAt - now())/1000)) : null;
      return `
        <div class="shelf">
          <div class="shelf-top">
            <div>
              <div class="shelf-name">æ£š${idx+1}</div>
              <div class="shelf-tag">${has ? `æ¬¡ã®å®¢ã¾ã§ ${nextSec}s` : "ç©º"}</div>
            </div>
            <button class="btn mini" data-act="pick" data-idx="${idx}">${has ? "å…¥æ›¿" : "å‡ºå“"}</button>
          </div>
          <div class="shelf-body">
            <div class="slot" data-act="pick" data-idx="${idx}">
              ${has ? `<img alt="" src="${escapeHTML(s.item.img||"")}" />` : `<div class="ph">ã‚¿ãƒƒãƒ—ã—ã¦<br>å‡ºå“</div>`}
              <div class="tier">Tier ${Number(s.priceTier||1)}</div>
            </div>
            <div class="shelf-info">
              <div class="line"><b>${has ? escapeHTML(s.item.name||"ã‚«ãƒ¼ãƒ‰") : "â€”"}</b></div>
              <div class="line">ä¾¡æ ¼å¸¯: <b>${Number(s.priceTier||1)}</b></div>
              <div class="shelf-actions">
                <button class="btn mini" data-act="tier" data-idx="${idx}" data-d="1">â–²</button>
                <button class="btn mini" data-act="tier" data-idx="${idx}" data-d="-1">â–¼</button>
                <button class="btn mini" data-act="remove" data-idx="${idx}" ${has?"":"disabled"}>å–ã‚Šä¸‹ã’</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // ãƒ€ãƒ–ã‚Šã‚«ãƒ¼ãƒ‰ï¼ˆtf_v1_book.got ã‹ã‚‰ count>1 ã‚’å‡ºå“å€™è£œã«ã™ã‚‹ç°¡æ˜“ï¼‰
  function getDupCards(){
    const book = lsGet(LS.farmBook, { ver:1, got:{} });
    const got = book.got || {};
    const list = [];
    for(const id of Object.keys(got)){
      const it = got[id];
      const c = Number(it.count||0);
      if(c > 1){
        list.push({
          id,
          name: it.name || id,
          img: it.img || "",
          count: c - 1 // 1æšæ®‹ã—ã¦ä½™ã‚‹åˆ†
        });
      }
    }
    // é©å½“ã«å®‰å®šã‚½ãƒ¼ãƒˆ
    list.sort((a,b)=>a.name.localeCompare(b.name,"ja"));
    return list;
  }

  let pickTargetIndex = -1;

  function openPickModal(slotIndex){
    pickTargetIndex = slotIndex;

    const dups = getDupCards();
    pickTitleEl.textContent = `æ£š${slotIndex+1}ã«å‡ºå“ã™ã‚‹ã‚«ãƒ¼ãƒ‰`;
    pickHintEl.textContent = `å›³é‘‘ã«1æšæ®‹ã—ã¦ã‚‚ä½™ã‚‹åˆ†ã‹ã‚‰é¸ã¹ã¾ã™ã€‚`;

    if(dups.length === 0){
      pickCardsEl.innerHTML = "";
      pickEmptyEl.style.display = "block";
    }else{
      pickEmptyEl.style.display = "none";
      pickCardsEl.innerHTML = dups.map(c => `
        <div class="citem" data-pick="${escapeHTML(c.id)}">
          <div class="cimg">
            ${c.img ? `<img alt="" src="${escapeHTML(c.img)}">` : `<div class="ph">no image</div>`}
            <div class="cnt">Ã—${c.count}</div>
          </div>
          <div class="cmeta">
            <div class="cname">${escapeHTML(c.name)}</div>
            <div class="csub"><span class="tagmini"><b>ID</b> ${escapeHTML(c.id)}</span></div>
          </div>
        </div>
      `).join("");
    }

    pickModal.classList.add("show");
    document.body.classList.add("noscroll");
    pickModal.setAttribute("aria-hidden","false");
  }

  function closePickModal(){
    pickModal.classList.remove("show");
    document.body.classList.remove("noscroll");
    pickModal.setAttribute("aria-hidden","true");
    pickTargetIndex = -1;
  }

  function setListing(slotIndex, card){
    const shop = loadShop();
    const slot = shop.slots[slotIndex];
    slot.item = { id: card.id, name: card.name, img: card.img };
    // nextAtãŒ0ãªã‚‰æœ€åˆã®å®¢ã¾ã§ã®æ™‚é–“ã‚’ä½œã‚‹
    const tNow = now();
    slot.nextAt = tNow + rand(8000, 14000);
    saveShop(shop);

    pushLog("å‡ºå“", `æ£š${slotIndex+1}ã«ã€Œ${card.name}ã€ã‚’ç½®ã„ãŸã€‚`, `nextAt set`);
    renderShelves();
    renderStats();
    renderStage();
  }

  function removeListing(slotIndex){
    const shop = loadShop();
    const slot = shop.slots[slotIndex];
    if(!slot.item) return;
    const name = slot.item.name || "ã‚«ãƒ¼ãƒ‰";
    slot.item = null;
    slot.nextAt = 0;
    saveShop(shop);

    pushLog("å–ã‚Šä¸‹ã’", `æ£š${slotIndex+1}ã‹ã‚‰ã€Œ${name}ã€ã‚’ä¸‹ã’ãŸã€‚`, "");
    renderShelves();
    renderStats();
  }

  function changeTier(slotIndex, delta){
    const shop = loadShop();
    const slot = shop.slots[slotIndex];
    slot.priceTier = clamp(Number(slot.priceTier||1) + Number(delta||0), 1, 4);
    saveShop(shop);
    renderShelves();
  }

  /* =========================
     å‘¼ã³è¾¼ã¿ï¼ˆ60ç§’CD / æ¬¡ã®å®¢ã‚’äºˆç´„ï¼‰
  ========================= */
  function shoutCooldownLeft(){
    const t = Number(lsGet(LS.shout, 0) || 0);
    return Math.max(0, t - now());
  }
  function updateShoutUI(){
    if(!shoutSub || !shoutBtn) return;
    const left = shoutCooldownLeft();
    if(left>0){
      shoutBtn.disabled = true;
      shoutSub.textContent = `CD: ${Math.ceil(left/1000)}s`;
    }else{
      shoutBtn.disabled = false;
      shoutSub.textContent = "â€”";
    }
  }

  function doShout(){
    const left = shoutCooldownLeft();
    if(left>0) return;

    const st = loadStage();
    if(st.hasVisitor || st.pending){
      toast("å‘¼ã³è¾¼ã¿å¤±æ•—", "ã„ã¾å®¢å¯¾å¿œä¸­ï¼ˆã¾ãŸå¾Œã§ï¼‰", "");
      return;
    }

    // å‡ºå“æ£šãŒç„¡ã„ã¨å‘¼ã¹ãªã„
    const shop = loadShop();
    const alive = shop.slots.map((s,i)=>({s,i})).filter(x=>x.s.item);
    if(alive.length===0){
      toast("å‘¼ã³è¾¼ã¿å¤±æ•—", "æ£šãŒç©ºã£ã½ã ã‚ˆ", "");
      return;
    }

    const x = pick(alive);
    const slotIndex = x.i;

    const st2 = loadStage();
    st2.pending = true;
    st2.pendingSlot = slotIndex;
    st2.pendingAt = now() + 3000;
    saveStage(st2);

    timers.arrive = setTimeout(() => {
      arriveVisitorFromSlot(slotIndex, "shout");
    }, 3000);

    lsSet(LS.shout, now() + 60_000);
    updateShoutUI();
    pushLog("å‘¼ã³è¾¼ã¿", `æ£š${slotIndex+1}ã«å®¢ã‚’å‘¼ã‚“ã ã€‚`, "arrive in 3s");
    renderStage();
  }

  /* =========================
     Events
  ========================= */
  function onClick(e){
    const t = e.target.closest("[data-act]");
    if(!t) return;
    const act = t.getAttribute("data-act");
    const idx = Number(t.getAttribute("data-idx"));

    if(act === "pick"){
      openPickModal(idx);
    }
    if(act === "remove"){
      removeListing(idx);
      // å®¢ãŒãã®æ£šã‚’ç‹™ã£ã¦ã„ãŸå ´åˆã¯ã€å¸°ã‚‰ã›ã‚‹/ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      const st = loadStage();
      if(st.hasVisitor && st.targetSlot === idx){
        forceLeave("listing_removed");
      }
      if(st.pending && st.pendingSlot === idx){
        st.pending = false; st.pendingSlot=-1; st.pendingAt=0;
        saveStage(st);
        renderStage();
        scheduleFromState();
      }
    }
    if(act === "tier"){
      const d = Number(t.getAttribute("data-d"));
      changeTier(idx, d);
    }
  }

  function onPickCard(e){
    const cardId = e.target.closest("[data-pick]")?.getAttribute("data-pick");
    if(!cardId) return;
    if(pickTargetIndex < 0) return;

    const dups = getDupCards();
    const c = dups.find(x=>x.id===cardId);
    if(!c) return;

    setListing(pickTargetIndex, c);
    closePickModal();

    // äºˆå®šã‚’å†æ§‹ç¯‰ï¼ˆnextAtç›£è¦–ï¼‰
    scheduleFromState();
  }

  function setupModalButtons(){
    pickCloseBtn?.addEventListener("click", closePickModal);
    pickCancelBtn?.addEventListener("click", closePickModal);
    pickModal?.addEventListener("click", (e)=>{
      if(e.target === pickModal) closePickModal();
    });

    helpBtn?.addEventListener("click", ()=>{
      helpModal.classList.add("show");
      document.body.classList.add("noscroll");
      helpModal.setAttribute("aria-hidden","false");
    });
    const closeHelp = ()=>{
      helpModal.classList.remove("show");
      document.body.classList.remove("noscroll");
      helpModal.setAttribute("aria-hidden","true");
    };
    helpClose?.addEventListener("click", closeHelp);
    helpOk?.addEventListener("click", closeHelp);
    helpModal?.addEventListener("click",(e)=>{ if(e.target===helpModal) closeHelp(); });
  }

  /* =========================
     Init
  ========================= */
  function init(){
    // èƒŒæ™¯åˆæœŸåŒ–
    setStageBg();

    // ãƒ­ã‚°ã¯å¿…ãš
    renderLog();

    // åˆå›UI
    renderShelves();
    renderStats();
    renderStage();
    updateShoutUI();

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    shelvesEl?.addEventListener("click", onClick);
    pickCardsEl?.addEventListener("click", onPickCard);

    refreshBtn?.addEventListener("click", ()=>{
      renderShelves();
      renderStats();
      renderStage();
      updateShoutUI();
      toast("æ›´æ–°", "è¡¨ç¤ºã‚’æ›´æ–°ã—ãŸã‚ˆ", "");
    });

    clearLogBtn?.addEventListener("click", ()=>{
      lsSet(LS.log, { ver:1, items:[] });
      renderLog();
      toast("ãƒ­ã‚°æ¶ˆå»", "ãƒ­ã‚°ã‚’æ¶ˆã—ãŸã‚ˆ", "");
    });

    shoutBtn?.addEventListener("click", doShout);

    backBtn?.addEventListener("click", ()=>{
      history.back();
    });

    setupModalButtons();

    // â˜…å¾©å¸°ã§å›ºã¾ã‚‹ã®ã‚’é˜²ãï¼šã‚¿ãƒ–å¾©å¸°æ™‚ã«å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    document.addEventListener("visibilitychange", ()=>{
      if(!document.hidden){
        updateShoutUI();
        scheduleFromState();
        renderStage();
      }
    });

    // 1ç§’ã”ã¨ã«å‘¼ã³è¾¼ã¿CDè¡¨ç¤ºã ã‘æ›´æ–°
    setInterval(updateShoutUI, 250);

    // â˜…ã“ã“ãŒæœ€é‡è¦ï¼šçŠ¶æ…‹ã‹ã‚‰å…¨ã‚¿ã‚¤ãƒãƒ¼ã‚’å¾©å…ƒ
    scheduleFromState();
  }

  init();

})();
</script>


</body>
</html>

