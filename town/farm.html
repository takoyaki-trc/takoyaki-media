<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãŸã“ç„¼ããƒ•ã‚¡ãƒ¼ãƒ </title>
  <style>
    :root{
      --bg:#0f1220;
      --panel:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --btn:rgba(255,255,255,.10);
      --btn2:rgba(255,255,255,.14);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:520px;margin:0 auto;padding:14px 14px 20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .topbar a{color:var(--text);text-decoration:none;border:1px solid var(--line);padding:8px 10px;border-radius:12px;background:var(--panel);font-weight:700}
    h1{font-size:18px;margin:10px 0 8px}
    .hint{font-size:12px;color:var(--muted);line-height:1.55;margin-bottom:10px}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:var(--panel);padding:8px 10px;border-radius:999px;font-size:12px}
    .pill b{font-weight:800}

    /* ====== Farm Grid ====== */
    .farm{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
      user-select:none;
    }
    .plot{
      aspect-ratio:1/1;
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:flex;align-items:center;justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .plot button{
      width:100%;height:100%;
      background:transparent;border:0;color:var(--text);
      font-weight:800;
      padding:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;
    }
    .plot .tag{font-size:10px;opacity:.8}
    .plot .time{font-size:11px;opacity:.9}
    .plot[data-state="EMPTY"] .tag{opacity:.6}
    .plot[data-state="GROW"]{outline:2px solid rgba(255,211,138,.25)}
    .plot[data-state="READY"]{outline:2px solid rgba(159,255,168,.35)}
    .plot[data-state="BURN"]{outline:2px solid rgba(255,154,165,.35)}
    .badge{
      position:absolute;top:8px;left:8px;
      font-size:10px;font-weight:900;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .badge.good{color:var(--good)}
    .badge.warn{color:var(--warn)}
    .badge.bad{color:var(--bad)}

    /* ====== Modal ====== */
    .modal{
      position:fixed;inset:0;display:none;
      background:rgba(0,0,0,.55);
      align-items:flex-end;justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal[aria-hidden="false"]{display:flex}
    .sheet{
      width:min(520px, 100%);
      border:1px solid var(--line);
      background:rgba(15,18,32,.92);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .sheetHead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .sheetHead .ttl{font-weight:900}
    .sheetHead button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      font-weight:900;
    }
    .sheetBody{padding:12px 14px 14px}
    .step{font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.5}

    /* ====== Card slider ====== */
    .cards{
      display:flex;gap:10px;overflow:auto;padding-bottom:8px;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
    }
    .c{
      min-width:150px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
      scroll-snap-align:start;
      flex:0 0 auto;
      position:relative;
    }
    .c .name{font-weight:900;margin-bottom:6px}
    .c .desc{font-size:12px;color:var(--muted);line-height:1.45;min-height:36px}
    .c .fx{font-size:12px;margin-top:8px}
    .c button{
      width:100%;
      margin-top:10px;
      border:1px solid var(--line);
      background:var(--btn2);
      color:var(--text);
      padding:10px 10px;border-radius:14px;
      font-weight:900;
    }
    .row{display:flex;gap:10px;margin-top:12px}
    .row button{
      flex:1;border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:12px;border-radius:14px;
      font-weight:900;
    }
    .row button.primary{background:rgba(159,255,168,.14);}

    /* ====== Harvest card ====== */
    .reward{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
    }
    .reward .big{font-weight:1000;font-size:16px;margin-bottom:6px}
    .reward .mini{font-size:12px;color:var(--muted);line-height:1.5}
    .reward .img{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      margin-top:10px;
      aspect-ratio:3/4;
      object-fit:cover;
      background:rgba(255,255,255,.03);
      display:block;
    }

    .dangerZone{
      margin-top:12px;
      border:1px dashed rgba(255,154,165,.45);
      background:rgba(255,154,165,.10);
      padding:10px 12px;
      border-radius:16px;
    }
    .dangerZone .dzttl{font-weight:900}
    .dangerZone .dzsub{font-size:12px;color:var(--muted);line-height:1.5;margin-top:4px}
    .dangerZone button{
      margin-top:10px;width:100%;
      border:1px solid rgba(255,154,165,.45);
      background:rgba(255,154,165,.14);
      color:var(--text);
      padding:12px;border-radius:14px;
      font-weight:900;
    }

/* ====== READY ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ====== */
.plot-fx{
  position:absolute;
  inset:-8px;
  pointer-events:none;
  border-radius:14px;
  mix-blend-mode:screen;
  opacity:.0;
}

.plot-fx--mild{
  opacity:.55;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.55), transparent 40%),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.35), transparent 45%),
    linear-gradient(120deg, transparent 0%, rgba(255,255,255,.25) 35%, transparent 70%);
  animation: fxShine 1.4s linear infinite;
}

.plot-fx--strong{
  opacity:.75;
  background:
    radial-gradient(circle at 30% 35%, rgba(255,255,255,.75), transparent 40%),
    radial-gradient(circle at 75% 55%, rgba(255,255,255,.55), transparent 45%),
    radial-gradient(circle at 55% 75%, rgba(255,255,255,.45), transparent 50%),
    linear-gradient(120deg, transparent 0%, rgba(255,255,255,.35) 35%, transparent 70%);
  animation: fxShine 1.0s linear infinite;
}

@keyframes fxShine{
  0%   { transform:translateX(-18px) rotate(0deg); filter:blur(.2px); }
  100% { transform:translateX(18px)  rotate(0deg); filter:blur(.2px); }
}
























    
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="./index.html">â† æˆ»ã‚‹</a>
      <a href="./zukan.html">å›³é‘‘</a>
    </div>

    <h1>ãŸã“ç„¼ããƒ•ã‚¡ãƒ¼ãƒ </h1>
    <div class="hint">
      ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ— â†’ ç¨® â†’ æ°´ â†’ è‚¥æ–™ã€‚<br>
      åŸºæœ¬ã®åç©«æ™‚é–“ã¯ <b>5æ™‚é–“</b>ã€‚åç©«å¯èƒ½ã«ãªã£ã¦ã‹ã‚‰æ”¾ç½®ã™ã‚‹ã¨<b>ç„¼ã‘ã‚‹</b>ã®ã§æ³¨æ„ã€‚
    </div>

    <div class="stats">
      <div class="pill">ç²å¾—ç¨®é¡ï¼š<b id="stBook">0</b></div>
      <div class="pill">è‚²æˆä¸­ï¼š<b id="stGrow">0</b></div>
      <div class="pill">åç©«å¯ï¼š<b id="stReady">0</b></div>
      <div class="pill">ç„¼ã‘ï¼š<b id="stBurn">0</b></div>
    </div>

    <div id="farm" class="farm" aria-label="ç•‘"></div>

    <div class="dangerZone">
      <div class="dzttl">ãƒ‡ãƒãƒƒã‚°/ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="dzsub">ãƒ†ã‚¹ãƒˆä¸­ã ã‘ä½¿ã£ã¦ã­ã€‚ç•‘ã¨å›³é‘‘ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™ã€‚</div>
      <button id="btnReset" type="button">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- ====== Modal ====== -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="ç•‘æ“ä½œ">
      <div class="sheetHead">
        <div class="ttl" id="mTitle">æ“ä½œ</div>
        <button id="mClose" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheetBody" id="mBody"></div>
    </div>
  </div>
<script>
(() => {
  /* ==========================
     ãŸã“ç„¼ããƒ•ã‚¡ãƒ¼ãƒ  v1ï¼ˆã‚ãªãŸã®ã‚„ã‚ŠãŸã„å½¢ã«å¯„ã›ãŸæš«å®šç‰ˆï¼‰
     - localStorageä¿å­˜
     - ç¨®â†’æ°´â†’è‚¥æ–™ï¼ˆä»Šã¯ã€Œæ¤ãˆã‚‹æ™‚ã«é¸ã¶ã€æ–¹å¼ã®ã¾ã¾ï¼‰
     - æ°´ã§ã€Œå‡ºã‚‹ãƒ¬ã‚¢ãƒªãƒ†ã‚£ç¢ºç‡ã€ãŒå¤‰ã‚ã‚‹ï¼ˆã“ã“ãŒä»Šå›ã®å¤‰æ›´ç‚¹ï¼‰
     - è‚¥æ–™ã¯ã€Œæ™‚é–“çŸ­ç¸®ã€ã ã‘ï¼ˆãƒ¬ã‚¢ç‡ã«ã¯å½±éŸ¿ã•ã›ãªã„ï¼‰
     - åç©«â†’ç¢ºèªâ†’å›³é‘‘è¿½åŠ ï¼ˆå›³é‘‘ã«rarityã‚‚ä¿å­˜ï¼‰
  ========================== */
// ãƒã‚¹ç”»åƒï¼ˆçŠ¶æ…‹ã”ã¨ï¼‰
const PLOT_IMG = {
  EMPTY: "https://ul.h3z.jp/muPEAkao.png",
  GROW1: "https://ul.h3z.jp/BrHRk8C4.png",
  GROW2: "https://ul.h3z.jp/tD4LUB6F.png",
  READY: "https://ul.h3z.jp/AmlnQA1b.png",
  BURN:  "https://ul.h3z.jp/q9hxngx6.png",

   // â˜…è¿½åŠ ï¼šç¬¬2æ®µéšã®äºˆå…†/ç¢ºå®š ç”»åƒ
  GROW2_SR65:  "https://ul.h3z.jp/W086w3xd.png",
  GROW2_SR100: "https://ul.h3z.jp/tBVUoc8w.png"
};

  const LS_STATE = "tf_v1_state";
  const LS_BOOK  = "tf_v1_book";

  // ====== ãƒãƒ©ãƒ³ã‚¹ ======
  // â€»å°†æ¥ã€ŒåŸºæœ¬6æ™‚é–“ã€ã«ã—ãŸã„ãªã‚‰ã€ã“ã“ã‚’6ã«ã™ã‚‹ã ã‘ã§OK
  const BASE_GROW_MS = 5 * 60 * 60 * 1000; // 5æ™‚é–“ï¼ˆä»Šã¯ç¾çŠ¶ç¶­æŒï¼‰
  const READY_TO_BURN_MS = 2 * 60 * 60 * 1000; // åç©«å¯èƒ½ã«ãªã£ã¦ã‹ã‚‰2æ™‚é–“ã§ç„¼ã‘
  const TICK_MS = 1000;

  // ====== ãƒ¬ã‚¢ç‡ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰=====
  // â€»ã“ã“ã‚’ã„ã˜ã‚‹ã¨å…¨ä½“ã®ãƒ¬ã‚¢å‡ºç¾ç‡ãŒå¤‰ã‚ã‚‹
  const BASE_RARITY_RATE = { N:70, R:20, SR:8, UR:1.8, LR:0.2 };

  // ====== å®Ÿåœ¨ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ï¼ˆãƒ¬ã‚¢ãƒªãƒ†ã‚£ã”ã¨ï¼‰=====
  // å½¢å¼ï¼š{ no:"TN-001", name:"ã‚«ãƒ¼ãƒ‰å", img:"https://..." }
  const CARD_POOLS = {
    N: [
      { no:"TN-005", name:"ãŸã“ç„¼ãã‚¿ãƒ¯ãƒ¼112", img:"https://ul.h3z.jp/xjoqO9HK.png" },
      { no:"TN-006", name:"å¡©é¡”ãƒ‘ãƒ¬ãƒ¼ãƒ‰ç„¼ã", img:"https://ul.h3z.jp/SvLLVa7m.png" },
      { no:"TN-009", name:"å¡©ãƒãƒ¨éœ²å¤©ç„¼ã", img:"https://ul.h3z.jp/sh2p18pj.png" },
      { no:"TN-011", name:"ãƒãƒ¼ã‚ºç«å±±ç„¼ã", img:"https://ul.h3z.jp/u12Q1rQ9.png" },
      { no:"TN-012", name:"æšã’ç‰ä¼šè­°ç„¼ã", img:"https://ul.h3z.jp/wvL9uwpZ.png" },
      { no:"TN-013", name:"ããŸã³ã‚Œå¡©ã“ã—ã‚‡ã†ç„¼ã", img:"https://ul.h3z.jp/KW4kM6OW.png" },
      { no:"TN-016", name:"ãŸã“ç„¼ãã€ç™ºå°„ã‚ªãƒ¼ãƒ©ã‚¤", img:"https://ul.h3z.jp/Dk6Hj5gd.png" },
      { no:"TN-018", name:"ã‚†ã®ã‹ã‚ã®ä¸»", img:"https://ul.h3z.jp/mPE2nzcz.png" },
      { no:"TN-019", name:"èª¤å…¥åº—ãƒˆãƒ©ãƒƒãƒ—", img:"https://ul.h3z.jp/xE6OcrTz.png" },
      { no:"TN-021", name:"ãŸã“ç„¼ãã€æµã‚Œã¦å€™", img:"https://ul.h3z.jp/XFCtYUZu.png" },
      { no:"TN-023", name:"èŠç”Ÿã‹ãŸã“ç„¼ãã‹å¤§ä¼š", img:"https://ul.h3z.jp/H4HOwhKK.png" },
      { no:"TN-024", name:"æ¸©æ³‰å¥³ç¥ã®ã‚ã‚ŠãŒãŸè¿·æƒ‘", img:"https://ul.h3z.jp/Q8392V7N.png" },
      { no:"TN-026", name:"ãŸã“ç„¼ã48å›ãƒªãƒœæ‰•ã„", img:"https://ul.h3z.jp/Ih4UgGuG.png" },
      { no:"TN-027", name:"å…¨èº«ãŸã“ç„¼ããƒ€ã‚¤ã‚¨ãƒƒãƒˆ", img:"https://ul.h3z.jp/JQcHg0cM.png" },
      { no:"TN-028", name:"è‡ªå·±å•“ç™ºãŸã“å¡¾ã€Šäº•ä¸Šè«’ãƒ—ãƒ­ğŸ¯ã€‹", img:"https://ul.h3z.jp/x2giE7yR.png" },
      { no:"TN-029", name:"ã‚«ãƒ­ãƒªãƒ¼ã‚¼ãƒ­ç†è«–ã€Šä»æœ¨æ²»ãƒ—ãƒ­ğŸ¯ã€‹", img:"https://ul.h3z.jp/G9TjNqsR.png" },
      { no:"TN-031", name:"è¡Œåˆ—ã®æœ€å¾Œå°¾ãŒåˆ¥çœŒ", img:"https://ul.h3z.jp/do0u2b0m.png" },
      { no:"TN-034", name:"ã‚¨ã‚·ã‚«ãƒ«éå‰°ç„¼ã", img:"https://ul.h3z.jp/grlvMXBT.png" },
      { no:"TN-036", name:"ãƒãƒ¨ãƒãƒ¼ã‚ºè©æ¬º", img:"https://ul.h3z.jp/Veh6cTQo.png" },
      { no:"TN-037", name:"å‹˜é•ã„ãƒ‡ãƒ¼ãƒˆ", img:"https://ul.h3z.jp/Zj9jqeFm.png" },
      { no:"TN-041", name:"ç‰ã®ä¸Šã«ã‚‚ä¸‰å¹´", img:"https://ul.h3z.jp/FHIVjxEc.png" },
      { no:"TN-043", name:"è»¢ç”Ÿã—ãŸã‚‰å³å£²ã‚ŒãŸã“ç„¼ã", img:"https://ul.h3z.jp/n6un0ECF.png" },
      { no:"TN-046", name:"ã”ã¾ã™ã‚ŠãŸã“ç„¼ã", img:"https://ul.h3z.jp/6hrmumFg.png" },
      { no:"TN-048", name:"åº—ä¸»åæ’ƒãƒ¬ãƒ“ãƒ¥ãƒ¼ã€Šä½ä¿£é›„ä¸€éƒğŸ¯ã€‹", img:"https://ul.h3z.jp/bGZmixM4.png" },
    ],
    R: [
      { no:"TN-002", name:"ç†±ã€…åœ°ç„ã®çµ¦ãŸã“æ‰€", img:"https://ul.h3z.jp/tnPHMqxN.png" },
      { no:"TN-003", name:"çˆ†èµ°ï¼ãŸã“ç„¼ããƒ©ã‚¤ãƒ€ãƒ¼èœã€…", img:"https://ul.h3z.jp/KB3Z4nk0.png" },
      { no:"TN-008", name:"æ˜å¤ªã‚®ãƒ£ãƒ©ã‚¯ã‚·ãƒ¼ç„¼ã", img:"https://ul.h3z.jp/ElEUWV02.png" },
      { no:"TN-014", name:"ä¸–ç•ŒãŸã“ç„¼ãé‡£ã‚Šé¸æ‰‹æ¨©å¤§ä¼š", img:"https://ul.h3z.jp/QBf0mhfP.png" },
      { no:"TN-017", name:"ãŸã“ç„¼ããƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ", img:"https://ul.h3z.jp/B5z1zmki.png" },
      { no:"TN-022", name:"ãŸã“ç„¼ããƒ€ãƒ¼ãƒ„ï½¥ã‚¤ãƒ³ãƒ•ã‚§ãƒ«ãƒã€Šå°é¦¬è£•ä½³å­ãƒ—ãƒ­ğŸ¯ã€‹", img:"https://ul.h3z.jp/5SAL3R2J.png" },
      { no:"TN-032", name:"å›½å¢ƒè¶…ãˆãŸæ‹", img:"https://ul.h3z.jp/Yhty1eVw.png" },
      { no:"TN-035", name:"ãƒ‡ãƒªãƒãƒªãƒ¼é•·è·é›¢ä¾¿", img:"https://ul.h3z.jp/uISdf4dn.png" },
      { no:"TN-038", name:"æ‹è½ã¡ãƒãƒƒãƒãƒ³ã‚°", img:"https://ul.h3z.jp/VaeuN4fe.png" },
      { no:"TN-042", name:"ãŸã“ç„¼ããƒ«ãƒ¼ãƒ—ã‚¶ãƒ«ãƒ¼ãƒ—", img:"https://ul.h3z.jp/uKy4GPOX.png" },
      { no:"TN-044", name:"ç™½ã„å¥‘ç´„(ç¨²çŸ³è£•ãƒ—ãƒ­ğŸ¯)", img:"https://ul.h3z.jp/g2banLA9.png" },
      { no:"TN-047", name:"ãƒœã‚¹ã‚²ãƒ¼ãƒˆ", img:"https://ul.h3z.jp/1Q26RpZH.png" },
    ],
    SR: [
      { no:"TN-004", name:"è¦‹ãˆã‚‹ãƒ•ãƒªç„¼ã", img:"https://ul.h3z.jp/NSUjkwRE.png" },
      { no:"TN-010", name:"ç„¼ã‚¯è€…ãƒè¨¼", img:"https://ul.h3z.jp/BCXLFeGI.png" },
      { no:"TN-015", name:"é¡”ã‚³ã‚¤ãƒ³", img:"https://ul.h3z.jp/CIA9LV8T.png" },
      { no:"TN-020", name:"ãƒ”ãƒƒã‚¯ä¸è¦ã®çœŸå®Ÿ", img:"https://ul.h3z.jp/Xave4XVq.png" },
      { no:"TN-030", name:"ã‚¬ãƒãƒ£ãŸã“ç„¼ã", img:"https://ul.h3z.jp/XDrYkA9R.png" },
      { no:"TN-039", name:"ãƒ‰ãƒ­ãƒ¼ãƒ³èª¤é…é”", img:"https://ul.h3z.jp/6VGy1YM2.png" },
      { no:"TN-040", name:"æ¨ã—æ´»ãŸã“å›£æ‰‡", img:"https://ul.h3z.jp/7mFuyxeG.png" },
      { no:"TN-049", name:"ãŸã“ç„¼ãã®å¾¡ç¥ä½“", img:"https://ul.h3z.jp/sv5Y8d9u.png" },
    ],
    UR: [
      { no:"TN-001", name:"é»’ãçœŸç ã‚¤ã‚«ã•ã¾ç„¼ã", img:"https://ul.h3z.jp/wMBupVzu.png" },
      { no:"TN-007", name:"ãƒ­ãƒ¼ã‚½ã‚¯å‡ºã›ï¼", img:"https://ul.h3z.jp/naBoXNrd.png" },
      { no:"BN-033", name:"é‰„æ¿ã®ãƒ“ãƒ¼ãƒŠã‚¹", img:"https://ul.h3z.jp/xI1NUxhq.png" },
      { no:"BN-045", name:"ãƒ‰ãƒªãƒ¼ãƒ ãƒ•ã‚¡ã‚¤ãƒˆ", img:"https://ul.h3z.jp/YNtkOAIi.png" },
    ],
    LR: [
      { no:"TN-025", name:"ãŸã“ç„¼ãåŒ–çŸ³inå‡½é¤¨å±±", img:"https://ul.h3z.jp/e2B7lU9p.png" },
      { no:"BN-050", name:"ç„¼ã‹ã‚Œã—è¨˜æ†¶ã€ã‚½ãƒ¼ã‚¹ã«é‚„ã‚‹", img:"https://ul.h3z.jp/l47TH2Ml.png" },
    ],
  };

  // ====== ç¨® / æ°´ / è‚¥æ–™ï¼ˆã‚«ãƒ¼ãƒ‰UIï¼‰=====
  const SEEDS = [
    { id:"seed_basic", name:"ç”Ÿåœ°ã®ã‚¿ãƒ", desc:"åŸºæœ¬ã®ãŸã“ç„¼ãã€‚ã¾ãšã¯ã“ã“ã‹ã‚‰ã€‚", factor:1.00 },
    { id:"seed_soft",  name:"ãµã‚ã¨ã‚ã‚¿ãƒ", desc:"ãµã‚ã£ã¨ä»•ä¸ŠãŒã‚‹ã€‚ç„¼ã‘ã«ãã„â€¦æ°—ãŒã™ã‚‹ã€‚", factor:1.00 },
    { id:"seed_rare",  name:"ãƒ¬ã‚¢ã‚¿ãƒ", desc:"å½“ãŸã‚Šã‚„ã™ã„æ°—é…ã€‚æ™‚é–“ã¯ãã®ã¾ã¾ã€‚", factor:1.00 },
  ];

  // â˜…æ°´ï¼šãƒ¬ã‚¢ç‡è£œæ­£ï¼ˆrarityMulï¼‰ã‚’è¿½åŠ 
  const WATERS = [
    {
      id:"water_small", name:"æ™®é€šã®æ°´", desc:"ã‚¯ã‚»ã®ãªã„æ°´ã€‚", factor:0.90, fx:"åç©«æ™‚é–“ -10%",
      rarityMul:{ N:1.00, R:1.00, SR:1.00, UR:1.00, LR:1.00 }
    },
    {
      id:"water_mid", name:"é»„é‡‘ã®æ°´", desc:"ãƒ¬ã‚¢ãŒä¸ŠãŒã‚Šã‚„ã™ã„ã€‚", factor:0.80, fx:"åç©«æ™‚é–“ -20%",
      rarityMul:{ N:0.95, R:1.10, SR:1.25, UR:1.45, LR:1.20 }
    },
    {
      id:"water_str", name:"æ€ªã—ã„æ°´", desc:"åšæ‰“ã®é¦™ã‚Šã€‚", factor:0.70, fx:"åç©«æ™‚é–“ -30%",
      rarityMul:{ N:0.90, R:1.00, SR:1.15, UR:1.65, LR:1.45 }
    },
  ];

  // è‚¥æ–™ï¼šæ™‚é–“çŸ­ç¸®ã ã‘ï¼ˆãƒ¬ã‚¢ç‡ã¯è§¦ã‚‰ãªã„ï¼‰
  const FERTS = [
    { id:"fert_small", name:"è‚¥æ–™ï¼šå°", desc:"å°‘ã—ã ã‘æ™‚çŸ­ã€‚", factor:0.90, fx:"åç©«æ™‚é–“ -10%" },
    { id:"fert_mid",   name:"è‚¥æ–™ï¼šä¸­", desc:"ã»ã©ã‚ˆãæ™‚çŸ­ã€‚", factor:0.80, fx:"åç©«æ™‚é–“ -20%" },
    { id:"fert_str",   name:"è‚¥æ–™ï¼šå¼·", desc:"ä¸€æ°—ã«æ™‚çŸ­ã€‚", factor:0.70, fx:"åç©«æ™‚é–“ -30%" },
  ];

  // ====== çŠ¶æ…‹ ======
  // plot: { state:"EMPTY|GROW|READY|BURN", seedId, waterId, fertId, startAt, readyAt, burnAt, reward? }
  const defaultPlot = () => ({ state:"EMPTY" });
  const defaultState = () => ({ ver:1, plots: Array.from({length:25}, defaultPlot) });

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_STATE);
      if(!raw) return defaultState();
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.plots) || obj.plots.length !== 25) return defaultState();
      return obj;
    }catch(e){
      return defaultState();
    }
  }
  function saveState(s){ localStorage.setItem(LS_STATE, JSON.stringify(s)); }

  function loadBook(){
    try{
      const raw = localStorage.getItem(LS_BOOK);
      if(!raw) return { ver:1, got:{} };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj.got !== "object") return { ver:1, got:{} };
      return obj;
    }catch(e){
      return { ver:1, got:{} };
    }
  }
  function saveBook(b){ localStorage.setItem(LS_BOOK, JSON.stringify(b)); }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtRemain(ms){
    if(ms <= 0) return "00:00:00";
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

 // ====== ãƒ¬ã‚¢æŠ½é¸ï¼ˆä»Šå›ã¯æ°´ã ã‘å½±éŸ¿ï¼‰=====
function pickRarityWithWater(waterId){
  const water = WATERS.find(x => x.id === waterId);
  const wm = (water && water.rarityMul) ? water.rarityMul : {};

  const weights = {};
  let total = 0;

  for (const k of Object.keys(BASE_RARITY_RATE)){
    const w = BASE_RARITY_RATE[k] * (wm[k] ?? 1);
    weights[k] = Math.max(0, w);
    total += weights[k];
  }

  if (total <= 0) return "N";

  let r = Math.random() * total;
  for (const k of Object.keys(weights)){
    r -= weights[k];
    if (r <= 0) return k;
  }
  return "N";
}

// â˜…SRäºˆå…†ï¼ˆsrHintï¼‰è¾¼ã¿ã®åç©«æŠ½é¸
// - p.srHint === "SR100" â†’ SR/UR/LR 100%
// - p.srHint === "SR65"  â†’ SR/UR/LR 65%ï¼ˆå¤–ã‚ŒãŸã‚‰é€šå¸¸ï¼‰
// - ãã‚Œä»¥å¤–             â†’ é€šå¸¸ï¼ˆæ°´æŠ½é¸ï¼‰
function drawRewardForPlot(p){
  // SRä»¥ä¸Šã®å€™è£œï¼ˆç©ºãƒ—ãƒ¼ãƒ«å¯¾ç­–ä»˜ãï¼‰
  const highList = ["SR", "UR", "LR"];

  const pickHigh = () => {
    const r = highList[Math.floor(Math.random() * highList.length)];
    const pool = CARD_POOLS[r] || [];
    const fallback = CARD_POOLS.SR || [];
    const base = pool.length ? pool : fallback;
    const c = pick(base);
    return { id:c.no, name:c.name, img:c.img, rarity:r };
  };

  // 100%ç¢ºå®š
  if (p && p.srHint === "SR100") {
    return pickHigh();
  }

  // 65%äºˆå…†
  if (p && p.srHint === "SR65") {
    const hit = Math.random() < 0.65;
    if (hit) return pickHigh();
    // å¤–ã‚ŒãŸã‚‰é€šå¸¸ã¸è½ã¨ã™
  }

  // é€šå¸¸ï¼ˆæ°´æŠ½é¸ï¼‰
  const rarity = pickRarityWithWater(p ? p.waterId : null);
  const pool = CARD_POOLS[rarity] || CARD_POOLS.N || [];
  const c = pick(pool);
  return { id:c.no, name:c.name, img:c.img, rarity };
}

function rarityLabel(r){
  return r || "";
}

// ====== DOMå‚ç…§ ======
const farmEl = document.getElementById("farm");
const stBook = document.getElementById("stBook");
const stGrow = document.getElementById("stGrow");
const stReady = document.getElementById("stReady");
const stBurn = document.getElementById("stBurn");

const modal  = document.getElementById("modal");
const mTitle = document.getElementById("mTitle");
const mBody  = document.getElementById("mBody");
const mClose = document.getElementById("mClose");

// ====== çŠ¶æ…‹ ======
let state = loadState();
let book  = loadBook();

let activeIndex = -1; // ä»Šæ“ä½œã—ã¦ã‚‹ãƒã‚¹
let draft = null;     // é¸æŠä¸­ï¼ˆç¨®/æ°´/è‚¥æ–™ï¼‰

// ====== ãƒ¢ãƒ¼ãƒ€ãƒ« ======
function openModal(title, html){
  mTitle.textContent = title;
  mBody.innerHTML = html;
  modal.setAttribute("aria-hidden","false");
  modal.addEventListener("click", onBackdrop);
  document.addEventListener("keydown", onEsc);
}

function closeModal(){
  modal.setAttribute("aria-hidden","true");
  modal.removeEventListener("click", onBackdrop);
  document.removeEventListener("keydown", onEsc);
  mBody.innerHTML = "";
  activeIndex = -1;
  draft = null;
}

function onBackdrop(e){
  if(e.target === modal) closeModal();
}

function onEsc(e){
  if(e.key === "Escape") closeModal();
}

mClose.addEventListener("click", closeModal);

// ====== UIæç”» ======
function render(){
  farmEl.innerHTML = "";
  let grow = 0, ready = 0, burn = 0;

  state.plots.forEach((p, i) => {
    const d = document.createElement("div");
    d.className = "plot";
    d.dataset.state = p.state || "EMPTY";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.dataset.i = String(i);

    // ====== ãƒã‚¹è¡¨ç¤ºï¼ˆç”»åƒç‰ˆï¼‰ ======
    let img = PLOT_IMG.EMPTY;
    let label = "æ¤ãˆã‚‹";

    if (p.state === "GROW") {
      grow++;

      // æ®‹ã‚Šæ™‚é–“
      const remain = (p.readyAt || 0) - Date.now();

      // æˆé•·æ®µéšï¼ˆå‰åŠ / å¾ŒåŠï¼‰
      const start = (typeof p.startAt === "number") ? p.startAt : Date.now();
      const end   = (typeof p.readyAt === "number") ? p.readyAt : (start + 1);
      const denom = Math.max(1, end - start);
      const progress = (Date.now() - start) / denom;

      // ====== æˆé•·æ®µéšã”ã¨ã®ç”»åƒåˆ‡ã‚Šæ›¿ãˆ ======
if (progress < 0.5) {
  // ç¬¬1æ®µéšï¼ˆå‰åŠï¼‰
  img = PLOT_IMG.GROW1;
} else {
  // ç¬¬2æ®µéšï¼ˆå¾ŒåŠï¼‰ï¼šãƒ¬ã‚¢äºˆå…†ã§åˆ†å²
  if (p.srHint === "SR100") {
    img = PLOT_IMG.GROW2_SR100;   // â˜…SRä»¥ä¸Š100%ç¢ºå®š
  } else if (p.srHint === "SR65") {
    img = PLOT_IMG.GROW2_SR65;    // â˜…SRä»¥ä¸Š65%äºˆå…†
  } else {
    img = PLOT_IMG.GROW2;         // é€šå¸¸
  }
}

label = `è‚²æˆä¸­ ${fmtRemain(remain)}`;


      const b = document.createElement("div");
      b.className = "badge warn";
      b.textContent = "GROW";
      d.appendChild(b);

    } else if (p.state === "READY") {
      ready++;
      img = PLOT_IMG.READY;
      label = "åç©«";

      const b = document.createElement("div");
      b.className = "badge good";
      b.textContent = "READY";
      d.appendChild(b);


      // ====== READYã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ======
const fx = document.createElement("div");
fx.className = "plot-fx plot-fx--mild"; // ã¾ãšã¯å¼±ã‚­ãƒ©ã‚­ãƒ©
d.appendChild(fx);


    } else if (p.state === "BURN") {
      burn++;
      img = PLOT_IMG.BURN;
      label = "ç„¦ã’";

      const b = document.createElement("div");
      b.className = "badge bad";
      b.textContent = "BURN";
      d.appendChild(b);

    } else if (p.state === "EMPTY") {
      img = PLOT_IMG.EMPTY;
      label = "æ¤ãˆã‚‹";
    } else {
      img = PLOT_IMG.EMPTY;
      label = "ä¸æ˜";
    }

    // ç”»åƒï¼‹ãƒ©ãƒ™ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¯ãƒœã‚¿ãƒ³å…¨ä½“ï¼‰
    btn.innerHTML = `
      <img src="${img}" alt="" style="
        width:100%;
        height:100%;
        object-fit:cover;
        border-radius:14px;
        display:block;
      ">
      <div class="tag" style="
        position:absolute;
        bottom:6px;
        left:0;
        right:0;
        text-align:center;
        font-size:11px;
        font-weight:900;
        color:#fff;
        text-shadow:0 1px 3px rgba(0,0,0,.6);
        pointer-events:none;
      ">
        ${label}
      </div>
    `;

    btn.addEventListener("click", () => onPlotTap(i));
    d.appendChild(btn);
    farmEl.appendChild(d);
  });

  stGrow.textContent = String(grow);
  stReady.textContent = String(ready);
  stBurn.textContent = String(burn);
  stBook.textContent = String(Object.keys(book.got || {}).length);
}


  // ====== ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ— ======
  function onPlotTap(i){
    activeIndex = i;
    const p = state.plots[i];

    if(p.state === "EMPTY"){
      draft = { seedId:null, waterId:null, fertId:null };
      showSeedStep();
      return;
    }

    if(p.state === "GROW"){
      const seed = SEEDS.find(x=>x.id===p.seedId);
      const water = WATERS.find(x=>x.id===p.waterId);
      const fert = FERTS.find(x=>x.id===p.fertId);
      const remain = (p.readyAt||0) - Date.now();
      openModal("è‚²æˆä¸­", `
        <div class="step">ã“ã®ãƒã‚¹ã¯è‚²æˆä¸­ã€‚åç©«ã¾ã§ã‚ã¨ <b>${fmtRemain(remain)}</b></div>
        <div class="reward">
          <div class="big">è¨­å®š</div>
          <div class="mini">
            ç¨®ï¼š${seed?seed.name:"-"}<br>
            æ°´ï¼š${water?water.name:"-"}<br>
            è‚¥æ–™ï¼š${fert?fert.name:"-"}
          </div>
        </div>
        <div class="row">
          <button type="button" id="btnOk">OK</button>
        </div>
      `);
      document.getElementById("btnOk").addEventListener("click", closeModal);
      return;
    }

    if(p.state === "READY"){
      // åç©«ï¼šæ°´ã«ã‚ˆã£ã¦ãƒ¬ã‚¢ç‡ãŒå¤‰ã‚ã‚‹
      const reward = drawRewardForPlot(p);

      p.reward = reward;
      saveState(state);

      openModal("åç©«ï¼", `
        <div class="step">åç©«ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å›³é‘‘ã«ç™»éŒ²ã™ã‚‹ã€‚</div>
        <div class="reward">
          <div class="big">${reward.name}ï¼ˆ${reward.id}ï¼‰</div>
          <div class="mini">ãƒ¬ã‚¢ï¼š<b>${rarityLabel(reward.rarity)}</b><br>ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å›³é‘‘ã«è¿½åŠ ã•ã‚Œã€ã“ã®ãƒã‚¹ã¯ç©ºã«ãªã‚‹ã€‚</div>
          <img class="img" src="${reward.img}" alt="${reward.name}">
        </div>
        <div class="row">
          <button type="button" id="btnCancel">ã‚„ã‚ã‚‹</button>
          <button type="button" class="primary" id="btnConfirm">ç¢ºèªã—ã¦å›³é‘‘ã¸</button>
        </div>
      `);

      document.getElementById("btnCancel").addEventListener("click", () => {
        delete p.reward;
        saveState(state);
        closeModal();
      });

      document.getElementById("btnConfirm").addEventListener("click", () => {
        addToBook(reward);
        state.plots[i] = defaultPlot();
        saveState(state);
        closeModal();
        location.href = "./zukan.html";
      });
      return;
    }

    if(p.state === "BURN"){
      openModal("ç„¼ã‘ãŸâ€¦", `
        <div class="step">æ”¾ç½®ã—ã™ãã¦ç„¼ã‘ãŸã€‚å›åã™ã‚‹ã¨ãƒã‚¹ãŒç©ºã«ãªã‚‹ã€‚</div>
        <div class="row">
          <button type="button" id="btnBack">æˆ»ã‚‹</button>
          <button type="button" class="primary" id="btnClear">å›åã—ã¦ç©ºã«ã™ã‚‹</button>
        </div>
      `);
      document.getElementById("btnBack").addEventListener("click", closeModal);
      document.getElementById("btnClear").addEventListener("click", () => {
        state.plots[i] = defaultPlot();
        saveState(state);
        closeModal();
        render();
      });
      return;
    }
  }

  function addToBook(card){
    const b = loadBook();
    if(!b.got) b.got = {};
    b.got[card.id] = {
      id: card.id,
      name: card.name,
      img: card.img,
      rarity: card.rarity || "",
      at: Date.now()
    };
    book = b;
    saveBook(book);
  }

  // ====== ã‚¹ãƒ†ãƒƒãƒ—UIï¼ˆç¨®â†’æ°´â†’è‚¥æ–™ï¼‰=====
  function cardSlider(items, onSelectId){
    const list = items.map(x => `
      <div class="c">
        <div class="name">${x.name}</div>
        <div class="desc">${x.desc || ""}</div>
        <div class="fx">${x.fx ? "åŠ¹æœï¼š<b>"+x.fx+"</b>" : ""}</div>
        <button type="button" data-pick="${x.id}">ã“ã‚Œã«ã™ã‚‹</button>
      </div>
    `).join("");

    openModal("é¸æŠ", `
      <div class="step">ã‚«ãƒ¼ãƒ‰ã‚’æ¨ªã«ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦é¸ã¹ã‚‹ã€‚</div>
      <div class="cards">${list}</div>
      <div class="row">
        <button type="button" id="btnBackStep">æˆ»ã‚‹</button>
        <button type="button" id="btnCloseStep">é–‰ã˜ã‚‹</button>
      </div>
    `);

    mBody.querySelectorAll("button[data-pick]").forEach(btn=>{
      btn.addEventListener("click", () => onSelectId(btn.getAttribute("data-pick")));
    });

    return {
      setTitle(t){ mTitle.textContent = t; },
      onBack(fn){ document.getElementById("btnBackStep").addEventListener("click", fn); },
      onClose(){ document.getElementById("btnCloseStep").addEventListener("click", closeModal); },
    };
  }

  function showSeedStep(){
    const ui = cardSlider(SEEDS, (id) => {
      draft.seedId = id;
      showWaterStep();
    });
    ui.setTitle("ç¨®ã‚’é¸ã¶");
    ui.onBack(() => closeModal());
    ui.onClose();
  }

  function showWaterStep(){
    const ui = cardSlider(WATERS, (id) => {
      draft.waterId = id;
      showFertStep();
    });
    ui.setTitle("æ°´ã‚’é¸ã¶");
    ui.onBack(() => showSeedStep());
    ui.onClose();
  }

  function showFertStep(){
    const ui = cardSlider(FERTS, (id) => {
      draft.fertId = id;
      confirmPlant();
    });
    ui.setTitle("è‚¥æ–™ã‚’é¸ã¶");
    ui.onBack(() => showWaterStep());
    ui.onClose();
  }

  function confirmPlant(){
    const seed  = SEEDS.find(x=>x.id===draft.seedId);
    const water = WATERS.find(x=>x.id===draft.waterId);
    const fert  = FERTS.find(x=>x.id===draft.fertId);

    const factor = clamp(
      (seed?.factor ?? 1) * (water?.factor ?? 1) * (fert?.factor ?? 1),
      0.35, 1.0
    );

    const growMs = Math.max(Math.floor(BASE_GROW_MS * factor), 60*60*1000); // æœ€çŸ­1æ™‚é–“
    const now = Date.now();

    openModal("æ¤ãˆã‚‹ç¢ºèª", `
      <div class="step">ã“ã®å†…å®¹ã§æ¤ãˆã‚‹ï¼Ÿï¼ˆåç©«ã¾ã§ç´„ <b>${fmtRemain(growMs)}</b>ï¼‰</div>
      <div class="reward">
        <div class="big">é¸æŠ</div>
        <div class="mini">
          ç¨®ï¼š${seed?.name || "-"}<br>
          æ°´ï¼š${water?.name || "-"}<br>
          è‚¥æ–™ï¼š${fert?.name || "-"}<br><br>
          æ™‚çŸ­ä¿‚æ•°ï¼š<b>${factor.toFixed(2)}</b><br>
          ãƒ¬ã‚¢è£œæ­£ï¼š<b>${water?.name || "-"}</b>ï¼ˆæ°´ã®åŠ¹æœï¼‰
        </div>
      </div>
      <div class="row">
        <button type="button" id="btnRe">é¸ã³ç›´ã™</button>
        <button type="button" class="primary" id="btnPlant">æ¤ãˆã‚‹</button>
      </div>
    `);

    document.getElementById("btnRe").addEventListener("click", showSeedStep);
    document.getElementById("btnPlant").addEventListener("click", () => {
      const p = {
  state: "GROW",
  seedId: draft.seedId,
  waterId: draft.waterId,
  fertId: draft.fertId,
  startAt: now,
  readyAt: now + growMs,

  // â˜…ç¬¬2æ®µéšã®äºˆå…†ãƒ•ãƒ©ã‚°ï¼ˆä¿å­˜ã•ã‚Œã‚‹ã®ã§å†èª­ã¿è¾¼ã¿ã—ã¦ã‚‚ãƒ–ãƒ¬ãªã„ï¼‰
  // "NONE" | "SR65" | "SR100"
  srHint:
    (draft.waterId === "water_mid" && draft.fertId === "fert_str") ? "SR100" :
    (draft.waterId === "water_mid") ? "SR65" :
    "NONE"
};

state.plots[activeIndex] = p;
saveState(state);
closeModal();
render();


  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  // ====== ãƒªã‚»ãƒƒãƒˆ ======
  document.getElementById("btnReset").addEventListener("click", () => {
    if(!confirm("ç•‘ã¨å›³é‘‘ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚OKï¼Ÿ")) return;
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_BOOK);
    state = loadState();
    book  = loadBook();
    render();
  });

  // åˆæœŸæç”»ï¼†ãƒ«ãƒ¼ãƒ—
  render();
  setInterval(tick, TICK_MS);
})();
</script>


</body>
</html>
