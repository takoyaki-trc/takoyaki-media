
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãŸã“ç„¼ãå›³é‘‘</title>
  <style>
    :root{
      --bg:#0b0f18;
      --text:#e9f1ff;
      --muted:#9fb0c9;
      --border:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:10px;

      --tile:84px;
      --thumbPad:5px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 40% -10%, rgba(106,160,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 10%, rgba(255,180,80,.10), transparent 65%),
                 var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 36px;}
    a{color:inherit}

    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .leftHead{display:flex;align-items:flex-start;gap:10px;min-width:0;}
    .backBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);color:var(--text);font-size:13px;cursor:pointer;
      user-select:none;-webkit-tap-highlight-color:transparent;box-shadow:0 10px 18px rgba(0,0,0,.18);
    }
    .backBtn:active{transform:translateY(1px)}
    .backBtn .ico{
      width:18px;height:18px;display:inline-block;border-radius:6px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;line-height:1;font-weight:700;
    }
    .title{display:flex;flex-direction:column;gap:4px;min-width:0;}
    h1{margin:0;font-size:20px;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .sub{color:var(--muted);font-size:12px;line-height:1.35}

    .controls{
      display:flex;flex-wrap:wrap;gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .field{display:flex;flex-direction:column;gap:6px;min-width:170px;flex:1 1 220px;}
    .label{font-size:11px;color:var(--muted);letter-spacing:.03em;}
    input[type="search"], select, input[type="password"], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:140px;resize:vertical;line-height:1.45}
    input[type="search"]::placeholder, textarea::placeholder{color:rgba(255,255,255,.35)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex:1 1 220px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--muted);
      font-size:12px;white-space:nowrap;box-shadow:0 10px 18px rgba(0,0,0,.15);
    }
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--text);font-size:13px;cursor:pointer;
    }
    .btn.small{padding:8px 10px;font-size:12px}
    .btn.danger{border-color:rgba(255,80,80,.35); color:#ffd3d3}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(var(--tile), 1fr));gap:var(--gap);align-items:stretch;}
    .card{
      position:relative;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      overflow:hidden;box-shadow:0 10px 18px rgba(0,0,0,.22);
      cursor:pointer;min-height:calc(var(--tile) + 34px);
      user-select:none;-webkit-tap-highlight-color:transparent;
      transition:transform .12s ease, filter .12s ease;
    }
    .card:active{transform:scale(.985)}
    .thumb{
      width:100%;height:var(--tile);display:block;
      object-fit:contain;
      padding:var(--thumbPad);
      background:rgba(0,0,0,.14);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .meta{padding:7px 8px 9px;display:flex;flex-direction:column;gap:4px;}
    .name{font-size:12px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .mini{display:flex;align-items:center;justify-content:space-between;gap:6px;color:var(--muted);font-size:11px;}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--muted);max-width:100%;
    }
    .tag b{color:var(--text);font-weight:600}
    .id{opacity:.95}

    .countBadge{
      position:absolute;right:6px;top:6px;
      padding:3px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.62);color:rgba(255,255,255,.92);
      font-size:11px;line-height:1;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      pointer-events:none;user-select:none;
      z-index:5;
    }

    /* =========================================================
       âœ… SRä»¥ä¸Šï¼šãŠã™ã™ã‚ï¼ˆä¸Šå“Ã—è¦–èªæ€§ï¼‰
       - å¤–å‘¨ãƒ›ãƒ­ï¼šè–„ã‚ï¼†ä½é€Ÿå›è»¢
       - æ–œã‚ã‚¹ã‚¤ãƒ¼ãƒ—ï¼šç´°ãã€ãŸã¾ã«æµã‚Œã‚‹
       - ç²’ï¼šæœ€å°é™ï¼ˆ1ãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘ã€ã‚†ã£ãã‚Šï¼‰
       ========================================================= */

    .card.is-glow{
      border-color:rgba(255,230,120,.38);
      transform: translateZ(0);
      box-shadow:
        0 0 0 1px rgba(255,230,120,.14) inset,
        0 10px 18px rgba(0,0,0,.22),
        0 0 18px rgba(255,210,90,.12),
        0 0 34px rgba(120,210,255,.07);
      filter:saturate(1.06) brightness(1.015);
    }

    /* å¤–å‘¨ã®è–„ã„ãƒ›ãƒ­ï¼ˆä½é€Ÿï¼‰ */
    .card.is-glow::before{
      content:"";
      position:absolute;
      inset:-3px;
      border-radius:18px;
      pointer-events:none;
      background:
        conic-gradient(from 200deg,
          rgba(255,215,90,0.00),
          rgba(255,215,90,0.30),
          rgba(150,220,255,0.18),
          rgba(255,170,235,0.10),
          rgba(255,215,90,0.00)
        );
      filter: blur(10px);
      opacity: .55;
      animation: holoSpin 7.5s linear infinite;
      mix-blend-mode: screen;
      z-index:1;
    }

    /* é¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆè–„ã‚ï¼‰ */
    .card.is-glow::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), transparent 58%),
        radial-gradient(150px 120px at 25% 18%, rgba(255,240,170,.12), transparent 62%),
        radial-gradient(190px 150px at 80% 30%, rgba(160,220,255,.10), transparent 66%);
      opacity:.75;
      mix-blend-mode: screen;
      z-index:2;
    }

    .card.is-glow .meta{position:relative;z-index:4;}
    .card.is-glow .thumb{position:relative;z-index:3;}

    /* æ–œã‚ã‚¹ã‚¤ãƒ¼ãƒ—ï¼šç´°ãã€é »åº¦ä½ã‚ */
    .card.is-glow .thumb::after{
      content:"";
      position:absolute;
      inset:-35% -55%;
      pointer-events:none;
      background: linear-gradient(115deg,
        rgba(255,255,255,0.00) 46%,
        rgba(255,255,255,0.10) 49%,
        rgba(255,255,255,0.26) 50.5%,
        rgba(255,255,255,0.10) 52%,
        rgba(255,255,255,0.00) 56%
      );
      transform: translateX(-75%) translateY(20%);
      opacity:.65;
      mix-blend-mode: screen;
      animation: shineSweep 6.8s ease-in-out infinite;
    }

    /* ç²’ã‚¹ãƒ‘ãƒ¼ã‚¯ï¼šå°‘æ•°ï¼†ã‚†ã£ãã‚Šï¼ˆ1ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ï¼‰ */
    .card.is-glow .spark{
      position:absolute; inset:0;
      pointer-events:none;
      z-index:4;
      opacity:.35;
      mix-blend-mode: screen;
      background:
        radial-gradient(circle at 18% 24%, rgba(255,255,255,.85) 0 1.2px, transparent 2px),
        radial-gradient(circle at 72% 20%, rgba(255,255,255,.75) 0 1.1px, transparent 2px),
        radial-gradient(circle at 84% 48%, rgba(255,255,255,.70) 0 1.1px, transparent 2px),
        radial-gradient(circle at 30% 70%, rgba(255,255,255,.62) 0 1.0px, transparent 2px),
        radial-gradient(circle at 60% 78%, rgba(255,255,255,.68) 0 1.1px, transparent 2px);
      filter: drop-shadow(0 0 5px rgba(255,255,255,.18));
      animation: sparkTwinkle 2.6s ease-in-out infinite;
    }

    @keyframes holoSpin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    @keyframes shineSweep{
      0%   { transform: translateX(-85%) translateY(25%); opacity:0; }
      12%  { opacity:.35; }
      22%  { opacity:.65; }
      30%  { opacity:.30; }
      100% { transform: translateX(75%) translateY(-10%); opacity:0; }
    }

    @keyframes sparkTwinkle{
      0%{ opacity:.10; transform: translateY(0); }
      50%{ opacity:.45; }
      100%{ opacity:.16; transform: translateY(-1px); }
    }

    @media (prefers-reduced-motion: reduce){
      .card.is-glow::before,
      .card.is-glow .thumb::after,
      .card.is-glow .spark{
        animation: none !important;
      }
    }

    .empty{
      margin-top:14px;padding:16px;border:1px dashed rgba(255,255,255,.18);
      border-radius:var(--radius);color:var(--muted);background:rgba(0,0,0,.18);
    }
    .empty code{color:var(--text);background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;}

    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      padding:16px;background:rgba(0,0,0,.72);z-index:9999;
    }
    .modal[aria-hidden="false"]{display:flex}

    .modal__panel{
      width:min(92vw, 560px);
      border-radius:18px;border:1px solid var(--border);
      background:#0f1626;
      box-shadow:0 24px 60px rgba(0,0,0,.5);
      overflow:hidden;position:relative;
    }

    .modal__img{width:100%;height:auto;display:block;background:rgba(255,255,255,.05);image-rendering:pixelated;image-rendering:crisp-edges;}
    .modal__body{padding:12px 12px 14px;display:flex;flex-direction:column;gap:10px;}
    .modal__title{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .modal__title h2{margin:0;font-size:15px;line-height:1.25;}
    .close{
      border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--text);
      border-radius:12px;padding:8px 10px;cursor:pointer;font-size:13px;
    }
    .kv{
      display:grid;grid-template-columns:110px 1fr;gap:8px 10px;
      font-size:12px;color:var(--muted);border-top:1px solid var(--border);padding-top:10px;
    }
    .kv b{color:var(--text);font-weight:600}
    .srGlow{
      display:inline-flex;align-items:center;gap:6px;font-size:11px;
      padding:4px 10px;border-radius:999px;border:1px solid rgba(255,220,120,.35);
      color:#ffe9b8;background:rgba(255,220,120,.08);
    }

    #bModal textarea, #bModal input[type="password"]{
      background:rgba(0,0,0,.35);
    }

    .bm-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .bm-title{font-size:14px;font-weight:700}
    .bm-note{color:var(--muted);font-size:12px;line-height:1.4}
    .bm-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    .bm-row{display:flex;gap:10px;flex-wrap:wrap}
    .bm-row .btn{flex:1 1 160px}
    .bm-mini{font-size:12px;color:var(--muted)}
    .bm-ok{color:#9fffa8}
    .bm-ng{color:#ffd3d3}
    .hr{height:1px;background:var(--border);margin:6px 0 2px}

    @media (max-width: 520px){
      :root{ --tile:96px; --gap:10px; --thumbPad:5px; }
      .field{min-width:140px}
      .backBtn{padding:8px 10px;font-size:12px}
      .backBtn .ico{width:18px;height:18px}
      .modal__panel{width:min(94vw, 560px)}
    }

    /* ===== å›³é‘‘ã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ­ãƒƒã‚¯ ===== */
.title{
  text-align:center;        /* â† ä¸­å¤®å¯„ã› */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;                 /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ä¸‹æ–‡å­—ã®é–“éš” */
}

/* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
.title h1{
  margin:0;
  font-size:22px;          /* å¥½ã¿ã§ 20ã€œ26px èª¿æ•´OK */
  letter-spacing:1px;
}

/* ä¸‹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆå°ã•ãæ§ãˆã‚ï¼‰ */
#lastBackupLine{
  font-size:11px;          /* â† å°ã•ã */
  opacity:.6;              /* å°‘ã—è–„ã */
  color:#ccc;
}

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="leftHead">
        <button class="backBtn" id="btnBack" type="button" aria-label="æˆ»ã‚‹">
          <span class="ico">â†</span>
          <span>æˆ»ã‚‹</span>
        </button>

        <div class="title">
          <h1>ã‚«ãƒ¼ãƒ‰å›³é‘‘</h1>
         <span id="lastBackupLine"></span>
          </div>
        </div>
      </div>

      <div class="pill" id="statPill">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </header>

    <section class="controls" aria-label="æ¤œç´¢ã¨ä¸¦ã³æ›¿ãˆ">
      <div class="field" style="flex:2 1 360px">
        <div class="label">æ¤œç´¢ï¼ˆID / åå‰ / ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼‰</div>
        <input id="q" type="search" placeholder="ä¾‹ï¼šTN-012 / ã‚½ãƒ¼ã‚¹ / SR" autocomplete="off" />
      </div>

      <div class="field">
        <div class="label">ä¸¦ã³æ›¿ãˆ</div>
        <select id="sort">
          <option value="new">å…¥æ‰‹é †ï¼ˆæ–°ã—ã„é †ï¼‰</option>
          <option value="dup">ãƒ€ãƒ–ã‚Šæšæ•°é †ï¼ˆæ‰€æŒæšæ•°ï¼‰</option>
          <option value="tn_shop">åº—é ­ãƒŠãƒ³ãƒãƒ¼ï¼ˆTN-001ã€œ025ï¼‰</option>
          <option value="tn_net">é€šè²©ãƒŠãƒ³ãƒãƒ¼ï¼ˆTN-026ã€œ050ï¼‰</option>
          <option value="tp">ãŸã“ã´ãƒ—ãƒ­ãƒ¢ï¼ˆTPï¼‰</option>
          <option value="nk">é™å®šã‚·ãƒ§ãƒƒãƒ—ï¼ˆNKï¼‰</option>
          <option value="bs">ãƒ€ãƒ¼ãƒ„ãƒ—ãƒ­ï¼ˆBSï¼‰</option>
          <option value="sp">ã‚¹ãƒšã‚·ãƒ£ãƒ«ï¼ˆSPï¼‰</option>
          <option value="col">ã‚³ãƒ©ãƒœï¼ˆCOLï¼‰</option>
          <option value="all_serial">å…¨ã‚«ãƒ¼ãƒ‰å“ç•ªé †ï¼ˆãŠã™ã™ã‚ï¼‰</option>
        </select>
      </div>

      <div class="row">
        <button class="btn small" id="btnReload" type="button">å†èª­è¾¼</button>
        <button class="btn small" id="btnBackup" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ</button>
        <button class="btn small danger" id="btnClear" type="button" title="å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¾ã™">å›³é‘‘ã‚’æ¶ˆå»</button>
      </div>
    </section>

    <main>
      <div id="grid" class="grid" aria-label="å›³é‘‘ã‚°ãƒªãƒƒãƒ‰"></div>
      <div id="empty" class="empty" style="display:none"></div>
    </main>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰è©³ç´° Modal -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-label="ã‚«ãƒ¼ãƒ‰æ‹¡å¤§è¡¨ç¤º">
    <div class="modal__panel" role="document">
      <img id="mImg" class="modal__img" alt="">
      <div class="modal__body">
        <div class="modal__title">
          <div>
            <h2 id="mTitle">-</h2>
            <div id="mGlow" style="margin-top:6px; display:none" class="srGlow">âœ¨ SRä»¥ä¸Š</div>
          </div>
          <button class="close" id="mClose" type="button" aria-label="é–‰ã˜ã‚‹">é–‰ã˜ã‚‹</button>
        </div>

        <div class="kv" aria-label="ã‚«ãƒ¼ãƒ‰æƒ…å ±">
          <div>ID</div><div><b id="mId">-</b></div>
          <div>ãƒ¬ã‚¢</div><div><b id="mRarity">-</b></div>
          <div>å–å¾—</div><div><b id="mAt">-</b></div>
          <div>æ‰€æŒ</div><div><b id="mCount">-</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ Modal -->
  <div class="modal" id="bModal" aria-hidden="true" role="dialog" aria-label="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ">
    <div class="modal__panel" role="document">
      <div class="modal__body">
        <div class="bm-head">
          <div class="bm-title">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒï¼ˆã“ã®ç«¯æœ«ã®å›³é‘‘ï¼‰</div>
          <button class="close" id="bClose" type="button">é–‰ã˜ã‚‹</button>
        </div>
        <div class="bm-note">
          âœ… å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§ã€Œå¾©å…ƒã‚³ãƒ¼ãƒ‰ã€ã‚’ä½œã£ã¦ä¿ç®¡ã™ã‚Œã°ã€ãƒ‡ãƒ¼ã‚¿æ¶ˆå»å¾Œã§ã‚‚å¾©å…ƒã§ãã¾ã™ã€‚<br>
          ğŸ”’ PINï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¨­å®šã™ã‚‹ã¨æš—å·åŒ–ã•ã‚Œã€PINã‚’çŸ¥ã‚‰ãªã„äººã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚
        </div>

        <div class="hr"></div>

        <div class="bm-grid">
          <div>
            <div class="label">PINï¼ˆä»»æ„ / æ¨å¥¨ï¼‰</div>
            <input id="pin" type="password" placeholder="ä¾‹ï¼š1234 / takopi ãªã©ï¼ˆå¿˜ã‚Œã‚‹ã¨å¾©å…ƒä¸å¯ï¼‰" autocomplete="off" />
            <div class="bm-mini">â€» PINã‚’å¿˜ã‚ŒãŸå ´åˆã€æš—å·åŒ–ã‚³ãƒ¼ãƒ‰ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</div>
          </div>

          <div class="bm-row">
            <button class="btn" id="btnMakeCode" type="button">å¾©å…ƒã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</button>
            <button class="btn" id="btnCopyCode" type="button">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn" id="btnSaveTxt" type="button">.txtã§ä¿å­˜</button>
          </div>

          <div>
            <div class="label">å¾©å…ƒã‚³ãƒ¼ãƒ‰ï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</div>
            <textarea id="codeBox" placeholder="ã“ã“ã«å¾©å…ƒã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            <div class="bm-row">
              <button class="btn" id="btnRestore" type="button">ã“ã®ã‚³ãƒ¼ãƒ‰ã§å¾©å…ƒ</button>
              <label class="btn" style="display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;">
                <input id="filePick" type="file" accept=".txt" style="display:none">
                .txtèª­ã¿è¾¼ã¿
              </label>
            </div>
            <div class="bm-mini bm-ng" id="bMsg"></div>
          </div>

          <div class="bm-mini">
            ğŸ’¡ãŠã™ã™ã‚ï¼šå›³é‘‘ãŒå¢—ãˆãŸæ—¥ï¼ˆã¾ãŸã¯é€±1ï¼‰ã«ã€Œç™ºè¡Œâ†’ã‚³ãƒ”ãƒ¼ã€ã—ã¦ã€è‡ªåˆ†ã®ãƒ¡ãƒ¢å¸³ã«è²¼ã‚‹ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // å›³é‘‘ + ãƒ€ãƒ–ã‚Šé›†è¨ˆï¼ˆcountæ–¹å¼ / IDã”ã¨ã«1æšè¡¨ç¤ºï¼‰ + ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¾©å…ƒã‚³ãƒ¼ãƒ‰ï¼‰
  // =========================================================

  const LS_KEY = "tf_v1_book";
  const LS_BACKUP_AT = "tf_v1_book_backup_at";

  const elGrid = document.getElementById("grid");
  const elEmpty = document.getElementById("empty");
  const elPill = document.getElementById("statPill");
  const elQ = document.getElementById("q");
  const elSort = document.getElementById("sort");
  const btnReload = document.getElementById("btnReload");
  const btnClear = document.getElementById("btnClear");
  const btnBack = document.getElementById("btnBack");
  const btnBackup = document.getElementById("btnBackup");
  const lastBackupLine = document.getElementById("lastBackupLine");

  // card modal
  const modal = document.getElementById("modal");
  const mImg = document.getElementById("mImg");
  const mTitle = document.getElementById("mTitle");
  const mId = document.getElementById("mId");
  const mRarity = document.getElementById("mRarity");
  const mAt = document.getElementById("mAt");
  const mGlow = document.getElementById("mGlow");
  const mClose = document.getElementById("mClose");
  const mCount = document.getElementById("mCount");

  // backup modal
  const bModal = document.getElementById("bModal");
  const bClose = document.getElementById("bClose");
  const pin = document.getElementById("pin");
  const codeBox = document.getElementById("codeBox");
  const btnMakeCode = document.getElementById("btnMakeCode");
  const btnCopyCode = document.getElementById("btnCopyCode");
  const btnSaveTxt = document.getElementById("btnSaveTxt");
  const btnRestore = document.getElementById("btnRestore");
  const filePick = document.getElementById("filePick");
  const bMsg = document.getElementById("bMsg");

  let all = [];
  let view = [];
  let countMap = {};

  function safeJSONParse(str){ try { return JSON.parse(str); } catch(e){ return null; } }
  function normalizeText(s){ return (s ?? "").toString().trim().toLowerCase(); }

  // ========= å“ç•ªè§£æï¼ˆTN/TP/NK/BS/SP/COL ãªã©ï¼‰ =========
  function parseCardId(id){
    const s = (id ?? "").toString().trim().toUpperCase();
    const m = s.match(/^([A-Z]+)[-_]?(\d+)?$/);
    if(!m) return { prefix:"ZZ", num:9999 };
    return { prefix: m[1], num: Number(m[2] || 0) };
  }

  // â˜… SPåˆ¤å®šï¼ˆç„¦ã’/ç”Ÿç„¼ã‘ã‚’SPã«å«ã‚ã‚‹ä¿é™ºï¼‰
  function isSpecialSPCard(item){
    const id = (item?.id ?? "").toString().trim().toUpperCase();
    const name = (item?.name ?? "").toString().trim();
    const rarity = (item?.rarity ?? "").toString().trim().toUpperCase();

    if(id.startsWith("SP")) return true;
    if(rarity === "SP") return true;
    if(name.includes("ç„¦ã’") || name.includes("ç”Ÿç„¼ã‘")) return true;
    if(id.includes("BURN") || id.includes("RAW") || id.includes("NAMA") || id.includes("KOGE")) return true;

    return false;
  }

  function idToNumber(id){
    const p = parseCardId(id);
    return Number.isFinite(p.num) ? p.num : Number.POSITIVE_INFINITY;
  }

  function isSRPlus(rarity){
    const r = normalizeText(rarity);
    if(!r) return false;
    if(r.includes("sr")) return true;
    if(r.includes("ur")) return true;
    if(r.includes("lr")) return true;
    if(r.includes("hr")) return true;
    if(r.includes("xr")) return true;
    return false;
  }

  // æ—¥æ™‚ï¼ˆè¡¨ç¤ºã¯æ—¥æœ¬æ™‚é–“å›ºå®šï¼‰
  const te = new TextEncoder();
  const td = new TextDecoder();

  function toDate(at){
    if(at == null || at === "") return null;
    if(typeof at === "number"){
      return new Date(normalizeEpoch(at));
    }
    const s = String(at).trim();
    if(/^\d+$/.test(s)){
      const n = Number(s);
      if(!Number.isFinite(n)) return null;
      return new Date(normalizeEpoch(n));
    }
    const d = new Date(s);
    if(isNaN(d.getTime())) return null;
    return d;
  }
  function normalizeEpoch(n){
    const abs = Math.abs(n);
    if(abs < 1e11) return n * 1000; // ç§’â†’ms
    return n; // ms
  }
  function fmtTokyo(d){
    try{
      const fmt = new Intl.DateTimeFormat("ja-JP",{
        timeZone:"Asia/Tokyo",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit",
        hour12:false
      });
      const parts = fmt.formatToParts(d);
      const get = (t) => parts.find(p=>p.type===t)?.value ?? "";
      return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}`;
    }catch(e){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }
  }
  function formatAt(at){
    const d = toDate(at);
    if(!d) return "-";
    return fmtTokyo(d);
  }
  function toTime(at){
    const d = toDate(at);
    return d ? d.getTime() : 0;
  }

  // countæ–¹å¼
  function buildCountMap(){
    countMap = {};
    for(const item of all){
      const id = (item.id ?? "").toString();
      if(!id) continue;
      const c = Number(item.count);
      countMap[id] = (Number.isFinite(c) && c > 0) ? c : 1;
    }
  }
  function getCount(id){
    const key = (id ?? "").toString();
    return countMap[key] || 1;
  }

  function updateBackupLine(){
    const n = Number(localStorage.getItem(LS_BACKUP_AT));
    if(!n){
      lastBackupLine.textContent = "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æœªä½œæˆï¼ˆä¸‡ãŒä¸€ã®ãŸã‚å¾©å…ƒã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¦ã­ï¼‰";
      return;
    }
    lastBackupLine.textContent = `æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š${fmtTokyo(new Date(n))}`;
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      all = [];
      render();
      showEmpty(
        `å›³é‘‘ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆã€‚<br>
         localStorage ã® <code>${LS_KEY}</code> ã‚’ç•‘å´ã§ä¿å­˜ã—ã¦ã‹ã‚‰é–‹ã„ã¦ã­ã€‚`
      );
      elPill.textContent = "0 / 0";
      updateBackupLine();
      return;
    }

    const obj = safeJSONParse(raw);

    let gotArr = [];
    if(obj && Array.isArray(obj.got)){
      gotArr = obj.got;
    } else if(obj && obj.got && typeof obj.got === "object"){
      gotArr = Object.values(obj.got);
    } else {
      gotArr = [];
    }

    all = gotArr.map(x => ({
      id: x?.id ?? "",
      name: x?.name ?? "",
      img: x?.img ?? "",
      rarity: x?.rarity ?? "",
      at: x?.at ?? "",
      lastAt: x?.lastAt ?? "",
      count: x?.count ?? 1
    }));

    buildCountMap();
    render();
    updateBackupLine();
  }

  function applyFilterSort(){
    const q = normalizeText(elQ.value);
    const sort = elSort.value;

    view = all.filter(item => {
      if(!q) return true;
      const hay = [ item.id, item.name, item.rarity ].map(normalizeText).join(" ");
      return hay.includes(q);
    });

    if(sort === "new"){
      view.sort((a,b) => {
        const ta = toTime(a.lastAt || a.at);
        const tb = toTime(b.lastAt || b.at);
        return tb - ta;
      });

    }else if(sort === "dup"){
      view.sort((a,b) => {
        const ca = getCount(a.id);
        const cb = getCount(b.id);
        if(cb !== ca) return cb - ca;

        const A = parseCardId(a.id);
        const B = parseCardId(b.id);
        if(A.prefix !== B.prefix) return A.prefix.localeCompare(B.prefix);
        if(A.num !== B.num) return A.num - B.num;

        const ta = toTime(a.lastAt || a.at);
        const tb = toTime(b.lastAt || b.at);
        return tb - ta;
      });

    }else if(sort === "tn_shop"){
      view = view.filter(c=>{
        const p = parseCardId(c.id);
        return p.prefix === "TN" && p.num >= 1 && p.num <= 25;
      }).sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "tn_net"){
      view = view.filter(c=>{
        const p = parseCardId(c.id);
        return p.prefix === "TN" && p.num >= 26 && p.num <= 50;
      }).sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "tp"){
      view = view.filter(c=> parseCardId(c.id).prefix === "TP")
                 .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "nk"){
      view = view.filter(c=> parseCardId(c.id).prefix === "NK")
                 .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "bs"){
      view = view.filter(c=> parseCardId(c.id).prefix === "BS")
                 .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "sp"){
      view = view.filter(c=> isSpecialSPCard(c))
                 .sort((a,b)=>{
                   const A0 = parseCardId(a.id);
                   const B0 = parseCardId(b.id);
                   if(A0.prefix === "SP" && B0.prefix === "SP" && A0.num !== B0.num){
                     return A0.num - B0.num;
                   }
                   const ta = toTime(a.lastAt || a.at);
                   const tb = toTime(b.lastAt || b.at);
                   return tb - ta;
                 });

    }else if(sort === "col"){
      view = view.filter(c=> parseCardId(c.id).prefix === "COL")
                 .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

    }else if(sort === "all_serial"){
      const prefixOrder = { TN:1, TP:2, NK:3, BS:4, COL:5, SP:6 };

      view.sort((a,b)=>{
        const A0 = parseCardId(a.id);
        const B0 = parseCardId(b.id);

        const A = isSpecialSPCard(a) ? { prefix:"SP", num:A0.num } : A0;
        const B = isSpecialSPCard(b) ? { prefix:"SP", num:B0.num } : B0;

        const pa = prefixOrder[A.prefix] ?? 99;
        const pb = prefixOrder[B.prefix] ?? 99;
        if(pa !== pb) return pa - pb;

        if(A.num !== B.num) return A.num - B.num;

        const ta = toTime(a.lastAt || a.at);
        const tb = toTime(b.lastAt || b.at);
        return tb - ta;
      });

    }else{
      view.sort((a,b) => idToNumber(a.id) - idToNumber(b.id));
    }

    elPill.textContent = `${view.length} / ${all.length}`;
  }

  function render(){
    hideEmpty();
    applyFilterSort();
    elGrid.innerHTML = "";

    if(view.length === 0){
      showEmpty("è©²å½“ã‚«ãƒ¼ãƒ‰ãŒãªã„ã‚ˆï¼ˆæ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ã­ï¼‰ã€‚");
      return;
    }

    const frag = document.createDocumentFragment();

    for(const item of view){
      const card = document.createElement("div");
      const glow = isSRPlus(item.rarity);
      card.className = "card" + (glow ? " is-glow" : "");
      card.setAttribute("role","button");
      card.setAttribute("tabindex","0");

      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = item.name || item.id || "card";
      img.loading = "lazy";
      img.decoding = "async";
      img.src = item.img || "";
      img.onerror = () => {
        img.removeAttribute("src");
        img.alt = "ç”»åƒãªã—";
        img.style.display = "block";
        img.style.objectFit = "contain";
      };

      // âœ… SRä»¥ä¸Šã ã‘ã‚¹ãƒ‘ãƒ¼ã‚¯ï¼ˆä¸Šå“ç‰ˆï¼š1ãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘ï¼‰
      if(glow){
        const s1 = document.createElement("div");
        s1.className = "spark";
        card.appendChild(s1);
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = item.name || "(no name)";

      const mini = document.createElement("div");
      mini.className = "mini";

      const tag = document.createElement("div");
      tag.className = "tag";
      tag.innerHTML = `<span class="id">#${escapeHTML(item.id || "-")}</span>`;

      const rar = document.createElement("div");
      rar.className = "tag";
      rar.innerHTML = `<b>${escapeHTML(item.rarity || "-")}</b>`;

      mini.appendChild(tag);
      mini.appendChild(rar);

      meta.appendChild(name);
      meta.appendChild(mini);

      const cnt = getCount(item.id);
      const badge = document.createElement("div");
      badge.className = "countBadge";
      badge.textContent = `Ã—${cnt}`;

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(badge);

      card.addEventListener("click", () => openModal(item));
      card.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openModal(item);
        }
      });

      frag.appendChild(card);
    }

    elGrid.appendChild(frag);
  }

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function showEmpty(html){
    elEmpty.style.display = "block";
    elEmpty.innerHTML = html;
  }
  function hideEmpty(){
    elEmpty.style.display = "none";
    elEmpty.innerHTML = "";
  }

  function openModal(item){
    mImg.src = item.img || "";
    mImg.alt = item.name || item.id || "card";
    mTitle.textContent = item.name || "(no name)";
    mId.textContent = item.id || "-";
    mRarity.textContent = item.rarity || "-";
    mAt.textContent = formatAt(item.lastAt || item.at);
    mGlow.style.display = isSRPlus(item.rarity) ? "inline-flex" : "none";
    mCount.textContent = `${getCount(item.id)} æš`;

    modal.setAttribute("aria-hidden","false");
    document.addEventListener("keydown", onEscClose, { once:false });
  }
  function closeModal(){
    modal.setAttribute("aria-hidden","true");
    mImg.removeAttribute("src");
    document.removeEventListener("keydown", onEscClose);
  }
  function onEscClose(e){
    if(e.key === "Escape") closeModal();
  }
  modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

  // =========================================================
  // â˜… å¾©å…ƒã‚³ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«è‡ªåˆ†ã§ä½œã‚‹ï¼‰
  // =========================================================
  function b64uEncodeBytes(bytes){
    let bin = "";
    const chunk = 0x8000;
    for(let i=0;i<bytes.length;i+=chunk){
      bin += String.fromCharCode(...bytes.subarray(i, i+chunk));
    }
    const b64 = btoa(bin);
    return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }
  function b64uDecodeToBytes(b64u){
    const b64 = b64u.replace(/-/g,"+").replace(/_/g,"/") + "===".slice((b64u.length + 3) % 4);
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
  }
  function b64uEncodeText(str){ return b64uEncodeBytes(te.encode(str)); }
  function b64uDecodeText(b64u){ return td.decode(b64uDecodeToBytes(b64u)); }

  function randBytes(n){
    const a = new Uint8Array(n);
    crypto.getRandomValues(a);
    return a;
  }

  async function deriveKeyFromPIN(pinStr, saltBytes, iterations){
    const baseKey = await crypto.subtle.importKey(
      "raw", te.encode(pinStr), { name:"PBKDF2" }, false, ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      { name:"PBKDF2", salt:saltBytes, iterations, hash:"SHA-256" },
      baseKey,
      { name:"AES-GCM", length:256 },
      false,
      ["encrypt","decrypt"]
    );
  }

  async function makeRestoreCode(){
    bMsg.className = "bm-mini bm-ng";
    bMsg.textContent = "";

    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      bMsg.textContent = "å›³é‘‘ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆtf_v1_book ãŒç©ºï¼‰ã€‚";
      return;
    }

    const pinStr = (pin.value ?? "").trim();

    if(!pinStr){
      const payload = { v:1, alg:"PLAIN", key:LS_KEY, data_b64:b64uEncodeText(raw) };
      codeBox.value = b64uEncodeText(JSON.stringify(payload));
      localStorage.setItem(LS_BACKUP_AT, String(Date.now()));
      updateBackupLine();
      bMsg.className = "bm-mini bm-ok";
      bMsg.textContent = "ç™ºè¡Œã—ã¾ã—ãŸï¼ˆPINãªã— / æš—å·åŒ–ãªã—ï¼‰ã€‚ã‚³ãƒ”ãƒ¼ or .txtä¿å­˜ã—ã¦ã­ã€‚";
      return;
    }

    const salt = randBytes(16);
    const iv = randBytes(12);
    const iterations = 120000;

    const key = await deriveKeyFromPIN(pinStr, salt, iterations);
    const plainBytes = te.encode(raw);
    const ct = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, plainBytes);

    const payload = {
      v:1,
      alg:"A256GCM",
      kdf:"PBKDF2-SHA256",
      iter:iterations,
      key:LS_KEY,
      salt_b64:b64uEncodeBytes(salt),
      iv_b64:b64uEncodeBytes(iv),
      ct_b64:b64uEncodeBytes(new Uint8Array(ct))
    };

    codeBox.value = b64uEncodeText(JSON.stringify(payload));
    localStorage.setItem(LS_BACKUP_AT, String(Date.now()));
    updateBackupLine();
    bMsg.className = "bm-mini bm-ok";
    bMsg.textContent = "ç™ºè¡Œã—ã¾ã—ãŸï¼ˆPINã‚ã‚Š / æš—å·åŒ–ï¼‰ã€‚PINã‚‚å¿˜ã‚Œãšã«ä¿ç®¡ã—ã¦ã­ã€‚";
  }

  async function restoreFromCode(){
    bMsg.className = "bm-mini bm-ng";
    bMsg.textContent = "";

    const code = (codeBox.value ?? "").trim();
    if(!code){ bMsg.textContent = "å¾©å…ƒã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™ã€‚"; return; }

    let payload = null;
    try{
      payload = JSON.parse(b64uDecodeText(code));
    }catch(e){
      bMsg.textContent = "å¾©å…ƒã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ï¼‰ã€‚";
      return;
    }

    if(!payload || payload.v !== 1 || !payload.alg){
      bMsg.textContent = "å¾©å…ƒã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆpayloadä¸æ­£ï¼‰ã€‚";
      return;
    }

    const targetKey = payload.key || LS_KEY;

    if(payload.alg === "PLAIN"){
      try{
        const raw = b64uDecodeText(payload.data_b64);
        localStorage.setItem(targetKey, raw);
        load();
        bMsg.className = "bm-mini bm-ok";
        bMsg.textContent = "å¾©å…ƒã—ã¾ã—ãŸï¼";
        return;
      }catch(e){
        bMsg.textContent = "å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå¹³æ–‡ãƒ‡ãƒ¼ã‚¿ã®å¾©å·å¤±æ•—ï¼‰ã€‚";
        return;
      }
    }

    if(payload.alg === "A256GCM"){
      const pinStr = (pin.value ?? "").trim();
      if(!pinStr){
        bMsg.textContent = "ã“ã®å¾©å…ƒã‚³ãƒ¼ãƒ‰ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
      }
      try{
        const salt = b64uDecodeToBytes(payload.salt_b64);
        const iv = b64uDecodeToBytes(payload.iv_b64);
        const ct = b64uDecodeToBytes(payload.ct_b64);
        const iter = payload.iter || 120000;

        const key = await deriveKeyFromPIN(pinStr, salt, iter);
        const pt = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, ct);
        const raw = td.decode(new Uint8Array(pt));

        localStorage.setItem(targetKey, raw);
        load();
        bMsg.className = "bm-mini bm-ok";
        bMsg.textContent = "å¾©å…ƒã—ã¾ã—ãŸï¼";
        return;
      }catch(e){
        bMsg.textContent = "å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚PINãŒé•ã†ã‹ã€ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚";
        return;
      }
    }

    bMsg.textContent = "æœªå¯¾å¿œã®å¾©å…ƒã‚³ãƒ¼ãƒ‰ã§ã™ã€‚";
  }

  function copyCode(){
    const t = (codeBox.value ?? "").trim();
    if(!t){ bMsg.className="bm-mini bm-ng"; bMsg.textContent = "ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
    navigator.clipboard?.writeText(t).then(()=>{
      bMsg.className="bm-mini bm-ok"; bMsg.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
    }).catch(()=>{
      codeBox.focus(); codeBox.select();
      document.execCommand("copy");
      bMsg.className="bm-mini bm-ok"; bMsg.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
    });
  }

  function saveTxt(){
    const t = (codeBox.value ?? "").trim();
    if(!t){ bMsg.className="bm-mini bm-ng"; bMsg.textContent = "ä¿å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
    const blob = new Blob([t], { type:"text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const ts = new Date();
    a.href = url;
    a.download = `takoyaki_zukan_restore_code_${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,"0")}${String(ts.getDate()).padStart(2,"0")}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    bMsg.className="bm-mini bm-ok"; bMsg.textContent = ".txtã§ä¿å­˜ã—ã¾ã—ãŸï¼";
  }

  filePick.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    codeBox.value = text.trim();
    bMsg.className="bm-mini bm-ok";
    bMsg.textContent = "èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å¾©å…ƒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ã€‚";
    filePick.value = "";
  });

  function openBackupModal(){
    bMsg.className="bm-mini bm-ng";
    bMsg.textContent = "";
    bModal.setAttribute("aria-hidden","false");
    document.addEventListener("keydown", onEscBackup, { once:false });
  }
  function closeBackupModal(){
    bModal.setAttribute("aria-hidden","true");
    document.removeEventListener("keydown", onEscBackup);
  }
  function onEscBackup(e){
    if(e.key === "Escape") closeBackupModal();
  }
  bModal.addEventListener("click", (e)=>{ if(e.target===bModal) closeBackupModal(); });

  // controls
  elQ.addEventListener("input", () => render());
  elSort.addEventListener("change", () => render());
  btnReload.addEventListener("click", () => load());

  btnClear.addEventListener("click", () => {
    const ok = confirm("å›³é‘‘ï¼ˆtf_v1_bookï¼‰ã‚’æ¶ˆå»ã™ã‚‹ï¼Ÿ\nâ€»ã“ã®ç«¯æœ«ã®å›³é‘‘ãŒæ¶ˆãˆã¾ã™");
    if(!ok) return;
    localStorage.removeItem(LS_KEY);
    load();
  });

  btnBack.addEventListener("click", () => {
    if(history.length > 1) history.back();
    else location.href = "./index.html";
  });

  // backup modal buttonsï¼ˆâ˜…äºŒé‡ç™»éŒ²ã—ãªã„ï¼‰
  btnBackup.addEventListener("click", openBackupModal);
  bClose.addEventListener("click", closeBackupModal);
  btnMakeCode.addEventListener("click", () => makeRestoreCode());
  btnCopyCode.addEventListener("click", copyCode);
  btnSaveTxt.addEventListener("click", saveTxt);
  btnRestore.addEventListener("click", () => restoreFromCode());

  // modal close
  mClose.addEventListener("click", closeModal);

  // init
  load();
  updateBackupLine();
</script>
</body>
</html>


