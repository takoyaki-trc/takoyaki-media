<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>たこ焼き図鑑</title>

  <style>
    :root{
      --bg:#0b0f18;
      --text:#e9f1ff;
      --muted:#9fb0c9;
      --border:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:10px;

      --tile:84px;
      --thumbPad:5px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 40% -10%, rgba(106,160,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 10%, rgba(255,180,80,.10), transparent 65%),
                 var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 36px;}
    a{color:inherit}

    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .leftHead{display:flex;align-items:flex-start;gap:10px;min-width:0;}
    .backBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);color:var(--text);font-size:13px;cursor:pointer;
      user-select:none;-webkit-tap-highlight-color:transparent;box-shadow:0 10px 18px rgba(0,0,0,.18);
    }
    .backBtn:active{transform:translateY(1px)}
    .backBtn .ico{
      width:18px;height:18px;display:inline-block;border-radius:6px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;line-height:1;font-weight:700;
    }
    .title{display:flex;flex-direction:column;gap:4px;min-width:0;}
    h1{margin:0;font-size:20px;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .sub{color:var(--muted);font-size:12px;line-height:1.35}

    .controls{
      display:flex;flex-wrap:wrap;gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .field{display:flex;flex-direction:column;gap:6px;min-width:170px;flex:1 1 220px;}
    .label{font-size:11px;color:var(--muted);letter-spacing:.03em;}
    input[type="search"], select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input[type="search"]::placeholder{color:rgba(255,255,255,.35)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex:1 1 220px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--muted);
      font-size:12px;white-space:nowrap;box-shadow:0 10px 18px rgba(0,0,0,.15);
    }
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--text);font-size:13px;cursor:pointer;
    }
    .btn.small{padding:8px 10px;font-size:12px}
    .btn.primary{
      background:linear-gradient(180deg, rgba(140,200,255,.18), rgba(255,255,255,.08));
      border-color: rgba(180,220,255,.38);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(var(--tile), 1fr));gap:var(--gap);align-items:stretch;}
    .card{
      position:relative;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      overflow:hidden;box-shadow:0 10px 18px rgba(0,0,0,.22);
      cursor:pointer;min-height:calc(var(--tile) + 34px);
      user-select:none;-webkit-tap-highlight-color:transparent;
      transition:transform .12s ease, filter .12s ease;
    }
    .card:active{transform:scale(.985)}
    .thumb{
      width:100%;height:var(--tile);display:block;
      object-fit:contain;
      padding:var(--thumbPad);
      background:rgba(0,0,0,.14);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .meta{padding:7px 8px 9px;display:flex;flex-direction:column;gap:4px;}
    .name{font-size:12px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .mini{display:flex;align-items:center;justify-content:space-between;gap:6px;color:var(--muted);font-size:11px;}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--muted);max-width:100%;
    }
    .tag b{color:var(--text);font-weight:600}
    .id{opacity:.95}

    .countBadge{
      position:absolute;right:6px;top:6px;
      padding:3px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.62);color:rgba(255,255,255,.92);
      font-size:11px;line-height:1;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      pointer-events:none;user-select:none;
      z-index:5;
    }

    /* =========================
       ✅ SR以上：おすすめ（上品×視認性）
       ========================= */
    .card.is-glow{
      border-color:rgba(255,230,120,.38);
      transform: translateZ(0);
      box-shadow:
        0 0 0 1px rgba(255,230,120,.14) inset,
        0 10px 18px rgba(0,0,0,.22),
        0 0 18px rgba(255,210,90,.12),
        0 0 34px rgba(120,210,255,.07);
      filter:saturate(1.06) brightness(1.015);
    }
    .card.is-glow::before{
      content:"";
      position:absolute;
      inset:-3px;
      border-radius:18px;
      pointer-events:none;
      background:
        conic-gradient(from 200deg,
          rgba(255,215,90,0.00),
          rgba(255,215,90,0.30),
          rgba(150,220,255,0.18),
          rgba(255,170,235,0.10),
          rgba(255,215,90,0.00)
        );
      filter: blur(10px);
      opacity: .55;
      animation: holoSpin 7.5s linear infinite;
      mix-blend-mode: screen;
      z-index:1;
    }
    .card.is-glow::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), transparent 58%),
        radial-gradient(150px 120px at 25% 18%, rgba(255,240,170,.12), transparent 62%),
        radial-gradient(190px 150px at 80% 30%, rgba(160,220,255,.10), transparent 66%);
      opacity:.75;
      mix-blend-mode: screen;
      z-index:2;
    }
    .card.is-glow .meta{position:relative;z-index:4;}
    .card.is-glow .thumb{position:relative;z-index:3;}

    .card.is-glow .thumb::after{
      content:"";
      position:absolute;
      inset:-35% -55%;
      pointer-events:none;
      background: linear-gradient(115deg,
        rgba(255,255,255,0.00) 46%,
        rgba(255,255,255,0.10) 49%,
        rgba(255,255,255,0.26) 50.5%,
        rgba(255,255,255,0.10) 52%,
        rgba(255,255,255,0.00) 56%
      );
      transform: translateX(-75%) translateY(20%);
      opacity:.65;
      mix-blend-mode: screen;
      animation: shineSweep 6.8s ease-in-out infinite;
    }

    .card.is-glow .spark{
      position:absolute; inset:0;
      pointer-events:none;
      z-index:4;
      opacity:.35;
      mix-blend-mode: screen;
      background:
        radial-gradient(circle at 18% 24%, rgba(255,255,255,.85) 0 1.2px, transparent 2px),
        radial-gradient(circle at 72% 20%, rgba(255,255,255,.75) 0 1.1px, transparent 2px),
        radial-gradient(circle at 84% 48%, rgba(255,255,255,.70) 0 1.1px, transparent 2px),
        radial-gradient(circle at 30% 70%, rgba(255,255,255,.62) 0 1.0px, transparent 2px),
        radial-gradient(circle at 60% 78%, rgba(255,255,255,.68) 0 1.1px, transparent 2px);
      filter: drop-shadow(0 0 5px rgba(255,255,255,.18));
      animation: sparkTwinkle 2.6s ease-in-out infinite;
    }

    @keyframes holoSpin{ from{ transform: rotate(0deg); } to{ transform: rotate(360deg); } }
    @keyframes shineSweep{
      0%   { transform: translateX(-85%) translateY(25%); opacity:0; }
      12%  { opacity:.35; }
      22%  { opacity:.65; }
      30%  { opacity:.30; }
      100% { transform: translateX(75%) translateY(-10%); opacity:0; }
    }
    @keyframes sparkTwinkle{
      0%{ opacity:.10; transform: translateY(0); }
      50%{ opacity:.45; }
      100%{ opacity:.16; transform: translateY(-1px); }
    }
    @media (prefers-reduced-motion: reduce){
      .card.is-glow::before,
      .card.is-glow .thumb::after,
      .card.is-glow .spark{ animation:none !important; }
    }

    .empty{
      margin-top:14px;padding:16px;border:1px dashed rgba(255,255,255,.18);
      border-radius:var(--radius);color:var(--muted);background:rgba(0,0,0,.18);
    }
    .empty code{color:var(--text);background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;}

    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      padding:16px;background:rgba(0,0,0,.72);z-index:9999;
    }
    .modal[aria-hidden="false"]{display:flex}

    .modal__panel{
      width:min(92vw, 560px);
      border-radius:18px;border:1px solid var(--border);
      background:#0f1626;
      box-shadow:0 24px 60px rgba(0,0,0,.5);
      overflow:hidden;position:relative;
    }
    .modal__img{width:100%;height:auto;display:block;background:rgba(255,255,255,.05);image-rendering:pixelated;image-rendering:crisp-edges;}
    .modal__body{padding:12px 12px 14px;display:flex;flex-direction:column;gap:10px;}
    .modal__title{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .modal__title h2{margin:0;font-size:15px;line-height:1.25;}
    .close{
      border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--text);
      border-radius:12px;padding:8px 10px;cursor:pointer;font-size:13px;
    }
    .kv{
      display:grid;grid-template-columns:110px 1fr;gap:8px 10px;
      font-size:12px;color:var(--muted);border-top:1px solid var(--border);padding-top:10px;
    }
    .kv b{color:var(--text);font-weight:600}
    .srGlow{
      display:inline-flex;align-items:center;gap:6px;font-size:11px;
      padding:4px 10px;border-radius:999px;border:1px solid rgba(255,220,120,.35);
      color:#ffe9b8;background:rgba(255,220,120,.08);
    }

    @media (max-width: 520px){
      :root{ --tile:96px; --gap:10px; --thumbPad:5px; }
      .field{min-width:140px}
      .backBtn{padding:8px 10px;font-size:12px}
      .backBtn .ico{width:18px;height:18px}
      .modal__panel{width:min(94vw, 560px)}
    }

    /* ===== 図鑑タイトルブロック（詰め） ===== */
    .title{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      padding:0;
      margin:0;
    }
    .title h1{
      margin:0;
      padding:0;
      line-height:1.1;
      font-size:22px;
    }
    #lastBackupLine{
      margin:0;
      padding:0;
      font-size:10px;
      line-height:1;
      opacity:.6;
    }

    /* =========================================================
       ✅ 重要：この図鑑ページでは「復元ボタン」は置かない
       - town/assets/trc-backup-float.js は共通UIで復元も出る仕様なので
       - このページだけCSSで復元ボタンを非表示にする
       ========================================================= */
    #trcBackupFloat .trcBtn:not(.trcBtnPrimary){
      display:none !important; /* 復元ボタンを隠す */
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="leftHead">
        <button class="backBtn" id="btnBack" type="button" aria-label="戻る">
          <span class="ico">←</span>
          <span>戻る</span>
        </button>

        <div class="title">
          <h1>所有カード一覧</h1>
          <span id="lastBackupLine"></span>
        </div>
      </div>

      <div class="pill" id="statPill">読み込み中…</div>
    </header>

    <section class="controls" aria-label="検索と並び替え">
      <div class="field" style="flex:2 1 360px">
        <div class="label">検索（ID / 名前 / レアリティ）</div>
        <input id="q" type="search" placeholder="例：TN-012 / ソース / SR" autocomplete="off" />
      </div>

      <div class="field">
        <div class="label">並び替え</div>
        <select id="sort">
          <option value="new">入手順（新しい順）</option>
          <option value="dup">ダブり枚数順（所持枚数）</option>
          <option value="tn_shop">店頭ナンバー（TN-001〜025）</option>
          <option value="tn_net">通販ナンバー（TN-026〜050）</option>
          <option value="tp">たこぴプロモ（TP）</option>
          <option value="nk">限定ショップ（NK）</option>
          <option value="bs">ダーツプロ（BS）</option>
          <option value="sp">スペシャル（SP）</option>
          <option value="col">コラボ（COL）</option>
          <option value="all_serial">全カード品番順（おすすめ）</option>
        </select>
      </div>

      <div class="row">
        <button class="btn small" id="btnReload" type="button">再読込</button>

        <!-- ✅ 図鑑を消去ボタンは削除（要望） -->
        <!-- ✅ 代わりに「マイ露店でカードを売る」ボタン -->
        <button class="btn small primary" id="btnMyShop" type="button">マイ露店でカードを売る</button>

        <!-- ✅ バックアップは共通のフローティングUI（右上DATA）で統一
             このページは復元を置かない（CSSで復元ボタン非表示） -->
      </div>
    </section>

    <main>
      <div id="grid" class="grid" aria-label="図鑑グリッド"></div>
      <div id="empty" class="empty" style="display:none"></div>
    </main>
  </div>

  <!-- カード詳細 Modal -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-label="カード拡大表示">
    <div class="modal__panel" role="document">
      <img id="mImg" class="modal__img" alt="">
      <div class="modal__body">
        <div class="modal__title">
          <div>
            <h2 id="mTitle">-</h2>
            <div id="mGlow" style="margin-top:6px; display:none" class="srGlow">✨ SR以上</div>
          </div>
          <button class="close" id="mClose" type="button" aria-label="閉じる">閉じる</button>
        </div>

        <div class="kv" aria-label="カード情報">
          <div>ID</div><div><b id="mId">-</b></div>
          <div>レア</div><div><b id="mRarity">-</b></div>
          <div>取得</div><div><b id="mAt">-</b></div>
          <div>所持</div><div><b id="mCount">-</b></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // 図鑑 + ダブり集計（count方式 / IDごとに1枚表示）
    // =========================================================

    const LS_KEY = "tf_v1_book";

    // ✅ マイ露店URL（あなたの実ファイル名に合わせて調整OK）
    // 例）露店が town/roten/ 配下なら： "./roten/index.html" や "./roten/myshop.html" など
    const MYSHOP_URL = "./roten/index.html";

    const elGrid = document.getElementById("grid");
    const elEmpty = document.getElementById("empty");
    const elPill = document.getElementById("statPill");
    const elQ = document.getElementById("q");
    const elSort = document.getElementById("sort");
    const btnReload = document.getElementById("btnReload");
    const btnBack = document.getElementById("btnBack");
    const btnMyShop = document.getElementById("btnMyShop");
    const lastBackupLine = document.getElementById("lastBackupLine");

    // card modal
    const modal = document.getElementById("modal");
    const mImg = document.getElementById("mImg");
    const mTitle = document.getElementById("mTitle");
    const mId = document.getElementById("mId");
    const mRarity = document.getElementById("mRarity");
    const mAt = document.getElementById("mAt");
    const mGlow = document.getElementById("mGlow");
    const mClose = document.getElementById("mClose");
    const mCount = document.getElementById("mCount");

    let all = [];
    let view = [];
    let countMap = {};

    function safeJSONParse(str){ try { return JSON.parse(str); } catch(e){ return null; } }
    function normalizeText(s){ return (s ?? "").toString().trim().toLowerCase(); }

    // ========= 品番解析（TN/TP/NK/BS/SP/COL など） =========
    function parseCardId(id){
      const s = (id ?? "").toString().trim().toUpperCase();
      const m = s.match(/^([A-Z]+)[-_]?(\d+)?$/);
      if(!m) return { prefix:"ZZ", num:9999 };
      return { prefix: m[1], num: Number(m[2] || 0) };
    }

    // ★ SP判定（焦げ/生焼けをSPに含める保険）
    function isSpecialSPCard(item){
      const id = (item?.id ?? "").toString().trim().toUpperCase();
      const name = (item?.name ?? "").toString().trim();
      const rarity = (item?.rarity ?? "").toString().trim().toUpperCase();

      if(id.startsWith("SP")) return true;
      if(rarity === "SP") return true;
      if(name.includes("焦げ") || name.includes("生焼け")) return true;
      if(id.includes("BURN") || id.includes("RAW") || id.includes("NAMA") || id.includes("KOGE")) return true;

      return false;
    }

    function idToNumber(id){
      const p = parseCardId(id);
      return Number.isFinite(p.num) ? p.num : Number.POSITIVE_INFINITY;
    }

    function isSRPlus(rarity){
      const r = normalizeText(rarity);
      if(!r) return false;
      if(r.includes("sr")) return true;
      if(r.includes("ur")) return true;
      if(r.includes("lr")) return true;
      if(r.includes("hr")) return true;
      if(r.includes("xr")) return true;
      return false;
    }

    // 日時（表示は日本時間固定）
    function toDate(at){
      if(at == null || at === "") return null;
      if(typeof at === "number") return new Date(normalizeEpoch(at));
      const s = String(at).trim();
      if(/^\d+$/.test(s)){
        const n = Number(s);
        if(!Number.isFinite(n)) return null;
        return new Date(normalizeEpoch(n));
      }
      const d = new Date(s);
      if(isNaN(d.getTime())) return null;
      return d;
    }
    function normalizeEpoch(n){
      const abs = Math.abs(n);
      if(abs < 1e11) return n * 1000; // 秒→ms
      return n; // ms
    }
    function fmtTokyo(d){
      try{
        const fmt = new Intl.DateTimeFormat("ja-JP",{
          timeZone:"Asia/Tokyo",
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit",
          hour12:false
        });
        const parts = fmt.formatToParts(d);
        const get = (t) => parts.find(p=>p.type===t)?.value ?? "";
        return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}`;
      }catch(e){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }
    }
    function formatAt(at){
      const d = toDate(at);
      if(!d) return "-";
      return fmtTokyo(d);
    }
    function toTime(at){
      const d = toDate(at);
      return d ? d.getTime() : 0;
    }

    // count方式
    function buildCountMap(){
      countMap = {};
      for(const item of all){
        const id = (item.id ?? "").toString();
        if(!id) continue;
        const c = Number(item.count);
        countMap[id] = (Number.isFinite(c) && c > 0) ? c : 1;
      }
    }
    function getCount(id){
      const key = (id ?? "").toString();
      return countMap[key] || 1;
    }

    function updateBackupLine(){
      // ✅ 統一バックアップは「右上DATAボタン（フローティング）」のみ
      lastBackupLine.textContent = "右上のDATAからバックアップできます（このページに復元は置きません）";
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        all = [];
        render();
        showEmpty(
          `図鑑データが見つからないよ。<br>
           localStorage の <code>${LS_KEY}</code> を畑側で保存してから開いてね。`
        );
        elPill.textContent = "0 / 0";
        updateBackupLine();
        return;
      }

      const obj = safeJSONParse(raw);

      let gotArr = [];
      if(obj && Array.isArray(obj.got)){
        gotArr = obj.got;
      } else if(obj && obj.got && typeof obj.got === "object"){
        gotArr = Object.values(obj.got);
      } else {
        gotArr = [];
      }

      all = gotArr.map(x => ({
        id: x?.id ?? "",
        name: x?.name ?? "",
        img: x?.img ?? "",
        rarity: x?.rarity ?? "",
        at: x?.at ?? "",
        lastAt: x?.lastAt ?? "",
        count: x?.count ?? 1
      }));

      buildCountMap();
      render();
      updateBackupLine();
    }

    function applyFilterSort(){
      const q = normalizeText(elQ.value);
      const sort = elSort.value;

      view = all.filter(item => {
        if(!q) return true;
        const hay = [ item.id, item.name, item.rarity ].map(normalizeText).join(" ");
        return hay.includes(q);
      });

      if(sort === "new"){
        view.sort((a,b) => {
          const ta = toTime(a.lastAt || a.at);
          const tb = toTime(b.lastAt || b.at);
          return tb - ta;
        });

      }else if(sort === "dup"){
        view.sort((a,b) => {
          const ca = getCount(a.id);
          const cb = getCount(b.id);
          if(cb !== ca) return cb - ca;

          const A = parseCardId(a.id);
          const B = parseCardId(b.id);
          if(A.prefix !== B.prefix) return A.prefix.localeCompare(B.prefix);
          if(A.num !== B.num) return A.num - B.num;

          const ta = toTime(a.lastAt || a.at);
          const tb = toTime(b.lastAt || b.at);
          return tb - ta;
        });

      }else if(sort === "tn_shop"){
        view = view.filter(c=>{
          const p = parseCardId(c.id);
          return p.prefix === "TN" && p.num >= 1 && p.num <= 25;
        }).sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "tn_net"){
        view = view.filter(c=>{
          const p = parseCardId(c.id);
          return p.prefix === "TN" && p.num >= 26 && p.num <= 50;
        }).sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "tp"){
        view = view.filter(c=> parseCardId(c.id).prefix === "TP")
                   .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "nk"){
        view = view.filter(c=> parseCardId(c.id).prefix === "NK")
                   .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "bs"){
        view = view.filter(c=> parseCardId(c.id).prefix === "BS")
                   .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "sp"){
        view = view.filter(c=> isSpecialSPCard(c))
                   .sort((a,b)=>{
                     const A0 = parseCardId(a.id);
                     const B0 = parseCardId(b.id);
                     if(A0.prefix === "SP" && B0.prefix === "SP" && A0.num !== B0.num){
                       return A0.num - B0.num;
                     }
                     const ta = toTime(a.lastAt || a.at);
                     const tb = toTime(b.lastAt || b.at);
                     return tb - ta;
                   });

      }else if(sort === "col"){
        view = view.filter(c=> parseCardId(c.id).prefix === "COL")
                   .sort((a,b)=> parseCardId(a.id).num - parseCardId(b.id).num);

      }else if(sort === "all_serial"){
        const prefixOrder = { TN:1, TP:2, NK:3, BS:4, COL:5, SP:6 };

        view.sort((a,b)=>{
          const A0 = parseCardId(a.id);
          const B0 = parseCardId(b.id);

          const A = isSpecialSPCard(a) ? { prefix:"SP", num:A0.num } : A0;
          const B = isSpecialSPCard(b) ? { prefix:"SP", num:B0.num } : B0;

          const pa = prefixOrder[A.prefix] ?? 99;
          const pb = prefixOrder[B.prefix] ?? 99;
          if(pa !== pb) return pa - pb;

          if(A.num !== B.num) return A.num - B.num;

          const ta = toTime(a.lastAt || a.at);
          const tb = toTime(b.lastAt || b.at);
          return tb - ta;
        });

      }else{
        view.sort((a,b) => idToNumber(a.id) - idToNumber(b.id));
      }

      elPill.textContent = `${view.length} / ${all.length}`;
    }

    function render(){
      hideEmpty();
      applyFilterSort();
      elGrid.innerHTML = "";

      if(view.length === 0){
        showEmpty("該当カードがないよ（検索条件を変えてみてね）。");
        return;
      }

      const frag = document.createDocumentFragment();

      for(const item of view){
        const card = document.createElement("div");
        const glow = isSRPlus(item.rarity);
        card.className = "card" + (glow ? " is-glow" : "");
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");

        const img = document.createElement("img");
        img.className = "thumb";
        img.alt = item.name || item.id || "card";
        img.loading = "lazy";
        img.decoding = "async";
        img.src = item.img || "";
        img.onerror = () => {
          img.removeAttribute("src");
          img.alt = "画像なし";
          img.style.display = "block";
          img.style.objectFit = "contain";
        };

        if(glow){
          const s1 = document.createElement("div");
          s1.className = "spark";
          card.appendChild(s1);
        }

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = item.name || "(no name)";

        const mini = document.createElement("div");
        mini.className = "mini";

        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerHTML = `<span class="id">#${escapeHTML(item.id || "-")}</span>`;

        const rar = document.createElement("div");
        rar.className = "tag";
        rar.innerHTML = `<b>${escapeHTML(item.rarity || "-")}</b>`;

        mini.appendChild(tag);
        mini.appendChild(rar);

        meta.appendChild(name);
        meta.appendChild(mini);

        const cnt = getCount(item.id);
        const badge = document.createElement("div");
        badge.className = "countBadge";
        badge.textContent = `×${cnt}`;

        card.appendChild(img);
        card.appendChild(meta);
        card.appendChild(badge);

        card.addEventListener("click", () => openModal(item));
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            openModal(item);
          }
        });

        frag.appendChild(card);
      }

      elGrid.appendChild(frag);
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function showEmpty(html){
      elEmpty.style.display = "block";
      elEmpty.innerHTML = html;
    }
    function hideEmpty(){
      elEmpty.style.display = "none";
      elEmpty.innerHTML = "";
    }

    function openModal(item){
      mImg.src = item.img || "";
      mImg.alt = item.name || item.id || "card";
      mTitle.textContent = item.name || "(no name)";
      mId.textContent = item.id || "-";
      mRarity.textContent = item.rarity || "-";
      mAt.textContent = formatAt(item.lastAt || item.at);
      mGlow.style.display = isSRPlus(item.rarity) ? "inline-flex" : "none";
      mCount.textContent = `${getCount(item.id)} 枚`;

      modal.setAttribute("aria-hidden","false");
      document.addEventListener("keydown", onEscClose, { once:false });
    }
    function closeModal(){
      modal.setAttribute("aria-hidden","true");
      mImg.removeAttribute("src");
      document.removeEventListener("keydown", onEscClose);
    }
    function onEscClose(e){
      if(e.key === "Escape") closeModal();
    }
    modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

    // controls
    elQ.addEventListener("input", () => render());
    elSort.addEventListener("change", () => render());
    btnReload.addEventListener("click", () => load());

    btnBack.addEventListener("click", () => {
      if(history.length > 1) history.back();
      else location.href = "./index.html";
    });

    btnMyShop.addEventListener("click", () => {
      location.href = MYSHOP_URL;
    });

    // modal close
    mClose.addEventListener("click", closeModal);

    // init
    load();
    updateBackupLine();
  </script>

  <!-- ✅ 共通バックアップ（town/assets/trc-backup-float.js）を読み込み
       ※ このHTMLが town/ 配下なら "./assets/..." でOK
       ※ もし階層が違う場合はパスだけ調整してください -->
  <script src="./assets/trc-backup-float.js"></script>
</body>
</html>


