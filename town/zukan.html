<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>たこ焼き図鑑</title>
  <style>
    :root{
      --bg:#0b0f18;
      --panel:#11192a;
      --panel2:#0f1626;
      --text:#e9f1ff;
      --muted:#9fb0c9;
      --border:rgba(255,255,255,.10);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:10px;

      /* ▼タイルを「もう一回り」小さく */
      --tile:84px; /* 96px → 84px */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 40% -10%, rgba(106,160,255,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 10%, rgba(255,180,80,.10), transparent 65%),
                 var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", sans-serif;
    }
    a{color:inherit}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 36px;
    }

    /* ===== Header ===== */
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .leftHead{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }
    .backBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
    }
    .backBtn:active{transform:translateY(1px)}
    .backBtn .ico{
      width:18px;height:18px;display:inline-block;
      border-radius:6px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      line-height:1;
      font-weight:700;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
    }

    /* ===== Controls ===== */
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:170px;
      flex:1 1 220px;
    }
    .label{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.03em;
    }
    input[type="search"], select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input[type="search"]::placeholder{color:rgba(255,255,255,.35)}
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:1 1 220px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      box-shadow:0 10px 18px rgba(0,0,0,.15);
    }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.small{padding:8px 10px;font-size:12px}
    .btn.danger{border-color:rgba(255,80,80,.35); color:#ffd3d3}
    .btn:hover{filter:brightness(1.05)}

    /* ===== Grid ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(var(--tile), 1fr));
      gap:var(--gap);
      align-items:stretch;
    }

    .card{
      position:relative;
      border-radius:14px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      overflow:hidden;
      box-shadow:0 10px 18px rgba(0,0,0,.22);
      cursor:pointer;
      min-height:calc(var(--tile) + 34px);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .12s ease, filter .12s ease;
    }
    .card:active{transform:scale(.985)}
    .thumb{
      width:100%;
      height:var(--tile);
      display:block;
      object-fit:cover;
      background:rgba(255,255,255,.05);

      /* ドット絵系ならこの2つが効くことが多い */
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .meta{
      padding:7px 8px 9px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .name{
      font-size:12px;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .mini{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      color:var(--muted);
      font-size:11px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      max-width:100%;
    }
    .tag b{color:var(--text); font-weight:600}
    .id{opacity:.95}

    /* ===== SR+ glow ===== */
    .card.is-glow{
      border-color:rgba(255,230,120,.35);
      box-shadow:
        0 0 0 1px rgba(255,230,120,.10) inset,
        0 10px 18px rgba(0,0,0,.22),
        0 0 20px rgba(255,210,90,.10);
    }
    .card.is-glow::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:conic-gradient(from 180deg,
        rgba(255,215,90,.0),
        rgba(255,215,90,.35),
        rgba(160,220,255,.22),
        rgba(255,215,90,.0));
      filter:blur(10px);
      opacity:.45;
      pointer-events:none;
      animation:spin 4.2s linear infinite;
    }
    .card.is-glow::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(255,255,255,.10), transparent 55%);
      pointer-events:none;
      opacity:.55;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }

    /* ===== Empty / Error ===== */
    .empty{
      margin-top:14px;
      padding:16px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:var(--radius);
      color:var(--muted);
      background:rgba(0,0,0,.18);
    }
    .empty code{
      color:var(--text);
      background:rgba(255,255,255,.06);
      padding:2px 6px;
      border-radius:8px;
    }

    /* ===== Modal ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.68);
      z-index:9999;
    }
    .modal[aria-hidden="false"]{display:flex}
    .modal__panel{
      width:min(92vw, 520px);
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      box-shadow:0 24px 60px rgba(0,0,0,.5);
      overflow:hidden;
      position:relative;
    }
    .modal__img{
      width:100%;
      height:auto;
      display:block;
      background:rgba(255,255,255,.05);
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .modal__body{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal__title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modal__title h2{
      margin:0;
      font-size:15px;
      line-height:1.25;
    }
    .close{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-size:13px;
    }
    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px 10px;
      font-size:12px;
      color:var(--muted);
      border-top:1px solid var(--border);
      padding-top:10px;
    }
    .kv b{color:var(--text); font-weight:600}
    .srGlow{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,220,120,.35);
      color:#ffe9b8;
      background:rgba(255,220,120,.08);
    }

    /* スマホ：カードは少し大きめ（ただし今回小さくしたので控えめに） */
    @media (max-width: 520px){
      :root{ --tile:96px; --gap:10px; } /* 110 → 96 */
      .field{min-width:140px}
      .backBtn{padding:8px 10px;font-size:12px}
      .backBtn .ico{width:18px;height:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="leftHead">
        <!-- ★ 左上：戻るボタン -->
        <button class="backBtn" id="btnBack" type="button" aria-label="戻る">
          <span class="ico">←</span>
          <span>戻る</span>
        </button>

        <div class="title">
          <h1>図鑑（tf_v1_book）</h1>
          <div class="sub">localStorage の <b>tf_v1_book</b> → got[] を表示します</div>
        </div>
      </div>

      <div class="pill" id="statPill">読み込み中…</div>
    </header>

    <section class="controls" aria-label="検索と並び替え">
      <div class="field" style="flex:2 1 360px">
        <div class="label">検索（ID / 名前 / レアリティ）</div>
        <input id="q" type="search" placeholder="例：TN-012 / ソース / SR" autocomplete="off" />
      </div>

      <div class="field">
        <div class="label">並び替え</div>
        <select id="sort">
          <option value="new">新しい順（at 降順）</option>
          <option value="num">番号順（id の数値）</option>
        </select>
      </div>

      <div class="row">
        <button class="btn small" id="btnReload" type="button">再読込</button>
        <button class="btn small danger" id="btnClear" type="button" title="図鑑データを消します">図鑑を消去</button>
      </div>
    </section>

    <main>
      <div id="grid" class="grid" aria-label="図鑑グリッド"></div>
      <div id="empty" class="empty" style="display:none"></div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-label="カード拡大表示">
    <div class="modal__panel" role="document">
      <img id="mImg" class="modal__img" alt="">
      <div class="modal__body">
        <div class="modal__title">
          <div>
            <h2 id="mTitle">-</h2>
            <div id="mGlow" style="margin-top:6px; display:none" class="srGlow">✨ SR以上</div>
          </div>
          <button class="close" id="mClose" type="button" aria-label="閉じる">閉じる</button>
        </div>

        <div class="kv" aria-label="カード情報">
          <div>ID</div><div><b id="mId">-</b></div>
          <div>レア</div><div><b id="mRarity">-</b></div>
          <div>取得</div><div><b id="mAt">-</b></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // zukan.html (tf_v1_book)
    // 期待データ: localStorage["tf_v1_book"] = JSON string
    // 例: { got: [{ id, name, img, rarity, at }], ... }
    // =========================================================

    const LS_KEY = "tf_v1_book";

    const elGrid = document.getElementById("grid");
    const elEmpty = document.getElementById("empty");
    const elPill = document.getElementById("statPill");
    const elQ = document.getElementById("q");
    const elSort = document.getElementById("sort");
    const btnReload = document.getElementById("btnReload");
    const btnClear = document.getElementById("btnClear");
    const btnBack = document.getElementById("btnBack");

    // modal
    const modal = document.getElementById("modal");
    const mImg = document.getElementById("mImg");
    const mTitle = document.getElementById("mTitle");
    const mId = document.getElementById("mId");
    const mRarity = document.getElementById("mRarity");
    const mAt = document.getElementById("mAt");
    const mGlow = document.getElementById("mGlow");
    const mClose = document.getElementById("mClose");

    let all = [];   // raw got
    let view = [];  // filtered+sorted

    function safeJSONParse(str){
      try { return JSON.parse(str); } catch(e){ return null; }
    }

    function normalizeText(s){
      return (s ?? "").toString().trim().toLowerCase();
    }

    // id から数値を抜く（TN-012 → 12 / 012 → 12 / No.TN-048 → 48 なども吸う）
    function idToNumber(id){
      const s = (id ?? "").toString();
      const m = s.match(/(\d+)/g);
      if(!m) return Number.POSITIVE_INFINITY;
      const last = m[m.length - 1];
      const n = parseInt(last, 10);
      return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY;
    }

    function isSRPlus(rarity){
      const r = normalizeText(rarity);
      if(!r) return false;
      if(r.includes("sr")) return true;
      if(r.includes("ur")) return true;
      if(r.includes("lr")) return true;
      if(r.includes("hr")) return true;
      if(r.includes("xr")) return true;
      return false;
    }

    // ★ 取得日時ズレ対策：
    // - 数値は「桁」でms/秒を判定（10桁=秒, 13桁=msが多い）
    // - ISO文字列はそのままDateに
    // - 表示は日本時間（Asia/Tokyo）固定でブレを減らす
    function toDate(at){
      if(at == null || at === "") return null;

      if(typeof at === "number"){
        const t = normalizeEpoch(at);
        return new Date(t);
      }

      const s = String(at).trim();

      // 数値文字列
      if(/^\d+$/.test(s)){
        const n = Number(s);
        if(!Number.isFinite(n)) return null;
        const t = normalizeEpoch(n);
        return new Date(t);
      }

      // それ以外（ISOなど）
      const d = new Date(s);
      if(isNaN(d.getTime())) return null;
      return d;
    }

    function normalizeEpoch(n){
      // nが「秒」なら *1000、msならそのまま
      // よくある桁: 10桁=秒, 13桁=ms
      // それ以外は閾値でも吸う
      const abs = Math.abs(n);
      if(abs < 1e11) return n * 1000; // 〜10桁程度は秒扱い
      return n; // ms扱い
    }

    function formatAt(at){
      const d = toDate(at);
      if(!d) return "-";

      // 日本時間固定で表示
      try{
        const fmt = new Intl.DateTimeFormat("ja-JP",{
          timeZone:"Asia/Tokyo",
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit",
          hour12:false
        });
        // "YYYY/MM/DD HH:MM" を "YYYY-MM-DD HH:MM" に寄せる
        const parts = fmt.formatToParts(d);
        const get = (t) => parts.find(p=>p.type===t)?.value ?? "";
        const yyyy = get("year");
        const mm = get("month");
        const dd = get("day");
        const hh = get("hour");
        const mi = get("minute");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }catch(e){
        // もしIntlが使えない環境なら従来フォールバック（端末TZ依存）
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }
    }

    function toTime(at){
      const d = toDate(at);
      return d ? d.getTime() : 0;
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        all = [];
        render();
        showEmpty(
          `図鑑データが見つからないよ。<br>
           localStorage の <code>${LS_KEY}</code> を畑側で保存してから開いてね。`
        );
        elPill.textContent = "0 / 0";
        return;
      }

      const obj = safeJSONParse(raw);

      // got は「配列」or「オブジェクト」どちらでも来る可能性があるので吸収
      let gotArr = [];
      if(obj && Array.isArray(obj.got)){
        gotArr = obj.got;
      } else if(obj && obj.got && typeof obj.got === "object"){
        gotArr = Object.values(obj.got);
      } else {
        gotArr = [];
      }

      all = gotArr.map(x => ({
        id: x?.id ?? "",
        name: x?.name ?? "",
        img: x?.img ?? "",
        rarity: x?.rarity ?? "",
        at: x?.at ?? ""
      }));

      render();
    }

    function applyFilterSort(){
      const q = normalizeText(elQ.value);
      const sort = elSort.value;

      // filter
      view = all.filter(item => {
        if(!q) return true;
        const hay = [ item.id, item.name, item.rarity ]
          .map(normalizeText).join(" ");
        return hay.includes(q);
      });

      // sort
      if(sort === "new"){
        view.sort((a,b) => toTime(b.at) - toTime(a.at));
      } else if(sort === "num"){
        view.sort((a,b) => {
          const na = idToNumber(a.id);
          const nb = idToNumber(b.id);
          if(na !== nb) return na - nb;
          return toTime(b.at) - toTime(a.at);
        });
      }

      elPill.textContent = `${view.length} / ${all.length}`;
    }

    function render(){
      hideEmpty();
      applyFilterSort();

      elGrid.innerHTML = "";
      if(view.length === 0){
        showEmpty("該当カードがないよ（検索条件を変えてみてね）。");
        return;
      }

      const frag = document.createDocumentFragment();

      for(const item of view){
        const card = document.createElement("div");
        card.className = "card" + (isSRPlus(item.rarity) ? " is-glow" : "");
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");

        const img = document.createElement("img");
        img.className = "thumb";
        img.alt = item.name || item.id || "card";
        img.loading = "lazy";
        img.decoding = "async";
        img.src = item.img || "";
        img.onerror = () => {
          img.removeAttribute("src");
          img.alt = "画像なし";
          img.style.display = "block";
          img.style.objectFit = "contain";
        };

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = item.name || "(no name)";

        const mini = document.createElement("div");
        mini.className = "mini";

        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerHTML = `<span class="id">#${escapeHTML(item.id || "-")}</span>`;

        const rar = document.createElement("div");
        rar.className = "tag";
        rar.innerHTML = `<b>${escapeHTML(item.rarity || "-")}</b>`;

        mini.appendChild(tag);
        mini.appendChild(rar);

        meta.appendChild(name);
        meta.appendChild(mini);

        card.appendChild(img);
        card.appendChild(meta);

        card.addEventListener("click", () => openModal(item));
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            openModal(item);
          }
        });

        frag.appendChild(card);
      }

      elGrid.appendChild(frag);
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showEmpty(html){
      elEmpty.style.display = "block";
      elEmpty.innerHTML = html;
    }
    function hideEmpty(){
      elEmpty.style.display = "none";
      elEmpty.innerHTML = "";
    }

    function openModal(item){
      mImg.src = item.img || "";
      mImg.alt = item.name || item.id || "card";
      mTitle.textContent = item.name || "(no name)";
      mId.textContent = item.id || "-";
      mRarity.textContent = item.rarity || "-";
      mAt.textContent = formatAt(item.at);
      mGlow.style.display = isSRPlus(item.rarity) ? "inline-flex" : "none";

      modal.setAttribute("aria-hidden","false");
      document.addEventListener("keydown", onEscClose, { once:false });
    }

    function closeModal(){
      modal.setAttribute("aria-hidden","true");
      mImg.removeAttribute("src");
      document.removeEventListener("keydown", onEscClose);
    }

    function onEscClose(e){
      if(e.key === "Escape") closeModal();
    }

    // 背景クリックで閉じる
    modal.addEventListener("click", (e) => {
      if(e.target === modal) closeModal();
    });
    mClose.addEventListener("click", closeModal);

    // controls
    elQ.addEventListener("input", () => render());
    elSort.addEventListener("change", () => render());
    btnReload.addEventListener("click", () => load());

    btnClear.addEventListener("click", () => {
      const ok = confirm("図鑑（tf_v1_book）を消去する？\n※畑側の図鑑も消えます");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      load();
    });

    // ★ 戻るボタン
    btnBack.addEventListener("click", () => {
      // 履歴があるなら戻る。なければフォールバックへ
      if(history.length > 1){
        history.back();
      }else{
        // 必要ならここをあなたのトップURLに変更してOK
        location.href = "./index.html";
      }
    });

    // init
    load();
  </script>
</body>
</html>

