
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…¥å£ï½œãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—</title>
  <style>
    :root{
      --bg:#05060b;
      --panel:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --btn:rgba(255,255,255,.12);
      --btn2:rgba(255,255,255,.18);
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      background: radial-gradient(1200px 800px at 50% 35%, rgba(120,140,255,.10), transparent 55%),
                  radial-gradient(900px 600px at 30% 70%, rgba(140,255,200,.07), transparent 60%),
                  var(--bg);
      overflow-x:hidden;
    }

    /* ===== æ˜Ÿï¼ˆCSSã ã‘ã§è»½é‡ï¼‰===== */
    .stars, .stars2{
      position:fixed; inset:0;
      pointer-events:none;
      background-repeat:repeat;
      opacity:.85;
      z-index:0;
    }
    .stars{
      background-image:
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(1px 1px at 80px 120px, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1px 1px at 150px 60px, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(1px 1px at 220px 180px, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1px 1px at 300px 90px, rgba(255,255,255,.65), transparent 60%);
      background-size: 320px 220px;
      animation: drift 38s linear infinite;
    }
    .stars2{
      background-image:
        radial-gradient(2px 2px at 40px 50px, rgba(255,255,255,.20), transparent 60%),
        radial-gradient(1px 1px at 120px 140px, rgba(255,255,255,.25), transparent 60%),
        radial-gradient(2px 2px at 260px 160px, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(1px 1px at 310px 30px, rgba(255,255,255,.22), transparent 60%);
      background-size: 360px 260px;
      animation: drift2 64s linear infinite;
      opacity:.65;
    }
    @keyframes drift{ from{transform:translateY(0)} to{transform:translateY(-220px)} }
    @keyframes drift2{ from{transform:translateY(0)} to{transform:translateY(-260px)} }

    /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .wrap{
      position:relative;
      z-index:1;
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:28px 14px 22px;
      gap:14px;
    }

    .stage{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .stage-top{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .title{
      font-weight:900;
      letter-spacing:.04em;
      font-size:15px;
    }
    .brand .sub{
      color:var(--muted);
      font-size:12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background:rgba(255,255,255,.06);
      font-size:12px;
      max-width:58%;
    }
    .pill .avatar{
      width:22px;height:22px;border-radius:8px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 22px;
      display:grid;place-items:center;
      overflow:hidden;
    }
    .pill img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
    .pill .name{
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      color:#fff;
    }

    .scene{
      position:relative;
      padding:18px 14px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      background:
        radial-gradient(260px 160px at 50% 30%, rgba(120,140,255,.18), transparent 70%),
        radial-gradient(240px 140px at 50% 70%, rgba(255,200,120,.10), transparent 75%),
        rgba(0,0,0,.18);
    }

    /* æ‰‰ï¼‹é–€ç•ªã®ä¸­å¤®æ¼”å‡º */
    .gateRow{
      width:100%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap:14px;
      padding:6px 0 0;
      min-height:180px;
    }
    .door{
      width:140px; height:160px;
      border-radius:18px 18px 22px 22px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(90px 120px at 50% 40%, rgba(120,180,255,.35), rgba(0,0,0,.0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      position:relative;
      box-shadow:0 0 22px rgba(140,180,255,.18);
      overflow:hidden;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .door::before{
      content:"";
      position:absolute; inset:-30px;
      background:conic-gradient(from 0deg, transparent 0 40%, rgba(180,220,255,.22) 45% 55%, transparent 60% 100%);
      animation: shimmer 4.2s linear infinite;
      opacity:.8;
    }
    @keyframes shimmer{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .doorCore{
      position:relative;
      width:92px;height:120px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(80px 90px at 50% 35%, rgba(255,255,255,.10), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.10));
      display:grid;place-items:center;
      box-shadow: inset 0 0 20px rgba(120,180,255,.18);
    }
    .doorCore .sigil{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(120,180,255,.18);
      display:grid;place-items:center;
      font-weight:900;
      letter-spacing:.08em;
      font-family:var(--mono);
      opacity:.9;
    }

    .guard{
      width:120px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .guard .img{
      width:74px;height:74px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      display:grid;place-items:center;
      overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      user-select:none;
    }
    .guard .img img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
    .guard .badge{
      font-size:11px;
      color:rgba(255,255,255,.85);
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 8px;
      border-radius:999px;
      max-width:120px;
      text-align:center;
    }

    .dialog{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      background:rgba(0,0,0,.28);
      padding:10px 12px;
      color:rgba(255,255,255,.92);
      font-size:13px;
      line-height:1.5;
    }
    .dialog .small{color:var(--muted); font-size:12px; display:block; margin-top:2px;}

    .actions{
      width:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:10px 0 6px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(120,180,255,.28), rgba(255,255,255,.10));
      border-color:rgba(140,200,255,.35);
    }
    .btn.ghost{
      background:rgba(255,255,255,.06);
    }

    .footer{
      padding:10px 16px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,.18);
    }
    .footer .hint{
      display:flex; flex-direction:column; gap:2px;
      overflow:hidden;
    }
    .footer .hint b{
      color:rgba(255,255,255,.92);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .footer .hint span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .footer .mini{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:6px 8px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.85);
    }

    /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.62);
      z-index:50;
    }
    .modal.on{display:flex}
    .modal .card{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(20,22,40,.96), rgba(10,12,20,.92));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
    }
    .modal .head .ttl{font-weight:900}
    .modal .close{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modal .body{padding:14px}

    .field{
      display:flex; flex-direction:column; gap:6px;
      margin:0 0 12px;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
      font-weight:700;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }

    /* ===== ã‚¢ãƒã‚¿ãƒ¼é¸æŠ ===== */
    .avatarGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .avOpt{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
    }
    .avOpt.on{
      border-color:rgba(120,180,255,.45);
      box-shadow:0 0 0 2px rgba(120,180,255,.18) inset;
    }
    .avOpt .img{
      width:52px;height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      overflow:hidden;
      display:grid;place-items:center;
    }
    .avOpt img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
    .avOpt .nm{font-size:11px;color:rgba(255,255,255,.88); text-align:center; line-height:1.2}

    /* ===== ä½æ°‘ç¥¨ï¼ˆãƒˆãƒ¬ã‚«é¢¨ï¼‰===== */
    .residentCard{
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      overflow:hidden;
      background:
        radial-gradient(220px 180px at 30% 25%, rgba(255,220,130,.12), transparent 60%),
        radial-gradient(260px 200px at 80% 70%, rgba(120,180,255,.14), transparent 65%),
        rgba(255,255,255,.04);
      box-shadow:0 16px 40px rgba(0,0,0,.45);
    }
    .rcTop{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .rar{
      font-family:var(--mono);
      font-weight:900;
      letter-spacing:.08em;
      font-size:12px;
      padding:6px 8px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background:rgba(255,255,255,.06);
    }
    .rcMid{
      padding:12px 14px;
      display:grid;
      grid-template-columns: 96px 1fr;
      gap:12px;
      align-items:start;
    }
    .rcAv{
      width:96px;height:96px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      overflow:hidden;
      display:grid;place-items:center;
    }
    .rcAv img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
    .rcInfo .big{
      font-weight:900;
      font-size:16px;
      letter-spacing:.02em;
      margin:0 0 2px;
      word-break:break-word;
    }
    .rcInfo .sub{
      color:var(--muted);
      font-size:12px;
      margin:0 0 10px;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .stat{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:8px 10px;
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:rgba(255,255,255,.9);
    }
    .stat b{display:block; font-size:11px; color:var(--muted); margin-bottom:2px; font-weight:700}
    .rcBot{
      padding:10px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .quote{
      font-size:12px;
      color:rgba(255,255,255,.88);
      line-height:1.4;
    }
    .quote .mut{color:var(--muted)}
    .rcBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .sbtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .sbtn:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="stars2"></div>

  <main class="wrap">
    <section class="stage" aria-label="å…¥å£">
      <div class="stage-top">
        <div class="brand">
          <div class="title">ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—ãƒ»å…¥å£</div>
          <div class="sub">â€” ç•°ç©ºé–“ã‚²ãƒ¼ãƒˆ â€”</div>
        </div>

        <div class="pill" title="ä½æ°‘æƒ…å ±">
          <div class="avatar" id="pillAvatar">ğŸ™‚</div>
          <div class="name" id="pillName">åç„¡ã—ã®ã‚¿ã‚³æ°‘</div>
        </div>
      </div>

      <div class="scene">
        <div class="gateRow">
          <div class="door" aria-label="æ‰‰ï¼ˆã‚²ãƒ¼ãƒˆï¼‰">
            <div class="doorCore">
              <div class="sigil">TRC</div>
            </div>
          </div>

          <div class="guard" aria-label="é–€ç•ª">
            <div class="img" id="guardImg">ğŸ›¡ï¸</div>
            <div class="badge" id="guardBadge">é–€ç•ªã‚¿ã‚³æ°‘</div>
          </div>
        </div>

        <div class="dialog" id="gateDialog">
          â€¦â€¦ã“ã“ã¯ ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—ã€‚<br>
          <span class="small">åã‚’åä¹—ã‚Œã€‚ä½æ°‘ç¥¨ã‚’ç™ºè¡Œã—ã¦ã‚„ã‚ã†ã€‚</span>
        </div>

        <div class="actions">
          <button class="btn primary" id="enterBtn" type="button">è¡—ã¸å…¥ã‚‹</button>
          <button class="btn ghost" id="residentBtn" type="button">ä½æ°‘ç¥¨ã‚’è¦‹ã‚‹</button>
        </div>
      </div>

      <div class="footer">
        <div class="hint">
          <b id="hintTitle">é–€ç•ªãƒ¡ãƒ¢</b>
          <span id="hintText">åˆå›ã¯ä½æ°‘ç™»éŒ²ãŒå¿…è¦ã ã€‚</span>
        </div>
        <div class="mini">
          <span class="chip" id="chipLv">Lv --</span>
          <span class="chip" id="chipTitle">ç§°å·ï¼š---</span>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div class="modal" id="regModal" aria-hidden="true">
    <div class="card">
      <div class="head">
        <div class="ttl">ä½æ°‘ç™»éŒ²</div>
        <button class="close" id="regClose" type="button">Ã—</button>
      </div>
      <div class="body">
        <div class="field">
          <label for="nickInput">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆã‚ã¨ã§å¤‰æ›´OKï¼‰</label>
          <input id="nickInput" type="text" maxlength="16" placeholder="ä¾‹ï¼šãŸã“ã´å¤ªéƒ / ç„¼ãå¸«ã®mika ãªã©" />
        </div>

        <div class="field">
          <label>ã‚¢ãƒã‚¿ãƒ¼ï¼ˆã‚¿ã‚³æ°‘ã‚¢ã‚¤ã‚³ãƒ³ï¼‰</label>
          <div class="avatarGrid" id="avatarGrid"></div>
        </div>

        <div class="row">
          <button class="btn primary" id="regSave" type="button" style="flex:1">ç™»éŒ²ã™ã‚‹</button>
          <button class="btn" id="regCancel" type="button" style="flex:1">ã‚ã¨ã§</button>
        </div>

        <div style="margin-top:10px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.5">
          â€» ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã® <b>localStorage</b> ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã‚µãƒ¼ãƒé€ä¿¡ãªã—ï¼‰ã€‚<br>
          â€» ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã§æ¶ˆãˆã‚‹ã®ã§ã€ã®ã¡ã»ã©ã€Œé”æˆã®è¨˜éŒ²ã€ãªã©ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å°ç·šã‚’è¶³ã—ã¦ã‚‚OKã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ä½æ°‘ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div class="modal" id="rcModal" aria-hidden="true">
    <div class="card">
      <div class="head">
        <div class="ttl">ä½æ°‘ç¥¨</div>
        <button class="close" id="rcClose" type="button">Ã—</button>
      </div>
      <div class="body">
        <div class="residentCard">
          <div class="rcTop">
            <div class="rar" id="rcRarity">CITIZEN</div>
            <div class="rar" id="rcLv">Lv 1</div>
          </div>

          <div class="rcMid">
            <div class="rcAv" id="rcAvatar">ğŸ™‚</div>
            <div class="rcInfo">
              <div class="big" id="rcName">åç„¡ã—ã®ã‚¿ã‚³æ°‘</div>
              <div class="sub" id="rcTitle">ç§°å·ï¼šã¯ã˜ã¾ã‚Šã®ç„¼ãæ‰‹</div>

              <div class="stats">
                <div class="stat"><b>ç·EXP</b><span id="stExp">0</span></div>
                <div class="stat"><b>ç·ãƒ­ã‚°ã‚¤ãƒ³</b><span id="stDays">0</span>æ—¥</div>
                <div class="stat"><b>ç•‘ï¼ˆåç©«æ•°ï¼‰</b><span id="stHarvest">0</span></div>
                <div class="stat"><b>éœ²åº—ï¼ˆå£²ä¸Šï¼‰</b><span id="stSales">0</span> ã‚ªã‚¯ãƒˆ</div>
                <div class="stat"><b>éœ²åº—ï¼ˆè²©å£²å›æ•°ï¼‰</b><span id="stSellCount">0</span></div>
                <div class="stat"><b>æœ€é«˜ã‚¹ã‚³ã‚¢</b><span id="stBest">0</span></div>
              </div>
            </div>
          </div>

          <div class="rcBot">
            <div class="quote">
              <div id="rcQuote">ã€Œä»Šæ—¥ã‚‚ç„¼ã‹ã‚Œã«æ¥ãŸã®ã‹ã€‚ã€</div>
              <div class="mut" id="rcQuoteSub">é–€ç•ªã‚ˆã‚Š</div>
            </div>
            <div class="rcBtns">
              <button class="sbtn" id="editBtn" type="button">åå‰/ã‚¢ãƒã‚¿ãƒ¼å¤‰æ›´</button>
              <button class="sbtn" id="exportBtn" type="button">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.5">
          â€» ä½æ°‘ç¥¨ã¯ã€Œç”ºã®å¤–ã€ã«ç½®ãã“ã¨ã§ã€ç”ºãƒãƒƒãƒ—ã®å¯†åº¦ã‚’ä¸Šã’ãšã«æ‹¡å¼µã§ãã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    /* =========================================================
       gate.html / å…¥å£ + ä½æ°‘ç¥¨ å®Œå…¨ç‰ˆ
       - localStorageã®ã¿
       - åˆå›ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²ï¼ˆå¤‰æ›´OKï¼‰
       - ã‚¿ã‚³æ°‘ã‚¢ãƒã‚¿ãƒ¼é¸æŠï¼ˆå¤‰æ›´OKï¼‰
       - ä½æ°‘ç¥¨ï¼ˆãƒˆãƒ¬ã‚«é¢¨ï¼‰è¡¨ç¤º
       - æ—¢å­˜ã‚­ãƒ¼(tf_v1_book / roten_v1_octoç­‰)ãŒã‚ã‚Œã°è»½ãæ‹¾ã†
       - ä»–ãƒšãƒ¼ã‚¸ã‹ã‚‰å‘¼ã¹ã‚‹API(window.TRCResident.*)
       ========================================================= */

    // â˜… ã‚ãªãŸã®ã€Œç”ºãƒšãƒ¼ã‚¸ã€URLã«åˆã‚ã›ã¦ã“ã“ã ã‘å¤‰æ›´ã—ã¦OK
    const TOWN_URL = "town/index.html"; // ä¾‹: "town/index.html" or "/takoyaki-media/town/index.html"

    // ===== localStorage keysï¼ˆæ–°è¦ï¼šä½æ°‘ç¥¨ï¼‰=====
    const KEY = {
      resident: "trc_v1_resident", // ä½æ°‘ç¥¨ï¼ˆåå‰/ã‚¢ãƒã‚¿ãƒ¼/exp/çµ±è¨ˆï¼‰
      lastLogin: "trc_v1_last_login", // å…¥å£ã‚’é–‹ã„ãŸæ—¥
    };

    // ===== æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼ï¼ˆã‚ã‚Œã°æ‹¾ã†ï¼‰=====
    const EXIST = {
      farmBook: "tf_v1_book",
      rotenOcto: "roten_v1_octo",
      rotenLog:  "roten_v1_log"
    };

    // ===== ã‚¢ãƒã‚¿ãƒ¼å€™è£œï¼ˆå·®ã—æ›¿ãˆè‡ªç”±ï¼‰=====
    // ç”»åƒURLã‚’ã‚ãªãŸã®ã‚¿ã‚³æ°‘PNGã«å¤‰ãˆã‚‹ã¨æœ€é«˜ã«ãªã‚‹ï¼ˆä»Šã¯ãƒ€ãƒŸãƒ¼çµµæ–‡å­—/è‰²ï¼‰
    const AVATARS = [
      { id:"av_guard", name:"é–€ç•ª", emoji:"ğŸ›¡ï¸", img:"" },
      { id:"av_farmer", name:"è¾²å®¶", emoji:"ğŸŒ±", img:"" },
      { id:"av_shop", name:"éœ²åº—", emoji:"ğŸ®", img:"" },
      { id:"av_hero", name:"å‹‡è€…", emoji:"âš”ï¸", img:"" },
      { id:"av_sage", name:"è³¢è€…", emoji:"ğŸ“œ", img:"" },
      { id:"av_ninja", name:"å¿è€…", emoji:"ğŸ¥·", img:"" },
      { id:"av_ghost", name:"GHOST", emoji:"ğŸ‘»", img:"" },
      { id:"av_takopi", name:"ãŸã“ã´", emoji:"ğŸ™", img:"" },
    ];

    // ====== DOM ======
    const $ = (sel, root=document) => root.querySelector(sel);

    const pillName = $("#pillName");
    const pillAvatar = $("#pillAvatar");

    const enterBtn = $("#enterBtn");
    const residentBtn = $("#residentBtn");
    const gateDialog = $("#gateDialog");
    const hintTitle = $("#hintTitle");
    const hintText  = $("#hintText");
    const chipLv = $("#chipLv");
    const chipTitle = $("#chipTitle");

    const regModal = $("#regModal");
    const regClose = $("#regClose");
    const regSave  = $("#regSave");
    const regCancel= $("#regCancel");
    const nickInput= $("#nickInput");
    const avatarGrid = $("#avatarGrid");

    const rcModal = $("#rcModal");
    const rcClose = $("#rcClose");
    const editBtn = $("#editBtn");
    const exportBtn = $("#exportBtn");

    const rcName = $("#rcName");
    const rcAvatar = $("#rcAvatar");
    const rcTitle = $("#rcTitle");
    const rcLv = $("#rcLv");
    const rcRarity = $("#rcRarity");
    const rcQuote = $("#rcQuote");
    const rcQuoteSub = $("#rcQuoteSub");

    const stExp = $("#stExp");
    const stDays = $("#stDays");
    const stHarvest = $("#stHarvest");
    const stSales = $("#stSales");
    const stSellCount = $("#stSellCount");
    const stBest = $("#stBest");

    const guardImg = $("#guardImg");
    const guardBadge = $("#guardBadge");

    // ====== util ======
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };

    function safeJSONParse(raw, fallback){
      try{ return JSON.parse(raw); }catch(_){ return fallback; }
    }

    function loadResident(){
      const raw = localStorage.getItem(KEY.resident);
      const base = {
        ver:1,
        nick:"",
        avatarId:"av_guard",
        exp:0,
        days:0,
        best:0,
        farmHarvest:0,
        rotenSales:0,
        rotenSellCount:0,
        lastSeenDay:"",
        createdAt: Date.now()
      };
      if(!raw) return base;
      const r = safeJSONParse(raw, base);
      return Object.assign(base, r);
    }

    function saveResident(r){
      localStorage.setItem(KEY.resident, JSON.stringify(r));
    }

    function getAvatarById(id){
      return AVATARS.find(a=>a.id===id) || AVATARS[0];
    }

    // ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼šexpã«åŸºã¥ãï¼ˆç°¡å˜ã§æ°—æŒã¡ã„ã„æ›²ç·šï¼‰
    function calcLevel(exp){
      exp = Math.max(0, Math.floor(Number(exp)||0));
      // Lv1=0ã€Lv2=40ã€Lv3=100ã€Lv4=180...ï¼ˆã ã‚“ã ã‚“é‡ãï¼‰
      let lv = 1;
      let need = 40;
      let cur = exp;
      while(cur >= need){
        cur -= need;
        lv++;
        need = Math.floor(need * 1.35 + 10);
        if(lv >= 99) break;
      }
      return { lv, nextNeed: need, curToNext: cur };
    }

    // ç§°å·ï¼šãƒ¬ãƒ™ãƒ«å¸¯ï¼‹è¡Œå‹•ã§æ±ºã‚ã‚‹ï¼ˆä¸–ç•Œè¦³ã‚®ãƒ£ã‚°ç³»ï¼‰
    function calcTitle(r, lv){
      const h = r.farmHarvest||0;
      const s = r.rotenSellCount||0;

      if(lv>=30) return "ç§°å·ï¼šç„¼ã‹ã‚Œã—ä¼èª¬ã®ä½æ°‘";
      if(lv>=20) return "ç§°å·ï¼šè¶…ãƒ»ç„¼ãæ‰‹ï¼ˆã»ã¼ç¥ï¼‰";
      if(lv>=15) return "ç§°å·ï¼šç„¦ã’ã¨åŠç†Ÿã®ä¸¡åˆ€ä½¿ã„";
      if(lv>=10) return "ç§°å·ï¼šåŠç†Ÿãƒã‚¹ã‚¿ãƒ¼";
      if(h>=50)  return "ç§°å·ï¼šç•‘ã®æ²¼ã«æ²ˆã‚“ã ç„¼ãæ‰‹";
      if(s>=20)  return "ç§°å·ï¼šéœ²åº—ã®é¡”ï¼ˆå€¤æœ­ã®åŒ–èº«ï¼‰";
      if(lv>=5)  return "ç§°å·ï¼šè¦‹ç¿’ã„ç„¼ãå¸«";
      return "ç§°å·ï¼šã¯ã˜ã¾ã‚Šã®ç„¼ãæ‰‹";
    }

    // ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¡¨ç¤ºï¼ˆæ°—æŒã¡ã‚ˆã•å„ªå…ˆï¼‰
    function calcRarity(lv){
      if(lv>=30) return "LR CITIZEN";
      if(lv>=20) return "UR CITIZEN";
      if(lv>=12) return "SR CITIZEN";
      if(lv>=6)  return "R  CITIZEN";
      return "N  CITIZEN";
    }

    function pickQuote(r, lv){
      const list = [
        "ã€Œæ‰‰ã¯é–‹ã„ã¦ã„ã‚‹ã€‚å•é¡Œã¯ã€ãŠå‰ã®è…¹ã ã€‚ã€",
        "ã€Œä»Šæ—¥ã‚‚ç„¼ã‹ã‚Œã«æ¥ãŸã®ã‹ã€‚â€¦ã„ã„é¡”ã ã€‚ã€",
        "ã€Œä½æ°‘ç¥¨ã¯å˜˜ã‚’ã¤ã‹ãªã„ã€‚å˜˜ã‚’ã¤ãã®ã¯äººé–“ã ã€‚ã€",
        "ã€Œç„¦ã’ã¦ã‚‚ä¾¡å€¤ã¯æ®‹ã‚‹ã€‚â€¦ãŸã¶ã‚“ã€‚ã€",
        "ã€ŒåŠç†Ÿã¯æœªå®Œæˆã˜ã‚ƒãªã„ã€‚â€œä½™ç™½â€ã ã€‚ã€"
      ];
      // æ—¥ä»˜ã§å›ºå®šï¼ˆæ¯æ—¥ã¡ã‚‡ã£ã¨é•ã†æ„Ÿã˜ï¼‰
      const key = todayKey();
      let hash = 0;
      for(let i=0;i<key.length;i++) hash = (hash*31 + key.charCodeAt(i)) >>> 0;
      const idx = hash % list.length;
      return list[idx];
    }

    // ===== æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œãã‚Œã£ã½ã„ã€çµ±è¨ˆã‚’æ‹¾ã†ï¼ˆç„¡ã‘ã‚Œã°0ï¼‰=====
    function syncFromExisting(r){
      // 1) ç•‘ï¼štf_v1_book ã® got ã‚’æ•°ãˆã‚‹
      const bookRaw = localStorage.getItem(EXIST.farmBook);
      if(bookRaw){
        const book = safeJSONParse(bookRaw, null);
        const got = book && book.got ? book.got : null;
        if(got && typeof got === "object"){
          let total = 0;
          for(const k in got){
            const v = got[k];
            // count ã‚’æŒã£ã¦ã„ã‚Œã°ä½¿ã†ã€ç„¡ã‘ã‚Œã°1æ‰±ã„
            const c = (v && typeof v.count === "number") ? v.count : 1;
            total += Math.max(0, c|0);
          }
          // æ—¢ã«ä½æ°‘ç¥¨å´ãŒå¤šã‘ã‚Œã°æ¸›ã‚‰ã•ãªã„ï¼ˆä¸Šæ›¸ãäº‹æ•…å›é¿ï¼‰
          r.farmHarvest = Math.max(r.farmHarvest||0, total);
        }
      }

      // 2) éœ²åº—ï¼šã‚ªã‚¯ãƒˆæ®‹é«˜ã¯ã‚ã‚‹ãŒã€Œå£²ä¸Šã€ã¯åˆ¥ãªã®ã§ã€ãƒ­ã‚°ãŒã‚ã‚Œã°æ‹¾ã†
      const logRaw = localStorage.getItem(EXIST.rotenLog);
      if(logRaw){
        const log = safeJSONParse(logRaw, null);
        // æƒ³å®šï¼šé…åˆ—ãƒ­ã‚° or {items:[...]} ç­‰ã€å½¢ãŒé•ã£ã¦ã‚‚è½ã¡ãªã„
        const arr = Array.isArray(log) ? log : (log && Array.isArray(log.items) ? log.items : null);
        if(arr){
          // ã–ã£ãã‚Šï¼šæ–‡å­—åˆ—ã«ã€Œå£²ã‚ŒãŸã€ã€Œè²©å£²ã€ã€Œè³¼å…¥ã€ã£ã½ã„ã®ãŒã‚ã‚Œã°å›æ•°+1
          let sellCount = r.rotenSellCount||0;
          for(const it of arr){
            const t = String(it && (it.text||it.msg||it) || "");
            if(/å£²ã‚Œ|è²©å£²|è³¼å…¥/.test(t)) sellCount++;
          }
          r.rotenSellCount = Math.max(r.rotenSellCount||0, sellCount);
        }
      }

      return r;
    }

    // ===== ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°ç®¡ç†ï¼ˆå…¥å£ã‚’é–‹ã„ãŸã‚‰1æ—¥1å›ã‚«ã‚¦ãƒ³ãƒˆï¼‰=====
    function touchLoginDay(r){
      const t = todayKey();
      const last = localStorage.getItem(KEY.lastLogin) || "";
      if(last !== t){
        localStorage.setItem(KEY.lastLogin, t);
        r.days = (r.days||0) + 1;
        // å…¥å£ã«æ¥ãŸEXPï¼ˆå°‘é‡ã ã‘ï¼‰ï¼ç¿’æ…£åŒ–ã®ç«ç¨®
        r.exp = (r.exp||0) + 5;
      }
      r.lastSeenDay = t;
      return r;
    }

    // ===== UIæ›´æ–° =====
    function setAvatarNode(node, av){
      // nodeãŒdivã®å ´åˆï¼šimgã‹çµµæ–‡å­—
      node.innerHTML = "";
      if(av.img){
        const img = document.createElement("img");
        img.src = av.img;
        img.alt = av.name;
        img.loading = "lazy";
        node.appendChild(img);
      }else{
        node.textContent = av.emoji || "ğŸ™‚";
      }
    }

    function renderTop(r){
      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "åç„¡ã—ã®ã‚¿ã‚³æ°‘";
      const av = getAvatarById(r.avatarId);
      pillName.textContent = nick;
      setAvatarNode(pillAvatar, av);

      // é–€ç•ªã‚‚åŒã˜ã‚¢ãƒã‚¿ãƒ¼ã§çµ±ä¸€ï¼ˆä¸–ç•Œè¦³ï¼‰
      setAvatarNode(guardImg, getAvatarById("av_guard"));
      guardBadge.textContent = "é–€ç•ªã‚¿ã‚³æ°‘";

      const {lv} = calcLevel(r.exp||0);
      chipLv.textContent = `Lv ${lv}`;
      chipTitle.textContent = calcTitle(r, lv).replace("ç§°å·ï¼š","");
    }

    function renderGateText(r){
      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "";
      if(!nick){
        gateDialog.innerHTML = `â€¦â€¦ã“ã“ã¯ ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—ã€‚<br><span class="small">åã‚’åä¹—ã‚Œã€‚ä½æ°‘ç¥¨ã‚’ç™ºè¡Œã—ã¦ã‚„ã‚ã†ã€‚</span>`;
        hintTitle.textContent = "é–€ç•ªãƒ¡ãƒ¢";
        hintText.textContent  = "åˆå›ã¯ä½æ°‘ç™»éŒ²ãŒå¿…è¦ã ã€‚";
      }else{
        const {lv} = calcLevel(r.exp||0);
        const title = calcTitle(r, lv).replace("ç§°å·ï¼š","");
        gateDialog.innerHTML = `â€¦â€¦<b>${nick}</b>ã‹ã€‚<br><span class="small">ç§°å·ã€Œ${title}ã€â”€â”€ å…¥å ´ã‚’è¨±å¯ã™ã‚‹ã€‚</span>`;
        hintTitle.textContent = "é–€ç•ªãƒ¡ãƒ¢";
        hintText.textContent  = "ä½æ°‘ç¥¨ã¯ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã‚‹ã€‚";
      }
    }

    function openModal(m){ m.classList.add("on"); m.setAttribute("aria-hidden","false"); }
    function closeModal(m){ m.classList.remove("on"); m.setAttribute("aria-hidden","true"); }

    function buildAvatarGrid(selectedId){
      avatarGrid.innerHTML = "";
      AVATARS.forEach(av=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "avOpt" + (av.id===selectedId ? " on" : "");
        b.dataset.id = av.id;

        const img = document.createElement("div");
        img.className = "img";
        if(av.img){
          const im = document.createElement("img");
          im.src = av.img;
          im.alt = av.name;
          im.loading = "lazy";
          img.appendChild(im);
        }else{
          img.textContent = av.emoji || "ğŸ™‚";
        }

        const nm = document.createElement("div");
        nm.className = "nm";
        nm.textContent = av.name;

        b.appendChild(img);
        b.appendChild(nm);

        b.addEventListener("click", ()=>{
          // å˜ç´”ã«é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
          [...avatarGrid.querySelectorAll(".avOpt")].forEach(x=>x.classList.remove("on"));
          b.classList.add("on");
        });

        avatarGrid.appendChild(b);
      });
    }

    function getSelectedAvatarId(){
      const on = avatarGrid.querySelector(".avOpt.on");
      return on ? on.dataset.id : AVATARS[0].id;
    }

    function openRegister(r, mode="register"){
      $(".ttl", regModal).textContent = (mode==="edit") ? "ä½æ°‘æƒ…å ±ã®å¤‰æ›´" : "ä½æ°‘ç™»éŒ²";
      nickInput.value = r.nick || "";
      buildAvatarGrid(r.avatarId || AVATARS[0].id);
      openModal(regModal);
      nickInput.focus();
    }

    function openResidentCard(r){
      // æœ€æ–°åŒæœŸï¼ˆã‚ã‚Œã°ï¼‰
      r = syncFromExisting(r);
      const lvInfo = calcLevel(r.exp||0);
      const lv = lvInfo.lv;

      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "åç„¡ã—ã®ã‚¿ã‚³æ°‘";
      const av = getAvatarById(r.avatarId);

      rcName.textContent = nick;
      rcTitle.textContent = calcTitle(r, lv);
      rcLv.textContent = `Lv ${lv}`;
      rcRarity.textContent = calcRarity(lv);

      setAvatarNode(rcAvatar, av);

      stExp.textContent = String(Math.floor(r.exp||0));
      stDays.textContent = String(Math.floor(r.days||0));
      stHarvest.textContent = String(Math.floor(r.farmHarvest||0));
      stSales.textContent = String(Math.floor(r.rotenSales||0));
      stSellCount.textContent = String(Math.floor(r.rotenSellCount||0));
      stBest.textContent = String(Math.floor(r.best||0));

      rcQuote.textContent = pickQuote(r, lv);
      rcQuoteSub.textContent = "é–€ç•ªã‚ˆã‚Š";

      saveResident(r);
      renderTop(r);
      renderGateText(r);

      openModal(rcModal);
    }

    // ===== ä»–ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®åŠ ç®—APIï¼ˆå¿…è¦ã«ãªã£ãŸã‚‰ä½¿ã†ï¼‰=====
    // ä¾‹ï¼šç•‘ã§åç©«ã—ãŸã‚‰ window.TRCResident.addHarvest(1); window.TRCResident.addExp(10);
    function apiGet(){
      return loadResident();
    }
    function apiSave(patch){
      const r = loadResident();
      Object.assign(r, patch || {});
      saveResident(r);
      return r;
    }
    function apiAddExp(n){
      const r = loadResident();
      r.exp = (r.exp||0) + (Number(n)||0);
      saveResident(r);
      return r;
    }
    function apiAddHarvest(n){
      const r = loadResident();
      r.farmHarvest = (r.farmHarvest||0) + (Number(n)||0);
      // åç©«EXPï¼ˆè»½ãï¼‰
      r.exp = (r.exp||0) + Math.max(0, (Number(n)||0))*2;
      saveResident(r);
      return r;
    }
    function apiAddSale(octo, count=1){
      const r = loadResident();
      r.rotenSales = (r.rotenSales||0) + (Number(octo)||0);
      r.rotenSellCount = (r.rotenSellCount||0) + (Number(count)||0);
      r.exp = (r.exp||0) + Math.max(0, (Number(count)||0))*3;
      saveResident(r);
      return r;
    }
    function apiSetBestScore(score){
      const r = loadResident();
      const s = Math.floor(Number(score)||0);
      r.best = Math.max(r.best||0, s);
      r.exp = (r.exp||0) + Math.min(30, Math.floor(s/50)); // ã¡ã‚‡ã„ãƒœãƒ¼ãƒŠã‚¹
      saveResident(r);
      return r;
    }

    window.TRCResident = {
      get: apiGet,
      save: apiSave,
      addExp: apiAddExp,
      addHarvest: apiAddHarvest,
      addSale: apiAddSale,
      setBestScore: apiSetBestScore,
    };

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    enterBtn.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = r.nick && r.nick.trim();
      if(!nick){
        openRegister(r, "register");
        return;
      }
      // å…¥å ´ï¼šè»½ã„æ¼”å‡ºâ†’é·ç§»
      enterBtn.disabled = true;
      enterBtn.textContent = "æ‰‰ãŒé–‹ã„ã¦ã„ã‚‹â€¦";
      setTimeout(()=>{ location.href = TOWN_URL; }, 350);
    });

    residentBtn.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = r.nick && r.nick.trim();
      if(!nick){
        openRegister(r, "register");
        return;
      }
      openResidentCard(r);
    });

    regClose.addEventListener("click", ()=> closeModal(regModal));
    regCancel.addEventListener("click", ()=> closeModal(regModal));

    regSave.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = (nickInput.value||"").trim();
      if(!nick){
        nickInput.focus();
        nickInput.placeholder = "åå‰ãŒå¿…è¦ã ï¼ˆ16æ–‡å­—ã¾ã§ï¼‰";
        return;
      }
      const avatarId = getSelectedAvatarId();
      r.nick = nick.slice(0,16);
      r.avatarId = avatarId;
      saveResident(r);
      closeModal(regModal);

      renderTop(r);
      renderGateText(r);

      // ç™»éŒ²å¾Œã¯ä½æ°‘ç¥¨ã‚’è¦‹ã›ã‚‹ã¨æ°—æŒã¡ã„ã„
      setTimeout(()=> openResidentCard(loadResident()), 120);
    });

    rcClose.addEventListener("click", ()=> closeModal(rcModal));
    editBtn.addEventListener("click", ()=>{
      closeModal(rcModal);
      const r = loadResident();
      openRegister(r, "edit");
    });

    exportBtn.addEventListener("click", async ()=>{
      const r = loadResident();
      const text = JSON.stringify(r, null, 2);
      try{
        await navigator.clipboard.writeText(text);
        exportBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ãŸï¼";
        setTimeout(()=> exportBtn.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼", 1200);
      }catch(e){
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä¸å¯ç«¯æœ«ç”¨ï¼šprompt fallback
        prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ã­ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰", text);
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    [regModal, rcModal].forEach(m=>{
      m.addEventListener("click", (e)=>{
        if(e.target === m) closeModal(m);
      });
    });

    // ===== åˆæœŸåŒ– =====
    function init(){
      let r = loadResident();
      r = syncFromExisting(r);
      r = touchLoginDay(r);
      saveResident(r);

      renderTop(r);
      renderGateText(r);

      // åˆå›ãªã‚‰ç™»éŒ²ã‚’ä¿ƒã™ï¼ˆæŠ¼ã—ä»˜ã‘ãšã€ã‚„ã•ã—ãï¼‰
      if(!(r.nick && r.nick.trim())){
        setTimeout(()=> openRegister(r, "register"), 180);
      }
    }
    init();

  })();
  </script>
</body>
</html>
