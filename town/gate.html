<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å…¥å£ï½œãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—</title>

  <style>
    :root{
      --bg:#05060b;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.12);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --good:#9fffa8;
      --warn:#ffd38a;
      --bad:#ff9aa5;
      --shadow:0 18px 60px rgba(0,0,0,.62);
      --shadow2:0 10px 28px rgba(0,0,0,.38);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);

      /* ãƒ¯ã‚¯ãƒ¯ã‚¯ã®ä¸»å½¹è‰² */
      --a: rgba(120,180,255,.95);
      --a2: rgba(255,210,130,.90);
      --a3: rgba(160,255,210,.88);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      overflow-x:hidden;
      padding-left:var(--safeL);
      padding-right:var(--safeR);

      background:
        radial-gradient(1200px 800px at 50% 20%, rgba(120,180,255,.14), transparent 60%),
        radial-gradient(900px 700px at 20% 70%, rgba(255,210,130,.10), transparent 62%),
        radial-gradient(900px 700px at 85% 75%, rgba(160,255,210,.08), transparent 65%),
        linear-gradient(180deg, rgba(5,6,11,1), rgba(5,6,11,1));
    }

    /* ã‚¿ãƒƒãƒ—å®‰å®š */
    button, .btn, .sbtn, .avOpt{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

    /* ====== èƒŒæ™¯æ¼”å‡ºï¼šæ˜Ÿï¼‹æµã‚Œï¼‹ã‚°ãƒªãƒƒãƒ‰ ====== */
    .bg-stars, .bg-stars2, .bg-grid, .bg-comet{
      position:fixed; inset:0; pointer-events:none; z-index:0;
    }
    .bg-grid{
      opacity:.16;
      background:
        linear-gradient(rgba(255,255,255,.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size: 64px 64px;
      mask-image: radial-gradient(closest-side at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,0));
      -webkit-mask-image: radial-gradient(closest-side at 50% 40%, rgba(0,0,0,1), rgba(0,0,0,0));
    }
    .bg-stars{
      opacity:.9;
      background-repeat:repeat;
      background-image:
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(1px 1px at 80px 120px, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1px 1px at 150px 60px, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(1px 1px at 220px 180px, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1px 1px at 300px 90px, rgba(255,255,255,.65), transparent 60%);
      background-size: 320px 220px;
      animation: drift 42s linear infinite;
    }
    .bg-stars2{
      opacity:.55;
      background-repeat:repeat;
      background-image:
        radial-gradient(2px 2px at 40px 50px, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(1px 1px at 120px 140px, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(2px 2px at 260px 160px, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(1px 1px at 310px 30px, rgba(255,255,255,.20), transparent 60%);
      background-size: 360px 260px;
      animation: drift2 70s linear infinite;
    }
    .bg-comet{
      opacity:.55;
      background:
        radial-gradient(220px 120px at 20% 30%, rgba(120,180,255,.22), transparent 70%),
        radial-gradient(240px 130px at 75% 22%, rgba(255,210,130,.18), transparent 72%),
        radial-gradient(260px 150px at 70% 80%, rgba(160,255,210,.14), transparent 74%);
      filter: blur(0px);
      animation: floaty 10s ease-in-out infinite;
    }
    @keyframes drift{ from{transform:translateY(0)} to{transform:translateY(-220px)} }
    @keyframes drift2{ from{transform:translateY(0)} to{transform:translateY(-260px)} }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

    /* ====== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ====== */
    .wrap{
      position:relative;
      z-index:1;
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: calc(18px + var(--safeT)) 14px calc(18px + var(--safeB));
    }

    .shell{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .shell{ grid-template-columns: 1fr; }
    }

    /* ====== å·¦ï¼šãƒ¡ã‚¤ãƒ³ãƒ’ãƒ¼ãƒ­ãƒ¼ ====== */
    .hero{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 26px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background:
        radial-gradient(520px 300px at 35% 20%, rgba(120,180,255,.22), transparent 60%),
        radial-gradient(520px 360px at 78% 78%, rgba(255,210,130,.14), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        conic-gradient(from 210deg,
          rgba(120,180,255,.10),
          rgba(255,210,130,.08),
          rgba(160,255,210,.08),
          rgba(120,180,255,.10)
        );
      filter: blur(18px);
      opacity:.35;
      animation: spin 18s linear infinite;
      pointer-events:none;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .heroTop{
      position:relative;
      padding: 18px 18px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: rgba(0,0,0,.20);
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .logoBlock{ display:flex; flex-direction:column; gap:8px; min-width:0; }
    .kicker{
      display:inline-flex;
      align-items:center;
      gap:8px;
      width:fit-content;
      font-weight:900;
      letter-spacing:.08em;
      font-size:11px;
      color:rgba(255,255,255,.92);
      padding: 7px 10px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background:rgba(0,0,0,.18);
    }
    .kicker .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(120,180,255,.9);
      box-shadow: 0 0 18px rgba(120,180,255,.55);
    }
    .heroTitle{
      margin:0;
      font-weight:1000;
      letter-spacing:.02em;
      line-height:1.05;
      font-size: 28px;
    }
    .heroSub{
      margin:0;
      color:rgba(255,255,255,.78);
      line-height:1.55;
      font-size: 13px;
      max-width: 54ch;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow2);
      max-width: 46%;
      min-width: 0;
    }
    .pill .avatar{
      width:34px;height:34px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      flex:0 0 34px;
      display:grid;place-items:center;
    }
    .pill .avatar img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
    .pill .txt{display:flex;flex-direction:column; gap:2px; min-width:0;}
    .pill .name{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pill .meta{font-size:11px;color:rgba(255,255,255,.72);white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    /* ====== ä¸­å¤®ï¼šè¡—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‹ã‚²ãƒ¼ãƒˆæ¼”å‡º ====== */
    .heroMid{
      position:relative;
      padding: 16px 18px 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .preview{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      overflow:hidden;
      background:
        radial-gradient(420px 240px at 40% 25%, rgba(120,180,255,.18), transparent 65%),
        rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
      position:relative;
    }
    .preview::after{
      content:"";
      position:absolute; inset:-40px;
      background: conic-gradient(from 0deg, transparent 0 40%, rgba(255,255,255,.10) 45% 55%, transparent 60% 100%);
      animation: shimmer 5.2s linear infinite;
      opacity:.85;
      pointer-events:none;
    }
    @keyframes shimmer{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .previewTop{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .previewTop .ttl{
      font-weight:1000;
      letter-spacing:.02em;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .spark{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,210,130,.95);
      box-shadow: 0 0 18px rgba(255,210,130,.55);
    }
    .previewTop .cap{
      font-size:11px;
      color:rgba(255,255,255,.72);
      white-space:nowrap;
    }

    .townImg{
      height: 240px;
      display:grid;
      place-items:center;
      position:relative;
      padding: 14px;
    }
    /* âœ… ã“ã“ã«ã€Œè¡—ã®å…¥å£ç”»åƒã€ã‚’ç½®ãï¼ˆå·®ã—æ›¿ãˆç”¨ï¼‰ */
    .townImg .imgFrame{
      width:100%;
      height:100%;
      border-radius: 18px;
      border:1px dashed rgba(255,255,255,.18);
      background:
        radial-gradient(260px 160px at 50% 35%, rgba(120,180,255,.16), transparent 70%),
        radial-gradient(240px 140px at 55% 70%, rgba(255,210,130,.12), transparent 75%),
        rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }
    .townImg .imgFrame img{
      width:100%;
      height:100%;
      object-fit:cover; /* è¡—ç”»åƒã¯ãƒ‰ãƒ¼ãƒ³ã¨è¦‹ã›ã‚‹ */
      image-rendering: pixelated;
      opacity:.98;
      transform: scale(1.02);
    }
    .townImg .placeholder{
      text-align:center;
      color:rgba(255,255,255,.74);
      padding: 0 10px;
      line-height:1.55;
      font-size:12px;
    }
    .townImg .placeholder b{color:rgba(255,255,255,.92)}
    .tagRow{
      position:absolute;
      left: 22px;
      bottom: 20px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .tag{
      font-size:11px;
      font-weight:900;
      letter-spacing:.02em;
      padding: 7px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color:rgba(255,255,255,.90);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
    }

    /* ã‚²ãƒ¼ãƒˆã®çŸ­ã„ã‚»ãƒªãƒ• */
    .dialog{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(0,0,0,.26);
      padding: 12px 12px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      line-height: 1.55;
      box-shadow: var(--shadow2);
    }
    .dialog .small{display:block;margin-top:4px;color:var(--muted);font-size:12px}

    .actions{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .actions{ grid-template-columns: 1fr; }
      .pill{ max-width: 52%; }
      .townImg{ height: 220px; }
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 18px;
      font-weight: 1000;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow: 0 14px 32px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(120,180,255,.35);
      background:
        radial-gradient(220px 160px at 30% 30%, rgba(120,180,255,.35), transparent 60%),
        radial-gradient(260px 180px at 80% 80%, rgba(255,210,130,.20), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    }
    .btn.primary::after{
      content:"";
      position:absolute; inset:-60px;
      background: conic-gradient(from 90deg, transparent 0 40%, rgba(255,255,255,.20) 45% 55%, transparent 60% 100%);
      animation: shimmer 4.8s linear infinite;
      opacity:.85;
      pointer-events:none;
    }
    .btn .sub{
      display:block;
      margin-top:4px;
      font-size:11px;
      color:rgba(255,255,255,.75);
      font-weight:800;
      letter-spacing:.02em;
    }

    /* ====== ä¸‹ï¼šã§ãã‚‹ã“ã¨ã‚«ãƒ¼ãƒ‰ ====== */
    .featureRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 860px){
      .featureRow{ grid-template-columns: 1fr; }
    }
    .feature{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height: 74px;
    }
    .ico{
      width:40px;height:40px;border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 40px;
      box-shadow: 0 10px 20px rgba(0,0,0,.24);
    }
    .ftxt{min-width:0}
    .ftxt b{display:block;font-size:13px;letter-spacing:.02em}
    .ftxt span{display:block;margin-top:3px;font-size:12px;color:rgba(255,255,255,.72);line-height:1.45}

    /* ====== å³ï¼šã‚µã‚¤ãƒ‰ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ’ãƒ³ãƒˆ/é–€ç•ªï¼‰ ====== */
    .side{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 26px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background:
        radial-gradient(360px 240px at 60% 20%, rgba(160,255,210,.10), transparent 62%),
        radial-gradient(420px 280px at 20% 80%, rgba(120,180,255,.12), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;
      flex-direction:column;
      position:relative;
    }

    .sideTop{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sideTop .t{
      font-weight:1000;
      letter-spacing:.02em;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .sideTop .t .miniDot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(160,255,210,.92);
      box-shadow: 0 0 18px rgba(160,255,210,.55);
    }
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 7px 9px;
      border-radius: 999px;
      font-size: 11px;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }

    .sideBody{
      padding: 14px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1;
    }

    .guardBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .guardImg{
      width:64px;height:64px;border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:grid;place-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      user-select:none;
      flex:0 0 64px;
    }
    .guardImg img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
    .guardTxt{min-width:0}
    .guardTxt b{
      display:block;
      font-size:13px;
      letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .guardTxt span{
      display:block;
      margin-top:4px;
      color: rgba(255,255,255,.72);
      font-size:12px;
      line-height:1.45;
    }

    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
    }
    .stat b{
      display:block;
      font-size:11px;
      color: rgba(255,255,255,.72);
      font-weight:900;
      margin-bottom: 6px;
      letter-spacing:.02em;
    }
    .stat .v{
      font-family: var(--mono);
      font-weight:1000;
      font-size: 14px;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sideBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:auto;
    }
    @media (max-width: 520px){
      .sideBtns{ grid-template-columns: 1fr; }
    }

    .sbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 18px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.02em;
      box-shadow: 0 14px 30px rgba(0,0,0,.34);
    }
    .sbtn:active{transform:translateY(1px)}
    .sbtn.primary{
      border-color: rgba(160,255,210,.30);
      background:
        radial-gradient(220px 160px at 30% 30%, rgba(160,255,210,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¸­èº«ã¯ã‚ãªãŸã®ä½æ°‘ç¥¨ãã®ã¾ã¾ï¼‰ ====== */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.62);
      z-index:50;
      overscroll-behavior: contain;
    }
    .modal.on{display:flex}
    .modal .card{
      width:min(520px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(20,22,40,.96), rgba(10,12,20,.92));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
    }
    .modal .head .ttl{font-weight:1000}
    .modal .close{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      border-radius:14px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:1000;
    }
    .modal .body{padding:14px}

    .field{display:flex; flex-direction:column; gap:6px; margin:0 0 12px;}
    .field label{font-size:12px;color:var(--muted); font-weight:800}
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      outline:none;
      font-weight:900;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap;}

    .avatarGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .avOpt{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      padding:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 22px rgba(0,0,0,.24);
    }
    .avOpt.on{
      border-color:rgba(120,180,255,.45);
      box-shadow: 0 0 0 2px rgba(120,180,255,.18) inset, 0 12px 22px rgba(0,0,0,.24);
    }
    .avOpt .img{
      width:52px;height:52px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      overflow:hidden;
      display:grid;place-items:center;
    }
    .avOpt img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
    .avOpt .nm{font-size:11px;color:rgba(255,255,255,.88); text-align:center; line-height:1.2; font-weight:900}

    /* ä½æ°‘ç¥¨ï¼ˆã‚ãªãŸã®ã‚¬ãƒ©ã‚¹UIç¶­æŒï¼‰ */
    .residentCard{
      background: rgba(17, 20, 30, .55);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow:
        0 18px 55px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
    }
    .rcTop{
      padding: 14px 16px 10px;
      position: relative;
      background: rgba(0,0,0,.18);
      border-bottom: 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .rcTop::after{
      content:"";
      position:absolute;
      left: 14px; right: 14px; bottom: 0;
      height: 1px;
      background: linear-gradient(90deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.20),
        rgba(255,255,255,0)
      );
    }
    .rar{
      font-family:var(--mono);
      font-weight:1000;
      letter-spacing:.08em;
      font-size:12px;
      padding:6px 8px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background: rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .rcMid{
      padding: 12px 16px 10px;
      display:grid;
      grid-template-columns: 88px 1fr;
      align-items: center;
      gap: 12px;
    }
    .rcAv{
      width: 88px;
      height: 88px;
      border-radius: 20px;
      background: radial-gradient(circle at 30% 20%,
        rgba(255,255,255,.16),
        rgba(255,255,255,.04) 55%,
        rgba(0,0,0,.10) 100%
      );
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        0 10px 30px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.08);
      overflow: hidden;
      display:grid;place-items:center;
    }
    .rcAv img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated; transform:scale(.92)}
    .rcInfo .big{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .02em;
      line-height: 1.15;
      margin: 0 0 4px;
      word-break: break-word;
    }
    .rcInfo .sub{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      margin-bottom: 10px;
      font-weight:900;
    }
    .stats{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .stat2{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow:
        0 8px 22px rgba(0,0,0,.30),
        inset 0 1px 0 rgba(255,255,255,.06);
      font-size:12px;
      color:rgba(255,255,255,.92);
    }
    .stat2 b{display:block; font-size:11px; color:rgba(255,255,255,.72); margin-bottom:4px; font-weight:900}
    .rcBot{
      padding: 10px 16px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .quote{
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 12px;
      line-height: 1.6;
      font-size:12px;
      color:rgba(255,255,255,.90);
      min-width: 220px;
      flex: 1 1 220px;
    }
    .quote .mut{color:rgba(255,255,255,.72)}
    .rcBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; flex: 0 0 auto;}
    .rcBtns .sbtn{
      border-radius: 999px;
      padding: 12px 14px;
      font-size:12px;
      font-weight:1000;
      box-shadow:
        0 10px 26px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.06);
    }

    .backupBox{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      padding:10px 12px;
    }
    .backupBox .cap{font-size:12px; color:rgba(255,255,255,.90); font-weight:1000; margin:0 0 6px;}
    .backupBox .desc{font-size:12px; color:rgba(255,255,255,.72); margin:0 0 10px; line-height:1.45;}
    .backupRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    /* å°ã•ã‚ */
    @media (max-width: 420px){
      .heroTitle{font-size:26px}
      .rcMid{ grid-template-columns: 80px 1fr; }
      .rcAv{ width: 80px; height: 80px; border-radius: 18px; }
      .stats{ gap: 9px; }
    }

    /* å³ä¸Šä½æ°‘ pill ãŒè©°ã¾ã‚‹æ™‚ */
    @media (max-width: 520px){
      .pill{ padding:10px 10px; }
      .pill .meta{ display:none; }
    }
  </style>
</head>

<body>
  <div class="bg-comet"></div>
  <div class="bg-grid"></div>
  <div class="bg-stars"></div>
  <div class="bg-stars2"></div>

  <main class="wrap">
    <div class="shell" aria-label="å…¥å£">

      <!-- ===== å·¦ï¼šãƒ¡ã‚¤ãƒ³ï¼ˆãƒ¯ã‚¯ãƒ¯ã‚¯å´ï¼‰ ===== -->
      <section class="hero">
        <div class="heroTop">
          <div class="logoBlock">
            <div class="kicker"><span class="dot"></span> TRC WORLD GATE</div>
            <h1 class="heroTitle">ç„¼ã‹ã‚ŒãŸä¼èª¬ã¸ã€å…¥å ´ã›ã‚ˆã€‚</h1>
            <p class="heroSub">
              ã“ã“ã¯â€œãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—â€ã€‚<br>
              ç•‘ã§è‚²ã¦ã€éœ²åº—ã§ç¨¼ãã€å›³é‘‘ã‚’åŸ‹ã‚ã€ã‚²ãƒ¼ãƒ ã§è¨˜éŒ²ã‚’åˆ»ã‚€ã€‚<br>
              <b>ä½æ°‘ç¥¨ã‚’æŒã¤è€…ã ã‘ãŒã€è¡—ã®æ‰‰ã‚’é–‹ã‘ã‚‰ã‚Œã‚‹ã€‚</b>
            </p>
          </div>

          <div class="pill" title="ä½æ°‘æƒ…å ±">
            <div class="avatar" id="pillAvatar">ğŸ™‚</div>
            <div class="txt">
              <div class="name" id="pillName">åç„¡ã—ã®ã‚¿ã‚³æ°‘</div>
              <div class="meta" id="pillMeta">Lv -- / ç§°å· ---</div>
            </div>
          </div>
        </div>

        <div class="heroMid">
          <!-- è¡—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã“ã«è¡—ã®ç”»åƒã‚’ãƒ‰ãƒ¼ãƒ³ã¨ç½®ãï¼‰ -->
          <div class="preview" aria-label="è¡—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
            <div class="previewTop">
              <div class="ttl"><span class="spark"></span> ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—</div>
              <div class="cap">â€” å…¥å£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â€”</div>
            </div>

            <div class="townImg">
              <div class="imgFrame" id="townPreviewFrame">
                <!-- âœ… ã“ã“ã‚’å·®ã—æ›¿ãˆï¼šè¡—ã®å…¥å£ç”»åƒï¼ˆä¾‹ï¼šæƒ…å ±ã®è¡—/å”åŠ›åº—ã®è¡—/éŠæˆ¯ã®è¡—ã®ç·åˆå…¥å£ï¼‰ -->
                <!-- <img src="https://ul.h3z.jp/XXXXXXXX.png" alt="è¡—ã®å…¥å£" /> -->
                <div class="placeholder">
                  <b>ã“ã“ã«ã€Œè¡—ã®å…¥å£ç”»åƒã€ã‚’ç½®ãã¨ä¸€æ°—ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹</b><br>
                  ãƒ»æ¨ªé•·ã§OKï¼ˆã‚¹ãƒãƒ›ã«æ˜ ãˆã‚‹ï¼‰<br>
                  ãƒ»å¤œã®è¡—/ãƒã‚ªãƒ³/ç¥­ã‚Šæ„Ÿ ã ã¨æœ€é«˜
                </div>

                <div class="tagRow">
                  <span class="tag">ç•‘</span>
                  <span class="tag">éœ²åº—</span>
                  <span class="tag">å›³é‘‘</span>
                  <span class="tag">ã‚²ãƒ¼ãƒ </span>
                </div>
              </div>
            </div>
          </div>

          <div class="dialog" id="gateDialog">
            â€¦â€¦ã“ã“ã¯ ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—ã€‚<br>
            <span class="small">åã‚’åä¹—ã‚Œã€‚ä½æ°‘ç¥¨ã‚’ç™ºè¡Œã—ã¦ã‚„ã‚ã†ã€‚</span>
          </div>

          <div class="actions">
            <button class="btn primary" id="enterBtn" type="button">
              è¡—ã¸å…¥ã‚‹
              <span class="sub">ï¼ˆæ‰‰ã‚’é–‹ã‘ã‚‹ï¼‰</span>
            </button>
            <button class="btn" id="residentBtn" type="button">
              ä½æ°‘ç¥¨ã‚’è¦‹ã‚‹
              <span class="sub">ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚ã“ã“ï¼‰</span>
            </button>
          </div>

          <div class="featureRow" aria-label="ã§ãã‚‹ã“ã¨">
            <div class="feature">
              <div class="ico">ğŸŒ±</div>
              <div class="ftxt">
                <b>ç•‘ã§è‚²ã¦ã‚‹</b>
                <span>ã‚¿ãƒãƒ»æ°´ãƒ»è‚¥æ–™ã§ã‚«ãƒ¼ãƒ‰ã‚’åç©«ã€‚ãƒ¬ã‚¢ã‚‚ç„¦ã’ã‚‚ã€é‹å‘½ã€‚</span>
              </div>
            </div>
            <div class="feature">
              <div class="ico">ğŸ®</div>
              <div class="ftxt">
                <b>éœ²åº—ã§ç¨¼ã</b>
                <span>è©•åˆ¤ã¨ç›¸å ´ã§å£²è²·ãŒå¤‰ã‚ã‚‹ã€‚ã‚ªã‚¯ãƒˆã‚’æ¡ã‚Œã€‚</span>
              </div>
            </div>
            <div class="feature">
              <div class="ico">ğŸ®</div>
              <div class="ftxt">
                <b>éŠã³ã§åˆ»ã‚€</b>
                <span>ã‚¿ãƒ¯ãƒ¼ãƒ»é‡£ã‚Šâ€¦è¨˜éŒ²ãŒä½æ°‘ç¥¨ã«åˆ»ã¾ã‚Œã‚‹ã€‚</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== å³ï¼šã‚µã‚¤ãƒ‰ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦‹ã›ã¦ç…½ã‚‹ï¼‰ ===== -->
      <aside class="side" aria-label="æ¡ˆå†…">
        <div class="sideTop">
          <div class="t"><span class="miniDot"></span> é–€ç•ªã®æ¤œå•</div>
          <div class="chips">
            <span class="chip" id="chipLv">Lv --</span>
            <span class="chip" id="chipTitle">ç§°å·ï¼š---</span>
          </div>
        </div>

        <div class="sideBody">
          <div class="guardBox">
            <div class="guardImg" id="guardImg">ğŸ›¡ï¸</div>
            <div class="guardTxt">
              <b id="guardBadge">é–€ç•ªã‚¿ã‚³æ°‘</b>
              <span id="hintText">åˆå›ã¯ä½æ°‘ç™»éŒ²ãŒå¿…è¦ã ã€‚</span>
            </div>
          </div>
<div class="statGrid" aria-label="ã–ã£ãã‚Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
            <div class="stat"><b>æ‰€æŒã‚ªã‚¯ãƒˆ</b><div class="v" id="miniOcto">0</div></div>
            <div class="stat"><b>å›³é‘‘ï¼ˆæ‰€æŒåˆè¨ˆï¼‰</b><div class="v" id="miniZukan">0</div></div>
            <div class="stat"><b>è³‡æ åˆè¨ˆ</b><div class="v" id="miniInv">0</div></div>
            <div class="stat"><b>ã‚¿ãƒ¯ãƒ¼æœ€é«˜</b><div class="v" id="miniTower">0</div></div>
            <div class="stat"><b>é‡£ã‚Šæœ€é«˜</b><div class="v" id="miniFish">0</div></div>
            <div class="stat"><b>ä»Šæ—¥ã®è¨€è‘‰</b><div class="v" id="miniQuote">â€¦</div></div>
          </div>

          <div class="sideBtns">
            <button class="sbtn primary" id="quickResident" type="button">ä½æ°‘ç¥¨ï¼ˆè©³ç´°ï¼‰</button>
            <button class="sbtn" id="quickBackup" type="button">è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
          </div>

          <div style="color:rgba(255,255,255,.70);font-size:12px;line-height:1.55">
            â€» ä½æ°‘ç¥¨ã¨è¨˜éŒ²ã¯ç«¯æœ«ã® <b>localStorage</b> ã«ä¿å­˜ï¼ˆã‚µãƒ¼ãƒé€ä¿¡ãªã—ï¼‰ã€‚<br>
            â€» ä¸å®‰ãªäººã¯ã€æ™‚ã€… <b>è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</b> æ¨å¥¨ã€‚
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- ===== ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div class="modal" id="regModal" aria-hidden="true">
    <div class="card">
      <div class="head">
        <div class="ttl">ä½æ°‘ç™»éŒ²</div>
        <button class="close" id="regClose" type="button">Ã—</button>
      </div>
      <div class="body">
        <div class="field">
          <label for="nickInput">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆã‚ã¨ã§å¤‰æ›´OKï¼‰</label>
          <input id="nickInput" type="text" maxlength="16" placeholder="ä¾‹ï¼šãŸã“ã´å¤ªéƒ / ç„¼ãå¸«ã®mika ãªã©" />
        </div>

        <div class="field">
          <label>ã‚¢ãƒã‚¿ãƒ¼ï¼ˆã‚¿ã‚³æ°‘ã‚¢ã‚¤ã‚³ãƒ³ï¼‰</label>
          <div class="avatarGrid" id="avatarGrid"></div>
        </div>

        <div class="row">
          <button class="btn primary" id="regSave" type="button" style="flex:1">ç™»éŒ²ã™ã‚‹</button>
          <button class="btn" id="regCancel" type="button" style="flex:1">ã‚ã¨ã§</button>
        </div>

        <div style="margin-top:10px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.5">
          â€» ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã® <b>localStorage</b> ã«ä¿å­˜ï¼ˆã‚µãƒ¼ãƒé€ä¿¡ãªã—ï¼‰ã€‚<br>
          â€» æ¶ˆãˆãŸã‚‰å›°ã‚‹äººã¯ã€ä½æ°‘ç¥¨ã® <b>ã€Œè»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€</b> ã‚’æ¨å¥¨ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ä½æ°‘ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div class="modal" id="rcModal" aria-hidden="true">
    <div class="card">
      <div class="head">
        <div class="ttl">ä½æ°‘ç¥¨</div>
        <button class="close" id="rcClose" type="button">Ã—</button>
      </div>
      <div class="body">
        <div class="residentCard">
          <div class="rcTop">
            <div class="rar" id="rcRarity">CITIZEN</div>
            <div class="rar" id="rcLv">Lv 1</div>
          </div>

          <div class="rcMid">
            <div class="rcAv" id="rcAvatar">ğŸ™‚</div>
            <div class="rcInfo">
              <div class="big" id="rcName">åç„¡ã—ã®ã‚¿ã‚³æ°‘</div>
              <div class="sub" id="rcTitle">ç§°å·ï¼šã¯ã˜ã¾ã‚Šã®ç„¼ãæ‰‹</div>

              <div class="stats">
                <div class="stat2"><b>ç·EXPï¼ˆä½æ°‘ç¥¨ï¼‰</b><span id="stExp">0</span></div>
                <div class="stat2"><b>ç·ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä½æ°‘ç¥¨ï¼‰</b><span id="stDays">0</span>æ—¥</div>

                <div class="stat2"><b>æ‰€æŒã‚ªã‚¯ãƒˆ</b><span id="stOcto">0</span></div>
                <div class="stat2"><b>è³‡æ åˆè¨ˆ</b><span id="stInvAll">0</span></div>

                <div class="stat2"><b>å›³é‘‘ æ‰€æŒåˆè¨ˆ</b><span id="stZukan">0</span></div>
                <div class="stat2"><b>ã‚¿ãƒ¯ãƒ¼æœ€é«˜è¨˜éŒ²</b><span id="stTower">0</span></div>

                <div class="stat2"><b>é‡£ã‚Šæœ€é«˜è¨˜éŒ²</b><span id="stFishBest">0</span></div>
                <div class="stat2"><b>ãƒ¡ãƒ¢</b><span style="opacity:.85">è¨˜éŒ²ã¯è‡ªå‹•èª­å–</span></div>
              </div>
            </div>
          </div>

          <div class="rcBot">
            <div class="quote">
              <div id="rcQuote">ã€Œä»Šæ—¥ã‚‚ç„¼ã‹ã‚Œã«æ¥ãŸã®ã‹ã€‚ã€</div>
              <div class="mut" id="rcQuoteSub">é–€ç•ªã‚ˆã‚Š</div>
            </div>
            <div class="rcBtns">
              <button class="sbtn" id="editBtn" type="button">åå‰/ã‚¢ãƒã‚¿ãƒ¼å¤‰æ›´</button>
              <button class="sbtn" id="exportBtn" type="button">ä½æ°‘ç¥¨ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
          </div>
        </div>

        <!-- âœ… è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…è¦ç¯„å›²ã®ã¿ï¼‰ -->
        <div class="backupBox">
          <div class="cap">è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…è¦ç¯„å›²ã ã‘ä¿å­˜ï¼‰</div>
          <p class="desc">
            ä¿å­˜ã™ã‚‹ã‚‚ã®ï¼š<br>
            <b>ä½æ°‘ç¥¨ï¼ˆexp/days/åå‰/ã‚¢ãƒã‚¿ãƒ¼ï¼‰</b> / <b>æ‰€æŒã‚ªã‚¯ãƒˆ</b> /
            <b>å›³é‘‘ï¼ˆæ‰€æŒcount + ç”»åƒimgãŒã‚ã‚Œã°ï¼‰</b> / <b>è³‡æ</b> /
            <b>ç•‘ã®ãƒ¬ãƒ™ãƒ«ç­‰ï¼ˆtf_v1_* ã®é€²è¡Œã‚­ãƒ¼ï¼‰</b> / <b>éœ²åº—ãƒ¬ãƒ™ãƒ«ç­‰ï¼ˆroten_v1_*ï¼‰</b> /
            <b>ã‚¿ãƒ¯ãƒ¼</b> / <b>é‡£ã‚Š</b><br>
            â€» ãƒ­ã‚°ç³»ãƒ»å±¥æ­´ç³»ã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚
          </p>
          <div class="backupRow">
            <button class="sbtn" id="btnBackupAll" type="button">è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            <button class="sbtn" id="btnRestoreAll" type="button">å¾©å…ƒ</button>
            <input id="restoreFile" type="file" accept="application/json" style="display:none;">
          </div>
        </div>

        <div style="margin-top:12px;color:rgba(255,255,255,.72);font-size:12px;line-height:1.5">
          â€» å¾©å…ƒã¯ <b>ä¸Šæ›¸ã</b> ã§ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰ã€‚å…ˆã«2æœ¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    /* =========================================================
       gate.html / å…¥å£ + ä½æ°‘ç¥¨ å®Œå…¨ç‰ˆï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³åˆ·æ–°ç‰ˆï¼‰
       âœ… ã‚ãªãŸã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¯ç¶­æŒï¼ˆä½æ°‘ç¥¨/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/èª­å–/å¾©å…ƒï¼‰
       âœ… è¦‹ãŸç›®ã ã‘ã€Œã‚²ãƒ¼ãƒ é–‹å§‹æ¼”å‡ºã€ã«å¯„ã›ã¦ãƒ†ãƒ³ã‚·ãƒ§ãƒ³UP
       ========================================================= */

    const TOWN_URL = "town/index.html";

    const KEY = {
      resident: "trc_v1_resident",
      lastLogin: "trc_v1_last_login",
    };

    const EXIST = {
      farmBook: "tf_v1_book",
      farmInv:  "tf_v1_inv",
      rotenOcto:"roten_v1_octo",
      tower: "tower_v1_state",
      fish:  "fish_v1_state",
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const pillName = $("#pillName");
    const pillAvatar = $("#pillAvatar");
    const pillMeta = $("#pillMeta");

    const enterBtn = $("#enterBtn");
    const residentBtn = $("#residentBtn");
    const gateDialog = $("#gateDialog");

    const chipLv = $("#chipLv");
    const chipTitle = $("#chipTitle");

    const regModal = $("#regModal");
    const regClose = $("#regClose");
    const regSave  = $("#regSave");
    const regCancel= $("#regCancel");
    const nickInput= $("#nickInput");
    const avatarGrid = $("#avatarGrid");

    const rcModal = $("#rcModal");
    const rcClose = $("#rcClose");
    const editBtn = $("#editBtn");
    const exportBtn = $("#exportBtn");

    const btnBackupAll = $("#btnBackupAll");
    const btnRestoreAll = $("#btnRestoreAll");
    const restoreFile = $("#restoreFile");

    const rcName = $("#rcName");
    const rcAvatar = $("#rcAvatar");
    const rcTitle = $("#rcTitle");
    const rcLv = $("#rcLv");
    const rcRarity = $("#rcRarity");
    const rcQuote = $("#rcQuote");
    const rcQuoteSub = $("#rcQuoteSub");

    const stExp = $("#stExp");
    const stDays = $("#stDays");
    const stOcto = $("#stOcto");
    const stInvAll = $("#stInvAll");
    const stZukan = $("#stZukan");
    const stTower = $("#stTower");
    const stFishBest = $("#stFishBest");

    const guardImg = $("#guardImg");
    const guardBadge = $("#guardBadge");
    const hintText  = $("#hintText");

    const miniOcto = $("#miniOcto");
    const miniZukan = $("#miniZukan");
    const miniInv = $("#miniInv");
    const miniTower = $("#miniTower");
    const miniFish = $("#miniFish");
    const miniQuote = $("#miniQuote");

    const quickResident = $("#quickResident");
    const quickBackup = $("#quickBackup");

    const AVATARS = [
      { id:"av_guard", name:"é–€ç•ª", emoji:"ğŸ›¡ï¸", img:"https://ul.h3z.jp/uhjnnv4y.png" },
      { id:"av_farmer", name:"è¾²å®¶", emoji:"ğŸŒ±", img:"https://ul.h3z.jp/FZ0fXidR.png" },
      { id:"av_shop", name:"éœ²åº—", emoji:"ğŸ®", img:"https://ul.h3z.jp/LTVIOUJ6.png" },
      { id:"av_hero", name:"å‹‡è€…", emoji:"âš”ï¸", img:"https://ul.h3z.jp/UprqJlis.png" },
      { id:"av_sage", name:"è³¢è€…", emoji:"ğŸ“œ", img:"https://ul.h3z.jp/LVrnv9RL.png" },
      { id:"av_ninja", name:"å¿è€…", emoji:"ğŸ¥·", img:"https://ul.h3z.jp/6B74Di8u.png" },
      { id:"av_ghost", name:"GHOST", emoji:"ğŸ‘»", img:"https://ul.h3z.jp/vGChF0k6.png" },
      { id:"av_takopi", name:"ãŸã“ã´", emoji:"ğŸ™", img:"https://ul.h3z.jp/wZLLf3SY.png" },
    ];

    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };

    function safeJSONParse(raw, fallback){
      try{ return JSON.parse(raw); }catch(_){ return fallback; }
    }
    function safeStringify(obj){
      try{ return JSON.stringify(obj); }catch(_){ return "null"; }
    }

    function loadResident(){
      const raw = localStorage.getItem(KEY.resident);
      const base = {
        ver:3,
        nick:"",
        avatarId:"av_guard",
        exp:0,
        days:0,
        lastSeenDay:"",
        createdAt: Date.now()
      };
      if(!raw) return base;
      const r = safeJSONParse(raw, base);
      return Object.assign(base, r);
    }
    function saveResident(r){ localStorage.setItem(KEY.resident, JSON.stringify(r)); }
    function getAvatarById(id){ return AVATARS.find(a=>a.id===id) || AVATARS[0]; }

    function calcLevel(exp){
      exp = Math.max(0, Math.floor(Number(exp)||0));
      let lv = 1;
      let need = 40;
      let cur = exp;
      while(cur >= need){
        cur -= need;
        lv++;
        need = Math.floor(need * 1.35 + 10);
        if(lv >= 99) break;
      }
      return { lv, nextNeed: need, curToNext: cur };
    }

    function calcTitleByLevel(lv){
      if(lv>=30) return "ç§°å·ï¼šç„¼ã‹ã‚Œã—ä¼èª¬ã®ä½æ°‘";
      if(lv>=20) return "ç§°å·ï¼šè¶…ãƒ»ç„¼ãæ‰‹ï¼ˆã»ã¼ç¥ï¼‰";
      if(lv>=15) return "ç§°å·ï¼šç„¦ã’ã¨åŠç†Ÿã®ä¸¡åˆ€ä½¿ã„";
      if(lv>=10) return "ç§°å·ï¼šåŠç†Ÿãƒã‚¹ã‚¿ãƒ¼";
      if(lv>=5)  return "ç§°å·ï¼šè¦‹ç¿’ã„ç„¼ãå¸«";
      return "ç§°å·ï¼šã¯ã˜ã¾ã‚Šã®ç„¼ãæ‰‹";
    }

    function calcRarity(lv){
      if(lv>=30) return "LR CITIZEN";
      if(lv>=20) return "UR CITIZEN";
      if(lv>=12) return "SR CITIZEN";
      if(lv>=6)  return "R  CITIZEN";
      return "N  CITIZEN";
    }
function pickQuote(){
      const list = [
        "ã€Œæ‰‰ã¯é–‹ã„ã¦ã„ã‚‹ã€‚å•é¡Œã¯ã€ãŠå‰ã®è…¹ã ã€‚ã€",
        "ã€Œä»Šæ—¥ã‚‚ç„¼ã‹ã‚Œã«æ¥ãŸã®ã‹ã€‚â€¦ã„ã„é¡”ã ã€‚ã€",
        "ã€Œä½æ°‘ç¥¨ã¯å˜˜ã‚’ã¤ã‹ãªã„ã€‚å˜˜ã‚’ã¤ãã®ã¯äººé–“ã ã€‚ã€",
        "ã€Œç„¦ã’ã¦ã‚‚ä¾¡å€¤ã¯æ®‹ã‚‹ã€‚â€¦ãŸã¶ã‚“ã€‚ã€",
        "ã€ŒåŠç†Ÿã¯æœªå®Œæˆã˜ã‚ƒãªã„ã€‚â€œä½™ç™½â€ã ã€‚ã€"
      ];
      const key = todayKey();
      let hash = 0;
      for(let i=0;i<key.length;i++) hash = (hash*31 + key.charCodeAt(i)) >>> 0;
      return list[hash % list.length];
    }

    function setAvatarNode(node, av){
      node.innerHTML = "";
      if(av.img){
        const img = document.createElement("img");
        img.src = av.img;
        img.alt = av.name;
        img.loading = "lazy";
        node.appendChild(img);
      }else{
        node.textContent = av.emoji || "ğŸ™‚";
      }
    }

    const getRaw = (k) => {
      const v = localStorage.getItem(k);
      return (v === null || v === undefined) ? null : String(v);
    };

    // âœ… å›³é‘‘ã‚’slimåŒ–ï¼šcount + img/name(+ãŠã¾ã‘) ã‚’ä¿æŒ
    // â˜…é‡è¦ï¼šid ã‚’ãƒãƒ¼ãƒ‰å†…ã«ã‚‚å…¥ã‚Œã‚‹ï¼ˆå›³é‘‘å´ãŒObject.valuesã§ã‚‚å£Šã‚Œãªã„ï¼‰
    function slimBookRawKeepImg(){
      const raw = getRaw(EXIST.farmBook);
      if(!raw) return null;

      const book = safeJSONParse(raw, null);
      if(!book || typeof book !== "object") return raw;

      const got = (book.got && typeof book.got==="object") ? book.got : {};
      const outGot = {};
      for(const id of Object.keys(got)){
        const node = got[id] || {};
        const c = Number(node.count || 0);
        if(c > 0){
          const out = { id, count: c };
          if(typeof node.img === "string" && node.img.trim()) out.img = node.img.trim();
          if(typeof node.name === "string" && node.name.trim()) out.name = node.name.trim();
          if(typeof node.rarity === "string" && node.rarity.trim()) out.rarity = node.rarity.trim();
          if(node.at != null && String(node.at).trim()) out.at = node.at;
          if(node.lastAt != null && String(node.lastAt).trim()) out.lastAt = node.lastAt;
          outGot[id] = out;
        }
      }
      const slim = { ver: book.ver ?? 1, got: outGot };
      return safeStringify(slim);
    }

    function calcZukanOwnedTotal(){
      const raw = localStorage.getItem(EXIST.farmBook);
      if(!raw) return 0;
      const book = safeJSONParse(raw, null);
      if(!book || typeof book !== "object") return 0;
      const got = (book.got && typeof book.got==="object") ? book.got : {};
      let sum = 0;
      for(const id in got){
        const c = Number(got[id]?.count || 0);
        if(c > 0) sum += c;
      }
      return sum;
    }

    function calcInvTotals(){
      const raw = localStorage.getItem(EXIST.farmInv);
      if(!raw) return { seed:0, water:0, fert:0, all:0 };
      const inv = safeJSONParse(raw, null);
      if(!inv) return { seed:0, water:0, fert:0, all:0 };

      const sumObj = (o) => {
        if(!o || typeof o !== "object") return 0;
        let s = 0;
        for(const k in o){
          const v = o[k];
          if(typeof v === "number" && isFinite(v)) s += Math.max(0, v|0);
        }
        return s;
      };
      const seed = sumObj(inv.seed);
      const water= sumObj(inv.water);
      const fert = sumObj(inv.fert);
      return { seed, water, fert, all: seed + water + fert };
    }

    function readOcto(){
      const raw = localStorage.getItem(EXIST.rotenOcto);
      if(raw == null) return 0;
      const n = Number(raw);
      return Number.isFinite(n) ? Math.floor(n) : 0;
    }

    function listKeysByRegex(re){
      const out = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(re.test(k)) out.push(k);
      }
      return out;
    }

    function parseMaybeDeep(raw, depth=2){
      let cur = raw;
      for(let i=0;i<depth;i++){
        if(cur == null) break;
        if(typeof cur === "number") return cur;
        if(typeof cur === "object") return cur;

        if(typeof cur === "string"){
          const s = cur.trim();
          if(!s) return cur;
          if(/^-?\d+(\.\d+)?$/.test(s)) return Number(s);
          if((s.startsWith("{") && s.endsWith("}")) || (s.startsWith("[") && s.endsWith("]"))){
            try{ cur = JSON.parse(s); continue; }catch(_){ return cur; }
          }
          return cur;
        }
      }
      return cur;
    }

    function extractBestNumber(obj, candidates){
      if(typeof obj === "number" && Number.isFinite(obj)) return Math.floor(obj);
      if(!obj || typeof obj !== "object") return 0;

      let best = 0;

      for(const path of candidates){
        const parts = path.split(".");
        let cur = obj;
        for(const p of parts){
          if(cur && typeof cur === "object" && p in cur) cur = cur[p];
          else { cur = undefined; break; }
        }
        const n = Number(cur);
        if(Number.isFinite(n)) best = Math.max(best, n);
      }

      for(const k in obj){
        const v = obj[k];
        if(typeof v === "number" && Number.isFinite(v)) best = Math.max(best, v);
        else if(typeof v === "string" && v.trim() && /^-?\d+(\.\d+)?$/.test(v.trim())) best = Math.max(best, Number(v));
      }

      return Math.floor(best);
    }

    function readTowerStats(){
      let bestFloor = 0;
      let bestScore = 0;

      const consider = (key, raw)=>{
        const parsed = parseMaybeDeep(raw, 3);

        if(typeof parsed === "number" && Number.isFinite(parsed)){
          const n = Math.floor(parsed);
          if(/floor|maxfloor|bestfloor/i.test(key)) bestFloor = Math.max(bestFloor, n);
          else bestScore = Math.max(bestScore, n);
          return;
        }

        if(Array.isArray(parsed)){
          for(const it of parsed){
            const p = parseMaybeDeep(it, 2);
            if(typeof p === "number" && Number.isFinite(p)){
              bestScore = Math.max(bestScore, Math.floor(p));
            }else if(p && typeof p === "object"){
              bestFloor = Math.max(bestFloor, extractBestNumber(p, ["bestFloor","maxFloor","floor","best.floor","stats.bestFloor","tower.bestFloor"]));
              bestScore = Math.max(bestScore, extractBestNumber(p, ["bestScore","maxScore","score","best.score","stats.bestScore","tower.bestScore"]));
            }
          }
          return;
        }

        if(parsed && typeof parsed === "object"){
          bestFloor = Math.max(bestFloor, extractBestNumber(parsed, [
            "bestFloor","maxFloor","floor","best.floor",
            "stats.bestFloor","stats.maxFloor","tower.bestFloor"
          ]));
          bestScore = Math.max(bestScore, extractBestNumber(parsed, [
            "bestScore","maxScore","score","best.score",
            "stats.bestScore","stats.maxScore","tower.bestScore"
          ]));
          return;
        }

        if(typeof parsed === "string"){
          const s = parsed.trim();
          if(/^-?\d+(\.\d+)?$/.test(s)) bestScore = Math.max(bestScore, Math.floor(Number(s)));
        }
      };

      const raw0 = localStorage.getItem(EXIST.tower);
      if(raw0 != null) consider(EXIST.tower, raw0);

      for(const k of listKeysByRegex(/tower/i)){
        const raw = localStorage.getItem(k);
        if(raw != null) consider(k, raw);
      }

      return { floor: bestFloor, score: bestScore };
    }

    function readFishBest(){
      let best = 0;

      const consider = (key, raw)=>{
        const parsed = parseMaybeDeep(raw, 3);

        if(typeof parsed === "number" && Number.isFinite(parsed)){
          best = Math.max(best, Math.floor(parsed));
          return;
        }

        if(Array.isArray(parsed)){
          for(const it of parsed){
            const p = parseMaybeDeep(it, 2);
            if(typeof p === "number" && Number.isFinite(p)){
              best = Math.max(best, Math.floor(p));
            }else if(p && typeof p === "object"){
              best = Math.max(best, extractBestNumber(p, [
                "best","bestScore","maxScore","highScore","record",
                "bestSize","maxSize","max",
                "stats.best","stats.bestScore",
                "result.best","result.score"
              ]));
            }
          }
          return;
        }

        if(parsed && typeof parsed === "object"){
          best = Math.max(best, extractBestNumber(parsed, [
            "best","bestScore","maxScore","highScore","record",
            "bestSize","maxSize","max",
            "stats.best","stats.bestScore",
            "result.best","result.score"
          ]));
          return;
        }

        if(typeof parsed === "string"){
          const s = parsed.trim();
          if(/^-?\d+(\.\d+)?$/.test(s)) best = Math.max(best, Math.floor(Number(s)));
        }
      };

      const raw0 = localStorage.getItem(EXIST.fish);
      if(raw0 != null) consider(EXIST.fish, raw0);

      for(const k of listKeysByRegex(/fish|takofish|tako_fish|tfish/i)){
        const raw = localStorage.getItem(k);
        if(raw != null) consider(k, raw);
      }

      for(const k of listKeysByRegex(/fish.*best|best.*fish|takofish.*best/i)){
        const raw = localStorage.getItem(k);
        if(raw == null) continue;
        const n = Number(String(raw).trim());
        if(Number.isFinite(n)) best = Math.max(best, Math.floor(n));
      }

      return { best };
    }

    function touchLoginDay(r){
      const t = todayKey();
      const last = localStorage.getItem(KEY.lastLogin) || "";
      if(last !== t){
        localStorage.setItem(KEY.lastLogin, t);
        r.days = (r.days||0) + 1;
        r.exp = (r.exp||0) + 5;
      }
      r.lastSeenDay = t;
      return r;
    }

    function renderTop(r){
      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "åç„¡ã—ã®ã‚¿ã‚³æ°‘";
      const av = getAvatarById(r.avatarId);
      pillName.textContent = nick;
      setAvatarNode(pillAvatar, av);

      setAvatarNode(guardImg, getAvatarById("av_guard"));
      guardBadge.textContent = "é–€ç•ªã‚¿ã‚³æ°‘";

      const {lv} = calcLevel(r.exp||0);
      chipLv.textContent = `Lv ${lv}`;
      chipTitle.textContent = calcTitleByLevel(lv).replace("ç§°å·ï¼š","");
      pillMeta.textContent = `Lv ${lv} / ${calcTitleByLevel(lv).replace("ç§°å·ï¼š","")}`;

      // å³å´ã®ãƒŸãƒ‹ã‚¹ãƒ†è¡¨ç¤ºã‚‚æ›´æ–°
      const octo = readOcto();
      const invT = calcInvTotals();
      const zukan = calcZukanOwnedTotal();
      const tower = readTowerStats();
      const fish  = readFishBest();

      miniOcto.textContent = String(Math.floor(octo));
      miniZukan.textContent = String(Math.floor(zukan));
      miniInv.textContent = String(invT.all);
      miniTower.textContent = `${Math.floor(tower.floor)}F`;
      miniFish.textContent = String(Math.floor(fish.best));
      miniQuote.textContent = pickQuote().replace(/[ã€Œã€]/g,"");
    }

    function renderGateText(r){
      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "";
      if(!nick){
        gateDialog.innerHTML = `â€¦â€¦ã“ã“ã¯ ãŸã“ç„¼ããƒˆãƒ¬ã‚«ã®è¡—ã€‚<br><span class="small">åã‚’åä¹—ã‚Œã€‚ä½æ°‘ç¥¨ã‚’ç™ºè¡Œã—ã¦ã‚„ã‚ã†ã€‚</span>`;
        hintText.textContent  = "åˆå›ã¯ä½æ°‘ç™»éŒ²ãŒå¿…è¦ã ã€‚";
      }else{
        const {lv} = calcLevel(r.exp||0);
        const title = calcTitleByLevel(lv).replace("ç§°å·ï¼š","");
        gateDialog.innerHTML = `â€¦â€¦<b>${nick}</b>ã‹ã€‚<br><span class="small">ç§°å·ã€Œ${title}ã€â”€â”€ å…¥å ´ã‚’è¨±å¯ã™ã‚‹ã€‚</span>`;
        hintText.textContent  = "ä½æ°‘ç¥¨ï¼å¿…è¦é …ç›®ã ã‘è¡¨ç¤ºã ã€‚";
      }
    }

    function openModal(m){ m.classList.add("on"); m.setAttribute("aria-hidden","false"); }
    function closeModal(m){ m.classList.remove("on"); m.setAttribute("aria-hidden","true"); }

    function buildAvatarGrid(selectedId){
      avatarGrid.innerHTML = "";
      AVATARS.forEach(av=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "avOpt" + (av.id===selectedId ? " on" : "");
        b.dataset.id = av.id;

        const img = document.createElement("div");
        img.className = "img";
        if(av.img){
          const im = document.createElement("img");
          im.src = av.img;
          im.alt = av.name;
          im.loading = "lazy";
          img.appendChild(im);
        }else{
          img.textContent = av.emoji || "ğŸ™‚";
        }

        const nm = document.createElement("div");
        nm.className = "nm";
        nm.textContent = av.name;

        b.appendChild(img);
        b.appendChild(nm);

        b.addEventListener("click", ()=>{
          [...avatarGrid.querySelectorAll(".avOpt")].forEach(x=>x.classList.remove("on"));
          b.classList.add("on");
        });

        avatarGrid.appendChild(b);
      });
    }

    function getSelectedAvatarId(){
      const on = avatarGrid.querySelector(".avOpt.on");
      return on ? on.dataset.id : AVATARS[0].id;
    }

    function openRegister(r, mode="register"){
      $(".ttl", regModal).textContent = (mode==="edit") ? "ä½æ°‘æƒ…å ±ã®å¤‰æ›´" : "ä½æ°‘ç™»éŒ²";
      nickInput.value = r.nick || "";
      buildAvatarGrid(r.avatarId || AVATARS[0].id);
      openModal(regModal);
      nickInput.focus();
    }

    function openResidentCard(r){
      const lvInfo = calcLevel(r.exp||0);
      const lv = lvInfo.lv;

      const nick = r.nick && r.nick.trim() ? r.nick.trim() : "åç„¡ã—ã®ã‚¿ã‚³æ°‘";
      const av = getAvatarById(r.avatarId);

      rcName.textContent = nick;
      rcTitle.textContent = calcTitleByLevel(lv);
      rcLv.textContent = `Lv ${lv}`;
      rcRarity.textContent = calcRarity(lv);
      setAvatarNode(rcAvatar, av);

      stExp.textContent = String(Math.floor(r.exp||0));
      stDays.textContent = String(Math.floor(r.days||0));

      const octo = readOcto();
      const invT = calcInvTotals();
      const zukan = calcZukanOwnedTotal();
      const tower = readTowerStats();
      const fish  = readFishBest();

      stOcto.textContent = String(Math.floor(octo));
      stInvAll.textContent = `${invT.all}ï¼ˆ${invT.seed}/${invT.water}/${invT.fert}ï¼‰`;
      stZukan.textContent = String(Math.floor(zukan));
      stTower.textContent = `${Math.floor(tower.floor)}F / ${Math.floor(tower.score)}`;
      stFishBest.textContent = String(Math.floor(fish.best));

      rcQuote.textContent = pickQuote();
      rcQuoteSub.textContent = "é–€ç•ªã‚ˆã‚Š";

      saveResident(r);
      renderTop(r);
      renderGateText(r);

      openModal(rcModal);
    }

    window.TRCResident = {
      get: () => loadResident(),
      save: (patch) => { const r = loadResident(); Object.assign(r, patch||{}); saveResident(r); return r; },
      addExp: (add) => {
        const r = loadResident();
        r.exp = (r.exp||0) + Math.max(0, Math.floor(Number(add)||0));
        saveResident(r);
        return r;
      }
    };

    function findFarmProgressKeys(){
      const out = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(!/^tf_v1_/i.test(k)) continue;
        if(/log|history|debug/i.test(k)) continue;
        if(k === EXIST.farmBook || k === EXIST.farmInv) continue;
        out.push(k);
      }
      const prefer = ["tf_v1_state","tf_v1_level","tf_v1_xp","tf_v1_farm","tf_v1_progress"];
      const ordered = [];
      for(const p of prefer){
        if(localStorage.getItem(p)!=null && !ordered.includes(p)) ordered.push(p);
      }
      for(const k of out){
        if(!ordered.includes(k)) ordered.push(k);
      }
      return ordered.slice(0, 30);
    }

    function findRotenProgressKeys(){
      const out = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(!/^roten_v1_/i.test(k)) continue;
        if(/log|history|debug/i.test(k)) continue;
        out.push(k);
      }
      const prefer = ["roten_v1_level","roten_v1_rep","roten_v1_myshop","roten_v1_inventory","roten_v1_market","roten_v1_state","roten_v1_shelves","roten_v1_octo"];
      const ordered = [];
      for(const p of prefer){
        if(localStorage.getItem(p)!=null && !ordered.includes(p)) ordered.push(p);
      }
      for(const k of out){
        if(!ordered.includes(k)) ordered.push(k);
      }
      return ordered.slice(0, 60);
    }

    function buildSlimBackupPayload(){
      const keys = {};

      keys[KEY.resident] = getRaw(KEY.resident);
      keys[KEY.lastLogin] = getRaw(KEY.lastLogin);

      keys[EXIST.rotenOcto] = getRaw(EXIST.rotenOcto);
      keys[EXIST.farmInv]   = getRaw(EXIST.farmInv);

      keys[EXIST.farmBook]  = slimBookRawKeepImg();

      for(const k of findFarmProgressKeys()){
        const v = getRaw(k);
        if(v != null) keys[k] = v;
      }
      for(const k of findRotenProgressKeys()){
        const v = getRaw(k);
        if(v != null) keys[k] = v;
      }

      if(getRaw(EXIST.tower) != null) keys[EXIST.tower] = getRaw(EXIST.tower);
      for(const k of listKeysByRegex(/tower/i)){
        const v = getRaw(k);
        if(v != null) keys[k] = v;
      }

      if(getRaw(EXIST.fish) != null) keys[EXIST.fish] = getRaw(EXIST.fish);
      for(const k of listKeysByRegex(/fish|takofish|tako_fish|tfish/i)){
        const v = getRaw(k);
        if(v != null) keys[k] = v;
      }

      for(const k of Object.keys(keys)){
        if(keys[k] === null || keys[k] === undefined) delete keys[k];
      }

      return {
        app: "takoyaki-trc",
        ver: 5,
        kind: "slim+roten",
        exportedAt: new Date().toISOString(),
        note: "ä½æ°‘ç¥¨/ã‚ªã‚¯ãƒˆ/è³‡æ/å›³é‘‘(count+img+id)/ç•‘é€²è¡Œ(tf_v1_*)/éœ²åº—é€²è¡Œ(roten_v1_*)/ã‚¿ãƒ¯ãƒ¼/é‡£ã‚Š ã‚’ä¿å­˜ã€‚ãƒ­ã‚°ã¯ä¿å­˜ã—ãªã„ã€‚",
        keys
      };
    }

    function downloadJson(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function backupSlim(){
      const payload = buildSlimBackupPayload();
      const stamp = new Date().toISOString().replace(/[:.]/g,"-");
      downloadJson(payload, `takoyaki-trc-backup_slim_${stamp}.json`);
    }

    async function restoreFromFile(file){
      const text = await file.text();
      const data = safeJSONParse(text, null);
      if(!data || !data.keys || typeof data.keys !== "object"){
        alert("ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }
      const keys = Object.keys(data.keys);
      const ok = confirm(
        "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚\n" +
        "ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰ã€‚\n\n" +
        `å¾©å…ƒã‚­ãƒ¼æ•°: ${keys.length}\n\n` +
        "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ"
      );
      if(!ok) return;

      for(const k of keys){
        const v = data.keys[k];
        if(v === null || v === undefined){
          localStorage.removeItem(k);
        }else{
          localStorage.setItem(k, String(v));
        }
      }
      alert("å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
      location.reload();
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    enterBtn.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = r.nick && r.nick.trim();
      if(!nick){
        openRegister(r, "register");
        return;
      }
      enterBtn.disabled = true;
      enterBtn.textContent = "æ‰‰ãŒé–‹ã„ã¦ã„ã‚‹â€¦";
      setTimeout(()=>{ location.href = TOWN_URL; }, 350);
    });

    residentBtn.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = r.nick && r.nick.trim();
      if(!nick){
        openRegister(r, "register");
        return;
      }
      openResidentCard(r);
    });

    if(quickResident){
      quickResident.addEventListener("click", ()=>{
        const r = loadResident();
        const nick = r.nick && r.nick.trim();
        if(!nick){ openRegister(r,"register"); return; }
        openResidentCard(r);
      });
    }
    if(quickBackup){
      quickBackup.addEventListener("click", ()=>{
        quickBackup.textContent = "ä½œæˆä¸­â€¦";
        setTimeout(()=>{
          backupSlim();
          quickBackup.textContent = "è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—";
        }, 60);
      });
    }

    regClose.addEventListener("click", ()=> closeModal(regModal));
    regCancel.addEventListener("click", ()=> closeModal(regModal));

    regSave.addEventListener("click", ()=>{
      const r = loadResident();
      const nick = (nickInput.value||"").trim();
      if(!nick){
        nickInput.focus();
        nickInput.placeholder = "åå‰ãŒå¿…è¦ã ï¼ˆ16æ–‡å­—ã¾ã§ï¼‰";
        return;
      }
      const avatarId = getSelectedAvatarId();
      r.nick = nick.slice(0,16);
      r.avatarId = avatarId;
      saveResident(r);
      closeModal(regModal);

      renderTop(r);
      renderGateText(r);

      setTimeout(()=> openResidentCard(loadResident()), 120);
    });

    rcClose.addEventListener("click", ()=> closeModal(rcModal));
    editBtn.addEventListener("click", ()=>{
      closeModal(rcModal);
      const r = loadResident();
      openRegister(r, "edit");
    });

    exportBtn.addEventListener("click", async ()=>{
      const r = loadResident();
      const text = JSON.stringify(r, null, 2);
      try{
        await navigator.clipboard.writeText(text);
        exportBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ãŸï¼";
        setTimeout(()=> exportBtn.textContent = "ä½æ°‘ç¥¨ã‚’ã‚³ãƒ”ãƒ¼", 1200);
      }catch(e){
        prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ã­ï¼ˆä½æ°‘ç¥¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰", text);
      }
    });

    if(btnBackupAll){
      btnBackupAll.addEventListener("click", ()=>{
        btnBackupAll.textContent = "ä½œæˆä¸­â€¦";
        setTimeout(()=>{
          backupSlim();
          btnBackupAll.textContent = "è»½é‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—";
        }, 60);
      });
    }

    if(btnRestoreAll && restoreFile){
      btnRestoreAll.addEventListener("click", ()=> restoreFile.click());
      restoreFile.addEventListener("change", ()=>{
        const f = restoreFile.files && restoreFile.files[0];
        restoreFile.value = "";
        if(f) restoreFromFile(f);
      });
    }

    [regModal, rcModal].forEach(m=>{
      m.addEventListener("click", (e)=>{
        if(e.target === m) closeModal(m);
      });
    });

    function init(){
      let r = loadResident();
      r = touchLoginDay(r);
      saveResident(r);

      renderTop(r);
      renderGateText(r);

      // åˆå›ã¯è‡ªå‹•ã§ç™»éŒ²ã‚’é–‹ã
      if(!(r.nick && r.nick.trim())){
        setTimeout(()=> openRegister(r, "register"), 180);
      }
    }
    init();
  })();
  </script>
</body>
</html>